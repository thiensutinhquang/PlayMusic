<!DOCTYPE html>
<html lang="vi" data-theme="lucbao">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#f59e0b" />
  <title>MSTQ Music – Trình phát nhạc</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Firebase compat (không bắt buộc dùng nhưng giữ để tương thích về sau) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Babel (JSX inline) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root,[data-theme]{transition:color .2s ease,background-color .2s ease}
    :root{--bg:#111827;--card:#1f2937;--text:#f9fafb;--muted:#9ca3af;--primary:#f59e0b;--primary-fg:#111827;--ring:#f59e0b66;--border:#374151;--nav-bg:rgba(31,41,55,.8);--shadow:0 10px 30px rgba(0,0,0,.35);--gradient:linear-gradient(135deg,#f59e0b 0%,#fbbf24 100%)}
    [data-theme=light]{--bg:#f3f4f6;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#d97706;--primary-fg:#fff;--ring:#d9770666;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.85);--shadow:0 10px 25px rgba(0,0,0,.08);--gradient:linear-gradient(135deg,#fbbf24 0%,#f97316 100%)}
    [data-theme=lucbao]{--bg:#081414;--card:#102424;--text:#e0f2f1;--muted:#80cbc4;--primary:#f4ff81;--primary-fg:#0c1113;--ring:#f4ff8166;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(16,36,36,.8);--gradient:linear-gradient(135deg,#a8ff78 0%,#f4ff81 100%)}
    [data-theme=tinhquang]{--bg:#1a2a45;--card:#2c3a58;--text:#f0f8ff;--muted:#a0aec0;--primary:#63b3ed;--primary-fg:#102035;--ring:#63b3ed66;--border:#4a5568;--nav-bg:rgba(44,58,88,.75);--gradient:linear-gradient(135deg,#63b3ed 0%,#90cdf4 100%)}
    [data-theme=senvang]{--bg:#f6f3ea;--card:#ffffff;--text:#1a202c;--muted:#6b7280;--primary:#d4a017;--primary-fg:#161616;--ring:#d4a01755;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.85);--gradient:linear-gradient(135deg,#fff7d6 0%,#ffd66e 100%)}
    [data-theme=binhminh]{--bg:#0f0b07;--card:#1a1410;--text:#fff5eb;--muted:#e7c5a1;--primary:#ff9d4d;--primary-fg:#2a1505;--ring:#ff9d4d66;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(26,20,16,.8);--gradient:linear-gradient(135deg,#ffcf6b 0%,#ff7a45 100%)}
    [data-theme=hukhong]{--bg:#f7fafc;--card:rgba(255,255,255,.75);--text:#1a202c;--muted:#718096;--primary:#4299e1;--primary-fg:#fff;--ring:#4299e166;--border:#e2e8f0;--nav-bg:rgba(255,255,255,.7)}
    [data-theme=kimcuong]{--bg:#f8fafc;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#06b6d4;--primary-fg:#ffffff;--ring:#06b6d455;--border:#e2e8f0;--nav-bg:rgba(255,255,255,.9);--gradient:linear-gradient(135deg,#a5f3fc 0%,#67e8f9 100%)}
    [data-theme=haoguang]{--bg:#0b1020;--card:#121a2b;--text:#e2e8f0;--muted:#94a3b8;--primary:#60a5fa;--primary-fg:#0b1020;--ring:#60a5fa66;--border:#1f2937;--nav-bg:rgba(18,26,43,.75);--gradient:linear-gradient(135deg,#60a5fa 0%,#a78bfa 100%)}
    [data-theme=thienanh]{--bg:#0b132b;--card:#1c2541;--text:#f8fafc;--muted:#a1a8c3;--primary:#f59e0b;--primary-fg:#0b132b;--ring:#f59e0b55;--border:#243b55;--nav-bg:rgba(28,37,65,.8);--gradient:linear-gradient(135deg,#fbbf24 0%,#ef4444 100%)}
    [data-theme=sakura]{--bg:#fff1f2;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--primary:#fb7185;--primary-fg:#ffffff;--ring:#fb718555;--border:#ffe4e6;--nav-bg:rgba(255,255,255,.85);--gradient:linear-gradient(135deg,#fecdd3 0%,#fda4af 100%)}
    .theme-swatch{display:flex;flex-direction:column;align-items:center;gap:.5rem;padding:.6rem;border-radius:12px;background:var(--card);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer}
    .theme-swatch .dot{width:38px;height:38px;border-radius:9999px;background:linear-gradient(135deg,var(--c1),var(--c2))}
    .theme-swatch[aria-current=true]{outline:3px solid var(--ring);outline-offset:2px;transform:scale(1.04)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--card);color:var(--text);padding:.6rem .8rem;border-radius:12px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--primary);color:var(--primary-fg);border-color:transparent}
    .input,.select,.textarea{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:.6rem .8rem}
    .textarea{min-height:140px}
    .error-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;text-align:left}
    .error-card{background:#111827;border:1px solid #374151;border-radius:14px;max-width:900px;width:100%;padding:18px}
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)]">
  <div id="root"></div>

  <!-- Audio chính (persistent) + Preload audio kế -->
  <audio id="mstq-player" preload="metadata" playsinline webkit-playsinline crossOrigin="anonymous"></audio>
  <audio id="mstq-preload" preload="auto" playsinline webkit-playsinline muted></audio>

  <!-- Error overlay -->
  <div id="err" class="error-overlay">
    <div class="error-card">
      <h3 class="text-lg font-bold">Đã bắt lỗi runtime</h3>
      <button onclick="document.getElementById('err').style.display='none'" class="btn">Đóng</button>
      <pre id="errlog" class="mt-3 whitespace-pre-wrap text-sm"></pre>
    </div>
  </div>

  <script>
    (function(){
      const show=(m)=>{const el=document.getElementById('err');const log=document.getElementById('errlog');if(log)log.textContent=String(m);if(el)el.style.display='flex';console.error('[GLOBAL ERROR]',m)};
      window.addEventListener('error',e=>show(e.error||e.message||e));
      window.addEventListener('unhandledrejection',e=>show(e.reason||e));
    })();
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useRef,useMemo,useCallback} = React;

    /* ===== Keys & helpers ===== */
    const SONGS_CACHE_KEY='mstq_songs_v2', FAVORITES_CACHE_KEY='mstq_favorites_v1';
    const THEME_KEY='music-theme', POWER_KEY='power-save';
    const SHUFFLE_KEY='mstq_shuffle', REPEAT_KEY='mstq_repeat', SPEED_KEY='mstq_speed', MUTED_KEY='mstq_muted';
    const RESUME_KEY='mstq_resume_v3';
    const INITIAL_VISIBLE=100, VISIBLE_STEP=100;

    const FALLBACK_SONGS=[{id:"testmp3testfile/mpthreetest.mp3",title:"Bài hát mẫu (Tạm thời)",artist:"Public Domain",stream_url:"https://archive.org/download/testmp3testfile/mpthreetest.mp3",artwork:"https://placehold.co/512x512/102424/e0f2f1?text=MSTQ",duration:5,lyrics:"Bài mẫu.",item_identifier:"testmp3testfile"}];

    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
    const formatTime=s=>{if(!isFinite(s)||s<0)return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${String(sec).padStart(2,'0')}`};
    const haptic=()=>{try{navigator.vibrate?.(12)}catch{}};

    /* ===== Icons (rút gọn) ===== */
    const Play=({size=22})=><svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>;
    const Pause=({size=22})=><svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>;
    const Back=({size=22})=><svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><path d="M11 19 2 12l9-7v14zm1-7 9 7V5l-9 7z"/></svg>;
    const Next=({size=22})=><svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><path d="m13 5 9 7-9 7V5zM2 19V5h2v14H2z"/></svg>;

    /* ===== Toast ===== */
    function useToast(){
      const [toast,setToast]=useState(null);
      const ref=useRef(null);
      const notify=useCallback((m,ms=1400)=>{setToast(m);clearTimeout(ref.current);ref.current=setTimeout(()=>setToast(null),ms);},[]);
      useEffect(()=>()=>clearTimeout(ref.current),[]);
      return {notify,toastNode:<div className={`fixed bottom-24 left-1/2 -translate-x-1/2 z-50 transition-all ${toast?'opacity-100':'opacity-0 pointer-events-none'}`}><div className="px-3 py-2 rounded-xl text-sm border border-[var(--border)] bg-[var(--card)]/95 shadow-xl">{toast}</div></div>};
    }

    /* ===== UI nhỏ gọn (playlist/miniplayer) – giống bản trước, lược bớt để tập trung playback ===== */
    const TopBar=()=>(
      <header className="fixed top-0 inset-x-0 z-30 px-4 py-3 flex items-center justify-between bg-[var(--nav-bg)] backdrop-blur-lg border-b border-[var(--border)]">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 rounded-lg" style={{background:'var(--gradient)'}}/>
          <h1 className="font-bold">MSTQ Music</h1>
        </div>
      </header>
    );

    const PlaylistView=({songs,currentId,onPick,visibleCount,onLoadMore,isLoading})=>{
      const shown=useMemo(()=>songs.slice(0,visibleCount),[songs,visibleCount]);
      return (
        <div className="px-4">
          <div className="flex items-center justify-between"><h2 className="text-xl font-bold my-3">Danh sách phát</h2><div className="text-xs text-[var(--muted)]">{songs.length} bài</div></div>
          {isLoading? <div className="animate-pulse space-y-3">{Array.from({length:6}).map((_,i)=>(<div key={i} className="h-14 rounded-xl bg-[var(--card)]/40"></div>))}</div>:
          <>
            <div className="space-y-2">
              {shown.map((s,idx)=>(
                <div key={s.id} className={`flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)] ${currentId===s.id?'ring-2 ring-[var(--ring)] bg-[var(--card)]/50':''}`}>
                  <div className="w-8 text-center text-sm text-[var(--muted)]">{idx+1}</div>
                  <button onClick={()=>onPick(s)} className="flex-grow text-left">
                    <div className="font-semibold truncate">{s.title||'Untitled'}</div>
                    <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                  </button>
                  <div className="text-sm text-[var(--muted)]">{formatTime(s.duration||0)}</div>
                </div>
              ))}
            </div>
            {songs.length>visibleCount && <button onClick={onLoadMore} className="w-full mt-3 btn">Tải thêm</button>}
          </>}
        </div>
      );
    };

    /* ======================= MAIN APP ======================= */
    function App(){
      const {notify,toastNode}=useToast();

      // theme & simple states
      const [theme,setTheme]=useState(localStorage.getItem(THEME_KEY)||'lucbao');
      useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);localStorage.setItem(THEME_KEY,theme);},[theme]);

      const [songs,setSongs]=useState([]);
      const [playlist,setPlaylist]=useState([]);
      const [loading,setLoading]=useState(true);
      const [visible,setVisible]=useState(INITIAL_VISIBLE);

      const [currentIndex,setCurrentIndex]=useState(0);
      const [playing,setPlaying]=useState(false);
      const [progress,setProgress]=useState({current:0,duration:0});

      // persistent audio elements
      const audioRef=useRef(null);
      const preloadRef=useRef(null);
      useEffect(()=>{ audioRef.current=document.getElementById('mstq-player'); preloadRef.current=document.getElementById('mstq-preload'); },[]);
      // user gesture marker
      const interactedRef=useRef(false);
      useEffect(()=>{ const m=()=>{interactedRef.current=true;document.removeEventListener('click',m);document.removeEventListener('keydown',m)};document.addEventListener('click',m);document.addEventListener('keydown',m);return()=>{document.removeEventListener('click',m);document.removeEventListener('keydown',m)};},[]);

      // persisted playback prefs
      const [volume,setVolume]=useState(load(RESUME_KEY,{volume:.9}).volume??.9);
      const [playbackRate,setPlaybackRate]=useState(parseFloat(localStorage.getItem(SPEED_KEY)||'1')||1);
      const [muted,setMuted]=useState(localStorage.getItem(MUTED_KEY)==='1');
      useEffect(()=>{const a=audioRef.current;if(a){a.volume=volume}},[volume]);
      useEffect(()=>{const a=audioRef.current;if(a){a.playbackRate=playbackRate}localStorage.setItem(SPEED_KEY,String(playbackRate))},[playbackRate]);
      useEffect(()=>{const a=audioRef.current;if(a){a.muted=muted}localStorage.setItem(MUTED_KEY,muted?'1':'0')},[muted]);

      // ===== Fetch playlist (Archive.org) =====
      const refetch=useCallback(async()=>{
        const cached=load(SONGS_CACHE_KEY,null);
        if(cached?.length){setSongs(cached);setPlaylist(cached);setLoading(false)}
        try{
          const queries=[
            'uploader:(tinhquang) AND mediatype:(audio)',
            'uploader:(thiensutinhquang) AND mediatype:(audio)',
            'creator:("Minh Su Tinh Quang") AND mediatype:(audio)'
          ];
          let docs=[];let ok=false;
          for(const q of queries){
            const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=publicdate+desc&rows=200&page=1&output=json`;
            const r=await fetch(url,{cache:'no-store'}); if(!r.ok) continue;
            const j=await r.json(); const list=j?.response?.docs||[]; if(list.length){docs=list;ok=true;break;}
          }
          if(!ok){ if(!cached?.length){setSongs(FALLBACK_SONGS);setPlaylist(FALLBACK_SONGS);} setLoading(false); return; }
          const all=[];
          for(const d of docs){
            try{
              const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
              (meta.files||[]).forEach(f=>{
                if(String(f.format||'').toUpperCase().includes('MP3')){
                  all.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'TinhQuang',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                }
              });
            }catch{}
          }
          if(all.length){ save(SONGS_CACHE_KEY,all); setSongs(all); setPlaylist(all); }
        }catch{ if(!cached?.length){setSongs(FALLBACK_SONGS);setPlaylist(FALLBACK_SONGS);} }
        setLoading(false);
      },[]);
      useEffect(()=>{refetch()},[]);

      const current=playlist[currentIndex]||null;

      // ===== Preload next track for smooth continuous =====
      const queuePreload=useCallback((idx)=>{
        const n=(idx+1)%playlist.length;
        const next=playlist[n]; const pre=preloadRef.current;
        if(next&&pre){ if(pre.src!==next.stream_url){ pre.src=next.stream_url; pre.load(); } }
      },[playlist]);
      useEffect(()=>{ if(playlist.length) queuePreload(currentIndex); },[playlist.length,currentIndex,queuePreload]);

      // ===== Recovery Engine / Anti-Stall =====
      const targetPlayingRef=useRef(false);          // ý định phát của app
      const lastProgRef=useRef({t:0,pos:0});        // lần cuối tiến độ thay đổi
      const stallScoreRef=useRef(0);                // điểm kẹt liên tiếp
      const lastManualPauseRef=useRef(0);           // để phân biệt người dùng pause

      // silent WebAudio keep-alive (start khi có tương tác)
      const audioCtxRef=useRef(null);
      const startKeepAlive=useCallback(()=>{
        try{
          if(audioCtxRef.current) return;
          const ctx=new (window.AudioContext||window.webkitAudioContext)();
          const o=ctx.createOscillator(); const g=ctx.createGain();
          g.gain.value=0; o.connect(g).connect(ctx.destination); o.start();
          audioCtxRef.current={ctx,o,g};
        }catch{}
      },[]);

      // wake lock + visibility resume
      useEffect(()=>{
        let lock=null;
        const reqLock=async()=>{try{if('wakeLock'in navigator){lock=await navigator.wakeLock.request('screen');}}catch{}};
        const vis=()=>{ if(document.visibilityState==='visible'){ reqLock(); if(targetPlayingRef.current){ audioRef.current?.play?.().catch(()=>{}); } } };
        reqLock(); document.addEventListener('visibilitychange',vis);
        return()=>{document.removeEventListener('visibilitychange',vis);try{lock?.release?.()}catch{}};
      },[]);

      // audio events
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const onTime=()=>{ if(!isFinite(a.duration)) return; setProgress({current:a.currentTime||0,duration:a.duration||0});
          const now=Date.now();
          if(Math.abs(a.currentTime-(lastProgRef.current.pos||0))>0.25){ lastProgRef.current={t:now,pos:a.currentTime}; stallScoreRef.current=0; }
        };
        const onEnded=()=>{ nextTrack(); };
        const onStallLike=()=>{ /* sẽ do watchdog xử lý */ };
        const onPause=()=>{ /* nếu người dùng pause => ghi dấu */ if(!targetPlayingRef.current){ lastManualPauseRef.current=Date.now(); } };
        a.addEventListener('timeupdate',onTime);
        a.addEventListener('ended',onEnded);
        ['stalled','suspend','waiting','error','abort'].forEach(e=>a.addEventListener(e,onStallLike));
        a.addEventListener('pause',onPause);
        return()=>{a.removeEventListener('timeupdate',onTime);a.removeEventListener('ended',onEnded);['stalled','suspend','waiting','error','abort'].forEach(e=>a.removeEventListener(e,onStallLike));a.removeEventListener('pause',onPause);};
      },[]);

      // watchdog: 5s check 1 lần
      useEffect(()=>{
        const tick=setInterval(async()=>{
          const a=audioRef.current; if(!a||!current) return;
          // lưu resume state
          save(RESUME_KEY,{index:currentIndex,id:current.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});

          if(!targetPlayingRef.current) return; // không có ý định phát → không ép
          // nếu vừa pause thủ công trong 1.5s → bỏ qua
          if(Date.now()-lastManualPauseRef.current<1500) return;

          // nếu paused → cố play
          if(a.paused){
            try{ await a.play(); return; }catch{}
          }
          // nếu không tiến bộ >20s hoặc readyState thấp → recover
          const stagnate = (Date.now()-(lastProgRef.current.t||0)>20000);
          const poorReady = a.readyState<2;
          if(stagnate || poorReady){
            stallScoreRef.current++;
            try{
              await a.play(); // thử nhẹ
              if(a.paused || poorReady){ a.load(); await a.play().catch(()=>{}); }
              // nếu kẹt nhiều lần → nhảy bài
              if(stallScoreRef.current>=3){ stallScoreRef.current=0; nextTrack(); }
            }catch{ if(stallScoreRef.current>=3){ stallScoreRef.current=0; nextTrack(); } }
          }
        },5000);
        return()=>clearInterval(tick);
      },[currentIndex,current]);

      // ===== Controls =====
      const nextTrack=useCallback(()=>{
        if(!playlist.length) return;
        const i=(currentIndex+1)%playlist.length;
        setCurrentIndex(i);
        setPlaying(true);
        targetPlayingRef.current=true;
        queuePreload(i);
        notify('▶ Bài tiếp');
      },[playlist,currentIndex,queuePreload,notify]);

      const prevTrack=useCallback(()=>{
        if(!playlist.length) return;
        const a=audioRef.current; if(a?.currentTime>3){ a.currentTime=0; return; }
        const i=(currentIndex-1+playlist.length)%playlist.length;
        setCurrentIndex(i);
        setPlaying(true);
        targetPlayingRef.current=true;
        queuePreload(i);
        notify('◀ Bài trước');
      },[playlist,currentIndex,queuePreload,notify]);

      const pickSong=(s)=>{
        const i=playlist.findIndex(x=>x.id===s.id);
        if(i>=0){ setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i); notify(`▶ ${s.title}`); startKeepAlive(); }
      };

      const playPause=()=>{
        const a=audioRef.current; if(!a) return;
        startKeepAlive(); // kích hoạt keep-alive sau thao tác
        if(!current && playlist.length){ setCurrentIndex(0); setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); return; }
        if(playing){ setPlaying(false); targetPlayingRef.current=false; a.pause(); }
        else{ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
      };

      // Load & play khi current/playing đổi
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        if(current){
          if(a.src!==current.stream_url){ a.src=current.stream_url; a.load(); }
          a.playbackRate=playbackRate; a.muted=muted; a.volume=volume;
          document.title=`${playing?'▶':'⏸'} ${current.title} – MSTQ`;
          if(playing && interactedRef.current){ a.play().catch(()=>{}); }
          // MediaSession
          try{
            if('mediaSession'in navigator){
              navigator.mediaSession.metadata=new MediaMetadata({title:current.title,artist:current.artist||'minhsutinhquang',album:'MSTQ Music',artwork:[{src:current.artwork||'https://placehold.co/512',sizes:'512x512',type:'image/jpeg'}]});
              navigator.mediaSession.setActionHandler('play',()=>{ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); });
              navigator.mediaSession.setActionHandler('pause',()=>{ setPlaying(false); targetPlayingRef.current=false; a.pause(); });
              navigator.mediaSession.setActionHandler('previoustrack',prevTrack);
              navigator.mediaSession.setActionHandler('nexttrack',nextTrack);
              navigator.mediaSession.setActionHandler('seekbackward',d=>{ a.currentTime=Math.max(0,(a.currentTime||0)-(d.seekOffset||10)); });
              navigator.mediaSession.setActionHandler('seekforward',d=>{ a.currentTime=Math.min(a.duration||0,(a.currentTime||0)+(d.seekOffset||10)); });
              navigator.mediaSession.setActionHandler('seekto',d=>{ if(d.seekTime!=null) a.currentTime=d.seekTime; });
              navigator.mediaSession.playbackState=playing?'playing':'paused';
              navigator.mediaSession.setPositionState?.({duration:a.duration||0,position:a.currentTime||0,playbackRate:a.playbackRate||1});
            }
          }catch{}
        }else{ document.title='MSTQ Music'; }
      },[currentIndex,playing,playbackRate,muted,volume,current,prevTrack,nextTrack]);

      // resume sau reload
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const r=load(RESUME_KEY,null);
        if(r&&playlist.length){
          const idx=Math.min(Math.max(0,r.index||0),playlist.length-1);
          setCurrentIndex(idx);
          setTimeout(()=>{ const s=playlist[idx]; if(!s) return;
            if(a.src!==s.stream_url){ a.src=s.stream_url; a.load(); }
            a.currentTime=Number(r.currentTime||0); a.volume=r.volume??volume; a.playbackRate=r.rate??playbackRate; a.muted=!!r.muted;
            if(r.playing){ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
          },0);
        }
      // eslint-disable-next-line react-hooks/exhaustive-deps
      },[playlist.length]);

      // Basic UI
      const padBottom=current?'160px':'80px';

      return (
        <div className="min-h-screen pb-40">
          {toastNode}
          <TopBar />
          <main className="pt-16" style={{paddingBottom:padBottom}}>
            <div className="px-4 flex items-center gap-2 my-2">
              <button className="btn" onClick={()=>setTheme(t=>t==='lucbao'?'light':'lucbao')}>Chủ đề</button>
              <button className="btn" onClick={()=>{refetch();visible<INITIAL_VISIBLE&&setVisible(INITIAL_VISIBLE)}}>Làm mới</button>
              <button className="btn" onClick={playPause}>{playing?'Tạm dừng':'Phát'}</button>
            </div>
            <PlaylistView songs={playlist} currentId={current?.id} onPick={pickSong} visibleCount={visible} onLoadMore={()=>setVisible(v=>Math.min(playlist.length,v+VISIBLE_STEP))} isLoading={loading}/>
          </main>

          {/* Mini player */}
          {current && (
            <div className="fixed bottom-2 left-2 right-2 rounded-2xl bg-[var(--card)]/95 border border-[var(--border)] backdrop-blur-md p-2 z-40 shadow-[var(--shadow)]">
              <div className="flex items-center gap-3">
                <div className="flex-grow min-w-0">
                  <p className="truncate font-semibold">{current.title}</p>
                  <p className="text-xs text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</p>
                </div>
                <button className="w-10 h-10" onClick={prevTrack}><Back/></button>
                <button className="w-10 h-10" onClick={playPause}>{playing?<Pause/>:<Play/>}</button>
                <button className="w-10 h-10" onClick={nextTrack}><Next/></button>
              </div>
              <div className="mt-2 h-1 bg-[var(--muted)]/20 rounded">
                <div className="h-1 bg-[var(--primary)] rounded" style={{width:`${progress.duration>0?(progress.current/progress.duration)*100:0}%`}}></div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
