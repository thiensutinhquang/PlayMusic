<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#f59e0b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Play Nh·∫°c MSTQ ‚Äì Pro 2.0</title>

  <style>
    :root{
      --primary:#f59e0b;--primary-2:#d97706;
      --bg:#f8fafc;--card:#ffffff;--text:#0f172a;--muted:#64748b;--border:#e5e7eb;
      --bg-dark:#0b1220;--card-dark:#131a2a;--text-dark:#e5edf7;--muted-dark:#b8c2cf;--border-dark:#273246;
      --radius:14px;
    }
    @media (prefers-color-scheme: dark){
      body{background:var(--bg-dark);color:var(--text-dark)}
      .card{background:var(--card-dark);border-color:var(--border-dark)}
      .subtle{color:var(--muted-dark)}
      #player{background:rgba(11,18,32,.92);border-color:var(--border-dark)}
      .row{border-color:var(--border-dark)}
      #search{background:#0e172a;border-color:var(--border-dark);color:var(--text-dark)}
      .row:hover{background:#111a2a}
      .active{background:#1a2335}
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:var(--text)
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 12px 120px}
    header{padding:16px;border-bottom:1px solid var(--border);text-align:center}
    h1{margin:0;font-size:28px;color:var(--primary);letter-spacing:.5px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
      padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-top:16px
    }
    .row{
      display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid var(--border);
      cursor:pointer;user-select:none;border-radius:10px
    }
    .row:last-child{border-bottom:none}
    .row:hover{background:#f6f7fb}
    .idx{width:28px;text-align:right;font-variant-numeric:tabular-nums;color:var(--muted)}
    .cover{width:44px;height:44px;border-radius:10px;background:#e2e8f0;flex:0 0 44px;overflow:hidden}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{flex:1 1 auto;min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dur{font-variant-numeric:tabular-nums;color:var(--muted);min-width:48px;text-align:right}
    .subtle{color:var(--muted)}
    #search{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;margin:8px 0 4px;font-size:15px
    }

    /* Player bar */
    #player{
      position:fixed;left:0;right:0;bottom:0;z-index:9999;
      background:rgba(255,255,255,.94);backdrop-filter:blur(8px);
      border-top:1px solid var(--border);padding:10px 12px
    }
    .pgrid{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
    .pinfo{display:flex;align-items:center;gap:10px;min-width:0}
    .pcover{width:48px;height:48px;border-radius:12px;overflow:hidden;background:#e2e8f0}
    .pcover img{width:100%;height:100%;object-fit:cover}
    .ptext{min-width:0}
    .ptext .ptitle{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ptext .partist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pctrl{display:flex;align-items:center;gap:10px}
    .btn{
      -webkit-tap-highlight-color:transparent;appearance:none;border:none;background:transparent;
      color:inherit;font-size:20px;cursor:pointer;border-radius:12px;line-height:0;padding:8px
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{
      background:var(--primary);color:#fff;border-radius:50%;width:48px;height:48px;display:grid;place-items:center;
      box-shadow:0 6px 14px rgba(245,158,11,.35)
    }
    .btn.tiny{font-size:16px;padding:6px}
    .badge{font-size:10px;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;margin-left:4px}
    @media (prefers-color-scheme: dark){.badge{background:#1e293b;color:#e5edf7}}
    .progress{
      grid-column:1 / -1;display:flex;align-items:center;gap:8px;margin-top:6px
    }
    .bar{position:relative;height:8px;border-radius:999px;background:#e5e7eb;flex:1;cursor:pointer;touch-action:none}
    .fill{position:absolute;left:0;top:0;height:100%;width:0;border-radius:999px;background:var(--primary)}
    .knob{position:absolute;top:50%;transform:translate(-50%,-50%);width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid var(--primary)}
    .time{font-variant-numeric:tabular-nums;font-size:12px;color:var(--muted)}
    .active{background:#fff6e5}

    /* Toast */
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:86px;z-index:10000;
      background:rgba(15,23,42,.92);color:#fff;padding:10px 14px;border-radius:12px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s
    }
    .toast.show{opacity:1;transform:translate(-50%,-6px)}
    .net{position:fixed;right:10px;bottom:86px;background:#0f172a;color:#fff;border:1px solid #334155;border-radius:12px;padding:8px 10px;font-size:12px;opacity:.9}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    @media (prefers-color-scheme: dark){.pill{background:#0f172a;border-color:#22314a}}
  </style>
</head>
<body>
  <header>
    <h1>PLAY NH·∫†C MSTQ ‚Äì Pro 2.0</h1>
    <div class="subtle" id="subtitle">Nhanh ‚Ä¢ G·ªçn nh·∫π ‚Ä¢ Ch·∫°y n·ªÅn b·ªÅn b·ªâ (t·∫Øt m√†n h√¨nh v·∫´n nghe)</div>
  </header>

  <main class="wrap">
    <div class="card" id="lib">
      <div class="pill">
        <span>üîé</span>
        <input id="search" type="search" placeholder="T√¨m b√†i h√°t / ngh·ªá sƒ©..." autocomplete="off" />
        <span id="count" class="badge">0 b√†i</span>
      </div>
      <div id="list" style="margin-top:8px"></div>
      <div id="loading" class="subtle" style="padding:14px 8px">ƒêang t·∫£i th∆∞ vi·ªán nh·∫°c‚Ä¶</div>
    </div>
  </main>

  <!-- Player -->
  <section id="player">
    <div class="pgrid">
      <div class="pinfo" aria-live="polite">
        <div class="pcover" aria-hidden="true"><img id="pcover" alt="" /></div>
        <div class="ptext">
          <div class="ptitle" id="ptitle">Ch∆∞a ch·ªçn b√†i</div>
          <div class="partist" id="partist">‚Äî</div>
        </div>
      </div>

      <div class="pctrl" role="group" aria-label="ƒêi·ªÅu khi·ªÉn ph√°t nh·∫°c">
        <button class="btn tiny" id="btn-shuffle" title="Tr·ªôn b√†i (Shuffle)" aria-pressed="false">üîÄ</button>
        <button class="btn" id="btn-prev" title="B√†i tr∆∞·ªõc" aria-label="B√†i tr∆∞·ªõc">‚èÆ</button>
        <button class="btn primary" id="btn-play" title="Ph√°t / T·∫°m d·ª´ng" aria-label="Ph√°t ho·∫∑c t·∫°m d·ª´ng">‚ñ∂</button>
        <button class="btn" id="btn-next" title="B√†i k·∫ø ti·∫øp" aria-label="B√†i k·∫ø ti·∫øp">‚è≠</button>
        <button class="btn tiny" id="btn-repeat" title="L·∫∑p l·∫°i" aria-pressed="false">üîÅ</button>
      </div>

      <div class="progress">
        <span id="cur" class="time">0:00</span>
        <div id="bar" class="bar" aria-label="Thanh ti·∫øn ƒë·ªô" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div id="fill" class="fill"></div>
          <div id="knob" class="knob" aria-hidden="true" style="left:0%"></div>
        </div>
        <span id="dur" class="time">0:00</span>
      </div>
    </div>
  </section>

  <!-- Hidden audio element (native, ti·∫øt ki·ªám pin) -->
  <audio id="audio" preload="metadata" crossorigin="anonymous" playsinline></audio>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="net" class="net" style="display:none">üîå Offline</div>

  <script>
  (()=>{ "use strict";

    const CONFIG = {
      APP_NAME: "MSTQ-PLAYER",
      APP_VERSION: "2.0",
      USER_HANDLE: "minhsutinhquang",
      PAGE_SIZE: 100,
      SAVE_INTERVAL_MS: 1200,
      SEEK_STEP: 10, // gi√¢y
      MEDIA_SESSION: true
    };

    /** ---------- DOM ---------- */
    const $ = id=>document.getElementById(id);
    const dom = {
      list: $("list"), loading: $("loading"), search: $("search"), count: $("count"),
      audio: $("audio"),
      ptitle: $("ptitle"), partist: $("partist"), pcover: $("pcover"),
      cur: $("cur"), dur: $("dur"),
      bar: $("bar"), fill: $("fill"), knob: $("knob"),
      btnPlay: $("btn-play"), btnNext: $("btn-next"), btnPrev: $("btn-prev"),
      btnShuffle: $("btn-shuffle"), btnRepeat: $("btn-repeat"),
      toast: $("toast"), net: $("net"), subtitle: $("subtitle")
    };

    /** ---------- STATE ---------- */
    const state = {
      hosts: [], hostIndex: 0,
      tracks: [], view: [], // view = list sau khi search
      index: -1,
      playing: false,
      shuffle: JSON.parse(localStorage.getItem("mstq.shuffle")||"false"),
      repeat: localStorage.getItem("mstq.repeat")||"off", // off | one | all
      lastSave: 0,
      dragging: false,
      resumedFromStorage: false
    };

    /** ---------- UTIL ---------- */
    const vibrate = (ms=12)=>{ if(navigator.vibrate) navigator.vibrate(ms); };
    const fmt = s=>{ s = Math.max(0, Math.floor(s||0)); const m = Math.floor(s/60), r = s%60; return `${m}:${r<10?"0":""}${r}`; };
    const now = ()=>performance.now();
    const appTag = `${CONFIG.APP_NAME}-${CONFIG.APP_VERSION}`;

    const showToast = (msg, t=1700)=>{
      dom.toast.textContent = msg;
      dom.toast.classList.add("show");
      setTimeout(()=>dom.toast.classList.remove("show"), t);
    };

    const saveSession = ()=>{
      try{
        const payload = {
          index: state.index,
          time: dom.audio.currentTime||0,
          shuffle: state.shuffle,
          repeat: state.repeat,
          ts: Date.now()
        };
        localStorage.setItem("mstq.session", JSON.stringify(payload));
        localStorage.setItem("mstq.shuffle", JSON.stringify(state.shuffle));
        localStorage.setItem("mstq.repeat", state.repeat);
      }catch{}
    };

    const restoreSession = ()=>{
      try{
        const s = JSON.parse(localStorage.getItem("mstq.session")||"null");
        if(!s) return;
        state.index = typeof s.index==="number" ? s.index : -1;
        state.shuffle = !!s.shuffle;
        state.repeat = s.repeat||"off";
        state.resumedFromStorage = true;
        // set UI flags
        dom.btnShuffle.setAttribute("aria-pressed", String(state.shuffle));
        dom.btnRepeat.setAttribute("aria-pressed", state.repeat!=="off");
        dom.btnRepeat.textContent = state.repeat==="one" ? "üîÇ" : "üîÅ";
        return s;
      }catch{}
    };

    /** ---------- NETWORK ---------- */
    const fetchJSON = async (url, {timeout=8000}={})=>{
      const c = new AbortController();
      const id = setTimeout(()=>c.abort(), timeout);
      try{
        const r = await fetch(url, {signal:c.signal});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      } finally { clearTimeout(id); }
    };

    const getHosts = async ()=>{
      // L·∫•y discovery hosts ch√≠nh th·ª©c t·ª´ Audius
      // https://api.audius.co -> { data: [hosts...] }
      const data = await fetchJSON("https://api.audius.co");
      const arr = (data && data.data)||[];
      state.hosts = arr.filter(Boolean);
      state.hostIndex = Math.floor(Math.random()*Math.max(1, state.hosts.length));
      return state.hosts.length>0;
    };

    const host = ()=>state.hosts[state.hostIndex]||"";
    const rotateHost = ()=>{
      state.hostIndex = (state.hostIndex+1) % Math.max(1, state.hosts.length);
      console.warn("[Host] rotate ->", host());
    };

    /** ---------- AUDIUS API ---------- */
    const userIdByHandle = async (handle)=>{
      const url = `${host()}/v1/users/handle/${encodeURIComponent(handle)}?app_name=${appTag}`;
      const j = await fetchJSON(url);
      return j && j.data && j.data.id;
    };

    const tracksByUser = async (uid, limit=CONFIG.PAGE_SIZE)=>{
      const url = `${host()}/v1/users/${uid}/tracks?limit=${limit}&app_name=${appTag}`;
      const j = await fetchJSON(url);
      return (j && j.data) || [];
    };

    const streamURL = (trackId)=> `${host()}/v1/tracks/${trackId}/stream?app_name=${appTag}`;

    /** ---------- RENDER LIST ---------- */
    const artworkFrom = (t)=>{
      // Audius artwork: t.artwork && t.artwork['100x100'|'480x480'|'1000x1000']
      const a = t.artwork||{};
      return a["100x100"]||a["480x480"]||a["1000x1000"]|| (t.user && t.user.profile_picture && (t.user.profile_picture["100x100"]||t.user.profile_picture["480x480"])) || "";
    };

    const renderList = ()=>{
      dom.list.innerHTML="";
      state.view.forEach((t, i)=>{
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.index = String(i);
        if(i===state.index) row.classList.add("active");
        row.innerHTML = `
          <div class="idx">${i+1}</div>
          <div class="cover">${artworkFrom(t)?`<img alt="" src="${artworkFrom(t)}">`:``}</div>
          <div class="meta">
            <div class="title">${t.title||"Untitled"}</div>
            <div class="artist">${(t.user && t.user.name)||"Unknown"}</div>
          </div>
          <div class="dur">${fmt(t.duration||0)}</div>
        `;
        row.addEventListener("click", (e)=>{
          e.preventDefault(); playIndex(i, true);
        }, {passive:true});
        dom.list.appendChild(row);
      });
      dom.count.textContent = `${state.view.length} b√†i`;
    };

    /** ---------- SEARCH FILTER ---------- */
    dom.search.addEventListener("input", ()=>{
      const q = dom.search.value.trim().toLowerCase();
      if(!q){ state.view = state.tracks.slice(); renderList(); return; }
      state.view = state.tracks.filter(t=>{
        const title = (t.title||"").toLowerCase();
        const artist = ((t.user && t.user.name)||"").toLowerCase();
        return title.includes(q) || artist.includes(q);
      });
      renderList();
    }, {passive:true});

    /** ---------- PLAYER ---------- */
    const setMeta = (t)=>{
      dom.ptitle.textContent = t.title||"";
      dom.partist.textContent = (t.user && t.user.name) || "";
      const art = artworkFrom(t);
      dom.pcover.src = art || "";
      document.title = `‚ñ∂ ${t.title||"ƒêang ph√°t"} ‚Äì MSTQ`;
      if("mediaSession" in navigator && CONFIG.MEDIA_SESSION){
        try{
          navigator.mediaSession.metadata = new MediaMetadata({
            title: t.title||"",
            artist: (t.user && t.user.name)||"",
            album: "MSTQ",
            artwork: art ? [
              {src: art, sizes:"96x96", type:"image/jpeg"},
              {src: art, sizes:"256x256", type:"image/jpeg"},
              {src: art, sizes:"512x512", type:"image/jpeg"}
            ] : []
          });
        }catch {}
      }
    };

    const updateActiveRow = ()=>{
      const prev = dom.list.querySelector(".row.active");
      if(prev) prev.classList.remove("active");
      const cur = dom.list.querySelector(`.row[data-index="${state.index}"]`);
      if(cur) cur.classList.add("active");
    };

    const playStreamWithFallback = async (track, keepTime=false)=>{
      // th·ª≠ ph√°t, n·∫øu l·ªói -> chuy·ªÉn host kh√°c
      const startAt = keepTime ? dom.audio.currentTime||0 : 0;
      for(let i=0;i<Math.max(1,state.hosts.length);i++){
        try{
          dom.audio.src = streamURL(track.id);
          await dom.audio.play();
          if(startAt>0 && dom.audio.seekable && dom.audio.duration) dom.audio.currentTime = Math.min(startAt, dom.audio.duration-0.5);
          state.playing = true; setPlayIcon();
          return true;
        }catch(err){
          console.warn("[play error] host:", host(), err);
          rotateHost();
        }
      }
      return false;
    };

    const playIndex = async (i, userGesture=false)=>{
      if(i<0 || i>=state.view.length) return;
      state.index = i;
      const t = state.view[i];
      setMeta(t);
      updateActiveRow();
      if(userGesture) vibrate(16);
      const ok = await playStreamWithFallback(t, false);
      if(!ok){
        showToast("Kh√¥ng ph√°t ƒë∆∞·ª£c b√†i n√†y. ƒêang th·ª≠ m√°y ch·ªß kh√°c‚Ä¶");
      } else {
        if('mediaSession' in navigator && CONFIG.MEDIA_SESSION) wireMediaSession();
        saveSession();
      }
    };

    const setPlayIcon = ()=>{
      dom.btnPlay.textContent = state.playing ? "‚è∏" : "‚ñ∂";
    };

    const togglePlay = async ()=>{
      vibrate();
      if(state.index===-1){
        // n·∫øu ch∆∞a ch·ªçn b√†i -> ph√°t b√†i ƒë·∫ßu
        if(state.view.length>0) return playIndex(0,true);
        return;
      }
      try{
        if(state.playing){ await dom.audio.pause(); state.playing=false; }
        else { await dom.audio.play(); state.playing=true; }
        setPlayIcon();
      }catch(e){
        // Autoplay policy
        showToast("Nh·∫•n ‚ñ∂ ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√°t");
      }
    };

    const nextIndex = ()=>{
      if(state.shuffle){
        // ch·ªçn ng·∫´u nhi√™n kh√°c b√†i hi·ªán t·∫°i
        if(state.view.length<=1) return state.index;
        let j = Math.floor(Math.random()*state.view.length);
        if(j===state.index) j = (j+1)%state.view.length;
        return j;
      }
      let j = state.index+1;
      if(j>=state.view.length) j = 0;
      return j;
    };
    const prevIndex = ()=>{
      if(state.shuffle){
        if(state.view.length<=1) return state.index;
        let j = Math.floor(Math.random()*state.view.length);
        if(j===state.index) j = (j+state.view.length-1)%state.view.length;
        return j;
      }
      let j = state.index-1;
      if(j<0) j = state.view.length-1;
      return j;
    };

    const playNext = ()=> playIndex(nextIndex(), false);
    const playPrev = ()=> playIndex(prevIndex(), false);

    dom.btnPlay.addEventListener("click", togglePlay, {passive:true});
    dom.btnNext.addEventListener("click", ()=>{ vibrate(); playNext(); }, {passive:true});
    dom.btnPrev.addEventListener("click", ()=>{ vibrate(); playPrev(); }, {passive:true});

    dom.btnShuffle.addEventListener("click", ()=>{
      state.shuffle = !state.shuffle;
      dom.btnShuffle.setAttribute("aria-pressed", String(state.shuffle));
      showToast(state.shuffle ? "ƒê√£ b·∫≠t Tr·ªôn b√†i" : "ƒê√£ t·∫Øt Tr·ªôn b√†i");
      vibrate();
      saveSession();
    }, {passive:true});

    dom.btnRepeat.addEventListener("click", ()=>{
      state.repeat = state.repeat==="off" ? "all" : state.repeat==="all" ? "one" : "off";
      dom.btnRepeat.setAttribute("aria-pressed", state.repeat!=="off");
      dom.btnRepeat.textContent = state.repeat==="one" ? "üîÇ" : "üîÅ";
      showToast(state.repeat==="off" ? "T·∫Øt l·∫∑p l·∫°i" : (state.repeat==="one"?"L·∫∑p 1 b√†i":"L·∫∑p danh s√°ch"));
      vibrate();
      saveSession();
    }, {passive:true});

    /** ---------- PROGRESS / SEEK ---------- */
    const updateProgressUI = ()=>{
      if(!dom.audio.duration) return;
      const pct = (dom.audio.currentTime / dom.audio.duration) * 100;
      dom.fill.style.width = pct+"%";
      dom.knob.style.left = pct+"%";
      dom.cur.textContent = fmt(dom.audio.currentTime);
      dom.dur.textContent = fmt(dom.audio.duration);
      dom.bar.setAttribute("aria-valuenow", String(Math.round(pct)));
    };

    dom.audio.addEventListener("timeupdate", ()=>{
      // gi·∫£m t·∫£i khi n·ªÅn: rely on native event; kh√¥ng v·∫Ω th√™m
      const t = now();
      if(t - state.lastSave > CONFIG.SAVE_INTERVAL_MS){
        state.lastSave = t; saveSession();
      }
      if(!state.dragging) updateProgressUI();
    });

    dom.audio.addEventListener("loadedmetadata", ()=>{
      updateProgressUI();
      // resume position n·∫øu c√≥
      if(state.resumedFromStorage && resumePayload && typeof resumePayload.time==="number" && resumePayload.index===state.index){
        try{ dom.audio.currentTime = Math.min(resumePayload.time, (dom.audio.duration||0)-0.5); }catch{}
      }
    });

    dom.audio.addEventListener("ended", ()=>{
      if(state.repeat==="one"){ dom.audio.currentTime = 0; dom.audio.play(); return; }
      if(state.repeat==="off" && !state.shuffle && state.index===state.view.length-1){
        state.playing=false; setPlayIcon(); showToast("ƒê√£ ph√°t h·∫øt danh s√°ch"); return;
      }
      playNext();
    });

    dom.audio.addEventListener("error", ()=>{
      // th·ª≠ ƒë·ªïi host nhanh
      const t = state.view[state.index];
      if(!t) return;
      rotateHost();
      playStreamWithFallback(t, true);
    });

    // Drag seek
    const onSeek = (clientX)=>{
      const r = dom.bar.getBoundingClientRect();
      let x = Math.min(Math.max(clientX - r.left, 0), r.width);
      const pct = x / r.width;
      if(dom.audio.duration){
        dom.audio.currentTime = pct * dom.audio.duration;
        updateProgressUI();
      }
    };
    const startDrag = (e)=>{
      state.dragging = true; vibrate(6);
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      onSeek(clientX);
    };
    const moveDrag = (e)=>{
      if(!state.dragging) return;
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      onSeek(clientX);
    };
    const endDrag = ()=>{
      if(state.dragging){ state.dragging=false; saveSession(); }
    };
    dom.bar.addEventListener("pointerdown", startDrag);
    dom.bar.addEventListener("pointermove", moveDrag);
    window.addEventListener("pointerup", endDrag);
    dom.bar.addEventListener("touchstart", startDrag, {passive:true});
    dom.bar.addEventListener("touchmove", moveDrag, {passive:true});
    window.addEventListener("touchend", endDrag, {passive:true});

    /** ---------- MEDIA SESSION (n√∫t ƒëi·ªÅu khi·ªÉn tr√™n m√†n h√¨nh kho√°) ---------- */
    const wireMediaSession = ()=>{
      if(!("mediaSession" in navigator)) return;
      try{
        navigator.mediaSession.setActionHandler("play", async ()=>{ try{ await dom.audio.play(); state.playing=true; setPlayIcon(); }catch{} });
        navigator.mediaSession.setActionHandler("pause", async ()=>{ try{ await dom.audio.pause(); state.playing=false; setPlayIcon(); }catch{} });
        navigator.mediaSession.setActionHandler("seekbackward", details=>{
          dom.audio.currentTime = Math.max(0, dom.audio.currentTime - (details.seekOffset||CONFIG.SEEK_STEP));
        });
        navigator.mediaSession.setActionHandler("seekforward", details=>{
          dom.audio.currentTime = Math.min(dom.audio.duration||0, dom.audio.currentTime + (details.seekOffset||CONFIG.SEEK_STEP));
        });
        navigator.mediaSession.setActionHandler("seekto", details=>{
          if(details.fastSeek && "fastSeek" in dom.audio){ dom.audio.fastSeek(details.seekTime); }
          else dom.audio.currentTime = details.seekTime;
        });
        navigator.mediaSession.setActionHandler("previoustrack", ()=> playPrev());
        navigator.mediaSession.setActionHandler("nexttrack", ()=> playNext());
      }catch{}
    };

    /** ---------- POWER SAVING / N·ªÄN ---------- */
    document.addEventListener("visibilitychange", ()=>{
      // khi n·ªÅn: kh√¥ng l√†m g√¨ th√™m ƒë·ªÉ ti·∫øt ki·ªám pin; audio v·∫´n ch·∫°y
      // Khi quay l·∫°i: c·∫≠p nh·∫≠t UI 1 l·∫ßn
      if(!document.hidden) updateProgressUI();
    }, {passive:true});

    window.addEventListener("online", ()=>{ dom.net.style.display="none"; showToast("ƒê√£ k·∫øt n·ªëi m·∫°ng"); }, {passive:true});
    window.addEventListener("offline", ()=>{ dom.net.style.display="block"; }, {passive:true});

    window.addEventListener("pagehide", saveSession, {passive:true});
    window.addEventListener("beforeunload", saveSession, {passive:true});

    /** ---------- INIT ---------- */
    let resumePayload = restoreSession();

    const boot = async ()=>{
      try{
        if(!await getHosts()) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c m√°y ch·ªß Audius");
        const uid = await userIdByHandle(CONFIG.USER_HANDLE);
        if(!uid) throw new Error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng");
        const tracks = await tracksByUser(uid, CONFIG.PAGE_SIZE);
        state.tracks = tracks;
        state.view = tracks.slice();
        dom.loading.style.display="none";
        renderList();
        if(state.index>=0 && state.index<state.view.length){
          // set meta s·∫µn, kh√¥ng auto play ƒë·ªÉ tr√°nh autoplay policy
          const t = state.view[state.index];
          setMeta(t); updateActiveRow();
          dom.cur.textContent = fmt(resumePayload?.time||0);
          dom.dur.textContent = fmt(t.duration||0);
          showToast("Nh·∫•n ‚ñ∂ ƒë·ªÉ ti·∫øp t·ª•c");
        } else {
          state.index = -1;
        }
        dom.subtitle.textContent = `ƒê√£ t·∫£i ${state.view.length} b√†i ‚Ä¢ Ch·∫°y n·ªÅn & kho√° m√†n h√¨nh d√πng Media Session`;
      }catch(err){
        console.error(err);
        dom.loading.textContent = "L·ªói t·∫£i th∆∞ vi·ªán. Ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.";
        showToast("Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán");
      }
    };

    // Keyboard shortcuts (desktop)
    window.addEventListener("keydown",(e)=>{
      if(e.target && (e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")) return;
      if(e.code==="Space"){ e.preventDefault(); togglePlay(); }
      else if(e.code==="ArrowRight"){ dom.audio.currentTime += CONFIG.SEEK_STEP; }
      else if(e.code==="ArrowLeft"){ dom.audio.currentTime -= CONFIG.SEEK_STEP; }
      else if(e.code==="ArrowUp"){ playPrev(); }
      else if(e.code==="ArrowDown"){ playNext(); }
    });

    // Start
    boot();

  })();
  </script>
</body>
</html>
