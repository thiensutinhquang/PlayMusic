<!DOCTYPE html>
<html lang="vi" data-theme="lucbao">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1b2d" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="MSTQ Music" />
  <title>MSTQ Music ‚Äì Nghe nh·∫°c li√™n t·ª•c</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" type="application/manifest+json" />
  <link rel="apple-touch-icon" sizes="192x192" href="/PlayMusic/images/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/PlayMusic/images/icons/icon-512x512.png" />

  <!-- Tailwind CDN (dev). B·∫£n build n√™n d√πng CLI/PostCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel cho JSX inline (dev) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root,[data-theme]{transition:color .2s ease,background-color .2s ease}
    :root{
      --bg:#0b132b;--card:#0f1b2d;--text:#eaf2ff;--muted:#93a3b8;
      --primary:#f59e0b;--primary-fg:#0b132b;--ring:#f59e0b66;
      --border:#203047;--nav-bg:rgba(16,24,40,.88);--shadow:0 12px 36px rgba(0,0,0,.28);
      --gradient:linear-gradient(135deg,#60a5fa 0%,#f59e0b 100%)
    }
    [data-theme=light]{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#0ea5e9;--primary-fg:#ffffff;--ring:#0ea5e955;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.92)}
    [data-theme=lucbao]{--bg:#081414;--card:#102424;--text:#e0f2f1;--muted:#80cbc4;--primary:#f4ff81;--primary-fg:#0c1113;--ring:#f4ff8166;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(16,36,36,.86)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--card);color:var(--text);padding:.6rem .9rem;border-radius:14px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--primary);color:var(--primary-fg);border-color:transparent}
    .chip{font-size:.72rem;border:1px solid var(--border);padding:.15rem .45rem;border-radius:999px;color:var(--muted)}
    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:40;backdrop-filter:blur(8px);background:var(--nav-bg);border-top:1px solid var(--border)}
    .tabbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:.55rem 0;font-size:.74rem;color:var(--muted)}
    .tabbtn[aria-current=true]{color:var(--text)}
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 10px)}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow);z-index:60;padding:10px}
    .err{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;text-align:left}
    .err-card{background:#111827;border:1px solid #374151;border-radius:14px;max-width:900px;width:100%;padding:18px}
    input[type="range"]{accent-color:#f59e0b}
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;right:0;top:100%;margin-top:.4rem;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);min-width:200px;z-index:50;padding:.4rem}
    .dropdown-item{display:flex;align-items:center;gap:.5rem;padding:.6rem .7rem;border-radius:10px}
    .dropdown-item:hover{background-color:rgba(255,255,255,.06)}
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)]">
  <div id="root"></div>

  <!-- audio -->
  <audio id="mstq-player" preload="metadata" playsinline webkit-playsinline crossOrigin="anonymous"></audio>
  <audio id="mstq-preload" preload="auto" playsinline webkit-playsinline muted crossOrigin="anonymous"></audio>

  <!-- Error overlay -->
  <div id="err" class="err">
    <div class="err-card">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">ƒê√£ b·∫Øt l·ªói runtime</h3>
        <button onclick="document.getElementById('err').style.display='none'" class="btn">ƒê√≥ng</button>
      </div>
      <pre id="errlog" class="mt-3 whitespace-pre-wrap text-sm"></pre>
    </div>
  </div>

  <script>
    // B·∫Øt l·ªói to√†n c·ª•c
    (function(){
      const show=(m)=>{const el=document.getElementById('err');const log=document.getElementById('errlog');if(log)log.textContent=String(m||'Unknown');if(el)el.style.display='flex';console.error('[GLOBAL ERROR]',m)};
      window.addEventListener('error',e=>show(e.error||e.message||e));
      window.addEventListener('unhandledrejection',e=>show(e.reason||e));
    })();
    // SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
    }
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useRef,useCallback} = React;

    /* ===== Keys & utils ===== */
    const SONGS_CACHE_KEY='mstq_songs_v13';
    const RESUME_KEY='mstq_resume_v16';
    const THEME_KEY='music-theme', SPEED_KEY='mstq_speed', MUTED_KEY='mstq_muted';
    const SHUFFLE_KEY='mstq_shuffle', REPEAT_KEY='mstq_repeat';
    const POWER_KEY='mstq_power_save', TIMER_KEY='mstq_sleep_timer', STOP_END_KEY='mstq_stop_at_end';
    const SRC_PREF_KEY='mstq_sources_pref', FAVORITES_KEY='mstq_favorites_v1';
    const COMPRESSOR_KEY='mstq_compressor_on';
    const INITIAL_VISIBLE=120, VISIBLE_STEP=160;

    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
    const clamp=(x,min,max)=>Math.min(Math.max(x,min),max);
    const formatTime=s=>{if(!isFinite(s)||s<0)return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${String(sec).padStart(2,'0')}`};
    const sanitizeRepeat=(r)=> (r==='off'||r==='all'||r==='one')?r:'all';
    const haptic=(ms=14)=>{ try{ navigator.vibrate?.(ms); }catch{} };

    const Icon = ({d=22,p="M5 12h14"}) => <svg width={d} height={d} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.7"><path d={p} strokeLinecap="round" strokeLinejoin="round"/></svg>;
    const I={
      home:(d)=><Icon d={d} p="M3 10.5 12 3l9 7.5v8.5a1.5 1.5 0 0 1-1.5 1.5H4.5A1.5 1.5 0 0 1 3 19V10.5Z"/>,
      search:(d)=><Icon d={d} p="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"/>,
      lib:(d)=><Icon d={d} p="M4 19h16M6 17V5a2 2 0 0 1 2-2h0M12 17V3h0M18 17V7a2 2 0 0 0-2-2h0"/>,
      queue:(d)=><Icon d={d} p="M4 6h16M4 12h10M4 18h7"/>,
      settings:(d)=><Icon d={d} p="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7Z M19.4 15l1.1 1.9-1.7 3-2.2-.4-.9 1.9h-3.4l-.9-1.9-2.2.4-1.7-3 1.1-1.9Z"/>,
      play:(d)=><Icon d={d} p="M8 5v14l11-7z"/>, pause:(d)=><Icon d={d} p="M6 5h4v14H6zM14 5h4v14h-4z"/>,
      next:(d)=><Icon d={d} p="m13 5 9 7-9 7V5zM2 19V5h2v14H2z"/>, back:(d)=><Icon d={d} p="M11 19 2 12l9-7v14zm1-7 9 7V5l-9 7z"/>,
      more:(d)=><Icon d={d} p="M6 12h.01M12 12h.01M18 12h.01"/>,
      repeat:(d)=><Icon d={d} p="M17 1v4H7a5 5 0 0 0 0 10h1M7 23v-4h10a5 5 0 0 0 0-10h-1"/>,
      shuffle:(d)=><Icon d={d} p="M4 4l7 7-7 7M15 4h5M20 4l-6 6M15 20h5M20 20l-6-6"/>,
      download:(d)=><Icon d={d} p="M12 3v12m0 0l4-4m-4 4-4-4M5 21h14"/>
    };

    function App(){
      /* Tabs & theme */
      const [tab,setTab]=useState('home');
      const [theme,setTheme]=useState(localStorage.getItem(THEME_KEY)||'lucbao');
      useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);localStorage.setItem(THEME_KEY,theme);},[theme]);

      /* Start Gate (m·ªôt ch·∫°m + auto 5s) */
      const [needsStart,setNeedsStart]=useState(true);
      const autoStartRef=useRef(null);

      /* Install & Links */
      const installEvtRef=useRef(null);
      const [linksOpen,setLinksOpen]=useState(false);
      useEffect(()=>{
        const onPrompt=(e)=>{ e.preventDefault(); installEvtRef.current=e; };
        window.addEventListener('beforeinstallprompt',onPrompt);
        return()=>window.removeEventListener('beforeinstallprompt',onPrompt);
      },[]);
      const askInstall=async()=>{ haptic(); try{ await installEvtRef.current?.prompt(); await audioCtxRef.current?.resume?.(); }catch{} };

      /* Playback state */
      const [playlist,setPlaylist]=useState([]);
      const [loading,setLoading]=useState(true);
      const [visible,setVisible]=useState(INITIAL_VISIBLE);
      const [filter,setFilter]=useState('');
      const [sourcePref,setSourcePref]=useState(load(SRC_PREF_KEY,{archive:true,custom:false,customText:""}));
      useEffect(()=>save(SRC_PREF_KEY,sourcePref),[sourcePref]);

      const [currentIndex,setCurrentIndex]=useState(0);
      const [playing,setPlaying]=useState(false);
      const [progress,setProgress]=useState({current:0,duration:0});
      const [shuffle,setShuffle]=useState(load(SHUFFLE_KEY,false));
      const [repeat,setRepeat]=useState(sanitizeRepeat(load(REPEAT_KEY,'all')));
      const [stopAtEnd,setStopAtEnd]=useState(load(STOP_END_KEY,false));
      useEffect(()=>save(SHUFFLE_KEY,shuffle),[shuffle]);
      useEffect(()=>save(REPEAT_KEY,repeat),[repeat]);
      useEffect(()=>save(STOP_END_KEY,stopAtEnd),[stopAtEnd]);

      const [upNext,setUpNext]=useState([]);
      const enqueueNext=(s)=>{ haptic(); setUpNext(q=> q.includes(s.id)? q : [...q,s.id]); };
      const moveUp=(id)=>{ haptic(); setUpNext(q=>{ const i=q.indexOf(id); if(i<=0) return q; const a=q.slice(); [a[i-1],a[i]]=[a[i],a[i-1]]; return a; }); };
      const moveDown=(id)=>{ haptic(); setUpNext(q=>{ const i=q.indexOf(id); if(i<0||i===q.length-1) return q; const a=q.slice(); [a[i+1],a[i]]=[a[i],a[i+1]]; return a; }); };
      const removeFromQueue=(id)=>{ haptic(); setUpNext(q=>q.filter(x=>x!==id)); };
      const clearQueue=()=>{ haptic(); setUpNext([]); };

      /* Audio & WebAudio graph (Gain -> Compressor -> Destination) */
      const audioRef=useRef(null), preloadRef=useRef(null);
      useEffect(()=>{ audioRef.current=document.getElementById('mstq-player'); preloadRef.current=document.getElementById('mstq-preload'); },[]);
      const [volume,setVolume]=useState(load(RESUME_KEY,{volume:.9}).volume??.9);
      const [playbackRate,setPlaybackRate]=useState(parseFloat(localStorage.getItem(SPEED_KEY)||'1')||1);
      const [muted,setMuted]=useState(localStorage.getItem(MUTED_KEY)==='1');
      const [compressorOn,setCompressorOn]=useState(load(COMPRESSOR_KEY,true));

      const audioCtxRef=useRef(null), gainRef=useRef(null), compNodeRef=useRef(null), srcNodeRef=useRef(null);
      const ensureAudioContext=async()=>{
        try{
          if(!audioCtxRef.current){
            const ctx=new (window.AudioContext||window.webkitAudioContext)();
            const a=audioRef.current;
            const src=ctx.createMediaElementSource(a);
            const gain=ctx.createGain(); gain.gain.value=1;
            const comp=ctx.createDynamicsCompressor();
            comp.threshold.value=-18; comp.knee.value=24; comp.ratio.value=6; comp.attack.value=0.008; comp.release.value=0.25;
            // src -> gain -> (compressor?) -> dest
            src.connect(gain);
            if(compressorOn){ gain.connect(comp).connect(ctx.destination); } else { gain.connect(ctx.destination); }
            audioCtxRef.current=ctx; gainRef.current=gain; compNodeRef.current=comp; srcNodeRef.current=src;
          }
          await audioCtxRef.current.resume();
        }catch{}
      };
      useEffect(()=>{ try{
        if(audioCtxRef.current && gainRef.current){
          gainRef.current.disconnect();
          const dst=audioCtxRef.current.destination;
          if(compressorOn){ gainRef.current.connect(compNodeRef.current).connect(dst); }
          else { gainRef.current.connect(dst); }
        }}catch{} },[compressorOn]);

      const fadeTo=async(target=1,ms=800)=>{
        try{
          if(!audioCtxRef.current || !gainRef.current) return;
          const g=gainRef.current;
          const now=audioCtxRef.current.currentTime;
          g.gain.cancelScheduledValues(now);
          g.gain.setValueAtTime(g.gain.value, now);
          g.gain.linearRampToValueAtTime(target, now + ms/1000);
        }catch{}
      };

      useEffect(()=>{const a=audioRef.current;if(a){a.volume=volume}},[volume]);
      useEffect(()=>{const a=audioRef.current;if(a){a.playbackRate=playbackRate}localStorage.setItem(SPEED_KEY,String(playbackRate))},[playbackRate]);
      useEffect(()=>{const a=audioRef.current;if(a){a.muted=muted}localStorage.setItem(MUTED_KEY,muted?'1':'0')},[muted]);

      /* Power save & timer */
      const [powerSave,setPowerSave]=useState(load(POWER_KEY,false));
      useEffect(()=>save(POWER_KEY,powerSave),[powerSave]);
      const [timerLeft,setTimerLeft]=useState(load(TIMER_KEY,null));
      const timerRef=useRef(null);
      const startSleepTimer=(ms)=>{
        haptic();
        clearInterval(timerRef.current);
        const end=Date.now()+ms; setTimerLeft(ms); save(TIMER_KEY,ms);
        timerRef.current=setInterval(()=>{ const left=end-Date.now(); if(left<=0){ clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null); pauseAll(); } else setTimerLeft(left); },1000);
      };
      const cancelSleepTimer=()=>{ haptic(); clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null);};
      useEffect(()=>{ const v=load(TIMER_KEY,null); if(v&&v>0) startSleepTimer(v); return()=>clearInterval(timerRef.current); },[]);

      /* Data sources */
      const FALLBACK_SONGS=[{id:"testmp3testfile/mpthreetest.mp3",title:"B√†i h√°t m·∫´u (T·∫°m th·ªùi)",artist:"Public Domain",stream_url:"https://archive.org/download/testmp3testfile/mpthreetest.mp3",artwork:"/PlayMusic/images/icons/icon-192x192.png",duration:5,lyrics:"B√†i m·∫´u.",item_identifier:"testmp3testfile"}];

      const parseCustom=(txt)=>{
        const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const out=[]; let last="";
        for(const ln of lines){
          if(ln.startsWith('#EXTINF:')){ last=ln.split(',').slice(1).join(',').trim(); }
          else if(/^https?:\/\//i.test(ln)){
            out.push({id:ln,title:last||ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:'/PlayMusic/images/icons/icon-192x192.png',duration:0,lyrics:'',item_identifier:'custom'}); last="";
          }
        }
        if(!out.length){
          for(const ln of lines) if(/^https?:\/\//i.test(ln))
            out.push({id:ln,title:ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:'/PlayMusic/images/icons/icon-192x192.png',duration:0,lyrics:'',item_identifier:'custom'});
        }
        return out;
      };

      const refetch=useCallback(async()=>{
        setLoading(true);
        try{
          let all=[];
          if(sourcePref.archive!==false){
            const queries=[
              'uploader:(tinhquang) AND mediatype:(audio)',
              'uploader:(thiensutinhquang) AND mediatype:(audio)',
              'creator:("Minh Su Tinh Quang") AND mediatype:(audio)'
            ];
            let docs=[];let ok=false;
            for(const q of queries){
              const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=publicdate+desc&rows=200&page=1&output=json`;
              const r=await fetch(url,{cache:'no-store'}); if(!r.ok) continue;
              const j=await r.json(); const list=j?.response?.docs||[]; if(list.length){docs=list;ok=true;break;}
            }
            if(ok){
              for(const d of docs){
                try{
                  const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                  (meta.files||[]).forEach(f=>{
                    if(String(f.format||'').toUpperCase().includes('MP3')){
                      all.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'TinhQuang',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                    }
                  });
                }catch{}
              }
            }
          }
          if(sourcePref.custom && sourcePref.customText?.trim()){
            all=[...all, ...parseCustom(sourcePref.customText)];
          }
          if(!all.length){ all=FALLBACK_SONGS; }
          setPlaylist(all);
          save(SONGS_CACHE_KEY,all);
        }catch{
          const cached=load(SONGS_CACHE_KEY,null);
          setPlaylist(cached?.length?cached:FALLBACK_SONGS);
        }
        setLoading(false);
      },[sourcePref]);
      useEffect(()=>{refetch()},[]);

      const current=playlist[currentIndex]||null;

      /* Preload an to√†n */
      const queuePreload=useCallback((idx)=>{
        const n=(idx+1)%playlist.length;
        const next=playlist[n]; const pre=preloadRef.current;
        if(!next||!pre) return;
        if (powerSave || document.visibilityState!=='visible') { pre.removeAttribute('src'); pre.load(); return; }
        if (isiOS && document.visibilityState!=='visible') return;
        if(pre.src!==next.stream_url){ pre.src=next.stream_url; pre.load(); }
      },[playlist,powerSave]);
      useEffect(()=>{ if(playlist.length) queuePreload(currentIndex); },[playlist.length,currentIndex,queuePreload]);
      useEffect(()=>{ const h=()=>queuePreload(currentIndex); document.addEventListener('visibilitychange',h); return()=>document.removeEventListener('visibilitychange',h); },[queuePreload,currentIndex]);

      /* Media Session */
      useEffect(()=>{
        const a=audioRef.current; if(!a||!current||!('mediaSession' in navigator)) return;
        try{
          navigator.mediaSession.metadata=new MediaMetadata({
            title:current.title, artist:current.artist||'minhsutinhquang', album:'MSTQ Music',
            artwork:[{src:current.artwork||'/PlayMusic/images/icons/icon-192x192.png',sizes:'512x512',type:'image/png'}]
          });
          navigator.mediaSession.setActionHandler('play',()=>playPause());
          navigator.mediaSession.setActionHandler('pause',()=>playPause());
          navigator.mediaSession.setActionHandler('previoustrack',()=>prevTrack());
          navigator.mediaSession.setActionHandler('nexttrack',()=>nextTrack());
          navigator.mediaSession.setActionHandler('seekto',d=>{ const a=audioRef.current; if(a && d.seekTime!=null) a.currentTime=d.seekTime; });
          navigator.mediaSession.playbackState=playing?'playing':'paused';
        }catch{}
      },[current,playing]);

      /* Watchdog/Recovery */
      const targetPlayingRef=useRef(false);
      const lastProgRef=useRef({t:0,pos:0});
      const stallScoreRef=useRef(0);
      const lastManualPauseRef=useRef(0);
      const lastRecoverRef=useRef(0);

      useEffect(()=>{
        let lock=null;
        const reqLock=async()=>{try{if('wakeLock'in navigator && document.visibilityState==='visible'){lock=await navigator.wakeLock.request('screen');}}catch{}};
        const vis=()=>{ if(document.visibilityState==='visible'){ reqLock(); if(targetPlayingRef.current){ audioRef.current?.play?.().catch(()=>{}); } } };
        reqLock(); document.addEventListener('visibilitychange',vis);
        return()=>{document.removeEventListener('visibilitychange',vis);try{lock?.release?.()}catch{}};
      },[]);

      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const onTime=()=>{ 
          if(!isFinite(a.duration)) return;
          setProgress({current:a.currentTime||0,duration:a.duration||0});
          const now=Date.now();
          if(Math.abs(a.currentTime-(lastProgRef.current.pos||0))>0.25){ lastProgRef.current={t:now,pos:a.currentTime}; stallScoreRef.current=0; }
          if(a.duration>0 && !a.paused && !a.loop && (a.currentTime>=a.duration-0.3)){ handleEnd(); }
        };
        const onEnded=()=>{ handleEnd(); };
        const onPause=()=>{ if(!targetPlayingRef.current){ lastManualPauseRef.current=Date.now(); } };
        a.addEventListener('timeupdate',onTime);
        a.addEventListener('ended',onEnded);
        a.addEventListener('pause',onPause);
        ['stalled','suspend','waiting','error','abort'].forEach(e=>a.addEventListener(e,()=>{}));
        return()=>{a.removeEventListener('timeupdate',onTime);a.removeEventListener('ended',onEnded);a.removeEventListener('pause',onPause);['stalled','suspend','waiting','error','abort'].forEach(e=>a.removeEventListener(e,()=>{}));};
      },[]);

      useEffect(()=>{
        const interval = powerSave ? 8000 : 5000;
        const tick=setInterval(async()=>{
          const a=audioRef.current; if(!a||!current) return;
          save(RESUME_KEY,{index:currentIndex,id:current.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});
          if(!targetPlayingRef.current) return;
          if(Date.now()-lastManualPauseRef.current<1500) return;

          const stagnate = (Date.now()-(lastProgRef.current.t||0) > (document.visibilityState==='visible'?(powerSave?28000:20000):(powerSave?15000:12000)));
          const poorReady = a.readyState<2;
          const now=Date.now();
          const canRecover = now - (lastRecoverRef.current||0) > (powerSave?3500:2500);

          if(a.paused && canRecover){
            lastRecoverRef.current=now;
            try{ await ensureAudioContext(); a.loop=false; a.muted=false; if(a.volume<0.6) a.volume=0.8; await a.play(); return; }catch{}
          }
          if((stagnate || poorReady) && canRecover){
            lastRecoverRef.current=now;
            stallScoreRef.current++;
            try{
              await ensureAudioContext();
              a.loop=false; a.muted=false; if(a.volume<0.6) a.volume=0.8;
              if(a.paused) await a.play();
              if(a.paused || poorReady){ a.load(); await a.play().catch(()=>{}); }
              const limit=(document.visibilityState==='visible'?(powerSave?4:3):(powerSave?3:2));
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(true); }
            }catch{
              const limit=(document.visibilityState==='visible'?(powerSave?4:3):(powerSave?3:2));
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(true); }
            }
          }
        },interval);
        return()=>clearInterval(tick);
      },[currentIndex,current,powerSave]);

      /* Controls + Crossfade */
      const computeNextIndex = useCallback((dir)=> {
        if(!playlist.length) return 0;
        if(shuffle){ let r=Math.floor(Math.random()*playlist.length); if (r===currentIndex && playlist.length>1) r=(r+1)%playlist.length; return r; }
        if(dir>0) return (currentIndex+1)%playlist.length;
        if(dir<0) return (currentIndex-1+playlist.length)%playlist.length;
        return currentIndex;
      },[playlist.length,shuffle,currentIndex]);

      const playIndex=useCallback(async(i,{fadeIn=true}={})=>{
        const a=audioRef.current; if(!a) return;
        await ensureAudioContext();
        a.loop=false; a.muted=false; if(a.volume<0.6) a.volume=0.85;
        setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true;
        const s=playlist[i]; if(!s) return;
        if(a.src!==s.stream_url){ a.src=s.stream_url; a.load(); }
        if(fadeIn) { try{ await fadeTo(0,10); await a.play(); await fadeTo(1,800);}catch{ a.play().catch(()=>{});} }
        else { a.play().catch(()=>{}); }
        queuePreload(i);
      },[playlist,queuePreload]);

      const nextTrack=useCallback(()=>{
        if(!playlist.length) return;
        if(upNext.length){
          const nextId=upNext[0]; setUpNext(q=>q.slice(1));
          const i=playlist.findIndex(x=>x.id===nextId);
          if(i>=0){ playIndex(i); return; }
        }
        let i=computeNextIndex(+1);
        if(playlist.length>1 && i===currentIndex && !shuffle){ i=(i+1)%playlist.length; }
        playIndex(i);
      },[playlist.length,computeNextIndex,upNext,currentIndex,shuffle,playIndex]);

      const prevTrack=useCallback(()=>{
        if(!playlist.length) return;
        const a=audioRef.current; if(a?.currentTime>3){ a.currentTime=0; return; }
        const i=computeNextIndex(-1);
        playIndex(i);
      },[playlist.length,computeNextIndex,playIndex]);

      const handleEnd=useCallback(()=>{
        const a=audioRef.current; if(a) a.loop=false;
        if(repeat==='one'){ const a=audioRef.current; if(a){ a.currentTime=0; a.loop=false; a.play().catch(()=>{});} return; }
        if((stopAtEnd || repeat==='off') && currentIndex===playlist.length-1 && !upNext.length){ setPlaying(false); targetPlayingRef.current=false; return; }
        nextTrack();
      },[repeat,stopAtEnd,currentIndex,playlist.length,nextTrack,upNext.length]);

      const pickSong=async(s)=>{ haptic(); const i=playlist.findIndex(x=>x.id===s.id); if(i>=0) playIndex(i); };

      const playPause=async()=>{
        haptic();
        const a=audioRef.current; if(!a) return;
        await ensureAudioContext();
        a.loop=false; a.muted=false; if(a.volume<0.6) a.volume=0.85;
        if(!current && playlist.length){ playIndex(0,{fadeIn:false}); setNeedsStart(false); return; }
        if(playing){ setPlaying(false); targetPlayingRef.current=false; try{await fadeTo(0.2,120)}catch{} a.pause(); }
        else{ setPlaying(true); targetPlayingRef.current=true; setNeedsStart(false); try{ await fadeTo(1,200); }catch{} a.play().catch(()=>{}); }
      };
      const pauseAll=()=>{const a=audioRef.current; if(a){ setPlaying(false); targetPlayingRef.current=false; a.pause(); }};

      /* Resume khi ƒë√£ c√≥ playlist */
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const r=load(RESUME_KEY,null);
        if(r&&playlist.length){
          const idx=Math.min(Math.max(0,r.index||0),playlist.length-1);
          setCurrentIndex(idx);
          setTimeout(()=>{ const s=playlist[idx]; if(!s) return;
            if(a.src!==s.stream_url){ a.src=s.stream_url; a.load(); }
            a.currentTime=Number(r.currentTime||0); a.volume=r.volume??volume; a.playbackRate=r.rate??playbackRate; a.muted=false; a.loop=false;
            if(r.playing){ setPlaying(true); targetPlayingRef.current=true; }
          },0);
        }
      // eslint-disable-next-line react-hooks/exhaustive-deps
      },[playlist.length]);

      /* Favorites */
      const [favs,setFavs]=useState(load(FAVORITES_KEY,[]));
      const isFav=(s)=>favs.some(x=>x.id===s.id);
      const toggleFav=(s)=>{
        haptic();
        setFavs((prev)=>{
          const ex=isFav(s);
          const out = ex ? prev.filter(x=>x.id!==s.id) : [{id:s.id,title:s.title,artist:s.artist,artwork:s.artwork},...prev].slice(0,200);
          save(FAVORITES_KEY,out); return out;
        });
      };

      /* ---- UI ---- */
      const TopBar=({title})=>(
        <header className="fixed top-0 inset-x-0 z-30 px-4 py-3 flex items-center justify-between bg-[var(--nav-bg)] backdrop-blur-lg border-b border-[var(--border)]">
          <div className="flex items-center gap-2">
            <img src="/PlayMusic/images/icons/icon-192x192.png" width="24" height="24" className="rounded-md" alt="logo"/>
            <h1 className="font-semibold">{title}</h1>
          </div>
          <div className="flex items-center gap-2">
            <button className="btn" onClick={askInstall}>C√†i ƒë·∫∑t ·ª©ng d·ª•ng</button>
            <div className="dropdown">
              <button className="btn" onClick={()=>{haptic();setLinksOpen(o=>!o)}}>Li√™n k·∫øt ‚ñæ</button>
              {linksOpen && (
                <div className="dropdown-menu" onMouseLeave={()=>setLinksOpen(false)}>
                  <a className="dropdown-item" href="/" target="_self">üè† Trang ch·ªß</a>
                  <a className="dropdown-item" href="https://youtube.com" target="_blank" rel="noopener">üîó YOUTUBE</a>
                  <a className="dropdown-item" href="https://tiktok.com" target="_blank" rel="noopener">üîó TIKTOK</a>
                  <a className="dropdown-item" href="https://facebook.com/groups" target="_blank" rel="noopener">üîó FACEBOOK Group</a>
                  <a className="dropdown-item" href="https://t.me" target="_blank" rel="noopener">üîó TELEGRAM</a>
                  <a className="dropdown-item" href="https://zalo.me" target="_blank" rel="noopener">üîó ZALO</a>
                </div>
              )}
            </div>
            <button className="btn" onClick={()=>{haptic();setTheme(t=>t==='lucbao'?'light':'lucbao')}}>Ch·ªß ƒë·ªÅ</button>
          </div>
        </header>
      );

      const [sheetFor,setSheetFor]=useState(null);
      const closeSheet=()=>setSheetFor(null);

      async function shareTrack(s){
        haptic();
        try{
          if(navigator.share){
            await navigator.share({title:s.title, text:`Nghe: ${s.title} ‚Äì ${s.artist||''}`, url:s.stream_url});
          }else{
            await navigator.clipboard.writeText(s.stream_url);
            alert('ƒê√£ sao ch√©p link ph√°t v√†o b·ªô nh·ªõ t·∫°m.');
          }
        }catch{}
      }
      function downloadTrack(s){
        haptic();
        const a=document.createElement('a');
        a.href=s.stream_url;
        a.download=(s.title||'track')+'.mp3';
        document.body.appendChild(a); a.click(); a.remove();
      }

      const HomeTab=()=>{
        const list = filter.trim()
          ? playlist.filter(s => (s.title||'').toLowerCase().includes(filter.toLowerCase()) || (s.artist||'').toLowerCase().includes(filter.toLowerCase()))
          : playlist;
        return (
          <div className="px-4 py-3">
            <div className="flex items-center justify-between mb-2">
              <h2 className="text-xl font-semibold">Danh s√°ch ph√°t</h2>
              <span className="chip">{list.length} b√†i</span>
            </div>
            <div className="mb-3 flex gap-2">
              <input className="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-xl p-2" placeholder="L·ªçc nhanh theo ti√™u ƒë·ªÅ / ngh·ªá sƒ©" value={filter} onChange={e=>setFilter(e.target.value)}/>
              <button className="btn" onClick={()=>{haptic();setFilter('');setVisible(INITIAL_VISIBLE)}}>Xo√°</button>
            </div>
            {loading?(
              <div className="animate-pulse space-y-3">{Array.from({length:6}).map((_,i)=>(<div key={i} className="h-14 rounded-xl bg-[var(--card)]/40"></div>))}</div>
            ):(
              <>
                <div className="space-y-2">
                  {list.slice(0,visible).map((s)=>(
                    <div key={s.id} className={`flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)] ${current?.id===s.id?'ring-2 ring-[var(--ring)] bg-[var(--card)]/50':''}`}>
                      <img src={s.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-12 h-12 rounded-lg object-cover"/>
                      <button className="flex-grow text-left" onClick={()=>pickSong(s)}>
                        <div className="font-semibold truncate">{s.title||'Untitled'}</div>
                        <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                      </button>
                      <div className="flex items-center gap-2">
                        <button className="btn" title="Chia s·∫ª" onClick={()=>shareTrack(s)}>‚Üó</button>
                        <button className="btn" title="T·∫£i v·ªÅ" onClick={()=>downloadTrack(s)}>{I.download(18)}</button>
                        <button className="btn" title="Tu·ª≥ ch·ªçn" onClick={()=>{haptic();setSheetFor(s)}}>{I.more(18)}</button>
                      </div>
                      <div className="text-xs text-[var(--muted)]">{formatTime(s.duration||0)}</div>
                    </div>
                  ))}
                </div>
                {list.length>visible && <button onClick={()=>{haptic();setVisible(v=>Math.min(list.length,v+VISIBLE_STEP))}} className="btn w-full mt-3">T·∫£i th√™m</button>}
              </>
            )}
            {sheetFor && (
              <div className="sheet">
                <div className="flex items-center justify-between px-2">
                  <div className="font-semibold truncate mr-2">{sheetFor.title}</div>
                  <button className="btn" onClick={()=>{haptic();closeSheet()}}>ƒê√≥ng</button>
                </div>
                <div className="mt-2 grid grid-cols-2 gap-2 px-2 pb-2">
                  <button className="btn btn-primary" onClick={()=>{setUpNext(q=>[...q,sheetFor.id]); haptic(); closeSheet(); setTab('queue');}}>Ph√°t ti·∫øp theo</button>
                  <button className="btn" onClick={()=>{toggleFav(sheetFor); closeSheet();}}>{isFav(sheetFor)?'B·ªè y√™u th√≠ch':'Y√™u th√≠ch'}</button>
                  <button className="btn" onClick={()=>{pickSong(sheetFor); closeSheet();}}>Ph√°t ngay</button>
                  <button className="btn" onClick={()=>{downloadTrack(sheetFor); closeSheet();}}>T·∫£i ngo·∫°i tuy·∫øn</button>
                  <button className="btn" onClick={()=>{shareTrack(sheetFor); closeSheet();}}>Chia s·∫ª‚Ä¶</button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const SearchTab=()=>{
        const [kw,setKw]=useState(''); const [busy,setBusy]=useState(false);
        const runQuery=async(q,sort='downloads+desc')=>{
          haptic();
          setBusy(true);
          try{
            const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=${encodeURIComponent(sort)}&rows=120&page=1&output=json`;
            const r=await fetch(url,{cache:'no-store'}); const j=await r.json();
            const docs=j?.response?.docs||[]; const out=[];
            for(const d of docs){
              try{
                const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                (meta.files||[]).forEach(f=>{
                  if(String(f.format||'').toUpperCase().includes('MP3')){
                    out.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'Archive',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                  }
                });
              }catch{}
            }
            if(out.length){ setPlaylist(out); setVisible(INITIAL_VISIBLE); setTab('home'); setFilter(''); }
          }catch{} setBusy(false);
        };
        const quick=[{label:'M·ªõi nh·∫•t',q:'mediatype:(audio)',sort:'publicdate+desc'},{label:'Ph·ªï bi·∫øn',q:'mediatype:(audio)',sort:'downloads+desc'},{label:'Ph√°p tho·∫°i',q:'"Minh Su Tinh Quang" mediatype:(audio)',sort:'downloads+desc'}];
        return (
          <div className="px-4 py-3">
            <div className="flex gap-2">
              <input className="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-xl p-2" placeholder="T√¨m tr√™n Archive.org..." value={kw} onChange={e=>setKw(e.target.value)}/>
              <button className="btn btn-primary" onClick={()=>runQuery(`${kw} AND mediatype:(audio)`)} disabled={!kw||busy}>{busy?'ƒêang t√¨m‚Ä¶':'T√¨m'}</button>
            </div>
            <div className="flex gap-2 mt-3 flex-wrap">
              {quick.map(x=>(<button key={x.label} className="btn" onClick={()=>runQuery(x.q,x.sort)}>{x.label}</button>))}
            </div>
          </div>
        );
      };

      const LibraryTab=()=>{
        const [custom,setCustom]=useState(sourcePref.customText||'');
        return (
          <div className="px-4 py-3 space-y-6">
            <div>
              <div className="mb-2 flex items-center justify-between">
                <h2 className="text-lg font-semibold">Y√™u th√≠ch</h2>
                <span className="chip">{favs.length} b√†i</span>
              </div>
              {favs.length===0 ? <p className="text-[var(--muted)] text-sm">Ch∆∞a c√≥ b√†i n√†o trong ‚ÄúY√™u th√≠ch‚Äù.</p>:
                <div className="space-y-2">
                  {favs.map(s=>(
                    <div key={s.id} className="flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)]">
                      <img src={s.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-12 h-12 rounded-lg object-cover"/>
                      <button className="flex-grow text-left" onClick={()=>pickSong(s)}>
                        <div className="font-semibold truncate">{s.title}</div>
                        <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                      </button>
                      <button className="btn" onClick={()=>toggleFav(s)} title="B·ªè y√™u th√≠ch">‚àí</button>
                    </div>
                  ))}
                </div>
              }
            </div>

            <div className="p-3 rounded-2xl border border-[var(--border)]">
              <h3 className="font-semibold mb-2">Ngu·ªìn tu·ª≥ ch·ªânh (M3U/URL)</h3>
              <label className="flex items-center gap-2 mb-2"><input type="checkbox" checked={!!sourcePref.custom} onChange={e=>{haptic();setSourcePref(p=>({...p,custom:e.target.checked}))}}/> B·∫≠t</label>
              <textarea className="w-full bg-[var(--card)] border border-[var(--border)] rounded-xl p-2 min-h-[120px]" placeholder="https://.../song1.mp3&#10;https://.../song2.mp3" value={custom} onChange={e=>setCustom(e.target.value)}></textarea>
              <div className="mt-2 flex gap-2">
                <button className="btn btn-primary" onClick={()=>{haptic();setSourcePref(p=>({...p,customText:custom,custom:true})); refetch();}}>T·∫£i v√†o danh s√°ch</button>
                <button className="btn" onClick={()=>{haptic();setCustom(''); setSourcePref(p=>({...p,customText:''}));}}>Xo√° n·ªôi dung</button>
              </div>
            </div>
          </div>
        );
      };

      const QueueTab=()=>{ const items=upNext.map(id=>playlist.find(s=>s.id===id)).filter(Boolean);
        return (<div className="px-4 py-3">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-lg font-semibold">H√†ng ƒë·ª£i ‚ÄúPh√°t ti·∫øp theo‚Äù</h2>
            <div className="flex gap-2"><span className="chip">{items.length} m·ª•c</span>{items.length>0 && <button className="btn" onClick={()=>{haptic();clearQueue()}}>Xo√° h·∫øt</button>}</div>
          </div>
          {items.length===0 ? <p className="text-[var(--muted)] text-sm">Ch∆∞a c√≥ m·ª•c n√†o. B·∫•m ‚ãØ tr√™n b√†i h√°t ƒë·ªÉ th√™m.</p>:
            <div className="space-y-2">
              {items.map(s=>(
                <div key={s.id} className="flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)]">
                  <img src={s.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-10 h-10 rounded-lg object-cover"/>
                  <div className="flex-grow min-w-0">
                    <div className="font-semibold truncate">{s.title}</div>
                    <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                  </div>
                  <div className="flex gap-2">
                    <button className="btn" onClick={()=>moveUp(s.id)}>‚Üë</button>
                    <button className="btn" onClick={()=>moveDown(s.id)}>‚Üì</button>
                    <button className="btn" onClick={()=>removeFromQueue(s.id)}>‚úï</button>
                  </div>
                </div>
              ))}
            </div>}
        </div>);
      };

      const SettingsTab=()=>(
        <div className="px-4 py-3 space-y-6">
          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-lg">Giao di·ªán</h3>
              <span className="chip">{theme}</span>
            </div>
            <div className="grid grid-cols-3 gap-3">
              {[
                ['T·ªëi','dark'],['S√°ng','light'],['L·ª•c B·∫£o','lucbao']
              ].map(([label,code])=>(
                <button key={code} onClick={()=>{haptic();setTheme(code)}} className={`w-full text-left p-4 rounded-2xl border border-[var(--border)] ${theme===code?'ring-2 ring-[var(--ring)]':''}`}>
                  <div className="font-semibold">{label}</div>
                  <div className="text-xs text-[var(--muted)]">{code}</div>
                </button>
              ))}
            </div>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">√Çm l∆∞·ª£ng & t·ªëc ƒë·ªô</h3>
            <div className="space-y-2">
              <label className="text-sm">√Çm l∆∞·ª£ng: {(volume*100)|0}%</label>
              <input type="range" min="0" max="1" step="0.01" value={volume} onChange={e=>{haptic(8);setVolume(parseFloat(e.target.value))}}/>
              <div className="flex gap-2 flex-wrap">
                {[0.75,1,1.25,1.5].map(v=>(
                  <button key={v} className={`btn ${playbackRate===v?'btn-primary':''}`} onClick={()=>{haptic();setPlaybackRate(v)}}>{v}x</button>
                ))}
                <label className="flex items-center gap-2 ml-1">
                  <input type="checkbox" checked={muted} onChange={e=>{haptic();setMuted(e.target.checked)}}/> T·∫Øt ti·∫øng
                </label>
              </div>
            </div>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">·ªîn ƒë·ªãnh √¢m l∆∞·ª£ng</h3>
            <label className="flex items-center gap-2">
              <input type="checkbox" checked={!!compressorOn} onChange={e=>{haptic();setCompressorOn(e.target.checked)}}/> B·∫≠t Dynamics Compressor
            </label>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Ti·∫øt ki·ªám ƒëi·ªán</h3>
            <label className="flex items-center gap-2">
              <input type="checkbox" checked={!!powerSave} onChange={e=>{haptic();setPowerSave(e.target.checked)}}/> B·∫≠t ti·∫øt ki·ªám pin (t·∫Øt preload khi n·ªÅn)
            </label>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-3">H·∫πn gi·ªù t·∫Øt nh·∫°c</h3>
            <div className="grid grid-cols-3 gap-2">
              {[15,30,45,60,90,120].map(m=>(<button key={m} className="btn" onClick={()=>startSleepTimer(m*60*1000)}>{m} ph√∫t</button>))}
            </div>
            <div className="flex items-center gap-3 mt-3">
              <span className="chip">{timerLeft?`C√≤n: ${formatTime(Math.ceil(timerLeft/1000))}`:'Kh√¥ng ƒë·∫∑t'}</span>
              {timerLeft && <button className="btn" onClick={cancelSleepTimer}>Hu·ª∑ h·∫πn gi·ªù</button>}
              <label className="flex items-center gap-2 ml-auto">
                <input type="checkbox" checked={!!stopAtEnd} onChange={e=>{haptic();setStopAtEnd(e.target.checked)}} /> D·ª´ng khi h·∫øt b√†i
              </label>
            </div>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">D·ªØ li·ªáu & ƒê·ªìng b·ªô</h3>
            <div className="flex flex-col gap-2">
              <button className="btn" onClick={()=>{haptic();refetch()}}>L√†m m·ªõi danh s√°ch nh·∫°c</button>
              <button
                className="btn"
                onClick={async()=>{
                  haptic();
                  try{ if('caches' in window){ const keys=await caches.keys(); for(const k of keys){ await caches.delete(k); } } }catch{}
                  try{ localStorage.clear(); }catch{}
                  location.reload();
                }}
                style={{background:'#2a1313',borderColor:'#6b1d1d',color:'#fff'}}
              >
                X√≥a & L√†m m·ªõi t·∫•t c·∫£
              </button>
            </div>
          </div>
        </div>
      );

      /* Now Playing */
      const [showNowPlaying,setShowNowPlaying]=useState(false);
      const NowPlaying=()=>{
        if(!current) return null;
        const a=audioRef.current;
        const onSeek=(e)=>{ if(!a||!isFinite(a.duration)) return; a.currentTime=clamp(parseFloat(e.target.value),0,a.duration); };
        const dblLeft=()=>{ if(a) a.currentTime=Math.max(0,(a.currentTime||0)-10); };
        const dblRight=()=>{ if(a) a.currentTime=Math.min(a.duration||0,(a.currentTime||0)+10); };
        return (
          <div className="fixed inset-0 z-50 bg-[var(--bg)]/98 backdrop-blur-md">
            <div className="p-4 flex items-center justify-between border-b border-[var(--border)]">
              <button className="btn" onClick={()=>{haptic();setShowNowPlaying(false)}}>ƒê√≥ng</button>
              <div className="font-semibold">ƒêang ph√°t</div>
              <div className="w-14"></div>
            </div>
            <div className="px-6 py-6">
              <div className="mx-auto w-64 h-64 rounded-3xl shadow-xl overflow-hidden relative select-none" style={{background:'var(--gradient)'}}>
                <div className="absolute inset-0" onDoubleClick={dblLeft}></div>
                <div className="absolute inset-0 left-1/2" onDoubleClick={dblRight}></div>
                <img src={current.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-full h-full object-cover mix-blend-luminosity pointer-events-none"/>
              </div>
              <div className="mt-5 text-center">
                <div className="text-xl font-bold truncate">{current.title}</div>
                <div className="text-sm text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</div>
              </div>

              <div className="mt-5 px-1">
                <input type="range" min="0" max={progress.duration||0} step="0.1" value={progress.current||0} onChange={onSeek} style={{width:'100%'}}/>
                <div className="mt-1 text-[12px] text-[var(--muted)] flex justify-between">
                  <span>{formatTime(progress.current)}</span><span>{formatTime(progress.duration)}</span>
                </div>
              </div>

              <div className="mt-4 grid grid-cols-3 gap-3 items-center">
                <div className="text-center">
                  <div className="text-xs text-[var(--muted)] mb-1">√Çm l∆∞·ª£ng {(volume*100|0)}%</div>
                  <input type="range" min="0" max="1" step="0.01" value={volume} onChange={e=>{haptic(8);setVolume(parseFloat(e.target.value))}}/>
                </div>
                <div className="flex items-center justify-center gap-3">
                  <button className="btn" onClick={prevTrack}>{I.back(24)}</button>
                  <button className="btn btn-primary" onClick={playPause}>{playing?I.pause(24):I.play(24)}</button>
                  <button className="btn" onClick={nextTrack}>{I.next(24)}</button>
                </div>
                <div className="text-center">
                  <div className="text-xs text-[var(--muted)] mb-1">T·ªëc ƒë·ªô {playbackRate}x</div>
                  <div className="flex gap-1 justify-center">
                    {[0.75,1,1.25,1.5].map(v=>(
                      <button key={v} className={`btn ${playbackRate===v?'btn-primary':''}`} onClick={()=>{haptic();setPlaybackRate(v)}}>{v}x</button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="mt-4 flex flex-wrap gap-2 justify-center">
                <button className={`btn ${shuffle?'btn-primary':''}`} onClick={()=>{haptic();setShuffle(s=>!s)}}>{I.shuffle(18)} Tr·ªôn</button>
                <button className="btn" onClick={()=>{haptic();setRepeat(r=> sanitizeRepeat(r==='off'?'all':r==='all'?'one':'off'))}}>{I.repeat(18)} L·∫∑p: {repeat==='off'?'T·∫Øt':repeat==='all'?'DS':'1'}</button>
                <button className="btn" onClick={()=>{haptic();setMuted(m=>!m)}}>{muted?'B·∫≠t ti·∫øng':'T·∫Øt ti·∫øng'}</button>
              </div>
            </div>
          </div>
        );
      };

      /* ---- Render & auto start ---- */
      useEffect(()=>{ 
        const a=audioRef.current; if(!a) return;
        if(current){
          if(a.src!==current.stream_url){ a.src=current.stream_url; a.load(); }
          a.loop=false; a.playbackRate=playbackRate; a.muted=false; a.volume=Math.max(a.volume,0.8);
          document.title=`${playing?'‚ñ∂':'‚è∏'} ${current.title} ‚Äì MSTQ`;
          if(playing && !needsStart){ a.play().catch(()=>{}); }
        }else{
          document.title='MSTQ Music';
        }
      },[currentIndex,playing,playbackRate,current,needsStart]);

      // Popup StartGate t·ª± ch·∫°y sau 5 gi√¢y
      useEffect(()=>{
        clearTimeout(autoStartRef.current);
        if(needsStart){
          autoStartRef.current=setTimeout(async()=>{
            try{
              await ensureAudioContext();
              const a=audioRef.current;
              a.loop=false; a.muted=false; if(a.volume<0.8) a.volume=0.85;
              if(!playlist.length){ return; }
              setNeedsStart(false); playIndex(0,{fadeIn:false});
            }catch{}
          },5000);
        }
        return()=>clearTimeout(autoStartRef.current);
      },[needsStart,playlist.length,playIndex]);

      const TabBar=()=>(
        <nav className="tabbar safe-bottom">
          <div className="flex">
            <button className="tabbtn" aria-current={tab==='home'} onClick={()=>{haptic();setTab('home')}}>{I.home(20)}<span>Trang ch·ªß</span></button>
            <button className="tabbtn" aria-current={tab==='search'} onClick={()=>{haptic();setTab('search')}}>{I.search(20)}<span>T√¨m ki·∫øm</span></button>
            <button className="tabbtn" aria-current={tab==='library'} onClick={()=>{haptic();setTab('library')}}>{I.lib(20)}<span>Th∆∞ vi·ªán</span></button>
            <button className="tabbtn" aria-current={tab==='queue'} onClick={()=>{haptic();setTab('queue')}}>{I.queue(20)}<span>H√†ng ƒë·ª£i</span></button>
            <button className="tabbtn" aria-current={tab==='settings'} onClick={()=>{haptic();setTab('settings')}}>{I.settings(20)}<span>C√†i ƒë·∫∑t</span></button>
          </div>
        </nav>
      );

      const MiniPlayer = () => current && !needsStart && (
        <div className="fixed left-2 right-2 rounded-2xl bg-[var(--card)]/95 border border-[var(--border)] backdrop-blur-md p-2 z-50 shadow-[var(--shadow)]" style={{bottom:'64px'}}>
          <div className="flex items-center gap-3">
            <img src={current.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" width="44" height="44" className="rounded-lg object-cover"/>
            <button className="flex-grow min-w-0 text-left" onClick={()=>{haptic();setShowNowPlaying(true)}}>
              <p className="truncate font-semibold">{current.title}</p>
              <p className="text-xs text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</p>
            </button>
            <button className="w-10 h-10" onClick={()=>{haptic();prevTrack()}} aria-label="Previous">{I.back(22)}</button>
            <button className="w-10 h-10" onClick={()=>{haptic();playPause()}} aria-label="Play/Pause">{playing?I.pause(22):I.play(22)}</button>
            <button className="w-10 h-10" onClick={()=>{haptic();nextTrack()}} aria-label="Next">{I.next(22)}</button>
          </div>
          <div className="mt-2 h-1 bg-[var(--muted)]/20 rounded">
            <div className="h-1 bg-[var(--primary)] rounded" style={{width:`${progress.duration>0?(progress.current/progress.duration)*100:0}%`}}></div>
          </div>
        </div>
      );

      const StartGate = () => needsStart && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-[var(--bg)]/95 backdrop-blur">
          <div className="p-5 rounded-2xl border border-[var(--border)] bg-[var(--card)] shadow-xl text-center max-w-sm">
            <img src="/PlayMusic/images/icons/icon-192x192.png" width="64" height="64" className="mx-auto mb-3 rounded-xl" alt=""/>
            <h2 className="font-bold text-lg mb-2">MSTQ Music</h2>
            <p className="text-sm text-[var(--muted)] mb-3">Ch·∫°m ‚ÄúB·∫Øt ƒë·∫ßu nghe‚Äù ƒë·ªÉ m·ªü quy·ªÅn √¢m thanh. H·ªôp tho·∫°i s·∫Ω t·ª± ƒë√≥ng sau 5 gi√¢y v√† th·ª≠ ph√°t t·ª± ƒë·ªông.</p>
            <div className="flex gap-2 justify-center">
              <button className="btn" onClick={askInstall}>C√†i ƒë·∫∑t ·ª©ng d·ª•ng</button>
              <button className="btn btn-primary" onClick={async()=>{haptic(); await ensureAudioContext(); setNeedsStart(false); if(playlist.length){ playIndex(0,{fadeIn:false}); }}}>B·∫Øt ƒë·∫ßu nghe</button>
            </div>
            <div class="text-[12px] text-[var(--muted)] mt-2">S·∫Ω t·ª± ƒë·ªông b·∫Øt ƒë·∫ßu sau 5 gi√¢y‚Ä¶</div>
          </div>
        </div>
      );

      const title = tab==='home'?'Trang ch·ªß':tab==='search'?'T√¨m ki·∫øm':tab==='library'?'Th∆∞ vi·ªán':tab==='queue'?'H√†ng ƒë·ª£i':'C√†i ƒë·∫∑t';

      return (
        <div className="min-h-screen" style={{paddingTop:64, paddingBottom:(current?188:104)}} onClick={()=>setLinksOpen(false)}>
          <TopBar title={title}/>
          <StartGate/>
          {tab==='home' && <HomeTab/>}
          {tab==='search' && <SearchTab/>}
          {tab==='library' && <LibraryTab/>}
          {tab==='queue' && <QueueTab/>}
          {tab==='settings' && <SettingsTab/>}
          <TabBar/>
          <MiniPlayer/>
          {showNowPlaying && !needsStart && <NowPlaying/>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
