<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Play Nhạc MSTQ</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    
    <style>
        /* ==============================================
        HỆ THỐNG THIẾT KẾ & BIẾN CSS
        ============================================== */
        :root {
            /* Bảng màu chính */
            --primary-color: #f59e0b; /* Amber 500 */
            --primary-hover: #d97706; /* Amber 600 */
            --secondary-color: #3b82f6; /* Blue 500 */
            --danger-color: #ef4444; /* Red 500 */
            
            /* Màu cho chế độ Sáng */
            --bg-light: #f1f5f9; /* Slate 100 */
            --card-bg-light: #ffffff;
            --text-light: #1e293b; /* Slate 800 */
            --text-muted-light: #475569; /* Slate 600 - Đã điều chỉnh để tăng độ tương phản */
            --border-light: #e2e8f0; /* Slate 200 */

            /* Màu cho chế độ Tối */
            --bg-dark: #0f172a; /* Slate 900 */
            --card-bg-dark: #1e293b; /* Slate 800 */
            --text-dark: #e2e8f0; /* Slate 200 */
            --text-muted-dark: #94a3b8; /* Slate 400 */
            --border-dark: #334155; /* Slate 700 */

            /* Đổ bóng */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            /* Hiệu ứng chuyển động */
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);

            /* Font chữ */
            --font-sans: 'Be Vietnam Pro', sans-serif;

            /* Mặc định là giao diện Sáng */
            --bg-current: var(--bg-light);
            --card-bg-current: var(--card-bg-light);
            --text-current: var(--text-light);
            --text-muted-current: var(--text-muted-light);
            --border-current: var(--border-light);
        }

        body.dark-mode {
            --bg-current: var(--bg-dark);
            --card-bg-current: var(--card-bg-dark);
            --text-current: var(--text-dark);
            --text-muted-current: var(--text-muted-dark);
            --border-current: var(--border-dark);
        }

        /* Preset themes */
        html[data-theme="strong"] {
            --bg-current: #003366;
            --card-bg-current: #004488;
            --text-current: #FFD700;
            --text-muted-current: #AAAAAA;
            --border-current: #0055AA;
        }
        html[data-theme="gentle"] {
            --bg-current: #6A057F;
            --card-bg-current: #7B1A8F;
            --text-current: #FFB6C1;
            --text-muted-current: #E0E0E0;
            --border-current: #8C2B9F;
        }
        html[data-theme="fresh"] {
            --bg-current: #228B22;
            --card-bg-current: #339B33;
            --text-current: #00CED1;
            --text-muted-current: #BBEEFF;
            --border-current: #44AA44;
        }
        html[data-theme="modern"] {
            --bg-current: #228B22;
            --card-bg-current: #339B33;
            --text-current: #FFD700;
            --text-muted-current: #FFDD77;
            --border-current: #44AA44;
        }
        html[data-theme="warm"] {
            --bg-current: #6A057F;
            --card-bg-current: #7B1A8F;
            --text-current: #FFD700;
            --text-muted-current: #FFDD77;
            --border-current: #8C2B9F;
        }
        html[data-theme="elegant"] {
            --bg-current: #003366;
            --card-bg-current: #004488;
            --text-current: #00CED1;
            --text-muted-current: #BBEEFF;
            --border-current: #0055AA;
        }
        html[data-theme="tinhquang"] {
            --bg-current: #1a0b2a;
            --card-bg-current: #2a1b4a;
            --text-current: #FFD700;
            --text-muted-current: #e0e0e0;
            --border-current: #4a2a6a;
        }
        
        /* ==============================================
        PHONG CÁCH CƠ BẢN & TOÀN CỤC
        ============================================== */
        html { scroll-behavior: smooth; }
        
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-current);
            color: var(--text-current);
            transition: background-color var(--transition-fast), color var(--transition-fast);
            line-height: 1.6;
            padding-bottom: 90px; /* Tạo không gian cho thanh điều khiển */
        }
        
        .container { max-width: 1280px; margin: 0 auto; padding: 1rem 1.5rem; }
        
        .card {
            background-color: var(--card-bg-current);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-current);
            transition: var(--transition-slow);
            padding: 1.25rem 1.5rem;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        /* ==============================================
        HEADER & ĐIỀU HƯỚNG MỚI
        ============================================== */
        .header {
            background-color: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid var(--border-current);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(8px);
            display: flex; /* Make header a flex container to stack main content and mobile controls */
            flex-direction: column; 
            align-items: center; /* Center content horizontally */
            padding: 1rem 0; /* Overall padding for the header */
            height: auto; /* Allow height to adjust */
        }
        
        body.dark-mode .header { background-color: rgba(15, 23, 42, 0.7); }

        .header-layout-wrapper { /* This wraps logo and main content (title + nav) */
            display: flex;
            align-items: stretch; /* Make children stretch to fill height */
            justify-content: space-between; /* Push logo left, main content center, hamburger right */
            width: 100%; /* Take full width of container */
            gap: 1.5rem; /* Space between logo and main content */
            padding: 0 1.5rem; /* Apply horizontal padding here */
        }

        .header-logo-container {
            flex-shrink: 0; /* Prevent logo from shrinking */
            display: flex;
            align-items: center; /* Vertically center logo content if it doesn't stretch */
            justify-content: center; /* Horizontally center logo content */
            max-width: 200px; /* Max width for logo container */
            width: 20%; /* Allow logo to take a percentage of width */
            min-width: 100px; /* Minimum width for logo */
        }

        #header-logo-placeholder {
            width: 100%;
            height: 100%; /* This will make it stretch vertically within header-logo-container */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #header-logo-placeholder svg {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Maintain aspect ratio */
        }

        .header-main-content { /* This holds main title and desktop nav */
            flex-grow: 1; /* Allow this section to take available space */
            display: flex;
            flex-direction: column; /* Stack title and nav vertically */
            align-items: center; /* Center title and nav rows horizontally */
            text-align: center; /* Center text within title */
            justify-content: center; /* Vertically center content if it doesn't fill height */
        }

        .main-title {
            font-size: 2.5rem; /* Larger font size for main title */
            font-weight: 800; /* Extra bold */
            color: var(--primary-color); /* Primary color for emphasis */
            margin: 0.5rem 0; /* Adjust margin */
            width: 100%; /* Ensure it takes full width for centering */
        }
        
        /* New Navigation Item Styling */
        .nav-item {
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem; 
            background-color: transparent;
            color: var(--text-muted-current); 
            padding: 0.6rem 1rem; 
            border-radius: 8px;
            text-decoration: none; 
            font-weight: 500; 
            font-size: 0.95rem; 
            border: 2px solid transparent; 
            transition: var(--transition-fast); 
            white-space: nowrap;
        }
        .nav-item:hover { 
            color: var(--text-current); 
            background-color: var(--bg-current); 
            transform: translateY(-2px); 
        }
        .nav-item:active { transform: scale(0.95); }

        /* Active state for navigation links */
        .nav-item.active { 
            color: var(--primary-color); 
            font-weight: 700; 
            background-color: var(--bg-current); 
            border-color: var(--primary-color); 
        }

        /* Dropdown specific styles */
        .dropdown-container { position: relative; }
        .dropdown-toggle {
            display: inline-flex; align-items: center; gap: 0.5rem; background-color: transparent;
            color: var(--text-muted-current); padding: 0.6rem 1rem; border-radius: 8px;
            text-decoration: none; font-weight: 500; font-size: 0.95rem; border: 2px solid transparent;
            transition: var(--transition-fast); white-space: nowrap;
            cursor: pointer; 
        }
        .dropdown-toggle:hover { color: var(--text-current); background-color: var(--bg-current); transform: translateY(-2px); }
        .dropdown-toggle:active { transform: scale(0.95); }
        .dropdown-toggle.active { 
            color: var(--primary-color); 
            font-weight: 700; 
            background-color: var(--bg-current); 
            border-color: var(--primary-color);
        }

        .dropdown-toggle .ph-caret-down {
            transition: transform 0.2s ease-in-out;
        }
        .dropdown-toggle.open .ph-caret-down {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            display: none; 
            position: absolute; 
            top: calc(100% + 10px); 
            right: 0;
            background-color: var(--card-bg-current); 
            border-radius: 8px; 
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-current); 
            width: 220px; 
            z-index: 1010;
            opacity: 0; 
            transform: translateY(10px); 
            transition: opacity 0.3s ease, transform 0.3s ease;
            padding: 0.5rem; 
        }
        .dropdown-menu.show { display: block; opacity: 1; transform: translateY(0); }
        
        .dropdown-menu a { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            padding: 0.75rem 1rem; 
            color: var(--text-muted-current); 
            text-decoration: none; 
            transition: var(--transition-fast); 
            font-size: 0.95rem;
            border-radius: 6px; 
        }
        .dropdown-menu a:hover { background-color: var(--primary-color); color: #fff; }
        .dropdown-menu a i, .dropdown-menu a svg { font-size: 1.25rem; width: 20px; height: 20px; text-align: center; }

        /* Preset Theme Buttons */
        .preset-theme-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 2px solid var(--border-current);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .preset-theme-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }
        .preset-theme-btn.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.4); 
        }

        /* Timer Action Buttons */
        .timer-action-btn {
            width: 100%;
            padding: 0.75rem 1rem; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
            display: block; 
            color: white; 
            margin-top: 0.5rem; /* Add some margin top for spacing */
        }
        .timer-action-btn.bg-primary-color {
            background-color: var(--primary-color);
        }
        .timer-action-btn.bg-primary-color:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .timer-action-btn.bg-danger-color {
            background-color: var(--danger-color);
        }
        .timer-action-btn.bg-danger-color:hover {
            background-color: #dc2626; 
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Input field in light mode */
        body:not(.dark-mode) input[type="number"] {
            color: var(--text-light); 
            background-color: #f8fafc; 
            border-color: #cbd5e1; 
        }

        /* ==============================================
        MÀN HÌNH CHÀO (SPLASH SCREEN)
        ============================================== */
        #splash-screen { 
            position: fixed; inset: 0; z-index: 9999; 
            opacity: 1; 
            transition: opacity 1.5s ease-out 4.5s, visibility 1.5s ease-out 4.5s; 
            visibility: visible;
            display: flex; justify-content: center; align-items: center; 
            background: #000;
            overflow: hidden;
        }
        #splash-screen.hidden { opacity: 0; visibility: hidden; }
        #splash-logo-container { width: 250px; height: 250px; position: relative; z-index: 10; }
        #splash-logo-placeholder svg, #header-logo-placeholder svg { width: 100%; height: 100%; object-fit: contain; }
        
        /* ==============================================
        HIỆU ỨNG LOGO & VŨ TRỤ
        ============================================== */
        
        /* Hiệu ứng Logo Header khi nhạc phát */
        #header-logo-placeholder #human-body.breathing-effect { animation: breathe 4s infinite ease-in-out; }
        #header-logo-placeholder #chakra-system.energy-flow-active { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: flow-animation 3s linear infinite; }
        #header-logo-placeholder #logo-text-trucchichantam.highlight-text { fill: gold; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); transform-origin: center; }
            50% { transform: scale(1.03); transform-origin: center; }
        }
        @keyframes flow-animation {
            from { stroke-dashoffset: 1000; }
            to { stroke-dashoffset: 0; }
        }

        /* Hiệu ứng vũ trụ nền */
        .stars, .stars2, .stars3 {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            display: block;
            background: transparent;
        }
        .stars { animation: rotate-stars 150s linear infinite; }
        .stars2 { animation: rotate-stars 100s linear infinite; }
        .stars3 { animation: rotate-stars 50s linear infinite; }
        @keyframes rotate-stars { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        @keyframes twinkle {
            0% { transform: scale(0.5); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.5); opacity: 0.5; }
        }

        /* ==============================================
        NỘI DUNG CHÍNH
        ============================================== */
        .main-content { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 2rem; 
            margin-top: 2rem; 
            max-width: none; 
            width: 100%; 
            padding-left: 1.5rem; 
            padding-right: 1.5rem; 
        }
        
        /* ==============================================
        TRÌNH PHÁT NHẠC - THANH ĐIỀU KHIỂN DƯỚI
        ============================================== */
        #player-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 90px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-current);
            z-index: 1001;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            gap: 2rem;
        }
        body.dark-mode #player-bar {
            background-color: rgba(15, 23, 42, 0.7);
        }

        #player-bar .now-playing-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
        }
        #player-bar .now-playing-info img {
            width: 56px;
            height: 56px;
            border-radius: 8px;
            object-fit: cover;
        }
        #player-bar .now-playing-info .text-info {
            min-width: 0;
        }

        #player-bar .player-controls-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        #player-bar .player-buttons {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        #player-bar .player-buttons button {
            background: none;
            border: none;
            color: var(--text-muted-current);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        #player-bar .player-buttons button:hover { color: var(--text-current); }
        #player-bar .player-buttons #play-pause-btn {
            background-color: var(--primary-color);
            color: white;
            width: 44px; height: 44px;
            border-radius: 50%;
            font-size: 1.5rem;
        }
        #player-bar .player-buttons #play-pause-btn:hover { background-color: var(--primary-hover); }

        #player-bar .progress-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 500px;
        }
        #player-bar .progress-container { flex-grow: 1; }

        #player-bar .player-actions-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 1rem;
        }
        #player-bar .player-actions-right button {
            background: none; border: none; color: var(--text-muted-current); font-size: 1.25rem;
        }
        #player-bar .volume-container { display: flex; align-items: center; gap: 0.5rem; width: 120px; }

        /* ==============================================
        DANH SÁCH CHỜ (QUEUE)
        ============================================== */
        #queue-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1002;
            opacity: 0;
            transition: opacity var(--transition-fast);
            pointer-events: none;
        }
        body.queue-open #queue-overlay {
            opacity: 1;
            pointer-events: all;
        }

        #queue-sidebar {
            position: fixed;
            top: 0; right: 0; bottom: 90px; /* Để hở thanh player */
            width: 350px;
            background-color: var(--card-bg-current);
            box-shadow: var(--shadow-lg);
            z-index: 1003;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        body.queue-open #queue-sidebar {
            transform: translateX(0);
        }
        #queue-sidebar .queue-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-current);
        }
        #queue-sidebar .queue-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .queue-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        .queue-item:hover { background-color: var(--bg-current); }
        .queue-item.active-song-in-queue { background-color: var(--primary-color) !important; color: white !important; }
        .queue-item img { width: 40px; height: 40px; border-radius: 4px; }
        
        /* ==============================================
        GIAO DIỆN DANH SÁCH NHẠC (LIST VIEW)
        ============================================== */
        .song-list-container {
            display: flex;
            flex-direction: column;
        }
        .song-list-header {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-current);
            color: var(--text-muted-current);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .song-list-item {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        .song-list-item:hover {
            background-color: var(--bg-current);
        }
        .song-list-item .song-index-play {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .song-list-item .index-number {
            transition: opacity var(--transition-fast);
        }
        .song-list-item .play-button {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity var(--transition-fast);
            font-size: 1.5rem;
        }
        .song-list-item:hover .index-number {
            opacity: 0;
        }
        .song-list-item:hover .play-button {
            opacity: 1;
        }
        .song-list-item.active-song .index-number {
            opacity: 0;
        }
        .song-list-item.active-song .play-button {
            opacity: 1;
        }
        .song-list-item .song-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
        }
        .song-list-item .artwork {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
        }
        .song-list-item .title-artist {
            min-width: 0;
        }
        .song-list-item .title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .song-list-item .artist {
            font-size: 0.875rem;
            color: var(--text-muted-current);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .song-list-item.active-song .title {
            color: var(--primary-color);
        }
        .song-list-item .duration {
            text-align: right;
            font-size: 0.875rem;
            color: var(--text-muted-current);
        }

        /* ==============================================
        RESPONSIVE & MOBILE
        ============================================== */
        .hamburger-menu { display: none; }
        .mobile-nav-overlay { display: none; }
        
        @media (max-width: 1024px) {
            .desktop-nav { display: none; }
            .header-layout-wrapper {
                flex-direction: row; /* Keep row for mobile */
                justify-content: space-between;
                align-items: center;
                padding: 0 1rem;
            }
            .header-logo-container {
                width: 80px; /* Smaller logo on mobile */
                max-width: 80px;
                min-width: 60px;
            }
            .header-main-content {
                display: none; /* Hide desktop content on mobile */
            }
            .hamburger-menu-wrapper {
                display: block; /* Show hamburger on mobile */
            }
            .header .main-title { 
                display: none; /* Ensure main title is hidden on mobile */
            }
            .header .desktop-nav {
                display: none; /* Ensure desktop nav is hidden on mobile */
            }
        }

        @media (max-width: 768px) {
            .header { 
                height: auto; 
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            /* Adjust logo size for smaller screens */
            .header-logo-container { width: 60px !important; max-width: 60px !important; } 
            .main-title { font-size: 1.8rem; } /* Adjust title size for mobile (though hidden for now) */
            
            #player-bar {
                grid-template-columns: auto 1fr;
                padding: 0.5rem 1rem;
            }
            #player-bar .player-controls-main {
                grid-column: 1 / -1;
                grid-row: 1;
                padding-bottom: 0.5rem;
            }
            #player-bar .now-playing-info {
                grid-column: 1 / -1;
                grid-row: 2;
                justify-content: center;
            }
            #player-bar .player-actions-right { display: none; }
        }
    </style>
</head>
<body class="theme-default">
    <!-- Màn hình chờ -->
    <div id="splash-screen">
        <div class="stars"></div>
        <div class="stars2"></div>
        <div class="stars3"></div>
        <div id="splash-logo-container">
            <div id="splash-logo-placeholder"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container header-layout-wrapper">
            <div class="header-logo-container">
                <a href="#">
                    <div id="header-logo-placeholder"></div>
                </a>
            </div>
            <div class="header-main-content">
                <h1 class="main-title">PLAY NHẠC MSTQ</h1>
                <!-- Desktop Navigation - Reorganized into 2 rows -->
                <nav class="desktop-nav flex flex-col items-center w-full">
                    <div class="flex items-center justify-center gap-2 mb-2"> <!-- Top row -->
                        <a href="https://sites.google.com/view/thiensutinhquang" class="nav-item group active" target="_blank">
                            <i class="ph-bold ph-house text-2xl"></i>
                            <span class="ml-2">Trang Chủ</span>
                        </a>
                        <a href="https://thiensutinhquang.github.io/Playlist-YouTube/" class="nav-item group" target="_blank">
                            <i class="ph-bold ph-video text-2xl"></i>
                            <span class="ml-2">Xem video</span>
                        </a>
                        <a href="https://thiensutinhquang.github.io/playtholientuc/" class="nav-item group" target="_blank">
                            <i class="ph-bold ph-book-open text-2xl"></i>
                            <span class="ml-2">Kho Thơ</span>
                        </a>
                    </div>
                    <div class="flex items-center justify-center gap-2"> <!-- Bottom row -->
                        <!-- Platforms Dropdown -->
                        <div class="dropdown-container" id="platforms-dropdown-desktop">
                            <button class="dropdown-toggle group" id="platforms-toggle-desktop">
                                <i class="ph-bold ph-globe text-2xl"></i>
                                <span class="ml-2">Các Nền Tảng</span>
                                <i class="ph-bold ph-caret-down ml-2 transition-transform duration-200"></i>
                            </button>
                            <div class="dropdown-menu" id="platforms-menu-desktop"></div>
                        </div>

                        <!-- Theme Dropdown -->
                        <div class="dropdown-container" id="theme-dropdown-desktop">
                            <button class="dropdown-toggle group" id="theme-toggle-desktop">
                                <i class="ph-bold ph-palette text-2xl"></i>
                                <span class="ml-2">Giao diện</span>
                                <i class="ph-bold ph-caret-down ml-2 transition-transform duration-200"></i>
                            </button>
                            <div class="dropdown-menu" id="theme-menu-desktop">
                                 <div id="preset-themes-desktop" class="grid grid-cols-4 gap-2 mb-4"></div>
                                 <div class="flex items-center gap-2 justify-center">
                                     <i class="ph-bold ph-sun text-yellow-500"></i>
                                     <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="darkModeToggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-color"></div></label>
                                     <i class="ph-bold ph-moon text-slate-400"></i>
                                 </div>
                            </div>
                        </div>

                        <!-- Timer Dropdown -->
                        <div class="dropdown-container" id="timer-dropdown-desktop">
                            <button class="dropdown-toggle group" id="timer-toggle-desktop">
                                <i class="ph-bold ph-hourglass text-2xl"></i>
                                <span class="ml-2">Hẹn giờ</span>
                                <i class="ph-bold ph-caret-down ml-2 transition-transform duration-200"></i>
                            </button>
                            <div class="dropdown-menu" id="timer-menu-desktop">
                                <div class="p-4">
                                    <label for="timer-minutes-desktop" class="block text-sm font-medium mb-2 text-current">Số phút:</label>
                                    <input type="number" id="timer-minutes-desktop" min="1" value="30" class="w-full p-2 rounded-md bg-bg-current border border-border-current mb-2 text-current">
                                    <button id="start-timer-btn-desktop" class="timer-action-btn bg-primary-color text-white py-2 rounded-md hover:bg-primary-hover transition-colors mb-2">Bắt đầu</button>
                                    <button id="cancel-timer-btn-desktop" class="timer-action-btn bg-danger-color text-white py-2 rounded-md hover:opacity-80 transition-opacity hidden">Hủy hẹn giờ</button>
                                    <p id="timer-display-desktop" class="text-center text-lg font-bold mt-2 text-current">00:00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="hamburger-menu-wrapper"> <!-- For mobile only -->
                <button class="hamburger-menu" id="hamburger-menu"><i class="ph-bold ph-list"></i></button>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay">
        <div class="mobile-nav-content">
            <button class="close-mobile-menu" id="close-mobile-menu"><i class="ph-bold ph-x"></i></button>
            <div class="flex flex-col gap-2 mt-8">
                 <a href="https://sites.google.com/view/thiensutinhquang" class="nav-item group active" target="_blank">
                    <i class="ph-bold ph-house text-2xl"></i>
                    <span class="ml-2">Trang Chủ</span>
                 </a>
                 <a href="https://thiensutinhquang.github.io/Playlist-YouTube/" class="nav-item group" target="_blank">
                    <i class="ph-bold ph-video text-2xl"></i>
                    <span class="ml-2">Xem video</span>
                 </a>
                 <a href="https://thiensutinhquang.github.io/playtholientuc/" class="nav-item group" target="_blank">
                    <i class="ph-bold ph-book-open text-2xl"></i>
                    <span class="ml-2">Kho Thơ</span>
                 </a>

                <!-- Mobile Platforms Dropdown -->
                <div class="dropdown-container">
                     <button class="dropdown-toggle group" id="platforms-toggle-mobile">
                        <i class="ph-bold ph-globe text-2xl"></i>
                        <span class="ml-2">Các Nền Tảng</span>
                        <i class="ph-bold ph-caret-down ml-auto transition-transform duration-200"></i>
                     </button>
                    <div class="dropdown-menu" id="platforms-menu-mobile"></div>
                </div>

                 <!-- Mobile Theme Dropdown -->
                <div class="dropdown-container">
                    <button class="dropdown-toggle group" id="theme-toggle-mobile">
                        <i class="ph-bold ph-palette text-2xl"></i>
                        <span class="ml-2">Giao diện</span>
                        <i class="ph-bold ph-caret-down ml-auto transition-transform duration-200"></i>
                    </button>
                    <div class="dropdown-menu" id="theme-menu-mobile">
                        <div id="preset-themes-mobile" class="grid grid-cols-4 gap-2 mb-4"></div>
                         <div class="flex items-center gap-2 justify-center">
                             <i class="ph-bold ph-sun text-yellow-500"></i>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="darkModeToggleMobile" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-color"></div></label>
                            <i class="ph-bold ph-moon text-slate-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Mobile Timer Dropdown -->
                <div class="dropdown-container">
                    <button class="dropdown-toggle group" id="timer-toggle-mobile">
                        <i class="ph-bold ph-hourglass text-2xl"></i>
                        <span class="ml-2">Hẹn giờ</span>
                        <i class="ph-bold ph-caret-down ml-auto transition-transform duration-200"></i>
                    </button>
                    <div class="dropdown-menu" id="timer-menu-mobile">
                        <div class="p-4">
                            <label for="timer-minutes-mobile" class="block text-sm font-medium mb-2 text-current">Số phút:</label>
                            <input type="number" id="timer-minutes-mobile" min="1" value="30" class="w-full p-2 rounded-md bg-bg-current border border-border-current mb-2 text-current">
                            <button id="start-timer-btn-mobile" class="timer-action-btn bg-primary-color text-white py-2 rounded-md hover:bg-primary-hover transition-colors mb-2">Bắt đầu</button>
                            <button id="cancel-timer-btn-mobile" class="timer-action-btn bg-danger-color text-white py-2 rounded-md hover:opacity-80 transition-opacity hidden">Hủy hẹn giờ</button>
                            <p id="timer-display-mobile" class="text-center text-lg font-bold mt-2 text-current">00:00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Nội dung chính -->
    <main class="container main-content">
        <div class="main-column space-y-6">
             <div class="card" id="music-section">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                     <h2 class="text-xl font-bold">Thư viện nhạc</h2>
                     <div id="category-menu" class="flex flex-wrap justify-center gap-2"></div>
                </div>
                <!-- Thanh tìm kiếm -->
                <div class="relative mb-4">
                    <input type="search" id="search-input" placeholder="Tìm kiếm bài hát, nghệ sĩ..." class="w-full p-3 pl-10 rounded-lg bg-bg-current border border-border-current focus:ring-2 focus:ring-primary-color focus:outline-none transition-shadow">
                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-muted-current"></i>
                    <button id="search-clear-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-current hover:text-current hidden cursor-pointer"><i class="ph-bold ph-x"></i></button>
                </div>
                <div id="songs-container" class="song-list-container">
                    <div class="song-list-header">
                        <span>#</span>
                        <span>Tiêu đề</span>
                        <span>Thời lượng</span>
                    </div>
                    <div id="song-list-body">
                         <p class="text-center text-muted-current col-span-full p-4">Đang tải thư viện nhạc...</p>
                    </div>
                </div>
                <audio id="audio-player" style="display: none;"></audio>
            </div>
        </div>
    </main>
    
    <!-- Thanh điều khiển nhạc cố định -->
    <div id="player-bar">
        <!-- Thông tin bài hát đang phát -->
        <div class="now-playing-info">
            <img id="player-album-art" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art">
            <div class="text-info">
                <h4 id="player-song-title" class="font-bold truncate">Chưa có nhạc</h4>
                <p id="player-song-artist" class="text-sm text-muted-current truncate">Vui lòng chọn bài hát</p>
            </div>
        </div>

        <!-- Điều khiển chính -->
        <div class="player-controls-main">
            <div class="player-buttons">
                <button id="shuffle-btn" title="Trộn bài"><i class="ph-bold ph-shuffle"></i></button>
                <button id="prev-btn" title="Bài trước"><i class="ph-bold ph-skip-back"></i></button>
                <button id="play-pause-btn" title="Phát/Dừng">
                    <i class="ph-bold ph-play" id="play-icon"></i>
                    <i class="ph-bold ph-pause hidden" id="pause-icon"></i>
                </button>
                <button id="next-btn" title="Bài kế tiếp"><i class="ph-bold ph-skip-forward"></i></button>
                <button id="repeat-btn" title="Lặp lại"><i class="ph-bold ph-repeat"></i></button>
            </div>
            <div class="progress-section">
                <span id="current-time" class="text-xs">0:00</span>
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <span id="duration" class="text-xs">0:00</span>
            </div>
        </div>

        <!-- Các hành động phụ -->
        <div class="player-actions-right">
             <button id="favorite-btn" title="Yêu thích"><i class="ph-bold ph-heart"></i></button>
             <div class="volume-container">
                <i class="ph-bold ph-speaker-high"></i>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" class="w-full h-1 bg-border-current rounded-lg appearance-none cursor-pointer">
             </div>
             <button id="queue-toggle-btn" title="Danh sách chờ"><i class="ph-bold ph-list-music"></i></button>
        </div>
    </div>

    <!-- Danh sách chờ (Queue) -->
    <div id="queue-overlay" class="hidden"></div>
    <div id="queue-sidebar">
        <div class="queue-header">
            <h3 class="text-lg font-bold">Danh sách chờ</h3>
        </div>
        <div class="queue-list">
            <ul id="queue-song-list">
                <!-- Các bài hát trong hàng chờ sẽ được thêm vào đây -->
            </ul>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ==============================================
        // QUẢN LÝ TRẠNG THÁI & BIẾN TOÀN CỤC
        // ==============================================
        const config = {
            USER_HANDLE: "minhsutinhquang",
            genreMap: {'new':"Pop",'hot':"Country",'dieu-thu':"Classical",'others':"Reggae",'phap':"Podcasts"},
            platformLinks: [
                { name: 'YouTube', url: 'https://www.youtube.com/@ThiensuTinhQuang', icon: 'ph-youtube-logo', color: '#FF0000' },
                { name: 'TikTok', url: 'https://www.tiktok.com/@thiensutinhquang', icon: 'ph-tiktok-logo', color: '#000000' },
                { name: 'Facebook', url: 'https://www.facebook.com/groups/minhsutinhquang', icon: 'ph-facebook-logo', color: '#1877F2' },
                { name: 'Telegram', url: 'https://t.me/thiensutinhquang', icon: 'ph-telegram-logo', color: '#24A1DE' },
                { name: 'Zalo', url: 'https://zalo.me/g/vjkhzt168', icon: 'zalo-svg', color: '#0068FF' } // Custom icon type for Zalo
            ],
            presetThemes: [
                { id: 'strong', title: 'Mạnh mẽ', bg: '#003366', cardBg: '#004488', text: '#FFD700', textMuted: '#AAAAAA', border: '#0055AA', style: 'background:linear-gradient(45deg,#003366 50%,#FFD700 50%);' },
                { id: 'gentle', title: 'Dịu nhẹ', bg: '#6A057F', cardBg: '#7B1A8F', text: '#FFB6C1', textMuted: '#E0E0E0', border: '#8C2B9F', style: 'background:linear-gradient(45deg,#6A057F 50%,#FFB6C1 50%);' },
                { id: 'fresh', title: 'Tươi mát', bg: '#228B22', cardBg: '#339B33', text: '#00CED1', textMuted: '#BBEEFF', border: '#44AA44', style: 'background:linear-gradient(45deg,#228B22 50%,#00CED1 50%);' },
                { id: 'modern', title: 'Hiện đại', bg: '#228B22', cardBg: '#339B33', text: '#FFD700', textMuted: '#FFDD77', border: '#44AA44', style: 'background:linear-gradient(45deg,#228B22 50%,#FFD700 50%);' },
                { id: 'warm', title: 'Ấm áp', bg: '#6A057F', cardBg: '#7B1A8F', text: '#FFD700', textMuted: '#FFDD77', border: '#8C2B9F', style: 'background:linear-gradient(45deg,#6A057F 50%,#FFD700 50%);' },
                { id: 'elegant', title: 'Trang nhã', bg: '#003366', cardBg: '#004488', text: '#00CED1', textMuted: '#BBEEFF', border: '#0055AA', style: 'background:linear-gradient(45deg,#003366 50%,#00CED1 50%);' },
                { id: 'tinhquang', title: 'Tinh Quang', bg: '#1a0b2a', cardBg: '#2a1b4a', text: '#FFD700', textMuted: '#e0e0e0', border: '#4a2a6a', style: 'background:radial-gradient(circle at center, #3a1a5a 0%, #1a0b2a 100%); border: 2px solid #FFD700;' },
            ]
        };

        let state = {
            songData: [],
            currentDisplayData: [],
            currentSongIndex: -1,
            isPlaying: false,
            isShuffling: JSON.parse(localStorage.getItem('isShuffling')) || false,
            repeatMode: localStorage.getItem('repeatMode') || 'none', // 'none', 'all', 'one'
            favoriteSongIds: JSON.parse(localStorage.getItem('favoriteSongIds')) || [],
            audiusDiscoveryHost: null,
            fuse: null,
            sleepTimerEndTime: null, // Stores the timestamp when the timer should end
            sleepTimerInterval: null, // Stores the interval ID for the countdown
            activeThemeTimeout: null, // For theme dropdown auto-hide
        };

        let dom = {};
        let logoElements = {};

        // ==============================================
        // CÁC HÀM KHỞI TẠO & CÀI ĐẶT
        // ==============================================

        async function initializeApp() {
            console.log("Ứng dụng đang khởi tạo...");
            
            cacheDOMElements();
            createStars(100, document.querySelector('.stars'));
            createStars(50, document.querySelector('.stars2'));
            createStars(20, document.querySelector('.stars3'));

            await loadAndInjectSVG();
            cacheLogoElements();
            setupEventListeners();
            applyInitialSettings();
            renderPlatformLinks();
            renderThemeButtons();
            renderCategoryButtons();
            
            await fetchAudiusData();
            setupFuse();
            loadCategory('all');

            // Initialize sleep timer display
            cancelSleepTimer(); // Ensure initial state is reset

            dom.splashScreen.classList.add('visible');

            setTimeout(() => {
                dom.splashScreen.classList.add('hidden');
                dom.body.classList.add('app-loaded');
            }, 5000);
            
            console.log("Khởi tạo hoàn tất.");
        }

        function cacheDOMElements() {
            dom = {
                body: document.body,
                html: document.documentElement, // Added for theme management
                splashScreen: document.getElementById('splash-screen'),
                songsContainer: document.getElementById('song-list-body'),
                categoryMenu: document.getElementById('category-menu'),
                audioPlayer: document.getElementById('audio-player'),
                playerBar: document.getElementById('player-bar'),
                playerAlbumArt: document.getElementById('player-album-art'),
                playerSongTitle: document.getElementById('player-song-title'),
                playerSongArtist: document.getElementById('player-song-artist'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                progressBar: document.getElementById('progress-bar'),
                currentTimeEl: document.getElementById('current-time'),
                durationEl: document.getElementById('duration'),
                shuffleBtn: document.getElementById('shuffle-btn'),
                repeatBtn: document.getElementById('repeat-btn'),
                favoriteBtn: document.getElementById('favorite-btn'),
                nextBtn: document.getElementById('next-btn'),
                prevBtn: document.getElementById('prev-btn'),
                volumeSlider: document.getElementById('volume-slider'),
                queueToggleBtn: document.getElementById('queue-toggle-btn'),
                queueSidebar: document.getElementById('queue-sidebar'),
                queueOverlay: document.getElementById('queue-overlay'),
                queueSongList: document.getElementById('queue-song-list'),
                lyricsContentMain: document.getElementById('lyrics-content-main'),
                searchInput: document.getElementById('search-input'),
                searchClearBtn: document.getElementById('search-clear-btn'),
                
                // Timer elements
                timerMinutesDesktop: document.getElementById('timer-minutes-desktop'),
                startTimerBtnDesktop: document.getElementById('start-timer-btn-desktop'),
                cancelTimerBtnDesktop: document.getElementById('cancel-timer-btn-desktop'),
                timerDisplayDesktop: document.getElementById('timer-display-desktop'),
                timerMinutesMobile: document.getElementById('timer-minutes-mobile'),
                startTimerBtnMobile: document.getElementById('start-timer-btn-mobile'),
                cancelTimerBtnMobile: document.getElementById('cancel-timer-btn-mobile'),
                timerDisplayMobile: document.getElementById('timer-display-mobile'),
            };
        }

        function cacheLogoElements() {
             logoElements = {
                chakraSystem: document.querySelector('#header-logo-placeholder #chakra-system'),
                humanBody: document.querySelector('#header-logo-placeholder #human-body'),
                trucChiChanTamText: document.querySelector('#header-logo-placeholder #logo-text-trucchichantam'),
             };
        }

        function createStars(count, container) {
            if (!container) return;
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'absolute bg-white rounded-full';
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animation = `twinkle ${Math.random() * 5 + 3}s linear infinite`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(star);
            }
        }

        async function loadAndInjectSVG() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/thiensutinhquang/PlayMusic/main/LOGOvectorFULL.svg');
                if (!response.ok) throw new Error('Không tải được SVG');
                const svgText = await response.text();
                document.getElementById('splash-logo-placeholder').innerHTML = svgText;
                document.getElementById('header-logo-placeholder').innerHTML = svgText;
            } catch (error) {
                console.error("Lỗi tải SVG:", error);
                document.getElementById('header-logo-placeholder').innerHTML = `<div class="w-16 h-16 bg-primary-color rounded-full flex items-center justify-center text-white font-bold text-2xl">M</div>`;
            }
        }

        function applyInitialSettings() {
            const savedTheme = JSON.parse(localStorage.getItem('themeState')) || { mode: 'light', id: 'default' };
            updateTheme(savedTheme);
            dom.shuffleBtn.classList.toggle('active-control', state.isShuffling);
            updateRepeatButtonUI();
        }
        
        // ==============================================
        // LẤY DỮ LIỆU & RENDER
        // ==============================================

        async function fetchAudiusData() {
            try {
                const hosts = await getAudiusHosts();
                state.audiusDiscoveryHost = hosts[Math.floor(Math.random() * hosts.length)];
                const userResponse = await fetch(`${state.audiusDiscoveryHost}/v1/users/search?query=${config.USER_HANDLE}&app_name=MSTQPlayer`);
                const userData = await userResponse.json();
                if (!userData.data || userData.data.length === 0) throw new Error("Không tìm thấy người dùng");
                const userId = userData.data[0].id;
                const tracksResponse = await fetch(`${state.audiusDiscoveryHost}/v1/users/${userId}/tracks?limit=1000&app_name=MSTQPlayer`);
                const tracksData = await tracksResponse.json();
                state.songData = tracksData.data.map(track => ({
                    id: track.id,
                    title: track.title,
                    artist: track.user ? track.user.name : 'Nghệ sĩ không xác định',
                    artwork: track.artwork ? (track.artwork['480x480'] || track.artwork.url) : `https://placehold.co/150x150/1e293b/f1f5f9?text=${track.title.charAt(0)}`,
                    duration: track.duration,
                    description: track.description || '',
                    genre: track.genre || 'Không rõ'
                }));
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ Audius:", error);
                dom.songsContainer.innerHTML = '<p class="text-center text-red-500 col-span-full">Lỗi khi tải danh sách nhạc. Vui lòng thử lại sau.</p>';
            }
        }

        async function getAudiusHosts() {
            try {
                const response = await fetch('https://api.audius.co');
                if (!response.ok) throw new Error('Không thể lấy danh sách host');
                const data = await response.json();
                return data.data;
            } catch (e) {
                console.warn("Không thể lấy danh sách host từ API, sử dụng danh sách dự phòng.", e.message);
                return ['https://discoveryprovider.audius.co', 'https://discoveryprovider2.audius.co', 'https://discoveryprovider3.audius.co'];
            }
        }
        
        function setupFuse() {
            const options = {
                keys: ['title', 'artist'],
                includeScore: true,
                threshold: 0.4,
            };
            state.fuse = new Fuse(state.songData, options);
        }

        function renderSongs(tracks) {
            state.currentDisplayData = tracks; 
            dom.songsContainer.innerHTML = !tracks || tracks.length === 0 ? '<p class="text-center text-muted-current col-span-full p-4">Không có bài hát nào trong mục này.</p>' : '';
            tracks.forEach((song, displayIndex) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-list-item';
                songItem.dataset.displayIndex = displayIndex; 
                songItem.innerHTML = `
                    <div class="song-index-play">
                        <span class="index-number">${displayIndex + 1}</span>
                        <div class="play-button"><i class="ph-bold ph-play"></i></div>
                    </div>
                    <div class="song-info">
                        <img src="${song.artwork}" alt="${song.title}" class="artwork">
                        <div class="title-artist">
                            <p class="title">${song.title}</p>
                            <p class="artist">${song.artist}</p>
                        </div>
                    </div>
                    <div class="duration">${new Date(song.duration * 1000).toISOString().substr(14, 5)}</div>
                `;
                dom.songsContainer.appendChild(songItem);
            });
            addSongEventListeners();
            renderQueueList(tracks);
            updateUI(); 
        }

        function renderCategoryButtons() {
            const categories = [
                { id: 'all', name: '🎧 Tất cả' }, { id: 'new', name: '🆕 Mới' },
                { id: 'hot', name: '🔥 Nổi bật' }, { id: 'dieu-thu', name: '🎤 Diệu Thu' },
                { id: 'others', name: '👤 Khác' }, { id: 'phap', name: '📿 Pháp' },
                { id: 'favorites', name: '❤️ Yêu thích' }
            ];
            dom.categoryMenu.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'nav-item text-xs'; /* Changed from new-nav-btn to nav-item */
                btn.innerHTML = cat.name;
                btn.dataset.category = cat.id;
                btn.onclick = () => loadCategory(cat.id);
                dom.categoryMenu.appendChild(btn);
            });
        }

        window.loadCategory = (category) => {
            document.querySelectorAll('#category-menu .nav-item').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`#category-menu .nav-item[data-category="${category}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            dom.searchInput.value = ''; // Clear search when changing category
            
            let filteredSongs = state.songData;
            if (category === 'favorites') {
                filteredSongs = state.songData.filter(s => state.favoriteSongIds.includes(s.id));
            } else if (config.genreMap[category]) {
                filteredSongs = state.songData.filter(s => s.genre && s.genre.toLowerCase() === config.genreMap[category].toLowerCase());
            }
            renderSongs(filteredSongs);
        };

        function renderQueueList(songs) {
            dom.queueSongList.innerHTML = '';
            if (!songs || songs.length === 0) return;
            songs.forEach((song) => {
                const globalIndex = state.songData.findIndex(s => s.id === song.id);
                const li = document.createElement('li');
                li.className = 'queue-item';
                li.dataset.index = globalIndex;
                li.innerHTML = `
                    <img src="${song.artwork}" alt="${song.title}" class="w-10 h-10 rounded-md">
                    <div class="flex-grow min-w-0">
                        <p class="font-semibold truncate">${song.title}</p>
                        <p class="text-sm text-muted-current truncate">${song.artist}</p>
                    </div>
                `;
                li.addEventListener('click', () => playSong(globalIndex));
                dom.queueSongList.appendChild(li);
            });
        }

        // ==============================================
        // ĐIỀU KHIỂN TRÌNH PHÁT
        // ==============================================
        
        function playSong(globalIndex) {
            if (globalIndex < 0 || globalIndex >= state.songData.length) return;
            
            state.currentSongIndex = globalIndex;
            const song = state.songData[globalIndex];
            dom.audioPlayer.src = `${state.audiusDiscoveryHost}/v1/tracks/${song.id}/stream?app_name=MSTQPlayer`;
            dom.audioPlayer.play().catch(e => console.error("Lỗi phát nhạc:", e));
            updateMediaSession();
            updateUI();
        }
        
        function playNext() {
            if (state.songData.length === 0) return;
            let nextIndex;
            if (state.isShuffling) {
                do { nextIndex = Math.floor(Math.random() * state.songData.length); } while (state.songData.length > 1 && nextIndex === state.currentSongIndex);
            } else {
                nextIndex = (state.currentSongIndex + 1) % state.songData.length;
            }
            playSong(nextIndex);
        }

        function playPrev() {
            if (state.songData.length === 0) return;
            let prevIndex;
            if (state.isShuffling) {
                do { prevIndex = Math.floor(Math.random() * state.songData.length); } while (state.songData.length > 1 && prevIndex === state.currentSongIndex);
            } else {
                prevIndex = (state.currentSongIndex - 1 + state.songData.length) % state.songData.length;
            }
            playSong(prevIndex);
        }

        function togglePlayPause() {
            if (state.currentSongIndex === -1 && state.songData.length > 0) {
                playSong(0);
            } else {
                if (dom.audioPlayer.paused) dom.audioPlayer.play();
                else dom.audioPlayer.pause();
            }
        }
        
        // ==============================================
        // CẬP NHẬT GIAO DIỆN & HIỆU ỨNG
        // ==============================================

        function updateUI() {
            const song = state.songData[state.currentSongIndex];
            state.isPlaying = !dom.audioPlayer.paused;

            if (song) {
                dom.playerSongTitle.textContent = song.title;
                dom.playerSongArtist.textContent = song.artist;
                dom.playerAlbumArt.src = song.artwork;
                if(dom.lyricsContentMain) dom.lyricsContentMain.innerHTML = song.description ? song.description.replace(/\n/g, '<br>') : '<p class="text-muted-current">Không có lời bài hát.</p>';
                dom.favoriteBtn.classList.toggle('liked', state.favoriteSongIds.includes(song.id));
                dom.favoriteBtn.innerHTML = state.favoriteSongIds.includes(song.id) ? '<i class="ph-fill ph-heart"></i>' : '<i class="ph-bold ph-heart"></i>';
            }

            dom.playIcon.classList.toggle('hidden', state.isPlaying);
            dom.pauseIcon.classList.toggle('hidden', !state.isPlaying);
            
            document.querySelectorAll('.song-list-item').forEach(item => {
                const itemSong = state.currentDisplayData[parseInt(item.dataset.displayIndex)];
                if(!itemSong) return;
                item.classList.toggle('active-song', song && itemSong.id === song.id);
                const indicatorIcon = item.querySelector('.play-button i');
                if (indicatorIcon) indicatorIcon.className = (song && itemSong.id === song.id && state.isPlaying) ? 'ph-bold ph-speaker-high text-primary-color' : 'ph-bold ph-play';
            });

            document.querySelectorAll('#queue-song-list li').forEach(item => {
                item.classList.toggle('active-song-in-queue', parseInt(item.dataset.index) === state.currentSongIndex);
            });

            if (state.isPlaying) {
                activateLogoAnimations();
            } else {
                deactivateLogoAnimations();
            }
        }
        
        function activateLogoAnimations() {
            if (logoElements.humanBody) logoElements.humanBody.classList.add('breathing-effect');
            if (logoElements.chakraSystem) logoElements.chakraSystem.classList.add('energy-flow-active');
            if (logoElements.trucChiChanTamText) logoElements.trucChiChanTamText.classList.add('highlight-text');
        }

        function deactivateLogoAnimations() {
            if (logoElements.humanBody) logoElements.humanBody.classList.remove('breathing-effect');
            if (logoElements.chakraSystem) logoElements.chakraSystem.classList.remove('energy-flow-active');
            if (logoElements.trucChiChanTamText) logoElements.trucChiChanTamText.classList.remove('highlight-text');
        }

        function updateProgress() {
            const { currentTime, duration } = dom.audioPlayer;
            if(duration) {
                dom.progressBar.style.width = `${(currentTime / duration) * 100}%`;
                dom.currentTimeEl.textContent = new Date(currentTime * 1000).toISOString().substr(14, 5);
                dom.durationEl.textContent = new Date(duration * 1000).toISOString().substr(14, 5);
            }
        }

        function updateRepeatButtonUI() {
            dom.repeatBtn.classList.toggle('active-control', state.repeatMode !== 'none');
            dom.repeatBtn.innerHTML = state.repeatMode === 'one' ? '<i class="ph-bold ph-repeat-once"></i>' : '<i class="ph-bold ph-repeat"></i>';
        }

        function updateTheme(theme) {
            localStorage.setItem('themeState', JSON.stringify(theme));
            
            // Remove all preset theme classes and dark mode class first
            dom.html.removeAttribute('data-theme');
            dom.body.classList.remove('dark-mode');
            document.querySelectorAll('.preset-theme-btn').forEach(b => b.classList.remove('active'));

            if (theme.mode === 'dark') {
                dom.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
                document.getElementById('darkModeToggleMobile').checked = true;
            } else if (theme.mode === 'light') {
                document.getElementById('darkModeToggle').checked = false;
                document.getElementById('darkModeToggleMobile').checked = false;
            } else if (theme.mode === 'preset' && theme.id) {
                dom.html.setAttribute('data-theme', theme.id);
                // Find and activate the corresponding preset button
                document.querySelectorAll(`.preset-theme-btn[data-theme="${theme.id}"]`).forEach(btn => btn.classList.add('active'));
                // Ensure dark mode toggle is off for preset themes
                document.getElementById('darkModeToggle').checked = false;
                document.getElementById('darkModeToggleMobile').checked = false;
            }
        }

        function updateMediaSession() {
            if ('mediaSession' in navigator) {
                const song = state.songData[state.currentSongIndex];
                if (!song) return;
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: song.artist,
                    album: 'Play Nhạc MSTQ',
                    artwork: [{ src: song.artwork, sizes: '512x512', type: 'image/jpeg' }]
                });
            }
        }

        // ==============================================
        // CÁC HÀM TIỆN ÍCH & SỰ KIỆN
        // ==============================================

        function setupEventListeners() {
            // Player controls
            dom.playPauseBtn.addEventListener('click', togglePlayPause);
            dom.nextBtn.addEventListener('click', playNext);
            dom.prevBtn.addEventListener('click', playPrev);
            dom.shuffleBtn.addEventListener('click', () => {
                state.isShuffling = !state.isShuffling;
                localStorage.setItem('isShuffling', state.isShuffling);
                dom.shuffleBtn.classList.toggle('active-control', state.isShuffling);
            });
            dom.repeatBtn.addEventListener('click', () => {
                const modes = ['none', 'all', 'one'];
                state.repeatMode = modes[(modes.indexOf(state.repeatMode) + 1) % modes.length];
                localStorage.setItem('repeatMode', state.repeatMode);
                updateRepeatButtonUI();
            });
            dom.favoriteBtn.addEventListener('click', () => {
                if (state.currentSongIndex !== -1) {
                    const songId = state.songData[state.currentSongIndex].id;
                    const index = state.favoriteSongIds.indexOf(songId);
                    if (index > -1) state.favoriteSongIds.splice(index, 1);
                    else state.favoriteSongIds.push(songId);
                    localStorage.setItem('favoriteSongIds', JSON.stringify(state.favoriteSongIds));
                    if(document.querySelector('#category-menu .active')?.dataset.category === 'favorites') loadCategory('favorites');
                    updateUI();
                }
            });

            // Audio events
            dom.audioPlayer.addEventListener('play', () => { state.isPlaying = true; updateUI(); updateMediaSession(); });
            dom.audioPlayer.addEventListener('pause', () => { state.isPlaying = false; updateUI(); });
            dom.audioPlayer.addEventListener('ended', () => {
                if (state.repeatMode === 'one') playSong(state.currentSongIndex);
                else playNext();
            });
            dom.audioPlayer.addEventListener('timeupdate', updateProgress);
            
            // Progress bar
            document.getElementById('progress-container').addEventListener('click', (e) => {
                if(dom.audioPlayer.duration) dom.audioPlayer.currentTime = (e.offsetX / e.currentTarget.clientWidth) * dom.audioPlayer.duration;
            });
            
            // Volume
            dom.volumeSlider.addEventListener('input', (e) => { dom.audioPlayer.volume = e.target.value; });

            // Search
            dom.searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                dom.searchClearBtn.classList.toggle('hidden', !query);
                if (query) {
                    const results = state.fuse.search(query).map(result => result.item);
                    renderSongs(results);
                } else {
                    const activeCategory = document.querySelector('#category-menu .active')?.dataset.category || 'all';
                    loadCategory(activeCategory);
                }
            });
            dom.searchClearBtn.addEventListener('click', () => {
                dom.searchInput.value = '';
                dom.searchClearBtn.classList.add('hidden');
                const activeCategory = document.querySelector('#category-menu .active')?.dataset.category || 'all';
                loadCategory(activeCategory);
            });

            // Queue
            dom.queueToggleBtn.addEventListener('click', () => dom.body.classList.toggle('queue-open'));
            dom.queueOverlay.addEventListener('click', () => dom.body.classList.remove('queue-open'));

            // Timer controls
            dom.startTimerBtnDesktop.addEventListener('click', () => startSleepTimer(parseInt(dom.timerMinutesDesktop.value)));
            dom.cancelTimerBtnDesktop.addEventListener('click', cancelSleepTimer);
            dom.timerMinutesDesktop.addEventListener('input', () => { // Clear timer if input changes
                if (state.sleepTimerInterval) cancelSleepTimer();
            });

            dom.startTimerBtnMobile.addEventListener('click', () => startSleepTimer(parseInt(dom.timerMinutesMobile.value)));
            dom.cancelTimerBtnMobile.addEventListener('click', cancelSleepTimer);
            dom.timerMinutesMobile.addEventListener('input', () => { // Clear timer if input changes
                if (state.sleepTimerInterval) cancelSleepTimer();
            });

            // Navigation and Theme
            setupNavEvents();
        }

        function addSongEventListeners() {
            document.querySelectorAll('.song-list-item').forEach(item => {
                item.addEventListener('click', () => {
                    const song = state.currentDisplayData[parseInt(item.dataset.displayIndex)];
                    const globalIndex = state.songData.findIndex(s => s.id === song.id);
                    playSong(globalIndex);
                });
            });
        }
        
        function setupNavEvents() {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
            const closeMobileMenu = document.getElementById('close-mobile-menu');

            // Hamburger menu toggle
            hamburgerMenu.addEventListener('click', () => mobileNavOverlay.classList.add('active'));
            closeMobileMenu.addEventListener('click', () => mobileNavOverlay.classList.remove('active'));
            mobileNavOverlay.addEventListener('click', (e) => { 
                if (e.target === mobileNavOverlay) mobileNavOverlay.classList.remove('active'); 
            });
            
            // Function to toggle dropdowns
            const toggleDropdown = (toggleId, menuId) => {
                const toggleBtn = document.getElementById(toggleId);
                const menu = document.getElementById(menuId);
                let timeoutId;

                const hideMenu = () => {
                    menu.classList.remove('show');
                    toggleBtn.classList.remove('open'); // Remove 'open' class for caret rotation
                };

                const showMenu = () => {
                    // Close all other dropdowns first
                    document.querySelectorAll('.dropdown-menu.show').forEach(openMenu => {
                        if (openMenu !== menu) openMenu.classList.remove('show');
                    });
                    document.querySelectorAll('.dropdown-toggle.open').forEach(openToggle => {
                        if (openToggle !== toggleBtn) openToggle.classList.remove('open');
                    });

                    menu.classList.add('show');
                    toggleBtn.classList.add('open'); // Add 'open' class for caret rotation
                    
                    // Clear any existing timeout and set a new one for auto-hide (for theme and timer dropdown)
                    if (toggleId.includes('theme-toggle') || toggleId.includes('timer-toggle')) {
                        clearTimeout(state.activeThemeTimeout);
                        state.activeThemeTimeout = setTimeout(hideMenu, 7000); // Auto-hide after 7 seconds
                    }
                };

                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click from bubbling to window and closing
                    if (menu.classList.contains('show')) {
                        hideMenu();
                    } else {
                        showMenu();
                    }
                });

                // Prevent clicks inside the menu from closing it immediately
                menu.addEventListener('click', (e) => e.stopPropagation());

                // Close dropdowns when clicking outside
                window.addEventListener('click', (e) => {
                    if (menu.classList.contains('show') && !menu.contains(e.target) && !toggleBtn.contains(e.target)) {
                        hideMenu();
                    }
                });
            };

            // Setup dropdowns for desktop
            toggleDropdown('platforms-toggle-desktop', 'platforms-menu-desktop');
            toggleDropdown('theme-toggle-desktop', 'theme-menu-desktop');
            toggleDropdown('timer-toggle-desktop', 'timer-menu-desktop');
            
            // Setup dropdowns for mobile
            toggleDropdown('platforms-toggle-mobile', 'platforms-menu-mobile');
            toggleDropdown('theme-toggle-mobile', 'theme-menu-mobile');
            toggleDropdown('timer-toggle-mobile', 'timer-menu-mobile');

            // Dark Mode Toggles
            [document.getElementById('darkModeToggle'), document.getElementById('darkModeToggleMobile')].forEach(toggle => {
                toggle.addEventListener('change', (e) => updateTheme({ mode: e.target.checked ? 'dark' : 'light' }));
            });
        }

        function renderPlatformLinks() {
            const containers = [document.getElementById('platforms-menu-desktop'), document.getElementById('platforms-menu-mobile')];
            const zaloSvg = `<svg viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5">
                <path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 456c-114.9 0-208-93.1-208-208S141.1 48 256 48s208 93.1 208 208-93.1 208-208 208zm-22.6-261.2c-1.5-1.5-3.5-2.2-5.7-2.2H168.4c-4.4 0-8 3.6-8 8v123.6c0 4.4 3.6 8 8 8h59.3c4.4 0 8-3.6 8-8v-60.6l28.7 28.7c1.5 1.5 3.5 2.2 5.7 2.2h15.2c4.4 0 8-3.6 8-8V194.8c0-4.4-3.6-8-8-8h-15.2c-2.2 0-4.2-.7-5.7-2.2L233.4 162.6zM343.6 288.4c-1.5-1.5-3.5-2.2-5.7-2.2h-59.3c-4.4 0-8 3.6-8 8v60.6l-28.7-28.7c-1.5-1.5-3.5-2.2-5.7-2.2h-15.2c-4.4 0-8 3.6-8 8v59.3c0 4.4 3.6 8 8 8h59.3c4.4 0 8-3.6 8-8v-60.6l28.7 28.7c1.5 1.5 3.5 2.2 5.7 2.2h15.2c4.4 0 8-3.6 8-8v-59.3c0-4.4-3.6-8-8-8z"/>
            </svg>`;

            containers.forEach(container => {
                container.innerHTML = '';
                config.platformLinks.forEach(link => {
                    const iconHtml = link.icon === 'zalo-svg' ? zaloSvg : `<i class="ph-bold ${link.icon}"></i>`;
                    const linkElement = document.createElement('a');
                    linkElement.href = link.url;
                    linkElement.target = "_blank";
                    linkElement.innerHTML = `${iconHtml} ${link.name}`;
                    linkElement.querySelector('svg, i').style.color = link.color; // Apply color to icon
                    container.appendChild(linkElement);
                });
            });
        }

        function renderThemeButtons() {
            const containers = [document.getElementById('preset-themes-desktop'), document.getElementById('preset-themes-mobile')];
            containers.forEach(container => {
                if(container) {
                    container.innerHTML = '';
                    config.presetThemes.forEach(theme => {
                        const btn = document.createElement('button');
                        btn.className = 'preset-theme-btn';
                        btn.title = theme.title;
                        btn.dataset.theme = theme.id;
                        btn.style.cssText = theme.style;
                        btn.onclick = () => updateTheme({ mode: 'preset', id: theme.id, bg: theme.bg, text: theme.text, cardBg: theme.cardBg, border: theme.border, textMuted: theme.textMuted });
                        container.appendChild(btn);
                    });
                }
            });
        }

        // ==============================================
        // HẸN GIỜ TẮT NHẠC
        // ==============================================
        function startSleepTimer(minutes) {
            if (minutes <= 0 || isNaN(minutes)) {
                // Using a simple alert for now. For a production app, this should be a custom modal.
                alert("Vui lòng nhập số phút hợp lệ (lớn hơn 0).");
                return;
            }

            cancelSleepTimer(); // Clear any existing timer first

            const endTime = Date.now() + minutes * 60 * 1000;
            state.sleepTimerEndTime = endTime;

            // Show cancel button, hide start button for both desktop and mobile
            dom.startTimerBtnDesktop.classList.add('hidden');
            dom.cancelTimerBtnDesktop.classList.remove('hidden');
            dom.startTimerBtnMobile.classList.add('hidden');
            dom.cancelTimerBtnMobile.classList.remove('hidden');

            // Initial update of display
            updateSleepTimerDisplay();

            state.sleepTimerInterval = setInterval(() => {
                updateSleepTimerDisplay();
                if (Date.now() >= state.sleepTimerEndTime) {
                    console.log("Hẹn giờ tắt nhạc đã hết.");
                    dom.audioPlayer.pause(); // Pause the music
                    cancelSleepTimer(); // Clear timer and reset UI
                }
            }, 1000); // Update every second
        }

        function updateSleepTimerDisplay() {
            const remainingTimeMs = state.sleepTimerEndTime - Date.now();
            if (remainingTimeMs <= 0) {
                dom.timerDisplayDesktop.textContent = '00:00';
                dom.timerDisplayMobile.textContent = '00:00';
                return;
            }

            const totalSeconds = Math.floor(remainingTimeMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            dom.timerDisplayDesktop.textContent = formattedTime;
            dom.timerDisplayMobile.textContent = formattedTime;
        }

        function cancelSleepTimer() {
            if (state.sleepTimerInterval) {
                clearInterval(state.sleepTimerInterval);
                state.sleepTimerInterval = null;
            }
            state.sleepTimerEndTime = null; // Clear end time
            dom.timerDisplayDesktop.textContent = '00:00';
            dom.timerDisplayMobile.textContent = '00:00';
            
            // Hide cancel button, show start button for both desktop and mobile
            dom.startTimerBtnDesktop.classList.remove('hidden');
            dom.cancelTimerBtnDesktop.classList.add('hidden');
            dom.startTimerBtnMobile.classList.remove('hidden');
            dom.cancelTimerBtnMobile.classList.add('hidden');
        }

        // ==============================================
        // KHỞI CHẠY ỨNG DỤNG
        // ==============================================
        initializeApp();
    });
    </script>
</body>
</html>
