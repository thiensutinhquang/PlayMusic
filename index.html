<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>N·ªôi dung k√™nh Multimedia MSTQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
        /* ==============================================
        DESIGN SYSTEM & CSS VARIABLES
        ==============================================
        */
        :root {
            /* Color Palette */
            --primary-color: #f59e0b; /* Amber 500 */
            --primary-hover: #d97706; /* Amber 600 */
            --secondary-color: #3b82f6; /* Blue 500 */
            --danger-color: #ef4444; /* Red 500 */
            
            /* Light Mode Colors */
            --bg-light: #f1f5f9; /* Slate 100 */
            --card-bg-light: #ffffff;
            --text-light: #1e293b; /* Slate 800 */
            --text-muted-light: #64748b; /* Slate 500 */
            --border-light: #e2e8f0; /* Slate 200 */

            /* Dark Mode Colors */
            --bg-dark: #0f172a; /* Slate 900 */
            --card-bg-dark: #1e293b; /* Slate 800 */
            --text-dark: #e2e8f0; /* Slate 200 */
            --text-muted-dark: #94a3b8; /* Slate 400 */
            --border-dark: #334155; /* Slate 700 */

            /* Custom Preset Colors */
            --preset-bg-blue-dark: #003366;
            --preset-bg-purple-dream: #6A057F;
            --preset-bg-forest-green: #228B22;
            --preset-text-yellow: #FFD700;
            --preset-text-aqua: #00CED1;
            --preset-text-pink-pastel: #FFB6C1;

            /* Tinh Quang Theme */
            --preset-bg-tinhquang: #1a0b2a; /* Dark violet/purple for deep space feel */
            --preset-text-tinhquang: #FFD700; /* Gold for highlights */
            --preset-text-muted-tinhquang: #e0e0e0; /* Lighter grey for secondary text */
            --preset-border-tinhquang: #4a2a6a; /* Darker purple for borders */


            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            /* Transitions */
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);

            /* Typography */
            --font-sans: 'Be Vietnam Pro', sans-serif;

            /* Set default theme to light */
            --bg-current: var(--bg-light);
            --card-bg-current: var(--card-bg-light);
            --text-current: var(--text-light);
            --text-muted-current: var(--text-muted-light);
            --border-current: var(--border-light);
        }

        body.dark-mode {
            --bg-current: var(--bg-dark);
            --card-bg-current: var(--card-bg-dark);
            --text-current: var(--text-dark);
            --text-muted-current: var(--text-muted-dark);
            --border-current: var(--border-dark);
        }

        body.preset-theme {
            --bg-current: var(--preset-bg-current);
            --card-bg-current: var(--preset-bg-current);
            --text-current: var(--preset-text-current);
            --text-muted-current: var(--preset-text-muted-current); /* Use specific muted for preset */
            --border-current: var(--preset-border-current); /* Use specific border for preset */
        }
        
        /* ==============================================
        BASE & GLOBAL STYLES
        ==============================================
        */
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-current);
            color: var(--text-current);
            transition: background-color var(--transition-fast), color var(--transition-fast);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
        }
        
        .card {
            background-color: var(--card-bg-current);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-current);
            transition: var(--transition-fast);
            padding: 1.25rem 1.5rem; /* Consistent padding */
        }
        
        /* ==============================================
        HEADER & NAVIGATION
        ==============================================
        */
        .header {
            background-color: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid var(--border-current);
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }
        
        body.dark-mode .header {
            background-color: rgba(15, 23, 42, 0.7);
        }
        body.preset-theme .header {
             background-color: rgba(0,0,0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo img {
            height: 40px; /* Adjust as needed */
            width: 40px; /* Adjust as needed */
            border-radius: 8px;
            object-fit: cover;
            transition: transform 0.5s ease-in-out, filter 0.5s ease-in-out;
        }

        .logo h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo a {
            color: var(--text-current);
            text-decoration: none;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .logo a:hover {
             color: var(--primary-color);
        }
        
        .new-nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: transparent;
            color: var(--text-muted-current);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            border: 2px solid transparent;
            transition: var(--transition-fast);
            white-space: nowrap;
        }
        
        .new-nav-btn:hover {
            color: var(--text-current);
            background-color: var(--bg-current);
        }

        .new-nav-btn.active {
            color: var(--primary-color);
            font-weight: 700;
            background-color: var(--bg-current);
        }
        
        .platforms-dropdown, .theme-dropdown { position: relative; }
        
        .platforms-menu, .theme-menu {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: var(--card-bg-current);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-current);
            width: 220px;
            z-index: 1010;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .theme-menu {
            padding: 1rem;
            width: auto;
        }
        
        .platforms-menu.show, .theme-menu.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .platforms-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            color: var(--text-muted-current);
            text-decoration: none;
            transition: var(--transition-fast);
            font-size: 0.95rem;
        }
        
        .platforms-menu a:hover {
            background-color: var(--primary-color);
            color: #fff;
        }
        
        .platforms-menu a i, .platforms-menu a .zalo-svg {
            font-size: 1.25rem;
            width: 20px; text-align: center;
        }
        
        .hamburger-menu { display: none; }
        .mobile-nav-overlay { display: none; }
        
        /* THEME PRESET BUTTONS */
        .preset-theme-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--border-current);
            transition: var(--transition-fast);
        }
        .preset-theme-btn:hover {
            transform: scale(1.15);
        }
        .preset-theme-btn.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        /* ==============================================
        MAIN CONTENT LAYOUT
        ==============================================
        */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem; /* Increased gap */
            margin-top: 2rem;
        }
        
        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr 350px; /* Main content and a sidebar */
            }
            .sidebar-column {
                position: sticky;
                top: 90px; /* Header height + some margin */
                align-self: start;
            }
        }
        
        /* ==============================================
        MUSIC PLAYER & LIST
        ==============================================
        */
        #popup-album-art {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--card-bg-current);
            transition: transform 0.8s ease-in-out, opacity 0.5s ease;
        }
        
        .fade-out {
            opacity: 0 !important;
        }

        #popup-album-art.spinning {
             animation: spin 8s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .player-controls button, #popup-open-lyrics-btn {
            background-color: transparent;
            color: var(--text-muted-current);
            border: none;
            border-radius: 50%;
            width: 44px; height: 44px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex; align-items: center; justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .player-controls button .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: ripple-effect 0.6s linear;
        }
        
        @keyframes ripple-effect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .player-controls button:hover, #popup-open-lyrics-btn:hover {
            background-color: var(--bg-current);
            color: var(--text-current);
        }
        
        .player-controls #popup-play-pause-btn {
            width: 56px; height: 56px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1.75rem;
        }

        .player-controls #popup-play-pause-btn:hover {
            background-color: var(--primary-hover);
        }
        
        .player-controls button.active-control, #popup-repeat-btn.active-control {
            color: var(--primary-color);
        }

        #popup-favorite-btn.liked {
            color: var(--danger-color);
        }
        
        .song-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1.25rem;
        }

        .song-grid-item {
            position: relative;
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .song-grid-item .artwork {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition-slow);
        }
        
        .song-grid-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            opacity: 0;
            transition: var(--transition-slow);
        }

        .song-grid-item:hover::after, .song-grid-item.active-song::after {
            opacity: 1;
        }
        
        .song-grid-item:hover .artwork, .song-grid-item.active-song .artwork {
            transform: scale(1.1);
        }
        
        .song-grid-item:hover {
            box-shadow: 0 0 15px 5px rgba(245, 158, 11, 0.4);
        }
        
        .song-grid-item .info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.5rem;
            color: white;
            transform: translateY(10px);
            opacity: 0;
            transition: var(--transition-slow);
            z-index: 2;
        }

        .song-grid-item:hover .info, .song-grid-item.active-song .info {
            transform: translateY(0);
            opacity: 1;
        }

        .song-grid-item .title {
            font-weight: 500;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-grid-item.active-song {
            box-shadow: 0 0 0 3px var(--primary-color), var(--shadow-lg);
        }
        
        .song-grid-item .play-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 44px;
            height: 44px;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            opacity: 0;
            transition: var(--transition-slow);
            pointer-events: none;
            z-index: 3;
        }

        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        #lyrics-display-area {
            position: relative;
        }

        #lyrics-display-area #lyrics-content-main {
            font-size: 1.1rem;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text-muted-current);
            white-space: pre-wrap;
            text-align: center;
        }
        
        #view-more-lyrics-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            background-color: var(--bg-current);
            border: 1px solid var(--border-current);
            color: var(--text-muted-current);
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        #view-more-lyrics-btn:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        #popup-playlist-container li.active-song-in-list {
            background-color: var(--primary-color) !important;
            color: white !important;
            font-weight: bold;
        }

        .progress-container {
            height: 4px;
            background-color: var(--border-current);
            cursor: pointer;
            transition: height 0.2s ease;
            position: relative;
        }
        .progress-container:hover {
            height: 8px;
        }
        
        .progress-bar {
            background-color: var(--primary-color);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.1s linear;
        }
        
        #progress-tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            bottom: 20px; /* Position above the bar */
            transform: translateX(-50%);
            pointer-events: none; /* So it doesn't interfere with mouse events on the bar */
            white-space: nowrap;
            display:none;
        }
        .progress-container:hover #progress-tooltip {
            display: block;
        }

        /* ==============================================
        FULLSCREEN LYRICS POPUP
        ==============================================
        */
        #lyrics-fullscreen-popup {
            position: fixed; inset: 0;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            z-index: 5000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #lyrics-fullscreen-popup.show {
            opacity: 1; visibility: visible;
        }
        #lyrics-fullscreen-popup .lyrics-popup-content {
            background-color: var(--card-bg-current);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            width: 90%; max-width: 48rem;
            max-height: calc(100vh - 4rem);
            display: flex; flex-direction: column;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #lyrics-fullscreen-popup.show .lyrics-popup-content {
            transform: scale(1);
        }
        
        #lyrics-fullscreen-popup .close-button {
            position: absolute;
            top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.5rem;
            color: var(--text-muted-current); 
            cursor: pointer;
            transition: var(--transition-fast);
        }
        #lyrics-fullscreen-popup .close-button:hover {
            color: var(--primary-color);
        }
        
        #lyrics-fullscreen-popup #full-lyrics-display {
             font-size: 1.5rem;
             line-height: 1.8;
             white-space: pre-wrap;
             text-align: center;
             overflow-y: auto;
             flex-grow: 1;
             padding: 1rem;
        }
        
         .lyrics-nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2em;
            color: var(--text-muted-current);
            opacity: 0.5;
            cursor: pointer;
            transition: var(--transition-fast);
            z-index: 10;
        }
        .lyrics-nav-arrow:hover {
            opacity: 1;
            color: var(--primary-color);
        }
        .lyrics-nav-arrow.disabled {
            opacity: 0.1;
            cursor: not-allowed;
        }
        .left-arrow { left: 1rem; }
        .right-arrow { right: 1rem; }

        #lyrics-radial-menu-container {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 5010;
        }

        #radial-menu-toggle-btn {
            background-color: var(--primary-color);
            color: #333;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            z-index: 1;
            box-shadow: var(--shadow-md);
            transition: var(--transition-fast);
        }

        .radial-item {
            position: absolute;
            background-color: var(--card-bg-current);
            color: var(--text-current);
            border: 1px solid var(--border-current);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transform: translate(0, 0) scale(0.5);
            transition: var(--transition-slow);
            pointer-events: none;
        }
        #lyrics-radial-menu-container.active .radial-item {
            opacity: 1;
            transform: translate(var(--x), var(--y)) scale(1);
            pointer-events: all;
        }
        
        /* ==============================================
        MODAL & RESPONSIVE
        ==============================================
        */
        #custom-alert-modal {
            position: fixed; inset: 0;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            z-index: 6000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        #custom-alert-modal.show {
            opacity: 1; visibility: visible;
        }
        #custom-alert-content {
             background-color: var(--card-bg-current);
             padding: 1.5rem;
             border-radius: 12px;
             box-shadow: var(--shadow-lg);
             text-align: center;
             max-width: 400px; width: 90%;
        }

        /* ==============================================
        SPLASH SCREEN
        ==============================================
        */
        #splash-screen {
            position: fixed;
            inset: 0;
            background-color: #0a0a0a; /* Dark background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-out, visibility 1s ease-out;
            visibility: visible;
            overflow: hidden;
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        #splash-logo-container {
            position: relative;
            width: 200px; /* Adjust size as needed */
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: breathe 4s infinite ease-in-out; /* Breathing effect */
        }

        #splash-logo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: brightness(1.2); /* Slightly brighter */
        }

        /* Starry background effect */
        #splash-screen::before {
            content: '';
            position: absolute;
            inset: 0;
            /* Enhanced radial gradients for more stars and colors */
            background: 
                radial-gradient(2px 2px at 20px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(3px 3px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 70px 10px, #aaa, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 100px 50px, #ff0, rgba(0,0,0,0)),
                radial-gradient(4px 4px at 120px 80px, #fff, rgba(0,0,0,0)),
                radial-gradient(5px 5px at 150px 100px, #ffcc00, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 200px 150px, #ff6347, rgba(0,0,0,0)),
                radial-gradient(3px 3px at 50px 100px, #a6a6ff, rgba(0,0,0,0)), /* New color star */
                radial-gradient(4px 4px at 150px 80px, #ffb3ff, rgba(0,0,0,0)), /* New color star */
                radial-gradient(2px 2px at 250px 200px, #f1c40f, rgba(0,0,0,0)), /* New color star */
                radial-gradient(2px 2px at 100px 300px, #1abc9c, rgba(0,0,0,0)), /* New color star */
                radial-gradient(3px 3px at 300px 400px, #3498db, rgba(0,0,0,0)), /* New color star */
                radial-gradient(5px 5px at 400px 500px, #9b59b6, rgba(0,0,0,0)), /* New color star */
                radial-gradient(1px 1px at 500px 600px, #e74c3c, rgba(0,0,0,0));
            background-size: 150px 150px; /* Base size for star pattern */
            /* Combined animations for movement and twinkling */
            animation: move-stars 200s linear infinite, twinkle-stars 2s infinite alternate; 
        }

        @keyframes move-stars {
            0% { background-position: 0 0; }
            100% { background-position: 100% 100%; }
        }

        /* New twinkling animation */
        @keyframes twinkle-stars {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Chakra light effect (stronger) */
        .chakra-glow-overlay {
            position: absolute;
            inset: 0;
            /* Stronger glow with increased opacity and larger initial scale */
            background: radial-gradient(circle at center, rgba(255,255,255,0.6) 0%, transparent 70%);
            opacity: 0;
            animation: chakra-pulse 1.5s infinite ease-in-out; /* Faster pulse */
            pointer-events: none;
        }

        #popup-album-art.playing .chakra-glow-overlay {
            opacity: 1; /* Show when playing */
        }

        @keyframes chakra-pulse {
            0% { transform: scale(0.8); opacity: 0; } /* Start smaller, fully transparent */
            50% { transform: scale(1.3); opacity: 1; } /* Expand more, fully opaque */
            100% { transform: scale(0.8); opacity: 0; } /* Shrink, fade out */
        }

        /* Breathing animation for logo (enhanced with color pulse and stronger glow) */
        @keyframes breathe {
            0% { 
                transform: scale(1); 
                filter: brightness(1) hue-rotate(0deg); 
                box-shadow: 0 0 0px 0px rgba(255, 215, 0, 0); /* Start with no shadow */
            }
            50% { 
                transform: scale(1.07); 
                filter: brightness(1.12) hue-rotate(15deg); 
                box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.7); /* Strong golden glow at peak */
            }
            100% { 
                transform: scale(1); 
                filter: brightness(1) hue-rotate(0deg); 
                box-shadow: 0 0 0px 0px rgba(255, 215, 0, 0); /* End with no shadow */
            }
        }
        .logo-breathe {
            animation: breathe 4s infinite ease-in-out;
        }

        /* Achievement animation placeholder */
        @keyframes achievement-glow {
            0% { box-shadow: 0 0 0px 0px rgba(255, 215, 0, 0.7); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.7); }
            100% { box-shadow: 0 0 0px 0px rgba(255, 215, 0, 0.7); }
        }
        .achievement-active {
            animation: achievement-glow 1.5s ease-out;
        }

        /* Custom Tooltip for Achievement Button */
        .custom-tooltip {
            position: absolute;
            bottom: 100%; /* Position above the button */
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px; /* Space between button and tooltip */
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            z-index: 20;
        }

        .custom-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }

        .custom-tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        /* ==============================================
        SVG Specific Animations (for LOGOvectorFULL.svg)
        ==============================================
        */

        /* Initial state for SVG text/elements (hidden/faded) */
        #logo-text-tinhquang,
        #logo-text-trucchichantam,
        #chakra-system,
        #chakra-crown,
        #energy-flow-line,
        #human-body { /* Assuming human-body is also part of SVG */
            opacity: 0;
            transition: opacity 0.5s ease-out, filter 0.5s ease-out;
            filter: brightness(0.5); /* Slightly dim initially */
        }

        /* Animation for text fade-in on app load */
        @keyframes text-fade-in {
            0% { opacity: 0; transform: translateY(10px); filter: brightness(0.5); }
            100% { opacity: 1; transform: translateY(0); filter: brightness(1); }
        }

        /* Animation for overall chakra system glow */
        @keyframes chakra-system-pulse {
            0%, 100% { filter: drop-shadow(0 0 0px rgba(255, 215, 0, 0.0)); opacity: 0.8; }
            50% { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 30px rgba(255, 165, 0, 0.5)); opacity: 1; }
        }

        /* Animation for energy flow line (assuming it's a path) */
        @keyframes energy-flow {
            0% { stroke-dashoffset: 100%; opacity: 0; }
            50% { opacity: 1; }
            100% { stroke-dashoffset: 0%; opacity: 1; }
        }

        /* Animation for chakra-crown (wisdom eye) */
        @keyframes chakra-crown-glow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 25px rgba(255, 255, 255, 1)) drop-shadow(0 0 50px rgba(255, 255, 255, 0.7)); }
        }

        /* Active states when music is playing */
        body.music-playing #chakra-system {
            animation: chakra-system-pulse 2s infinite ease-in-out;
        }

        body.music-playing #chakra-crown {
            animation: chakra-crown-glow 2.5s infinite ease-in-out;
        }

        body.music-playing #energy-flow-line {
            animation: energy-flow 3s linear infinite;
            /* Ensure stroke is visible and has a dasharray for the animation to work */
            stroke: #FFD700; /* Golden color for energy flow */
            stroke-width: 5;
            stroke-linecap: round;
        }
        /* Initial visibility for SVG elements after app loads */
        body.app-loaded #logo-text-tinhquang {
            animation: text-fade-in 1s ease-out forwards;
            animation-delay: 0.5s; /* Delay for subtle effect */
        }
        body.app-loaded #logo-text-trucchichantam {
            animation: text-fade-in 1s ease-out forwards;
            animation-delay: 1s; /* Delay for subtle effect */
        }
        body.app-loaded #human-body {
            opacity: 1; /* Make human body visible when app loads */
            filter: brightness(1);
        }
    </style>
</head>
<body class="theme-default">
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div id="splash-logo-container">
            <!-- Using the full SVG logo -->
            <img id="splash-logo" src="https://github.com/thiensutinhquang/PlayMusic/blob/main/LOGOvectorFULL.svg?raw=true" alt="MSTQ Logo">
        </div>
    </div>

    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <a href="#">
                    <!-- Using the full SVG logo -->
                    <img src="https://github.com/thiensutinhquang/PlayMusic/blob/main/LOGOvectorFULL.svg?raw=true" alt="MSTQ Logo" class="logo-breathe">
                    <h1>√ÇM NH·∫†C TSTQ</h1>
                </a>
            </div>
            
            <div class="header-controls">
                <nav class="desktop-nav">
                    <div class="new-nav-container">
                        <a href="https://sites.google.com/view/thiensutinhquang" class="new-nav-btn" target="_blank">
                            <i class="ph-bold ph-house"></i>
                            <span>Trang Ch·ªß</span>
                        </a>
                        <a href="https://thiensutinhquang.github.io/Playlist-YouTube/" class="new-nav-btn" target="_blank">
                           <i class="ph-bold ph-video"></i>
                           <span>Xem video</span>
                        </a>
                        <a href="https://sites.google.com/view/thiensutinhquang/tuy%E1%BB%83n-t%E1%BA%ADp-th%C6%A∆†" class="new-nav-btn" target="_blank">
                            <i class="ph-bold ph-book-open"></i>
                            <span>Kho Th∆°</span>
                        </a>
                        <div class="platforms-dropdown">
                            <button id="platforms-toggle-desktop" class="new-nav-btn">
                                <i class="ph-bold ph-share-network"></i>
                                <span>C√°c N·ªÅn T·∫£ng</span>
                                <i class="ph-bold ph-caret-down ml-2"></i>
                            </button>
                            <div id="platforms-menu-desktop" class="platforms-menu">
                                <a href="https://www.youtube.com/channel/UCLdLj1-g4TI5lSmWeD60mnA" target="_blank"><i class="ph-bold ph-youtube-logo" style="color: #FF0000;"></i> YouTube</a>
                                <a href="https://www.tiktok.com/@minhsutinhquang" target="_blank"><i class="ph-bold ph-tiktok-logo" style="color: #000000;"></i> TikTok</a>
                                <a href="https://www.facebook.com/phatphapnhiemmauTinhQuang" target="_blank"><i class="ph-bold ph-facebook-logo" style="color: #1877F2;"></i> Facebook</a>
                                <a href="https://t.me/Giaoly_phap_don_ngo" target="_blank"><i class="ph-bold ph-telegram-logo" style="color: #24A1DE;"></i> Telegram</a>
                                <a href="https://zalo.me/g/dukrae245" target="_blank">
                                    <svg class="zalo-svg" height="24px" width="24px" viewBox="0 0 48 48">
                                        <path d="M48 31.968c0 4.416-3.584 8-8 8H8c-4.416 0-8-3.584-8-8V8c0-4.416 3.584-8 8-8h32c4.416 0 8 3.584 8 8v23.968z" style="fill:#0068ff"></path><path d="M22.208 19.328c-.416-2.048-2.688-3.552-5.92-3.552-4.256 0-7.328 2.4-7.328 5.76 0 3.264 2.816 5.664 6.784 5.664a7.13 7.13 0 002.56-.416l-.8-3.328a3.91 3.91 0 01-1.728.32c-1.856 0-2.816-1.152-2.816-2.208 0-1.216.992-2.208 2.816-2.208 1.44 0 2.272.8 2.496 1.888l3.936.032zm-1.888 7.392l-1.152-4.8c-.128-.544-.608-1.024-1.216-1.024h-.032c-.64 0-1.152.48-1.28 1.056l-1.152 4.768c-.768.16-1.472.256-2.112.256-4.256 0-7.328-2.4-7.328-5.76 0-3.264 2.816-5.664 6.784-5.664 3.232 0 5.504 1.504 5.92 3.552L13.6 26.688c.864 0 1.696-.096 2.528-.256h.032c.16 0 .32.032.48.032.064 0 .128 0 .192-.032zm18.336-1.568H29.36v-1.312h8.32c.544 0 .8.416.512.864l-3.616 5.216h-4.928l4.096-5.768zM29.36 17.536h9.856v1.312h-9.856V17.536z" style="fill:#fff"></path>
                                    </svg>
                                    <span>Zalo</span>
                                </a>
                            </div>
                        </div>
                         <div id="desktop-theme-controls" class="theme-dropdown hidden lg:block">
                            <button id="theme-toggle-desktop" class="new-nav-btn">
                                <i class="ph-bold ph-palette"></i>
                                <span>Giao di·ªán</span>
                            </button>
                            <div id="theme-menu-desktop" class="theme-menu">
                                 <div id="preset-themes-desktop" class="grid grid-cols-6 gap-2 mb-4">
                                    <!-- Preset buttons will be rendered here by JS -->
                                </div>
                                <div class="theme-switch flex items-center gap-2 justify-center">
                                    <i class="ph-bold ph-sun text-yellow-500"></i>
                                    <label for="darkModeToggle" class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-color/50 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-primary-color"></div>
                                    </label>
                                    <i class="ph-bold ph-moon text-slate-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
                <button class="hamburger-menu" id="hamburger-menu">
                    <i class="ph-bold ph-list"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container main-content">
        <div class="main-column space-y-6">
             <div class="card" id="music-section">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                     <h2 class="text-xl font-bold">Th∆∞ vi·ªán nh·∫°c</h2>
                     <div id="menu" class="flex flex-wrap justify-center gap-2">
                        <button onclick="loadCustomCategory('all')" class="new-nav-btn text-xs active">üéß T·∫•t c·∫£</button>
                        <button onclick="loadCustomCategory('new')" class="new-nav-btn text-xs">üÜï M·ªõi</button>
                        <button onclick="loadCustomCategory('hot')" class="new-nav-btn text-xs">ÔøΩ N·ªïi b·∫≠t</button>
                        <button onclick="loadCustomCategory('dieu-thu')" class="new-nav-btn text-xs">üé§ Di·ªáu Thu</button>
                        <button onclick="loadCustomCategory('others')" class="new-nav-btn text-xs">üë§ Kh√°c</button>
                        <button onclick="loadCustomCategory('phap')" class="new-nav-btn text-xs">üìø Ph√°p</button>
                        <button onclick="loadCustomCategory('favorites')" class="new-nav-btn text-xs">‚ù§Ô∏è Y√™u th√≠ch</button>
                     </div>
                </div>
                <div id="songs-container" class="song-grid relative"> <!-- Added position:relative for loader -->
                    <div class="loader" id="initial-loader">
                        <div class="spinner"></div>
                        <p class="text-center text-muted-current ml-4">ƒêang t·∫£i b√†i h√°t...</p>
                    </div>
                    <!-- Songs will be appended here -->
                </div>
                <audio id="audio-player" style="display: none;"></audio>
            </div>
            
            <div class="card" id="lyrics-display-area">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">L·ªùi B√†i H√°t</h2>
                    <button id="view-more-lyrics-btn" class="new-nav-btn text-xs">
                        <i class="ph-bold ph-corners-out"></i>
                        <span>Xem r√µ h∆°n</span>
                    </button>
                </div>
                <div id="lyrics-content-main" class="whitespace-pre-wrap leading-loose text-center">
                    <p class="text-muted-current">L·ªùi b√†i h√°t s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y khi b·∫°n ch·ªçn m·ªôt b√†i h√°t.</p>
                </div>
            </div>
        </div>

        <div class="sidebar-column space-y-6">
            <div class="card" id="integratedMusicPlayer">
                 <div id="popup-now-playing-info-wrapper" class="flex items-center gap-4 mb-4">
                    <div class="relative">
                        <img id="popup-album-art" src="https://github.com/thiensutinhquang/PlayMusic/blob/main/LOGOvectorFULL.svg?raw=true" alt="Album Art">
                        <div class="chakra-glow-overlay" id="player-chakra-glow"></div>
                    </div>
                    <div class="flex-grow overflow-hidden">
                        <h4 id="popup-song-title" class="font-bold truncate">Ch·ªçn m·ªôt b√†i h√°t</h4>
                        <p id="popup-song-artist" class="text-sm text-muted-current truncate">ƒê·ªÉ b·∫Øt ƒë·∫ßu nghe nh·∫°c</p>
                    </div>
                     <button id="toggle-playlist-btn" class="flex-shrink-0 text-muted-current hover:text-current transition" title="Danh s√°ch ph√°t"><i class="ph-bold ph-list-music"></i></button>
                </div>
                
                <div id="popup-playlist-container" class="my-4 max-h-48 overflow-y-auto hidden">
                    <ul id="popup-song-list" class="space-y-1"></ul>
                </div>

                <div class="space-y-2 mb-4">
                    <div class="progress-container relative" id="popup-progress-container">
                        <div class="progress-bar" id="popup-progress-bar" style="width: 0%"></div>
                        <div id="progress-tooltip">0:00</div>
                    </div>
                    <div class="flex justify-between text-xs text-muted-current">
                        <span id="popup-current-time">0:00</span>
                        <span id="popup-duration">0:00</span>
                    </div>
                </div>

                <div class="player-controls flex items-center justify-around">
                    <button id="popup-shuffle-btn" title="Tr·ªôn b√†i"><i class="ph-bold ph-shuffle"></i></button>
                    <button id="popup-prev-btn" title="B√†i tr∆∞·ªõc"><i class="ph-bold ph-skip-back"></i></button>
                    <button id="popup-play-pause-btn" title="Ph√°t/D·ª´ng">
                        <i class="ph-bold ph-play" id="play-icon"></i>
                        <i class="ph-bold ph-pause hidden" id="pause-icon"></i>
                    </button>
                    <button id="popup-next-btn" title="B√†i k·∫ø ti·∫øp"><i class="ph-bold ph-skip-forward"></i></button>
                    <button id="popup-repeat-btn" title="L·∫∑p l·∫°i"><i class="ph-bold ph-repeat"></i></button>
                </div>
                
                 <div class="flex items-center gap-4 mt-4">
                    <button id="popup-favorite-btn" title="Y√™u th√≠ch"><i class="ph-bold ph-heart"></i></button>
                    <button id="popup-open-lyrics-btn" title="M·ªü l·ªùi b√†i h√°t"><i class="ph-bold ph-file-text"></i></button>
                    <div class="flex items-center gap-2 flex-grow">
                         <i class="ph-bold ph-speaker-high"></i>
                         <input type="range" id="popup-volume-slider" min="0" max="1" step="0.01" value="1" class="w-full">
                         <span id="volume-percentage" class="text-xs w-8 text-center">100</span>
                    </div>
                </div>

                <div class="sleep-timer-options mt-4 border-t border-border-current pt-4">
                    <h3 class="text-sm font-semibold mb-2">H·∫πn gi·ªù t·∫Øt nh·∫°c</h3>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button class="sleep-timer-btn text-xs px-2 py-1 border border-border-current rounded-full hover:bg-bg-current" data-minutes="15">15p</button>
                        <button class="sleep-timer-btn text-xs px-2 py-1 border border-border-current rounded-full hover:bg-bg-current" data-minutes="30">30p</button>
                        <button class="sleep-timer-btn text-xs px-2 py-1 border border-border-current rounded-full hover:bg-bg-current" data-minutes="0">T·∫Øt</button>
                        <input type="number" id="custom-minutes-input" placeholder="Ph√∫t" class="w-16 p-1 border rounded text-xs bg-bg-current">
                        <button id="set-custom-sleep-timer-compact" class="text-xs px-2 py-1 border border-border-current rounded-full hover:bg-bg-current">ƒê·∫∑t</button>
                    </div>
                    <div id="current-sleep-timer" class="text-xs text-muted-current mt-2">Kh√¥ng h·∫πn gi·ªù</div>
                </div>
                 <div class="relative mt-4 border-t border-border-current pt-4">
                    <button id="simulate-achievement-btn" class="new-nav-btn text-xs w-full justify-center" aria-describedby="achievement-tooltip">
                        <i class="ph-bold ph-star"></i>
                        <span>M√¥ ph·ªèng Th√†nh t√≠ch</span>
                    </button>
                    <div id="achievement-tooltip" role="tooltip" class="custom-tooltip hidden">
                        Nh·∫•n ƒë·ªÉ k√≠ch ho·∫°t hi·ªáu ·ª©ng th√†nh t√≠ch tr√™n logo.
                        <div class="absolute w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800" style="bottom: -4px; left: 50%; transform: translateX(-50%);"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="lyrics-fullscreen-popup" class="hidden">
        <div class="lyrics-popup-content">
            <button id="close-lyrics-fullscreen" class="close-button"><i class="ph-bold ph-x"></i></button>
            <h2 id="lyrics-popup-title" class="text-2xl font-bold mb-4 text-center">L·ªùi B√†i H√°t</h2>
            <div id="lyrics-content" class="flex-grow relative">
                 <div id="full-lyrics-display" class="h-full overflow-y-auto text-center"></div>
                 <div class="lyrics-nav-arrow left-arrow" id="lyrics-left-arrow"><i class="ph-bold ph-caret-left"></i></div>
                 <div class="lyrics-nav-arrow right-arrow" id="lyrics-right-arrow"><i class="ph-bold ph-caret-right"></i></div>
            </div>
             <div class="flex justify-center items-center mt-4">
                <span id="lyrics-page-indicator" class="text-lg font-semibold"></span>
            </div>
            <div id="lyrics-radial-menu-container">
                <button id="radial-menu-toggle-btn">üéöÔ∏è</button>
                <div id="radial-menu-items">
                    <button id="radial-theme-btn" class="radial-item" title="ƒê·ªïi giao di·ªán">üé®</button>
                    <button id="radial-font-btn" class="radial-item" title="ƒê·ªïi ph√¥ng ch·ªØ">üî§</button>
                    <button id="radial-font-size-decrease" class="radial-item" title="Gi·∫£m c·ª° ch·ªØ">üîé‚ûñ</button>
                    <button id="radial-font-size-increase" class="radial-item" title="TƒÉng c·ª° ch·ªØ">üîé‚ûï</button>
                    <button id="radial-lines-decrease" class="radial-item" title="Gi·∫£m s·ªë d√≤ng">‚ûñ</button>
                    <button id="radial-lines-increase" class="radial-item" title="TƒÉng s·ªë ch·ªØ">‚ûï</button>
                </div>
            </div>
        </div>
    </div>
    
     <div id="custom-alert-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[9999]">
        <div id="custom-alert-content" class="bg-[var(--card-bg-current)] p-6 rounded-lg shadow-lg text-center w-11/12 max-w-sm">
            <p id="custom-alert-message" class="mb-4"></p>
            <button id="custom-alert-ok-btn" class="new-nav-btn active">OK</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired. Starting app initialization.'); // Debug log

            // DOM Elements
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            // Ensure mobile dark mode toggle is correctly referenced
            const darkModeToggleMobile = document.getElementById('darkModeToggleMobile'); 
            const songsContainer = document.getElementById('songs-container');
            const mainLyricsContainer = document.getElementById('lyrics-content-main');
            const popupSongTitle = document.getElementById('popup-song-title');
            const popupSongArtist = document.getElementById('popup-song-artist');
            const popupAlbumArt = document.getElementById('popup-album-art');
            const playPauseBtn = document.getElementById('popup-play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const audioPlayer = document.getElementById('audio-player');
            const progressContainer = document.getElementById('popup-progress-container');
            const progressBar = document.getElementById('popup-progress-bar');
            const currentTimeEl = document.getElementById('popup-current-time');
            const durationEl = document.getElementById('popup-duration');
            const nextBtn = document.getElementById('popup-next-btn');
            const prevBtn = document.getElementById('popup-prev-btn');
            const shuffleBtn = document.getElementById('popup-shuffle-btn');
            const repeatBtn = document.getElementById('popup-repeat-btn');
            const sleepTimerButtons = document.querySelectorAll('.sleep-timer-btn');
            const customMinutesInput = document.getElementById('custom-minutes-input');
            const setCustomSleepTimerBtn = document.getElementById('set-custom-sleep-timer-compact');
            const currentSleepTimerDisplay = document.getElementById('current-sleep-timer');
            const popupOpenLyricsBtn = document.getElementById('popup-open-lyrics-btn');
            const viewMoreLyricsBtn = document.getElementById('view-more-lyrics-btn');
            const lyricsFullscreenPopup = document.getElementById('lyrics-fullscreen-popup');
            const closeLyricsFullscreenBtn = document.getElementById('close-lyrics-fullscreen'); 
            const fullLyricsDisplay = document.getElementById('full-lyrics-display');
            const lyricsPopupTitle = document.getElementById('lyrics-popup-title');
            const lyricsLeftArrow = document.getElementById('lyrics-left-arrow');
            const lyricsRightArrow = document.getElementById('lyrics-right-arrow');
            const lyricsPageIndicator = document.getElementById('lyrics-page-indicator');
            const radialMenuContainer = document.getElementById('lyrics-radial-menu-container');
            const radialMenuToggleBtn = document.getElementById('radial-menu-toggle-btn');
            const radialItems = radialMenuContainer.querySelectorAll('.radial-item');
            const volumeSlider = document.getElementById('popup-volume-slider');
            const volumePercentage = document.getElementById('volume-percentage');
            const favoriteBtn = document.getElementById('popup-favorite-btn');
            const customAlertModal = document.getElementById('custom-alert-modal');
            const customAlertMessage = document.getElementById('custom-alert-message');
            const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
            const togglePlaylistBtn = document.getElementById('toggle-playlist-btn');
            const popupPlaylistContainer = document.getElementById('popup-playlist-container');
            const popupSongList = document.getElementById('popup-song-list');
            const progressTooltip = document.getElementById('progress-tooltip');
            const splashScreen = document.getElementById('splash-screen');
            const simulateAchievementBtn = document.getElementById('simulate-achievement-btn');
            const logoInHeader = document.querySelector('.header .logo img');
            const playerChakraGlow = document.getElementById('player-chakra-glow');
            const achievementTooltip = document.getElementById('achievement-tooltip'); // New: Get tooltip element
            const initialLoader = document.getElementById('initial-loader'); // Added: Reference to the initial loader

            // SVG elements by ID (assuming they exist in the SVG file)
            let logoTextTinhQuang, logoTextTrucChiChanTam, chakraSystem, chakraCrown, energyFlowLine, humanBody;

            // Function to get SVG elements after SVG is loaded
            const getSvgElements = () => {
                const svgObject = document.getElementById('splash-logo') || document.querySelector('.logo img');
                if (svgObject && svgObject.contentDocument) {
                    const svgDoc = svgObject.contentDocument;
                    logoTextTinhQuang = svgDoc.getElementById('logo-text-tinhquang');
                    logoTextTrucChiChanTam = svgDoc.getElementById('logo-text-trucchichantam');
                    chakraSystem = svgDoc.getElementById('chakra-system');
                    chakraCrown = svgDoc.getElementById('chakra-crown');
                    energyFlowLine = svgDoc.getElementById('energy-flow-line');
                    humanBody = svgDoc.getElementById('human-body');
                    console.log('SVG elements fetched:', { logoTextTinhQuang, logoTextTrucChiChanTam, chakraSystem, chakraCrown, energyFlowLine, humanBody });
                } else {
                    console.warn('SVG contentDocument not available yet or SVG element not found.');
                }
            };

            // Mobile theme menu specific elements
            const mobileThemeMenu = document.getElementById('mobile-theme-menu');
            const mobileThemeOptions = document.getElementById('mobile-theme-options');
            const desktopThemeMenu = document.getElementById('theme-menu-desktop'); // Desktop theme menu
            const themeToggleDesktop = document.getElementById('theme-toggle-desktop'); // Desktop theme toggle button
            let mobileThemeAutoCloseTimer; // Timer for mobile theme menu auto-close
            let desktopThemeAutoCloseTimer; // Timer for desktop theme menu auto-close

            // Global State & Settings
            let songData = [], currentDisplayData = [], lyricsPages = [];
            let currentSongIndex = -1, currentLyricsPage = 0;
            let isPlaying = false;
            let isShuffling = JSON.parse(localStorage.getItem('isShuffling')) || false;
            let repeatMode = localStorage.getItem('repeatMode') || 'none';
            let favoriteSongIds = JSON.parse(localStorage.getItem('favoriteSongIds')) || [];
            let sleepTimer = null, sleepTimerEndTime = null, sleepTimerInterval = null;
            let audiusDiscoveryHost = null;
            let lyricsFontSize = parseInt(localStorage.getItem('lyricsFontSize')) || 24;
            let linesPerPage = parseInt(localStorage.getItem('linesPerPage')) || 10;
            let currentFontIndex = parseInt(localStorage.getItem('lyricsFontIndex')) || 0;
            let currentLyricsThemeId = localStorage.getItem('lyricsThemeId') || 'auto_day';
            let wakeLock = null;
            
            // Constants
            const API_KEY = "08c897eb7784e03007e0769d01f2ca1c6a2001b4";
            const USER_HANDLE = "minhsutinhquang";
            const genreMap = {'new':"Pop",'hot':"Country",'dieu-thu':"Classical",'others':"Reggae",'phap':"Podcasts"};
            const fontOptions = ['Be Vietnam Pro, sans-serif','Arial, sans-serif','Verdana, sans-serif','Tahoma, sans-serif',"'Times New Roman', serif"];
            const lyricsThemes = [
                { id: 'auto_day', name: "S√°ng", bgColor: "#FFFFFF", textColor: "#1e293b" },
                { id: 'auto_night', name: "T·ªëi", bgColor: "#1e293b", textColor: "#e2e8f0" },
                { id: 'sepia', name: "V√†ng C·ªï", bgColor: "#fbf3e5", textColor: "#5a4628" },
            ];

            const presetThemes = [
                { title: "M·∫°nh m·∫Ω", bg: "var(--preset-bg-blue-dark)", text: "var(--preset-text-yellow)", style: "background:linear-gradient(45deg,var(--preset-bg-blue-dark) 50%,var(--preset-text-yellow) 50%);" },
                { title: "D·ªãu nh·∫π", bg: "var(--preset-bg-purple-dream)", text: "var(--preset-text-pink-pastel)", style: "background:linear-gradient(45deg,var(--preset-bg-purple-dream) 50%,var(--preset-text-pink-pastel) 50%);" },
                { title: "T∆∞∆°i m√°t", bg: "var(--preset-bg-forest-green)", text: "var(--preset-text-aqua)", style: "background:linear-gradient(45deg,var(--preset-bg-forest-green) 50%,var(--preset-text-aqua) 50%);" },
                { title: "Hi·ªán ƒë·∫°i", bg: "var(--preset-bg-forest-green)", text: "var(--preset-text-yellow)", style: "background:linear-gradient(45deg,var(--preset-bg-forest-green) 50%,var(--preset-text-yellow) 50%);" },
                { title: "·∫§m √°p", bg: "var(--preset-bg-purple-dream)", text: "var(--preset-text-yellow)", style: "background:linear-gradient(45deg,var(--preset-bg-purple-dream) 50%,var(--preset-text-yellow) 50%);" },
                { title: "Trang nh√£", bg: "var(--preset-bg-blue-dark)", text: "var(--preset-text-aqua)", style: "background:linear-gradient(45deg,var(--preset-bg-blue-dark) 50%,var(--preset-text-aqua) 50%);" },
                // New "Tinh Quang" Theme
                { title: "Tinh Quang", bg: "var(--preset-bg-tinhquang)", text: "var(--preset-text-tinhquang)", textMuted: "var(--preset-text-muted-tinhquang)", border: "var(--preset-border-tinhquang)", style: "background:radial-gradient(circle at center, #3a1a5a 0%, var(--preset-bg-tinhquang) 100%); border: 2px solid var(--preset-text-tinhquang);" }
            ];

            // ==============================================
            // CORE FUNCTIONS
            // ==============================================

            const applyTheme = () => {
                if (navigator.vibrate) {
                    // This is an Intervention warning in iframe, cannot be fixed in code.
                    // It will work normally on a deployed site with user interaction.
                    navigator.vibrate(20); 
                }
                const theme = JSON.parse(localStorage.getItem('themeState')) || { mode: 'light' };
                body.classList.remove('dark-mode', 'preset-theme', 'tinhquang-theme'); // Remove specific theme class
                document.querySelectorAll('.preset-theme-btn').forEach(b => b.classList.remove('active'));

                if (theme.mode === 'dark') {
                    body.classList.add('dark-mode');
                    if (darkModeToggle) darkModeToggle.checked = true; // Fixed: Check if element exists
                    if (darkModeToggleMobile) darkModeToggleMobile.checked = true; // Fixed: Check if element exists
                } else if (theme.mode === 'preset') {
                    body.classList.add('preset-theme');
                    const root = document.documentElement;
                    root.style.setProperty('--preset-bg-current', theme.bg);
                    root.style.setProperty('--preset-text-current', theme.text);
                    // Set muted and border colors for preset themes, default to text if not specific
                    root.style.setProperty('--preset-text-muted-current', theme.textMuted || theme.text);
                    root.style.setProperty('--preset-border-current', theme.border || theme.text);

                    // Special handling for Tinh Quang theme background
                    if (theme.title === "Tinh Quang") {
                        body.classList.add('tinhquang-theme');
                    }

                    if (darkModeToggle) darkModeToggle.checked = false; // Fixed: Check if element exists
                    if (darkModeToggleMobile) darkModeToggleMobile.checked = false; // Fixed: Check if element exists
                    // Add active class to the selected preset buttons
                    const activeButtons = document.querySelectorAll(`.preset-theme-btn[data-bg="${theme.bg}"][data-text="${theme.text}"]`);
                    activeButtons.forEach(btn => btn.classList.add('active'));
                } else { // light mode
                    if (darkModeToggle) darkModeToggle.checked = false; // Fixed: Check if element exists
                    if (darkModeToggleMobile) darkModeToggleMobile.checked = false; // Fixed: Check if element exists
                }
            };

            // Helper function for safe classList operations
            function safeToggleClass(element, className, force) {
                if (element && element.classList) {
                    if (force !== undefined) {
                        element.classList.toggle(className, force);
                    } else {
                        element.classList.toggle(className);
                    }
                }
            }

            function safeAddClass(element, className) {
                if (element && element.classList) {
                    element.classList.add(className);
                }
            }

            function safeRemoveClass(element, className) {
                if (element && element.classList) {
                    element.classList.remove(className);
                }
            }

            // Function to close mobile theme options
            function closeMobileThemeOptions() {
                const currentMobileThemeOptions = document.getElementById('mobile-theme-options');
                safeAddClass(currentMobileThemeOptions, 'hidden');
            }

            // Function to close desktop theme options
            function closeDesktopThemeOptions() {
                const currentDesktopThemeMenu = document.getElementById('theme-menu-desktop');
                safeRemoveClass(currentDesktopThemeMenu, 'show');
            }

            // Function to render preset theme buttons dynamically
            function renderPresetThemes(container, onThemeChangeCallback) {
                if (!container) return; // Added check for container existence
                container.innerHTML = ''; // Clear existing buttons
                presetThemes.forEach(preset => {
                    const btn = document.createElement('button');
                    btn.className = 'preset-theme-btn';
                    btn.title = preset.title;
                    btn.dataset.bg = preset.bg;
                    btn.dataset.text = preset.text;
                    btn.setAttribute('aria-label', preset.title); // Accessibility
                    btn.tabIndex = 0; // Make focusable
                    btn.style = preset.style;
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        onThemeChangeCallback && onThemeChangeCallback(preset);
                    });
                    container.appendChild(btn);
                });
            }

            // Function to change theme (called by preset buttons)
            function changeTheme(preset) {
                const theme = { 
                    mode: 'preset', 
                    bg: preset.bg, 
                    text: preset.text,
                    title: preset.title, // Pass title for specific theme handling
                    textMuted: preset.textMuted, // Pass specific muted color if exists
                    border: preset.border // Pass specific border color if exists
                };
                localStorage.setItem('themeState', JSON.stringify(theme));
                applyTheme();
                if (navigator.vibrate) navigator.vibrate(20);
                // Auto-close menus after selecting a preset
                closeDesktopThemeOptions();
                closeMobileThemeOptions();
            }

            // Function to focus on the current theme preset when menu opens
            function focusCurrentThemePreset(container) {
                if (!container) return; // Added check for container existence
                const theme = JSON.parse(localStorage.getItem('themeState'));
                if (theme && theme.mode === 'preset') {
                    const btn = [...container.querySelectorAll('.preset-theme-btn')].find(b =>
                        b.dataset.bg === theme.bg && b.dataset.text === theme.text
                    );
                    btn?.focus();
                } else {
                    // If not preset theme, focus on the dark mode toggle or first preset
                    const darkModeToggleEl = container.querySelector('input[type="checkbox"]');
                    if (darkModeToggleEl) {
                        darkModeToggleEl.focus();
                    } else {
                        container.querySelector('.preset-theme-btn')?.focus();
                    }
                }
            }

            const setupNavEvents = () => {
                const hamburgerMenu = document.getElementById('hamburger-menu');
                const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
                const closeMobileMenu = document.querySelector('.mobile-nav-content .close-mobile-menu');
                const platformsToggleDesktop = document.getElementById('platforms-toggle-desktop');
                const platformsMenuDesktop = document.getElementById('platforms-menu-desktop');
                const platformsToggleMobile = document.getElementById('platforms-toggle-mobile');
                const platformsMenuMobile = document.getElementById('platforms-menu-mobile');
                
                if(hamburgerMenu) hamburgerMenu.addEventListener('click', () => safeAddClass(mobileNavOverlay, 'active'));
                if(closeMobileMenu) closeMobileMenu.addEventListener('click', () => safeRemoveClass(mobileNavOverlay, 'active'));
                if(mobileNavOverlay) mobileNavOverlay.addEventListener('click', (e) => {
                    if (e.target === mobileNavOverlay) safeRemoveClass(mobileNavOverlay, 'active');
                });
                if(platformsToggleDesktop) platformsToggleDesktop.addEventListener('click', (e) => {
                    e.stopPropagation();
                    safeToggleClass(platformsMenuDesktop, 'show');
                });
                if(platformsToggleMobile) platformsToggleMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    safeToggleClass(platformsMenuMobile, 'show');
                });
                
                // Desktop theme menu click listener
                if (themeToggleDesktop) {
                    themeToggleDesktop.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Re-fetch the element right before using it, as a last resort
                        const currentDesktopThemeMenu = document.getElementById('theme-menu-desktop');
                        if (currentDesktopThemeMenu) { 
                            safeToggleClass(currentDesktopThemeMenu, 'show'); 
                            if (navigator.vibrate) navigator.vibrate(20);
                            clearTimeout(desktopThemeAutoCloseTimer);
                            if (currentDesktopThemeMenu.classList.contains('show')) { // Check actual state after toggle
                                desktopThemeAutoCloseTimer = setTimeout(closeDesktopThemeOptions, 7000);
                                focusCurrentThemePreset(currentDesktopThemeMenu.querySelector('#preset-themes-desktop'));
                            }
                        } else {
                            console.warn("desktopThemeMenu is null when themeToggleDesktop is clicked.");
                        }
                    });
                }

                // Mobile theme menu click listener
                if (mobileThemeMenu) {
                    mobileThemeMenu.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Re-fetch the element right before using it, as a last resort
                        const currentMobileThemeOptions = document.getElementById('mobile-theme-options');
                        if (currentMobileThemeOptions) { 
                            safeToggleClass(currentMobileThemeOptions, 'hidden');
                            if (navigator.vibrate) navigator.vibrate(20);

                            clearTimeout(mobileThemeAutoCloseTimer);
                            if (!currentMobileThemeOptions.classList.contains('hidden')) { 
                                mobileThemeAutoCloseTimer = setTimeout(closeMobileThemeOptions, 7000);
                                focusCurrentThemePreset(currentMobileThemeOptions.querySelector('#mobile-preset-themes'));
                            }
                        } else {
                            console.warn("mobileThemeOptions is null when mobileThemeMenu is clicked.");
                        }
                    });
                }

                // Global click listener to hide menus when clicking outside
                window.addEventListener('click', (e) => {
                    if (platformsMenuDesktop?.classList?.contains('show') && !platformsMenuDesktop.contains(e.target) && e.target !== platformsToggleDesktop) { 
                        safeRemoveClass(platformsMenuDesktop, 'show');
                    }
                    // Re-fetch desktopThemeMenu for global click listener
                    const currentDesktopThemeMenu = document.getElementById('theme-menu-desktop');
                    if (currentDesktopThemeMenu?.classList?.contains('show') && !currentDesktopThemeMenu.contains(e.target) && e.target !== themeToggleDesktop) { 
                        closeDesktopThemeOptions();
                    }
                    // Hide mobile theme options if clicking outside
                    // Re-fetch mobileThemeOptions for global click listener
                    const currentMobileThemeOptions = document.getElementById('mobile-theme-options');
                    if (currentMobileThemeOptions?.classList && !currentMobileThemeOptions.classList.contains('hidden')) { 
                        if (!currentMobileThemeOptions.contains(e.target) && e.target !== mobileThemeMenu) {
                            closeMobileThemeOptions();
                        }
                    }
                });
            };

            async function fetchAudiusData() {
                console.log('fetchAudiusData: Starting data fetch.'); // Debug log
                let fetchedSuccessfully = false; // Flag to track if API fetch was successful
                try {
                    let hosts;
                    try {
                        // Attempt to fetch host list from Audius API
                        const response = await fetch('https://api.audius.co');
                        if (!response.ok) {
                            throw new Error(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√°y ch·ªß Audius: ${response.status} ${response.statusText}`);
                        }
                        hosts = (await response.json()).data;
                        if (!hosts || hosts.length === 0) {
                            throw new Error('Danh s√°ch m√°y ch·ªß Audius tr·ªëng.');
                        }
                        console.log('fetchAudiusData: Successfully fetched Audius hosts.', hosts); // Debug log
                    } catch (e) {
                        console.warn("fetchAudiusData: Could not fetch Audius host list, using fallback.", e.message); // Debug log
                        // Fallback hosts - these might also be blocked by CORS/network
                        hosts = [
                            'https://discoveryprovider.audius.co',
                            'https://discoveryprovider2.audius.co',
                            'https://discoveryprovider3.audius.co',
                            'https://dn-dn.audius.co',
                            'https://discoveryprovider.audius.prod-us-west-2.staked.cloud'
                        ];
                        showMessage(`Kh√¥ng th·ªÉ t·∫£i danh s√°ch m√°y ch·ªß Audius. Th·ª≠ l·∫°i v·ªõi m√°y ch·ªß d·ª± ph√≤ng. L·ªói: ${e.message}`);
                    }
                    
                    // Select a random discovery host
                    audiusDiscoveryHost = hosts[Math.floor(Math.random() * hosts.length)];
                    console.log(`fetchAudiusData: Using Audius host: ${audiusDiscoveryHost}`); // Debug log

                    let userResponse;
                    try {
                        // Fetch user data
                        userResponse = await fetch(`${audiusDiscoveryHost}/v1/users/search?query=${USER_HANDLE}&app_name=MSTQPlayer`);
                        if (!userResponse.ok) {
                            throw new Error(`L·ªói khi t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng: ${userResponse.status} ${userResponse.statusText}`);
                        }
                    } catch (e) {
                        throw new Error(`L·ªói khi t√¨m ki·∫øm ng∆∞·ªùi d√πng Audius (${USER_HANDLE}): ${e.message}`);
                    }
                    const userData = (await userResponse.json()).data;
                    if (!userData || userData.length === 0) {
                        throw new Error(`Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng Audius v·ªõi handle: ${USER_HANDLE}`);
                    }
                    const userId = userData[0].id;
                    console.log('fetchAudiusData: User ID found:', userId); // Debug log
                    
                    let tracksResponse;
                    try {
                        // Fetch tracks for the user
                        tracksResponse = await fetch(`${audiusDiscoveryHost}/v1/users/${userId}/tracks?limit=1000&app_name=MSTQPlayer`);
                        if (!tracksResponse.ok) {
                            throw new Error(`L·ªói khi t·∫£i b√†i h√°t: ${tracksResponse.status} ${tracksResponse.statusText}`);
                        }
                    } catch (e) {
                        throw new Error(`L·ªói khi t·∫£i danh s√°ch b√†i h√°t t·ª´ Audius: ${e.message}`);
                    }
                    
                    songData = (await tracksResponse.json()).data.map(track => ({
                        id: track.id,
                        title: track.title,
                        artist: track.user ? track.user.name : 'Unknown Artist',
                        artwork: track.artwork ? (track.artwork['480x480'] || track.artwork.url) : `https://placehold.co/150x150/1e293b/f1f5f9?text=${track.title.charAt(0)}`, 
                        duration: track.duration,
                        description: track.description || '',
                        isFavorite: favoriteSongIds.includes(track.id),
                        genre: track.genre || 'Unknown'
                    }));

                    console.log('fetchAudiusData: Songs fetched:', songData.length); // Debug log
                    fetchedSuccessfully = true; // Mark as successful
                    
                    if (songData.length === 0) {
                        songsContainer.innerHTML = '<p class="text-center text-muted-current col-span-full">Kh√¥ng c√≥ b√†i h√°t n√†o ƒë∆∞·ª£c t√¨m th·∫•y cho ng∆∞·ªùi d√πng n√†y.</p>';
                    }

                } catch (error) {
                    // Catch all errors during data fetching and display a user-friendly message
                    console.error("fetchAudiusData: L·ªói khi t·∫£i d·ªØ li·ªáu Audius:", error); // Debug log
                    songsContainer.innerHTML = `<p class="text-center text-red-500 col-span-full">L·ªói khi t·∫£i danh s√°ch nh·∫°c: ${error.message}</p>`;
                    showMessage(`L·ªói t·∫£i nh·∫°c: ${error.message}. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau.`);
                    
                } finally {
                    // Always ensure songData is populated, either from API or dummy data
                    // This block runs regardless of whether an error occurred in try/catch.
                    if (!fetchedSuccessfully || songData.length === 0) { // If fetch failed OR no songs were returned
                        console.log("fetchAudiusData: Falling back to dummy data.");
                        songData = [
                            {
                                id: "dummy1",
                                title: "B√†i H√°t Gi·∫£ ƒê·ªãnh 1",
                                artist: "Ngh·ªá Sƒ© Gi·∫£ ƒê·ªãnh",
                                artwork: "https://placehold.co/150x150/f59e0b/ffffff?text=DUMMY1",
                                duration: 180,
                                description: "ƒê√¢y l√† l·ªùi b√†i h√°t gi·∫£ ƒë·ªãnh s·ªë 1.\nB·∫°n c√≥ th·ªÉ thay ƒë·ªïi n√≥ ƒë·ªÉ ki·ªÉm tra t√≠nh nƒÉng l·ªùi b√†i h√°t.",
                                isFavorite: false,
                                genre: "Pop"
                            },
                            {
                                id: "dummy2",
                                title: "B√†i H√°t Gi·∫£ ƒê·ªãnh 2",
                                artist: "Ngh·ªá Sƒ© Gi·∫£ ƒê·ªãnh",
                                artwork: "https://placehold.co/150x150/3b82f6/ffffff?text=DUMMY2",
                                duration: 240,
                                description: "L·ªùi b√†i h√°t gi·∫£ ƒë·ªãnh s·ªë 2.\nTh·ª≠ ph√°t nh·∫°c v√† xem l·ªùi nh√©!",
                                isFavorite: true,
                                genre: "Country"
                            },
                            {
                                id: "dummy3",
                                title: "B√†i H√°t Gi·∫£ ƒê·ªãnh 3",
                                artist: "Ngh·ªá Sƒ© Gi·∫£ ƒê·ªãnh",
                                artwork: "https://placehold.co/150x150/ef4444/ffffff?text=DUMMY3",
                                duration: 200,
                                description: "ƒê√¢y l√† b√†i h√°t th·ª© ba trong danh s√°ch gi·∫£ ƒë·ªãnh.",
                                isFavorite: false,
                                genre: "Classical"
                            }
                        ];
                        showMessage("ƒê√£ t·∫£i d·ªØ li·ªáu gi·∫£ ƒë·ªãnh do l·ªói k·∫øt n·ªëi API Audius ho·∫∑c kh√¥ng c√≥ b√†i h√°t.");
                    }
                }
            }

            function renderSongs(tracks) {
                console.log('renderSongs: Attempting to render songs. Tracks count:', tracks ? tracks.length : 0); // Debug log
                
                // Hide the loader once we are ready to render songs
                if (initialLoader) {
                    initialLoader.classList.add('hidden');
                }

                currentDisplayData = tracks; 
                songsContainer.innerHTML = ''; // Clear previous content (including the loader if it wasn't hidden by class)

                if (!tracks || tracks.length === 0) {
                    songsContainer.innerHTML = '<p class="text-center text-muted-current col-span-full">Kh√¥ng c√≥ b√†i h√°t n√†o.</p>';
                    return;
                }

                tracks.forEach((song, displayIndex) => {
                    const songItem = document.createElement('div');
                    songItem.className = 'song-grid-item';
                    songItem.dataset.displayIndex = displayIndex; 
                    songItem.innerHTML = `<img src="${song.artwork}" alt="${song.title}" class="artwork"><div class="info"><p class="title">${song.title}</p></div><div class="play-indicator"><i class="ph-bold ph-play"></i></div>`;
                    songsContainer.appendChild(songItem);
                });
                addSongEventListeners();
                renderPopupSongList(tracks);
                console.log('renderSongs: Songs rendering complete.'); // Debug log
                updateUI(); 
            }
            
            function renderPopupSongList(songs) {
                console.log('renderPopupSongList: Rendering popup song list. Songs count:', songs ? songs.length : 0); // Debug log
                popupSongList.innerHTML = '';
                if (!songs || songs.length === 0) return;
                songs.forEach((song) => {
                    const globalIndex = songData.findIndex(s => s.id === song.id);
                    const li = document.createElement('li');
                    li.className = 'p-2 rounded-md cursor-pointer hover:bg-bg-current text-sm truncate';
                    li.textContent = song.title;
                    li.dataset.index = globalIndex;
                    li.addEventListener('click', () => playSong(globalIndex));
                    popupSongList.appendChild(li);
                });
                console.log('renderPopupSongList: Popup song list rendering complete.'); // Debug log
            }

            function addSongEventListeners() {
                 document.querySelectorAll('.song-grid-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const song = currentDisplayData[parseInt(item.dataset.displayIndex)];
                        const globalIndex = songData.findIndex(s => s.id === song.id);
                        if (globalIndex === currentSongIndex) {
                            if (audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause();
                        } else {
                            playSong(globalIndex);
                        }
                    });
                });
            }

            window.loadCustomCategory = (category) => {
                console.log('loadCustomCategory: Loading category:', category); // Debug log
                document.querySelectorAll('#menu .new-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`#menu .new-nav-btn[onclick="loadCustomCategory('${category}')"]`)?.classList.add('active');
                let filteredSongs = songData;
                if (category === 'favorites') filteredSongs = songData.filter(s => favoriteSongIds.includes(s.id));
                else if (genreMap[category]) filteredSongs = songData.filter(s => s.genre && s.genre.toLowerCase() === genreMap[category].toLowerCase());
                renderSongs(filteredSongs);
                console.log('loadCustomCategory: Category loaded.'); // Debug log
            };

            function playSong(index) {
                console.log('playSong: Attempting to play song at index:', index); // Debug log
                if (index < 0 || index >= songData.length) {
                    console.warn('playSong: Invalid song index.'); // Debug log
                    return;
                }

                const previousSongInfo = document.getElementById('popup-now-playing-info-wrapper');
                previousSongInfo.classList.add('fade-out');

                setTimeout(() => {
                    currentSongIndex = index;
                    const song = songData[index];
                    // IMPORTANT: Dummy data songs cannot be streamed from Audius.
                    // If using dummy data, audioPlayer.src will need to be a local/mock audio file,
                    // or this part will fail silently. For now, it will attempt to stream from Audius
                    // even with dummy data, which will likely fail.
                    audioPlayer.src = `${audiusDiscoveryHost}/v1/tracks/${song.id}/stream?app_name=MSTQPlayer`; 
                    audioPlayer.play().catch(e => console.error("playSong: Playback error:", e)); // Debug log
                    updateMediaSession();

                    popupSongTitle.textContent = song.title;
                    popupSongArtist.textContent = song.artist;
                    popupAlbumArt.src = song.artwork;

                    previousSongInfo.classList.remove('fade-out');
                    updateUI();
                    console.log('playSong: Song playback initiated.'); // Debug log
                }, 300);
            }
            
            function updateUI() {
                console.log('updateUI: Updating user interface.'); // Debug log
                const song = songData[currentSongIndex];
                isPlaying = !audioPlayer.paused;

                if (song) {
                    if (popupSongTitle) popupSongTitle.textContent = song.title; // Added check
                    if (popupSongArtist) popupSongArtist.textContent = song.artist; // Added check
                    if (popupAlbumArt) popupAlbumArt.src = song.artwork; // Added check
                    if(mainLyricsContainer) mainLyricsContainer.innerHTML = song.description ? song.description.split('\n').map(line => `<p>${line}</p>`).join('') : '<p class="text-muted-current">Kh√¥ng c√≥ l·ªùi b√†i h√°t.</p>';
                    updateFavoriteButtonsUI(song.id, favoriteSongIds.includes(song.id));
                } else {
                    if (popupSongTitle) popupSongTitle.textContent = "Ch·ªçn m·ªôt b√†i h√°t"; // Added check
                    if (popupSongArtist) popupSongArtist.textContent = "ƒê·ªÉ b·∫Øt ƒë·∫ßu nghe nh·∫°c"; // Added check
                    if (popupAlbumArt) popupAlbumArt.src = "https://github.com/thiensutinhquang/PlayMusic/blob/main/LOGOvectorFULL.svg?raw=true"; // Default logo // Added check
                    if(mainLyricsContainer) mainLyricsContainer.innerHTML = '<p class="text-muted-current">L·ªùi b√†i h√°t s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>';
                }

                if (playIcon) playIcon.classList.toggle('hidden', isPlaying); // Added check
                if (pauseIcon) pauseIcon.classList.toggle('hidden', !isPlaying); // Added check
                if (popupAlbumArt) popupAlbumArt.classList.toggle('spinning', isPlaying); // Added check
                if (playerChakraGlow) playerChakraGlow.classList.toggle('playing', isPlaying); // Apply chakra glow when playing // Added check
                
                document.querySelectorAll('.song-grid-item').forEach(item => {
                    const itemSong = currentDisplayData[parseInt(item.dataset.displayIndex)];
                    if(!itemSong) return;
                    const isActive = song && itemSong.id === song.id;
                    item.classList.toggle('active-song', isActive);
                    const indicatorIcon = item.querySelector('.play-indicator i');
                    if (indicatorIcon) indicatorIcon.className = (isActive && isPlaying) ? 'ph-bold ph-pause pulsing-icon' : 'ph-bold ph-play';
                });

                document.querySelectorAll('#popup-song-list li').forEach(item => {
                    const itemIndex = parseInt(item.dataset.index);
                    const isActive = itemIndex === currentSongIndex;
                    item.classList.toggle('active-song-in-list', isActive);
                    if (isActive && popupPlaylistContainer && !popupPlaylistContainer.classList.contains('hidden')) { // Added check for popupPlaylistContainer
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
                console.log('updateUI: UI update complete.'); // Debug log
            }
            
            function playNext() {
                console.log('playNext: Playing next song.'); // Debug log
                if (songData.length === 0) return;
                let nextIndex;
                if (isShuffling) {
                    let newIndex;
                    do {
                        newIndex = Math.floor(Math.random() * songData.length);
                    } while (songData.length > 1 && newIndex === currentSongIndex);
                    nextIndex = newIndex;
                } else {
                    nextIndex = (currentSongIndex >= 0 ? currentSongIndex : -1) + 1;
                    if(nextIndex >= songData.length) nextIndex = 0; 
                }
                playSong(nextIndex);
            }
            
            function playPrev() {
                console.log('playPrev: Playing previous song.'); // Debug log
                 if (songData.length === 0) return;
                 let prevIndex;
                 if (isShuffling) {
                    let newIndex;
                    do {
                        newIndex = Math.floor(Math.random() * songData.length);
                    } while (songData.length > 1 && newIndex === currentSongIndex);
                    prevIndex = newIndex;
                 } else {
                     prevIndex = (currentSongIndex <= 0 ? songData.length : currentSongIndex) - 1;
                 }
                playSong(prevIndex);
            }

            function startSleepTimer(minutes) {
                console.log('startSleepTimer: Setting sleep timer for', minutes, 'minutes.'); // Debug log
                clearTimeout(sleepTimer); clearInterval(sleepTimerInterval);
                if (minutes === 0) {
                    if (currentSleepTimerDisplay) currentSleepTimerDisplay.textContent = 'Kh√¥ng h·∫πn gi·ªù'; // Added check
                    return;
                }
                sleepTimerEndTime = Date.now() + minutes * 60 * 1000;
                sleepTimer = setTimeout(() => {
                    audioPlayer.pause();
                    showMessage('H·∫πn gi·ªù t·∫Øt nh·∫°c ƒë√£ h·∫øt.');
                    clearSleepTimer();
                }, minutes * 60 * 1000);
                updateSleepTimerDisplay();
                sleepTimerInterval = setInterval(updateSleepTimerDisplay, 1000);
            }

            function updateSleepTimerDisplay() {
                if (!sleepTimerEndTime) return;
                const timeLeftMs = sleepTimerEndTime - Date.now();
                if (timeLeftMs <= 0) { clearSleepTimer(); return; }
                const minutes = Math.floor((timeLeftMs / 1000) / 60);
                const seconds = Math.floor((timeLeftMs / 1000) % 60);
                if (currentSleepTimerDisplay) currentSleepTimerDisplay.textContent = `C√≤n: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`; // Added check
            }

            function clearSleepTimer() {
                console.log('clearSleepTimer: Clearing sleep timer.'); // Debug log
                clearTimeout(sleepTimer); clearInterval(sleepTimerInterval);
                sleepTimer = sleepTimerEndTime = sleepTimerInterval = null;
                if (currentSleepTimerDisplay) currentSleepTimerDisplay.textContent = 'Kh√¥ng h·∫πn gi·ªù'; // Added check
            }
            
            // Lyrics Popup Functions
            function showLyricsFullscreenPopup() {
                console.log('showLyricsFullscreenPopup: Opening lyrics popup.'); // Debug log
                const song = songData[currentSongIndex];
                if (!song) {
                    showMessage("Vui l√≤ng ch·ªçn m·ªôt b√†i h√°t ƒë·ªÉ xem l·ªùi.");
                    return;
                }
                if (lyricsPopupTitle) lyricsPopupTitle.textContent = song.title; // Added check
                paginateLyrics(song.description);
                applyLyricsThemeAndFontStyles();
                if (lyricsFullscreenPopup) safeRemoveClass(lyricsFullscreenPopup, 'hidden'); // Use safeRemoveClass
                if (lyricsFullscreenPopup) safeAddClass(lyricsFullscreenPopup, 'show'); // Use safeAddClass
            }

            function hideLyricsFullscreenPopup() {
                console.log('hideLyricsFullscreenPopup: Closing lyrics popup.'); // Debug log
                if (lyricsFullscreenPopup) safeRemoveClass(lyricsFullscreenPopup, 'show'); // Use safeRemoveClass
                if (lyricsFullscreenPopup) safeAddClass(lyricsFullscreenPopup, 'hidden'); // Use safeAddClass
            }

            function paginateLyrics(text) {
                console.log('paginateLyrics: Paginating lyrics.'); // Debug log
                const lines = text ? text.split('\n') : ['Kh√¥ng c√≥ l·ªùi b√†i h√°t.'];
                lyricsPages = [];
                for (let i = 0; i < lines.length; i += linesPerPage) {
                    lyricsPages.push(lines.slice(i, i + linesPerPage));
                }
                currentLyricsPage = 0;
                displayCurrentLyricsPage();
            };

            function displayCurrentLyricsPage() {
                console.log('displayCurrentLyricsPage: Displaying current lyrics page.'); // Debug log
                if (!lyricsPages || lyricsPages.length === 0) return;
                if (fullLyricsDisplay) fullLyricsDisplay.innerHTML = lyricsPages[currentLyricsPage].map(line => `<p>${line}</p>`).join(''); // Added check
                if (lyricsPageIndicator) lyricsPageIndicator.textContent = `Trang ${currentLyricsPage + 1} / ${lyricsPages.length}`; // Added check
                if (lyricsLeftArrow) lyricsLeftArrow.style.display = lyricsPages.length > 1 ? 'flex' : 'none'; // Added check
                if (lyricsRightArrow) lyricsRightArrow.style.display = lyricsPages.length > 1 ? 'flex' : 'none'; // Added check
                if (lyricsLeftArrow) lyricsLeftArrow.classList.toggle('disabled', currentLyricsPage === 0); // Added check
                if (lyricsRightArrow) lyricsRightArrow.classList.toggle('disabled', currentLyricsPage === lyricsPages.length - 1); // Added check
            };
            
             function positionRadialItems() {
                // Fixed: Check if radialItems exists and has length before iterating
                if (radialItems && radialItems.length > 0) { 
                    const angleStep = 150 / (radialItems.length -1);
                    radialItems.forEach((item, index) => {
                        const radians = angleStep * index * (Math.PI / 180); // Fixed: radians was not defined
                        item.style.setProperty('--x', `${70 * Math.cos(radians)}px`);
                        item.style.setProperty('--y', `${70 * Math.sin(radians)}px`);
                    });
                }
            };

            function saveLyricsPreferences() {
                localStorage.setItem('lyricsFontSize', lyricsFontSize);
                localStorage.setItem('linesPerPage', linesPerPage);
                localStorage.setItem('lyricsFontIndex', currentFontIndex);
                localStorage.setItem('lyricsThemeId', currentLyricsThemeId);
                console.log('saveLyricsPreferences: Lyrics preferences saved.'); // Debug log
            }

            function applyLyricsThemeAndFontStyles() {
                console.log('applyLyricsThemeAndFontStyles: Applying lyrics theme and font styles.'); // Debug log
                const theme = lyricsThemes.find(t => t.id === currentLyricsThemeId) || lyricsThemes[0];
                const popupContent = lyricsFullscreenPopup ? lyricsFullscreenPopup.querySelector('.lyrics-popup-content') : null; // Added check
                if (popupContent) { // Added check
                    popupContent.style.backgroundColor = theme.bgColor;
                    popupContent.style.color = theme.textColor;
                }
                if (fullLyricsDisplay) { // Added check
                    fullLyricsDisplay.style.fontSize = `${lyricsFontSize}px`;
                    fullLyricsDisplay.style.fontFamily = fontOptions[currentFontIndex];
                }
            }
            
            function toggleFavorite(songId) {
                console.log('toggleFavorite: Toggling favorite status for song:', songId); // Debug log
                const songIndexInFavorites = favoriteSongIds.indexOf(songId);
                if (songIndexInFavorites > -1) {
                    favoriteSongIds.splice(songIndexInFavorites, 1);
                } else {
                    favoriteSongIds.push(songId);
                }
                localStorage.setItem('favoriteSongIds', JSON.stringify(favoriteSongIds));
                
                const song = songData.find(s => s.id === songId);
                if(song) song.isFavorite = favoriteSongIds.includes(songId);

                updateFavoriteButtonsUI(songId, favoriteSongIds.includes(songId));
            }
            
            function updateFavoriteButtonsUI(songId, isFavorite) {
                if (songData[currentSongIndex]?.id === songId) {
                    if (favoriteBtn) favoriteBtn.classList.toggle('liked', isFavorite); // Added check
                    if (favoriteBtn) favoriteBtn.innerHTML = isFavorite ? '<i class="ph-fill ph-heart"></i>' : '<i class="ph-bold ph-heart"></i>'; // Added check
                }
            }
            
            function showMessage(message) {
                console.log('showMessage: Displaying custom alert:', message); // Debug log
                if (customAlertMessage) customAlertMessage.textContent = message; // Added check
                if (customAlertModal) customAlertModal.classList.remove('hidden'); // Added check
                if (customAlertModal) customAlertModal.classList.add('show'); // Added check
            }

            function hideMessage() {
                console.log('hideMessage: Hiding custom alert.'); // Debug log
                if (customAlertModal) customAlertModal.classList.remove('show'); // Added check
                if (customAlertModal) customAlertModal.classList.add('hidden'); // Added check
            }
            
            async function requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('requestWakeLock: Screen Wake Lock acquired.'); // Debug log
                    } catch (err) {
                         console.log('requestWakeLock: Screen Wake Lock not permitted:', err.message); // Debug log
                    }
                }
            }

            function releaseWakeLock() {
                if (wakeLock !== null) {
                    wakeLock.release().then(() => {
                        wakeLock = null;
                        console.log('releaseWakeLock: Screen Wake Lock released.'); // Debug log
                    });
                }
            }

            function updateMediaSession() {
                if ('mediaSession' in navigator) {
                    const song = songData[currentSongIndex];
                    if (!song) return;

                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song.title,
                        artist: song.artist,
                        album: '√Çm nh·∫°c TSTQ',
                        artwork: [{ src: song.artwork, sizes: '512x512', type: 'image/jpeg' }]
                    });

                    navigator.mediaSession.setActionHandler('play', () => audioPlayer.play());
                    navigator.mediaSession.setActionHandler('pause', () => audioPlayer.pause());
                    navigator.mediaSession.setActionHandler('previoustrack', playPrev);
                    navigator.mediaSession.setActionHandler('nexttrack', playNext);
                    console.log('updateMediaSession: Media Session updated.'); // Debug log
                }
            }

            // Function to simulate achievement animation on logo
            function simulateAchievementAnimation() {
                console.log('simulateAchievementAnimation: Simulating achievement.'); // Debug log
                if (logoInHeader) {
                    safeAddClass(logoInHeader, 'achievement-active');
                    setTimeout(() => {
                        safeRemoveClass(logoInHeader, 'achievement-active');
                    }, 1500); // Match animation duration
                }
                if (popupAlbumArt) {
                    safeAddClass(popupAlbumArt, 'achievement-active');
                    setTimeout(() => {
                        safeRemoveClass(popupAlbumArt, 'achievement-active');
                    }, 1500);
                }
            }

            // Function to activate SVG elements when music plays
            function activateSvgElementsForMusic() {
                console.log('Activating SVG elements for music playback.');
                // Get SVG elements again to ensure they are loaded
                getSvgElements(); 

                if (chakraSystem) {
                    safeAddClass(chakraSystem, 'active-chakra-system');
                    console.log('Chakra system activated.');
                }
                if (chakraCrown) {
                    safeAddClass(chakraCrown, 'active-chakra-crown');
                    console.log('Chakra crown activated.');
                }
                if (energyFlowLine) {
                    safeAddClass(energyFlowLine, 'active-energy-flow');
                    console.log('Energy flow line activated.');
                }
                // Add class to body to trigger music-playing specific CSS
                safeAddClass(body, 'music-playing'); 
            }

            // Function to deactivate SVG elements when music pauses/stops
            function deactivateSvgElementsForMusic() {
                console.log('Deactivating SVG elements for music playback.');
                // Get SVG elements again to ensure they are loaded
                getSvgElements(); 
                
                if (chakraSystem) {
                    safeRemoveClass(chakraSystem, 'active-chakra-system');
                }
                if (chakraCrown) {
                    safeRemoveClass(chakraCrown, 'active-chakra-crown');
                }
                if (energyFlowLine) {
                    safeRemoveClass(energyFlowLine, 'active-energy-flow');
                }
                safeRemoveClass(body, 'music-playing');
            }


            // ==============================================
            // EVENT LISTENERS
            // ==============================================
            if (darkModeToggle) { // Added check
                darkModeToggle.addEventListener('change', () => {
                    console.log('darkModeToggle: Change event detected.'); // Debug log
                    const theme = { mode: darkModeToggle.checked ? 'dark' : 'light' };
                    localStorage.setItem('themeState', JSON.stringify(theme));
                    applyTheme();
                });
            }
            // Fixed: Check if darkModeToggleMobile exists before adding event listener
            if (darkModeToggleMobile) { 
                darkModeToggleMobile.addEventListener('change', (e) => {
                    console.log('darkModeToggleMobile: Change event detected.'); // Debug log
                    const theme = { mode: e.target.checked ? 'dark' : 'light' };
                    localStorage.setItem('themeState', JSON.stringify(theme));
                    applyTheme();
                    if (navigator.vibrate) navigator.vibrate(20); // Vibrate on change
                    setTimeout(closeMobileThemeOptions, 500); // Auto-close after selecting
                });
            }

            if (customAlertOkBtn) customAlertOkBtn.addEventListener('click', hideMessage); // Added check
            
            if (playPauseBtn) { // Added check
                playPauseBtn.addEventListener('click', () => {
                    console.log('playPauseBtn: Click detected.'); // Debug log
                    if (currentSongIndex === -1 && songData.length > 0) playSong(0);
                    else if (audioPlayer.paused) audioPlayer.play();
                    else audioPlayer.pause();
                });
            }

            if (audioPlayer) { // Added check
                audioPlayer.addEventListener('play', () => { 
                    isPlaying = true; 
                    updateUI(); 
                    requestWakeLock(); 
                    updateMediaSession();
                    activateSvgElementsForMusic(); // Activate SVG animations on play
                });
                audioPlayer.addEventListener('pause', () => { 
                    isPlaying = false; 
                    updateUI(); 
                    releaseWakeLock(); 
                    updateMediaSession();
                    deactivateSvgElementsForMusic(); // Deactivate SVG animations on pause
                });
                
                audioPlayer.addEventListener('ended', () => {
                    console.log('audioPlayer: Song ended.'); // Debug log
                    deactivateSvgElementsForMusic(); // Deactivate SVG animations on end
                    if (repeatMode === 'one') {
                        playSong(currentSongIndex);
                    } else if (repeatMode === 'all') {
                         playNext();
                    } else if (currentSongIndex < currentDisplayData.length - 1) {
                        playNext();
                    }
                });

                audioPlayer.addEventListener('timeupdate', () => {
                    const { currentTime, duration } = audioPlayer;
                    if(duration) {
                        if (progressBar) progressBar.style.width = `${(currentTime / duration) * 100}%`; // Added check
                        if (currentTimeEl) currentTimeEl.textContent = new Date(currentTime * 1000).toISOString().substr(14, 5); // Added check
                        if (durationEl) durationEl.textContent = new Date(duration * 1000).toISOString().substr(14, 5); // Added check
                    }
                });
            }
            
            if (progressContainer) { // Added check
                progressContainer.addEventListener('click', (e) => {
                    if(audioPlayer.duration) audioPlayer.currentTime = (e.offsetX / progressContainer.clientWidth) * audioPlayer.duration;
                });
                progressContainer.addEventListener('mousemove', (e) => {
                    if (audioPlayer.duration) {
                        const hoverTime = (e.offsetX / progressContainer.clientWidth) * audioPlayer.duration;
                        if (progressTooltip) progressTooltip.textContent = new Date(hoverTime * 1000).toISOString().substr(14, 5); // Added check
                        if (progressTooltip) progressTooltip.style.left = `${e.offsetX}px`; // Added check
                    }
                });
            }
            
            if (nextBtn) nextBtn.addEventListener('click', playNext); // Added check
            if (prevBtn) prevBtn.addEventListener('click', playPrev); // Added check

            if (shuffleBtn) { // Added check
                shuffleBtn.addEventListener('click', () => {
                    console.log('shuffleBtn: Click detected. Shuffling:', !isShuffling); // Debug log
                    isShuffling = !isShuffling;
                    localStorage.setItem('isShuffling', isShuffling);
                    safeToggleClass(shuffleBtn, 'active-control', isShuffling); // Use safeToggleClass
                });
            }
            
            if (repeatBtn) { // Added check
                repeatBtn.addEventListener('click', () => {
                    console.log('repeatBtn: Click detected. Current repeat mode:', repeatMode); // Debug log
                    const modes = ['none', 'all', 'one'];
                    let currentModeIndex = modes.indexOf(repeatMode);
                    repeatMode = modes[(currentModeIndex + 1) % modes.length];
                    localStorage.setItem('repeatMode', repeatMode);
                    safeToggleClass(repeatBtn, 'active-control', repeatMode !== 'none'); // Use safeToggleClass
                    repeatBtn.innerHTML = repeatMode === 'one' ? '<i class="ph-bold ph-repeat-once"></i>' : '<i class="ph-bold ph-repeat"></i>';
                });
            }
            
            sleepTimerButtons.forEach(button => { // No need for individual check, as it's a querySelectorAll
                button.addEventListener('click', () => startSleepTimer(parseInt(button.dataset.minutes)));
            });
            if (setCustomSleepTimerBtn) { // Added check
                setCustomSleepTimerBtn.addEventListener('click', () => {
                    const minutes = parseInt(customMinutesInput.value);
                    if (!isNaN(minutes) && minutes > 0) startSleepTimer(minutes);
                });
            }

            if (volumeSlider) { // Added check
                volumeSlider.addEventListener('input', (e) => {
                    audioPlayer.volume = e.target.value;
                    if (volumePercentage) volumePercentage.textContent = Math.round(e.target.value * 100); // Added check
                });
            }
            
            if (favoriteBtn) { // Added check
                favoriteBtn.addEventListener('click', () => {
                    if (currentSongIndex !== -1) {
                        toggleFavorite(songData[currentSongIndex].id);
                    }
                });
            }
            
            // Lyrics Popup Listeners
            if (popupOpenLyricsBtn) popupOpenLyricsBtn.addEventListener('click', showLyricsFullscreenPopup); // Added check
            if (viewMoreLyricsBtn) viewMoreLyricsBtn.addEventListener('click', showLyricsFullscreenPopup); // Added check
            if (closeLyricsFullscreenBtn) closeLyricsFullscreenBtn.addEventListener('click', hideLyricsFullscreenPopup); // Added check
            if (lyricsLeftArrow) lyricsLeftArrow.addEventListener('click', () => { if(currentLyricsPage > 0) { currentLyricsPage--; displayCurrentLyricsPage(); } }); // Added check
            if (lyricsRightArrow) lyricsRightArrow.addEventListener('click', () => { if(currentLyricsPage < lyricsPages.length - 1) { currentLyricsPage++; displayCurrentLyricsPage(); } } ); // Added check
            
            // Radial Menu Listeners
            if (radialMenuToggleBtn) radialMenuToggleBtn.addEventListener('click', () => { // Added check
                safeToggleClass(radialMenuContainer, 'active'); // Use safeToggleClass
            });
            // Fixed: Check if elements exist before adding listeners
            const radialFontSizeIncrease = document.getElementById('radial-font-size-increase');
            const radialFontSizeDecrease = document.getElementById('radial-font-size-decrease');
            const radialLinesIncrease = document.getElementById('radial-lines-increase');
            const radialLinesDecrease = document.getElementById('radial-lines-decrease');
            const radialFontBtn = document.getElementById('radial-font-btn');
            const radialThemeBtn = document.getElementById('radial-theme-btn');

            if (radialFontSizeIncrease) radialFontSizeIncrease.addEventListener('click', () => {
                if (navigator.vibrate) { navigator.vibrate(20); }
                lyricsFontSize++; applyLyricsThemeAndFontStyles(); saveLyricsPreferences();
            });
            if (radialFontSizeDecrease) radialFontSizeDecrease.addEventListener('click', () => {
                if (navigator.vibrate) { navigator.vibrate(20); }
                lyricsFontSize = Math.max(12, lyricsFontSize - 1); applyLyricsThemeAndFontStyles(); saveLyricsPreferences();
            });
            if (radialLinesIncrease) radialLinesIncrease.addEventListener('click', () => {
                if (navigator.vibrate) { navigator.vibrate(20); }
                linesPerPage++; paginateLyrics(songData[currentSongIndex]?.description || ''); saveLyricsPreferences();
            });
            if (radialLinesDecrease) radialLinesDecrease.addEventListener('click', () => {
                if (navigator.vibrate) { navigator.vibrate(20); }
                linesPerPage = Math.max(1, linesPerPage - 1); paginateLyrics(songData[currentSongIndex]?.description || ''); saveLyricsPreferences();
            });
            if (radialFontBtn) radialFontBtn.addEventListener('click', () => {
                if (navigator.vibrate) { navigator.vibrate(20); }
                currentFontIndex = (currentFontIndex + 1) % fontOptions.length; applyLyricsThemeAndFontStyles(); saveLyricsPreferences();
            });
            if (radialThemeBtn) radialThemeBtn.addEventListener('click', () => {
                let currentThemeObjIndex = lyricsThemes.findIndex(t => t.id === currentLyricsThemeId);
                currentLyricsThemeId = lyricsThemes[(currentThemeObjIndex + 1) % lyricsThemes.length].id;
                applyLyricsThemeAndFontStyles(); saveLyricsPreferences();
            });
            
            if (togglePlaylistBtn) { // Added check
                togglePlaylistBtn.addEventListener('click', () => {
                    if (popupPlaylistContainer) safeToggleClass(popupPlaylistContainer, 'hidden'); // Use safeToggleClass
                    if (popupPlaylistContainer && !popupPlaylistContainer.classList.contains('hidden')) {
                        const activeSongInList = popupSongList ? popupSongList.querySelector('.active-song-in-list') : null; // Added check
                        if (activeSongInList) {
                            activeSongInList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                });
            }

            if (simulateAchievementBtn) simulateAchievementBtn.addEventListener('click', simulateAchievementAnimation); // Added check

            // New: Event listener for the custom tooltip
            if (simulateAchievementBtn && achievementTooltip) {
                simulateAchievementBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent document click from immediately closing
                    simulateAchievementAnimation(); // Existing animation call

                    // Toggle tooltip visibility
                    if (achievementTooltip) safeToggleClass(achievementTooltip, 'show'); // Added check
                    if (achievementTooltip && achievementTooltip.classList.contains('show')) {
                        // Optional: Set a timeout to hide the tooltip after a few seconds
                        setTimeout(() => {
                            if (achievementTooltip) safeRemoveClass(achievementTooltip, 'show'); // Added check
                        }, 3000); // Hide after 3 seconds
                    }
                });

                // Hide tooltip when clicking anywhere else on the document
                document.addEventListener('click', (e) => {
                    if (achievementTooltip && achievementTooltip.classList.contains('show')) {
                        if (!simulateAchievementBtn.contains(e.target) && !achievementTooltip.contains(e.target)) {
                            safeRemoveClass(achievementTooltip, 'show'); // Use safeRemoveClass
                        }
                    }
                });
            }


            // ==============================================
            // INITIALIZATION
            // ==============================================
            async function initializeApp() {
                console.log('initializeApp: Starting application initialization.'); // Debug log
                
                applyTheme();
                setupNavEvents();
                if (shuffleBtn) safeToggleClass(shuffleBtn, 'active-control', isShuffling); // Use safeToggleClass
                if (repeatBtn) safeToggleClass(repeatBtn, 'active-control', repeatMode !== 'none'); // Use safeToggleClass
                if (repeatBtn) repeatBtn.innerHTML = repeatMode === 'one' ? '<i class="ph-bold ph-repeat-once"></i>' : '<i class="ph-bold ph-repeat"></i>'; // Added check
                
                // Fetch and render data
                await fetchAudiusData();
                console.log('initializeApp: songData length after fetchAudiusData:', songData.length); // Debug log
                loadCustomCategory('all'); // This will render the songs
                
                updateUI();
                
                // Get SVG elements AFTER they are loaded by the browser
                const splashLogoObject = document.getElementById('splash-logo');
                if (splashLogoObject && splashLogoObject.contentDocument) {
                    // This ensures SVG is fully loaded before trying to get its internal elements
                    splashLogoObject.addEventListener('load', getSvgElements);
                    getSvgElements(); // Try to get them immediately if already loaded
                } else {
                    // Fallback for cases where SVG might not be loaded as contentDocument immediately
                    console.warn("SVG contentDocument not immediately available for splash-logo. Animations on SVG internal elements might be delayed.");
                    // Attempt to get elements after a short delay if not immediately available
                    setTimeout(getSvgElements, 1000); 
                }

                positionRadialItems(); // This now relies on radialItems being populated by getSvgElements
                if (popupPlaylistContainer) safeRemoveClass(popupPlaylistContainer, 'hidden'); // Show playlist by default // Use safeRemoveClass
                
                // Render preset themes for both desktop and mobile
                const desktopPresetsContainer = document.getElementById('preset-themes-desktop');
                const mobilePresetsContainer = document.getElementById('mobile-preset-themes');
                
                if (desktopPresetsContainer) {
                    renderPresetThemes(desktopPresetsContainer, changeTheme);
                }
                if (mobilePresetsContainer) {
                    renderPresetThemes(mobilePresetsContainer, changeTheme);
                }

                // Hide splash screen AFTER all content is loaded and rendered, with a small buffer
                // This ensures content is visible before splash disappears.
                setTimeout(() => {
                    if (splashScreen) safeAddClass(splashScreen, 'hidden');
                    console.log('initializeApp: Splash screen hidden AFTER content load.');
                    safeAddClass(body, 'app-loaded'); // Add class to body to trigger initial SVG text animations
                }, 1000); // Increased buffer to 1 second after content is rendered for better UX
                
                console.log('initializeApp: Application initialization complete.'); // Debug log
            }

            initializeApp(); // This call is outside DOMContentLoaded, but within its scope, so it runs when DOM is ready.
        });
    </script>
</body>
</html>
ÔøΩ
