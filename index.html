<!DOCTYPE html>
<html lang="vi" data-theme="lucbao">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f59e0b" />
  <title>MSTQ Music – Trình phát nhạc</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="192x192" href="/PlayMusic/images/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/PlayMusic/images/icons/icon-512x512.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel (JSX inline) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root,[data-theme]{transition:color .2s ease,background-color .2s ease}
    :root{--bg:#111827;--card:#1f2937;--text:#f9fafb;--muted:#9ca3af;--primary:#f59e0b;--primary-fg:#111827;--ring:#f59e0b66;--border:#374151;--nav-bg:rgba(31,41,55,.8);--shadow:0 10px 30px rgba(0,0,0,.35);--gradient:linear-gradient(135deg,#f59e0b 0%,#fbbf24 100%)}
    [data-theme=light]{--bg:#f3f4f6;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#d97706;--primary-fg:#fff;--ring:#d9770666;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.85)}
    [data-theme=lucbao]{--bg:#081414;--card:#102424;--text:#e0f2f1;--muted:#80cbc4;--primary:#f4ff81;--primary-fg:#0c1113;--ring:#f4ff8166;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(16,36,36,.8)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--card);color:var(--text);padding:.6rem .8rem;border-radius:12px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .badge{font-size:.7rem;border:1px solid var(--border);padding:.15rem .45rem;border-radius:999px;color:var(--muted)}
    .err{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;text-align:left}
    .err-card{background:#111827;border:1px solid #374151;border-radius:14px;max-width:900px;width:100%;padding:18px}
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 10px)}
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)]">
  <div id="root"></div>

  <!-- Luồng phát chính + luồng preload muted -->
  <audio id="mstq-player" preload="metadata" playsinline webkit-playsinline crossOrigin="anonymous"></audio>
  <audio id="mstq-preload" preload="auto" playsinline webkit-playsinline muted crossOrigin="anonymous"></audio>

  <!-- Error overlay -->
  <div id="err" class="err">
    <div class="err-card">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">Đã bắt lỗi runtime</h3>
        <button onclick="document.getElementById('err').style.display='none'" class="btn">Đóng</button>
      </div>
      <pre id="errlog" class="mt-3 whitespace-pre-wrap text-sm"></pre>
    </div>
  </div>

  <script>
    // Bắt lỗi toàn cục
    (function(){
      const show=(m)=>{const el=document.getElementById('err');const log=document.getElementById('errlog');if(log)log.textContent=String(m||'Unknown');if(el)el.style.display='flex';console.error('[GLOBAL ERROR]',m)};
      window.addEventListener('error',e=>show(e.error||e.message||e));
      window.addEventListener('unhandledrejection',e=>show(e.reason||e));
    })();

    // Đăng ký SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useRef,useMemo,useCallback} = React;

    /* ===== Helpers & keys ===== */
    const SONGS_CACHE_KEY='mstq_songs_v2', RESUME_KEY='mstq_resume_v5';
    const THEME_KEY='music-theme', SPEED_KEY='mstq_speed', MUTED_KEY='mstq_muted';
    const SHUFFLE_KEY='mstq_shuffle', REPEAT_KEY='mstq_repeat';
    const INITIAL_VISIBLE=100, VISIBLE_STEP=100;

    const FALLBACK_SONGS=[{
      id:"testmp3testfile/mpthreetest.mp3",
      title:"Bài hát mẫu (Tạm thời)",
      artist:"Public Domain",
      stream_url:"https://archive.org/download/testmp3testfile/mpthreetest.mp3",
      artwork:"/PlayMusic/images/icons/icon-192x192.png",
      duration:5,lyrics:"Bài mẫu.",item_identifier:"testmp3testfile"
    }];

    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
    const formatTime=s=>{if(!isFinite(s)||s<0)return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${String(sec).padStart(2,'0')}`};
    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    /* ===== UI ===== */
    const TopBar=({onTheme,installable})=>(
      <header className="fixed top-0 inset-x-0 z-30 px-4 py-3 flex items-center justify-between bg-[var(--nav-bg)] backdrop-blur-lg border-b border-[var(--border)]">
        <div className="flex items-center gap-2">
          <img src="/PlayMusic/images/icons/icon-192x192.png" width="28" height="28" className="rounded-lg" alt="MSTQ"/>
          <h1 className="font-bold">MSTQ Music</h1>
          <span className="badge hidden sm:inline">PWA</span>
        </div>
        <div className="flex items-center gap-2">
          {installable && <button id="btn-install" className="btn">Cài đặt</button>}
          <button className="btn" onClick={onTheme}>Chủ đề</button>
        </div>
      </header>
    );

    const PlaylistView=({songs,currentId,onPick,visibleCount,onLoadMore,isLoading})=>{
      const shown=useMemo(()=>songs.slice(0,visibleCount),[songs,visibleCount]);
      return (
        <div className="px-4">
          <div className="flex items-center justify-between"><h2 className="text-xl font-bold my-3">Danh sách phát</h2><div className="text-xs text-[var(--muted)]">{songs.length} bài</div></div>
          {isLoading? <div className="animate-pulse space-y-3">{Array.from({length:6}).map((_,i)=>(<div key={i} className="h-14 rounded-xl bg-[var(--card)]/40"></div>))}</div>:
          <>
            <div className="space-y-2">
              {shown.map((s,idx)=>(
                <div key={s.id} className={`flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)] ${currentId===s.id?'ring-2 ring-[var(--ring)] bg-[var(--card)]/50':''}`}>
                  <div className="w-8 text-center text-sm text-[var(--muted)]">{idx+1}</div>
                  <button onClick={()=>onPick(s)} className="flex-grow text-left">
                    <div className="font-semibold truncate">{s.title||'Untitled'}</div>
                    <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                  </button>
                  <div className="text-sm text-[var(--muted)]">{formatTime(s.duration||0)}</div>
                </div>
              ))}
            </div>
            {songs.length>visibleCount && <button onClick={onLoadMore} className="w-full mt-3 btn">Tải thêm</button>}
          </>}
        </div>
      );
    };

    /* ======================= MAIN APP ======================= */
    function App(){
      // Install prompt
      const [installable,setInstallable]=useState(false);
      useEffect(()=>{
        let deferred=null;
        const onBeforeInstall=(e)=>{e.preventDefault();deferred=e;setInstallable(true);
          const btn=document.getElementById('btn-install');
          if(btn){btn.onclick=async()=>{try{await deferred.prompt();}catch{} finally{setInstallable(false);deferred=null;}}}
        };
        window.addEventListener('beforeinstallprompt',onBeforeInstall);
        return()=>window.removeEventListener('beforeinstallprompt',onBeforeInstall);
      },[]);

      // theme
      const [theme,setTheme]=useState(localStorage.getItem(THEME_KEY)||'lucbao');
      useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);localStorage.setItem(THEME_KEY,theme);},[theme]);

      const [songs,setSongs]=useState([]);
      const [playlist,setPlaylist]=useState([]);
      const [loading,setLoading]=useState(true);
      const [visible,setVisible]=useState(INITIAL_VISIBLE);

      const [currentIndex,setCurrentIndex]=useState(0);
      const [playing,setPlaying]=useState(false);
      const [progress,setProgress]=useState({current:0,duration:0});
      const [shuffle,setShuffle]=useState(load(SHUFFLE_KEY,false));
      const [repeat,setRepeat]=useState(load(REPEAT_KEY,'all')); // off | one | all

      // audio elements
      const audioRef=useRef(null);
      const preloadRef=useRef(null);
      useEffect(()=>{ audioRef.current=document.getElementById('mstq-player'); preloadRef.current=document.getElementById('mstq-preload'); },[]);
      const interactedRef=useRef(false);
      useEffect(()=>{ const m=()=>{interactedRef.current=true;document.removeEventListener('click',m);document.removeEventListener('keydown',m)};document.addEventListener('click',m,{once:true});document.addEventListener('keydown',m,{once:true});},[]);

      // prefs
      const [volume,setVolume]=useState(load(RESUME_KEY,{volume:.9}).volume??.9);
      const [playbackRate,setPlaybackRate]=useState(parseFloat(localStorage.getItem(SPEED_KEY)||'1')||1);
      const [muted,setMuted]=useState(localStorage.getItem(MUTED_KEY)==='1');
      useEffect(()=>{const a=audioRef.current;if(a){a.volume=volume}},[volume]);
      useEffect(()=>{const a=audioRef.current;if(a){a.playbackRate=playbackRate}localStorage.setItem(SPEED_KEY,String(playbackRate))},[playbackRate]);
      useEffect(()=>{const a=audioRef.current;if(a){a.muted=muted}localStorage.setItem(MUTED_KEY,muted?'1':'0')},[muted]);
      useEffect(()=>save(SHUFFLE_KEY,shuffle),[shuffle]);
      useEffect(()=>save(REPEAT_KEY,repeat),[repeat]);

      // fetch playlist (Archive.org)
      const refetch=useCallback(async()=>{
        const cached=load(SONGS_CACHE_KEY,null);
        if(cached?.length){setSongs(cached);setPlaylist(cached);setLoading(false)}
        try{
          const queries=[
            'uploader:(tinhquang) AND mediatype:(audio)',
            'uploader:(thiensutinhquang) AND mediatype:(audio)',
            'creator:("Minh Su Tinh Quang") AND mediatype:(audio)'
          ];
          let docs=[];let ok=false;
          for(const q of queries){
            const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=publicdate+desc&rows=200&page=1&output=json`;
            const r=await fetch(url,{cache:'no-store'}); if(!r.ok) continue;
            const j=await r.json(); const list=j?.response?.docs||[]; if(list.length){docs=list;ok=true;break;}
          }
          if(!ok){ if(!cached?.length){setSongs(FALLBACK_SONGS);setPlaylist(FALLBACK_SONGS);} setLoading(false); return; }
          const all=[];
          for(const d of docs){
            try{
              const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
              (meta.files||[]).forEach(f=>{
                if(String(f.format||'').toUpperCase().includes('MP3')){
                  all.push({
                    id:`${d.identifier}/${f.name}`,
                    title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),
                    artist:d.creator||'TinhQuang',
                    stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,
                    artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,
                    duration:parseFloat(f.length||0)||0,
                    lyrics:d.description||'',
                    item_identifier:d.identifier
                  });
                }
              });
            }catch{}
          }
          if(all.length){ save(SONGS_CACHE_KEY,all); setSongs(all); setPlaylist(all); }
        }catch{ if(!cached?.length){setSongs(FALLBACK_SONGS);setPlaylist(FALLBACK_SONGS);} }
        setLoading(false);
      },[]);
      useEffect(()=>{refetch()},[]);

      const current=playlist[currentIndex]||null;

      // Preload next (tắt khi nền trên iOS; pause preload khi tab ẩn để không “đánh thức” audio)
      const queuePreload=useCallback((idx)=>{
        const n=(idx+1)%playlist.length;
        const next=playlist[n]; const pre=preloadRef.current;
        if(!next||!pre) return;
        if (document.visibilityState!=='visible') { pre.removeAttribute('src'); pre.load(); return; }
        if (isiOS && document.visibilityState!=='visible') return;
        if(pre.src!==next.stream_url){ pre.src=next.stream_url; pre.load(); }
      },[playlist]);
      useEffect(()=>{ if(playlist.length) queuePreload(currentIndex); },[playlist.length,currentIndex,queuePreload]);
      useEffect(()=>{
        const handler=()=>{ queuePreload(currentIndex); };
        document.addEventListener('visibilitychange',handler);
        return()=>document.removeEventListener('visibilitychange',handler);
      },[queuePreload,currentIndex]);

      // Media Session
      const updateMediaSession=useCallback((a)=>{
        try{
          if(!('mediaSession'in navigator)||!current) return;
          navigator.mediaSession.metadata=new MediaMetadata({
            title:current.title, artist:current.artist||'minhsutinhquang', album:'MSTQ Music',
            artwork:[{src:current.artwork||'/PlayMusic/images/icons/icon-192x192.png',sizes:'512x512',type:'image/png'}]
          });
          navigator.mediaSession.setActionHandler('play',()=>{ setPlaying(true); a.play().catch(()=>{}); });
          navigator.mediaSession.setActionHandler('pause',()=>{ setPlaying(false); a.pause(); });
          navigator.mediaSession.setActionHandler('previoustrack',prevTrack);
          navigator.mediaSession.setActionHandler('nexttrack',nextTrack);
          navigator.mediaSession.setActionHandler('seekbackward',d=>{ a.currentTime=Math.max(0,(a.currentTime||0)-(d.seekOffset||10)); });
          navigator.mediaSession.setActionHandler('seekforward',d=>{ a.currentTime=Math.min(a.duration||0,(a.currentTime||0)+(d.seekOffset||10)); });
          navigator.mediaSession.setActionHandler('seekto',d=>{ if(d.seekTime!=null) a.currentTime=d.seekTime; });
          navigator.mediaSession.playbackState=playing?'playing':'paused';
          navigator.mediaSession.setPositionState?.({duration:a.duration||0,position:a.currentTime||0,playbackRate:a.playbackRate||1});
        }catch{}
      },[current,playing]);

      // Recovery/Watchdog (throttle, tránh spam gây “bíp”)
      const targetPlayingRef=useRef(false);
      const lastProgRef=useRef({t:0,pos:0});
      const stallScoreRef=useRef(0);
      const lastManualPauseRef=useRef(0);
      const lastRecoverRef=useRef(0);

      // Wake lock khi visible
      useEffect(()=>{
        let lock=null;
        const reqLock=async()=>{try{if('wakeLock'in navigator && document.visibilityState==='visible'){lock=await navigator.wakeLock.request('screen');}}catch{}};
        const vis=()=>{ if(document.visibilityState==='visible'){ reqLock(); if(targetPlayingRef.current){ audioRef.current?.play?.().catch(()=>{}); } } };
        reqLock(); document.addEventListener('visibilitychange',vis);
        return()=>{document.removeEventListener('visibilitychange',vis);try{lock?.release?.()}catch{}};
      },[]);

      // audio events
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const onTime=()=>{ if(!isFinite(a.duration)) return; setProgress({current:a.currentTime||0,duration:a.duration||0});
          const now=Date.now();
          if(Math.abs(a.currentTime-(lastProgRef.current.pos||0))>0.25){ lastProgRef.current={t:now,pos:a.currentTime}; stallScoreRef.current=0; }
        };
        const onEnded=()=>{ handleEnd(); };
        const onPause=()=>{ if(!targetPlayingRef.current){ lastManualPauseRef.current=Date.now(); } };
        a.addEventListener('timeupdate',onTime);
        a.addEventListener('ended',onEnded);
        ['stalled','suspend','waiting','error','abort'].forEach(e=>a.addEventListener(e,()=>{}));
        a.addEventListener('pause',onPause);
        return()=>{a.removeEventListener('timeupdate',onTime);a.removeEventListener('ended',onEnded);['stalled','suspend','waiting','error','abort'].forEach(e=>a.removeEventListener(e,()=>{}));a.removeEventListener('pause',onPause);};
      },[]);

      // watchdog (5s), có throttle để không “bíp”
      useEffect(()=>{
        const tick=setInterval(async()=>{
          const a=audioRef.current; if(!a||!current) return;

          // Lưu resume
          save(RESUME_KEY,{index:currentIndex,id:current.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});

          if(!targetPlayingRef.current) return;
          if(Date.now()-lastManualPauseRef.current<1500) return;

          const stagnate = (Date.now()-(lastProgRef.current.t||0) > (document.visibilityState==='visible'?20000:12000));
          const poorReady = a.readyState<2;

          // tránh spam recover quá dày
          const now=Date.now();
          const canRecover = now - (lastRecoverRef.current||0) > 2500;

          if(a.paused && canRecover){
            lastRecoverRef.current=now;
            try{ await a.play(); updateMediaSession(a); return; }catch{}
          }

          if((stagnate || poorReady) && canRecover){
            lastRecoverRef.current=now;
            stallScoreRef.current++;
            try{
              // thử nhẹ
              if(a.paused) await a.play();
              if(a.paused || poorReady){ a.load(); await a.play().catch(()=>{}); }
              const limit=(document.visibilityState==='visible'?3:2);
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(); }
            }catch{
              const limit=(document.visibilityState==='visible'?3:2);
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(); }
            }
          } else {
            updateMediaSession(a);
          }
        },5000);
        return()=>clearInterval(tick);
      },[currentIndex,current,updateMediaSession]);

      // Controls
      const computeNextIndex = useCallback((dir)=> {
        if(!playlist.length) return 0;
        if(shuffle){
          let r=Math.floor(Math.random()*playlist.length);
          if (r===currentIndex) r=(r+1)%playlist.length;
          return r;
        }
        if(dir>0) return (currentIndex+1)%playlist.length;
        if(dir<0) return (currentIndex-1+playlist.length)%playlist.length;
        return currentIndex;
      },[playlist.length,shuffle,currentIndex]);

      const nextTrack=useCallback(()=>{
        if(!playlist.length) return;
        const i=computeNextIndex(+1);
        setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i);
      },[playlist.length,computeNextIndex,queuePreload]);

      const prevTrack=useCallback(()=>{
        if(!playlist.length) return;
        const a=audioRef.current; if(a?.currentTime>3){ a.currentTime=0; return; }
        const i=computeNextIndex(-1);
        setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i);
      },[playlist.length,computeNextIndex,queuePreload]);

      const handleEnd=useCallback(()=>{
        if(repeat==='one'){ const a=audioRef.current; if(a){ a.currentTime=0; a.play().catch(()=>{});} return; }
        if(repeat==='off' && currentIndex===playlist.length-1){ setPlaying(false); targetPlayingRef.current=false; return; }
        nextTrack();
      },[repeat,currentIndex,playlist.length,nextTrack]);

      const pickSong=(s)=>{
        const i=playlist.findIndex(x=>x.id===s.id);
        if(i>=0){ setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i); }
      };

      const playPause=()=>{
        const a=audioRef.current; if(!a) return;
        if(!current && playlist.length){ setCurrentIndex(0); setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); return; }
        if(playing){ setPlaying(false); targetPlayingRef.current=false; a.pause(); }
        else{ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
      };

      // Load & play khi current/playing đổi
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        if(current){
          if(a.src!==current.stream_url){ a.src=current.stream_url; a.load(); }
          a.playbackRate=playbackRate; a.muted=muted; a.volume=volume;
          document.title=`${playing?'▶':'⏸'} ${current.title} – MSTQ`;
          if(playing && interactedRef.current){ a.play().catch(()=>{}); }
          updateMediaSession(a);
        }else{ document.title='MSTQ Music'; }
      },[currentIndex,playing,playbackRate,muted,volume,current,updateMediaSession]);

      // resume sau reload / OS thaw
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const r=load(RESUME_KEY,null);
        if(r&&playlist.length){
          const idx=Math.min(Math.max(0,r.index||0),playlist.length-1);
          setCurrentIndex(idx);
          setTimeout(()=>{ const s=playlist[idx]; if(!s) return;
            if(a.src!==s.stream_url){ a.src=s.stream_url; a.load(); }
            a.currentTime=Number(r.currentTime||0); a.volume=r.volume??volume; a.playbackRate=r.rate??playbackRate; a.muted=!!r.muted;
            if(r.playing){ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
          },0);
        }
      // eslint-disable-next-line react-hooks/exhaustive-deps
      },[playlist.length]);

      // Lưu trước khi freeze/ẩn sâu
      useEffect(()=>{
        const saver=()=>{const a=audioRef.current;if(!a) return;save(RESUME_KEY,{index:currentIndex,id:current?.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});};
        window.addEventListener('pagehide',saver);
        document.addEventListener('freeze',saver);
        return()=>{window.removeEventListener('pagehide',saver);document.removeEventListener('freeze',saver);};
      },[currentIndex,current]);

      const padBottom=current?'172px':'90px';

      return (
        <div className="min-h-screen pb-40">
          <TopBar onTheme={()=>setTheme(t=>t==='lucbao'?'light':'lucbao')} installable={installable}/>
          <main className="pt-16" style={{paddingBottom:padBottom}}>
            <div className="px-4 flex items-center gap-2 my-2">
              <button className="btn" onClick={()=>{refetch();visible<INITIAL_VISIBLE&&setVisible(INITIAL_VISIBLE)}}>Làm mới</button>
              <button className="btn" onClick={playPause}>{playing?'Tạm dừng':'Phát'}</button>
              <button className="btn" onClick={()=>setShuffle(s=>!s)}>{shuffle?'Ngẫu nhiên ✓':'Ngẫu nhiên'}</button>
              <button className="btn" onClick={()=>{
                setRepeat(r=>r==='off'?'all':r==='all'?'one':'off');
              }}>Lặp: {repeat==='off'?'Tắt':repeat==='all'?'Danh sách':'1 bài'}</button>
            </div>

            <div className="px-4 grid grid-cols-2 sm:grid-cols-3 gap-2 my-2">
              <label className="flex items-center gap-2">
                <span className="text-sm w-16">Âm lượng</span>
                <input type="range" min="0" max="1" step="0.01" value={volume}
                       onChange={e=>setVolume(parseFloat(e.target.value))}
                       className="w-full"/>
              </label>
              <label className="flex items-center gap-2">
                <span className="text-sm w-16">Tốc độ</span>
                <select className="w-full bg-[var(--card)] border border-[var(--border)] rounded-xl p-2"
                        value={playbackRate} onChange={e=>setPlaybackRate(parseFloat(e.target.value))}>
                  {[0.75,1,1.1,1.25,1.5,1.75,2].map(v=><option key={v} value={v}>{v}x</option>)}
                </select>
              </label>
              <label className="flex items-center gap-2 col-span-2 sm:col-span-1">
                <input type="checkbox" checked={!!muted} onChange={e=>setMuted(e.target.checked)} />
                <span className="text-sm">Tắt tiếng</span>
              </label>
            </div>

            <PlaylistView songs={playlist} currentId={current?.id} onPick={pickSong} visibleCount={visible} onLoadMore={()=>setVisible(v=>Math.min(playlist.length,v+VISIBLE_STEP))} isLoading={loading}/>
          </main>

          {/* Mini player */}
          {current && (
            <div className="fixed bottom-2 left-2 right-2 rounded-2xl bg-[var(--card)]/95 border border-[var(--border)] backdrop-blur-md p-2 z-40 shadow-[var(--shadow)] safe-bottom">
              <div className="flex items-center gap-3">
                <img src={current.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" width="44" height="44" className="rounded-lg object-cover"/>
                <div className="flex-grow min-w-0">
                  <p className="truncate font-semibold">{current.title}</p>
                  <p className="text-xs text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</p>
                </div>
                <button className="w-10 h-10" onClick={prevTrack} aria-label="Previous">⏮️</button>
                <button className="w-10 h-10" onClick={playPause} aria-label="Play/Pause">{playing?'⏸️':'▶️'}</button>
                <button className="w-10 h-10" onClick={nextTrack} aria-label="Next">⏭️</button>
              </div>
              <div className="mt-2 h-1 bg-[var(--muted)]/20 rounded">
                <div className="h-1 bg-[var(--primary)] rounded" style={{width:`${progress.duration>0?(progress.current/progress.duration)*100:0}%`}}></div>
              </div>
              <div className="mt-1 text-[10px] text-[var(--muted)] flex justify-between">
                <span>{formatTime(progress.current)}</span>
                <span>{formatTime(progress.duration)}</span>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
