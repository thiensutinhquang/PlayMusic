<!DOCTYPE html>
<html lang="vi" data-theme="lucbao">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f59e0b" />
  <title>MSTQ Music ‚Äì Nghe nh·∫°c li√™n t·ª•c</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="192x192" href="/PlayMusic/images/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/PlayMusic/images/icons/icon-512x512.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel (JSX inline) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root,[data-theme]{transition:color .2s ease,background-color .2s ease}
    /* ==== Ch·ªß ƒë·ªÅ ==== */
    :root{
      --bg:#0b132b;--card:#0f1b2d;--text:#eaf2ff;--muted:#93a3b8;
      --primary:#f59e0b;--primary-fg:#0b132b;
      --ring:#f59e0b66;--border:#203047;--nav-bg:rgba(16,24,40,.88);
      --shadow:0 12px 36px rgba(0,0,0,.28);--gradient:linear-gradient(135deg,#60a5fa 0%,#f59e0b 100%)
    }
    [data-theme=light]{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#0ea5e9;--primary-fg:#ffffff;--ring:#0ea5e955;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.92);--gradient:linear-gradient(135deg,#93c5fd 0%,#67e8f9 100%)}
    [data-theme=dark]{--bg:#0d0f14;--card:#131720;--text:#e5e7eb;--muted:#a3a9b6;--primary:#f59e0b;--primary-fg:#0b132b;--ring:#f59e0b66;--border:#232836;--nav-bg:rgba(19,23,32,.9)}
    [data-theme=lucbao]{--bg:#081414;--card:#102424;--text:#e0f2f1;--muted:#80cbc4;--primary:#f4ff81;--primary-fg:#0c1113;--ring:#f4ff8166;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(16,36,36,.86);--gradient:linear-gradient(135deg,#a8ff78 0%,#f4ff81 100%)}
    [data-theme=tinhquang]{--bg:#1a2a45;--card:#243354;--text:#f0f8ff;--muted:#a0aec0;--primary:#63b3ed;--primary-fg:#102035;--ring:#63b3ed66;--border:#344366;--nav-bg:rgba(36,51,84,.86)}
    [data-theme=senvang]{--bg:#f6f3ea;--card:#ffffff;--text:#1a202c;--muted:#6b7280;--primary:#d4a017;--primary-fg:#161616;--ring:#d4a01755;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.9)}
    [data-theme=binhminh]{--bg:#0f0b07;--card:#1a1410;--text:#fff5eb;--muted:#e7c5a1;--primary:#ff9d4d;--primary-fg:#2a1505;--ring:#ff9d4d66;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(26,20,16,.86)}
    [data-theme=hukhong]{--bg:#f7fafc;--card:#ffffff;--text:#1a202c;--muted:#718096;--primary:#4299e1;--primary-fg:#fff;--ring:#4299e166;--border:#e2e8f0;--nav-bg:rgba(255,255,255,.9)}
    [data-theme=kimcuong]{--bg:#f8fafc;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#06b6d4;--primary-fg:#ffffff;--ring:#06b6d455;--border:#e2e8f0;--nav-bg:rgba(255,255,255,.92)}
    [data-theme=haoguang]{--bg:#0b1020;--card:#121a2b;--text:#e2e8f0;--muted:#94a3b8;--primary:#60a5fa;--primary-fg:#0b1020;--ring:#60a5fa66;--border:#1f2937;--nav-bg:rgba(18,26,43,.86)}
    [data-theme=thienanh]{--bg:#0b132b;--card:#1c2541;--text:#f8fafc;--muted:#a1a8c3;--primary:#f59e0b;--primary-fg:#0b132b;--ring:#f59e0b55;--border:#243b55;--nav-bg:rgba(28,37,65,.88)}
    [data-theme=sakura]{--bg:#fff1f2;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--primary:#fb7185;--primary-fg:#ffffff;--ring:#fb718555;--border:#ffe4e6;--nav-bg:rgba(255,255,255,.92)}

    /* ==== Ti·ªán √≠ch giao di·ªán ==== */
    .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--card);color:var(--text);padding:.6rem .85rem;border-radius:14px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--primary);color:var(--primary-fg);border-color:transparent}
    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:40;backdrop-filter:blur(8px);background:var(--nav-bg);border-top:1px solid var(--border)}
    .tabbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:.55rem 0;font-size:.75rem;color:var(--muted)}
    .tabbtn[aria-current=true]{color:var(--text)}
    .chip{font-size:.7rem;border:1px solid var(--border);padding:.15rem .45rem;border-radius:999px;color:var(--muted)}
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 12px)}
    .err{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;text-align:left}
    .err-card{background:#111827;border:1px solid #374151;border-radius:14px;max-width:900px;width:100%;padding:18px}
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)]">
  <div id="root"></div>

  <!-- 1 lu·ªìng ph√°t + 1 preload muted (t·ª± v√¥ hi·ªáu khi n·ªÅn) -->
  <audio id="mstq-player" preload="metadata" playsinline webkit-playsinline crossOrigin="anonymous"></audio>
  <audio id="mstq-preload" preload="auto" playsinline webkit-playsinline muted crossOrigin="anonymous"></audio>

  <!-- Error overlay -->
  <div id="err" class="err">
    <div class="err-card">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">ƒê√£ b·∫Øt l·ªói runtime</h3>
        <button onclick="document.getElementById('err').style.display='none'" class="btn">ƒê√≥ng</button>
      </div>
      <pre id="errlog" class="mt-3 whitespace-pre-wrap text-sm"></pre>
    </div>
  </div>

  <script>
    // B·∫Øt l·ªói to√†n c·ª•c
    (function(){
      const show=(m)=>{const el=document.getElementById('err');const log=document.getElementById('errlog');if(log)log.textContent=String(m||'Unknown');if(el)el.style.display='flex';console.error('[GLOBAL ERROR]',m)};
      window.addEventListener('error',e=>show(e.error||e.message||e));
      window.addEventListener('unhandledrejection',e=>show(e.reason||e));
    })();
    // ƒêƒÉng k√Ω SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useRef,useMemo,useCallback} = React;

    /* ===== H·∫±ng s·ªë & ti·ªán √≠ch ===== */
    const SONGS_CACHE_KEY='mstq_songs_v4';
    const RESUME_KEY='mstq_resume_v7';
    const THEME_KEY='music-theme'; const SPEED_KEY='mstq_speed'; const MUTED_KEY='mstq_muted';
    const SHUFFLE_KEY='mstq_shuffle'; const REPEAT_KEY='mstq_repeat';
    const POWER_KEY='mstq_power_save'; const TIMER_KEY='mstq_sleep_timer'; const STOP_END_KEY='mstq_stop_at_end';
    const SRC_PREF_KEY='mstq_sources_pref'; const FAVORITES_KEY='mstq_favorites_v1';
    const INITIAL_VISIBLE=80, VISIBLE_STEP=120;

    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
    const formatTime=s=>{if(!isFinite(s)||s<0)return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${String(sec).padStart(2,'0')}`};

    // Link ngo√†i (s·ª≠a theo √Ω b·∫°n)
    const LINKS={
      home:'/',
      youtube:'https://youtube.com/',
      tiktok:'https://www.tiktok.com/',
      facebook:'https://www.facebook.com/groups/',
      telegram:'https://t.me/',
      zalo:'https://zalo.me/'
    };

    // Icon SVG r√∫t g·ªçn
    const I = (d=22,p="M5 12h14") => <svg width={d} height={d} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.7"><path d={p} strokeLinecap="round" strokeLinejoin="round"/></svg>;
    const ICONS={
      home:(d)=>I(d,"M3 10.5 12 3l9 7.5v8.5a1.5 1.5 0 0 1-1.5 1.5H4.5A1.5 1.5 0 0 1 3 19V10.5Z"),
      search:(d)=>I(d,"M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"),
      lib:(d)=>I(d,"M4 19h16M6 17V5a2 2 0 0 1 2-2h0M12 17V3h0M18 17V7a2 2 0 0 0-2-2h0"),
      settings:(d)=>I(d,"M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7Z M19.4 15l1.1 1.9-1.7 3-2.2-.4-.9 1.9h-3.4l-.9-1.9-2.2.4-1.7-3 1.1-1.9-1.1-1.9 1.7-3 2.2.4.9-1.9h3.4l.9 1.9 2.2-.4 1.7 3-1.1 1.9Z"),
      admin:(d)=>I(d,"M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm0 2c-4 0-7 2-7 4v3h14v-3c0-2-3-4-7-4Z"),
      play:(d)=>I(d,"M8 5v14l11-7z"), pause:(d)=>I(d,"M6 5h4v14H6zM14 5h4v14h-4z"),
      next:(d)=>I(d,"m13 5 9 7-9 7V5zM2 19V5h2v14H2z"), back:(d)=>I(d,"M11 19 2 12l9-7v14zm1-7 9 7V5l-9 7z"),
      more:(d)=>I(d,"M6 12h.01M12 12h.01M18 12h.01"), heart:(d)=>I(d,"M20.8 8.6a5.3 5.3 0 0 0-7.5 0L12 9.9l-1.3-1.3a5.3 5.3 0 0 0-7.5 7.5l8.8 8.8 8.8-8.8a5.3 5.3 0 0 0 0-7.5Z"),
      power:(d)=>I(d,"M12 3v9m6.36-3.36a9 9 0 1 1-12.72 0"),
      timer:(d)=>I(d,"M12 7v6l3 3M12 2v2M4.9 4.9l1.4 1.4M2 12h2M4.9 19.1l1.4-1.4M12 20v2M19.1 19.1l-1.4-1.4M20 12h2")
    };

    /* ===== Th√†nh ph·∫ßn UI nh·ªè ===== */
    const ThemeSwatch=({name,code,active,onPick})=>(
      <button onClick={()=>onPick(code)} aria-current={active} className={`w-full text-left p-4 rounded-2xl border border-[var(--border)] ${active?'ring-2 ring-[var(--ring)]':''}`}>
        <div className="flex items-center gap-3">
          <div className="w-6 h-6 rounded-full" style={{background:'var(--primary)'}}></div>
          <div>
            <div className="font-semibold">{name}</div>
            <div className="text-xs text-[var(--muted)]">{code}</div>
          </div>
        </div>
      </button>
    );

    const TopBar=({title,onTheme,linksOpen,setLinksOpen})=>(
      <header className="fixed top-0 inset-x-0 z-30 px-4 py-3 flex items-center justify-between bg-[var(--nav-bg)] backdrop-blur-lg border-b border-[var(--border)]">
        <div className="flex items-center gap-2">
          <img src="/PlayMusic/images/icons/icon-192x192.png" width="28" height="28" className="rounded-lg" alt="MSTQ"/>
          <h1 className="font-bold">{title}</h1>
          <span className="chip hidden sm:inline">PWA</span>
        </div>
        <div className="relative">
          <button id="btn-links" className="btn mr-2" onClick={()=>setLinksOpen(v=>!v)}>Li√™n k·∫øt ‚ñæ</button>
          {linksOpen && (
            <div className="absolute right-0 mt-2 w-56 rounded-2xl border border-[var(--border)] bg-[var(--card)] shadow-xl p-1 z-50">
              <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 flex items-center gap-2" onClick={()=>window.open(LINKS.home,'_blank')}>{ICONS.home(18)} Trang ch·ªß</button>
              <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 flex items-center gap-2" onClick={()=>window.open(LINKS.youtube,'_blank')}>üîó YOUTUBE</button>
              <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 flex items-center gap-2" onClick={()=>window.open(LINKS.tiktok,'_blank')}>üîó TIKTOK</button>
              <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 flex items-center gap-2" onClick={()=>window.open(LINKS.facebook,'_blank')}>üîó FACEBOOK Group</button>
              <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 flex items-center gap-2" onClick={()=>window.open(LINKS.telegram,'_blank')}>üîó TELEGRAM</button>
              <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 flex items-center gap-2" onClick={()=>window.open(LINKS.zalo,'_blank')}>üîó ZALO</button>
            </div>
          )}
          <button className="btn" onClick={onTheme}>Ch·ªß ƒë·ªÅ</button>
        </div>
      </header>
    );

    const TabBar=({tab,setTab})=>(
      <nav className="tabbar safe-bottom">
        <div className="flex">
          <button className="tabbtn" aria-current={tab==='home'} onClick={()=>setTab('home')}>{ICONS.home(22)}<span>Trang ch·ªß</span></button>
          <button className="tabbtn" aria-current={tab==='search'} onClick={()=>setTab('search')}>{ICONS.search(22)}<span>T√¨m ki·∫øm</span></button>
          <button className="tabbtn" aria-current={tab==='library'} onClick={()=>setTab('library')}>{ICONS.lib(22)}<span>Th∆∞ vi·ªán</span></button>
          <button className="tabbtn" aria-current={tab==='settings'} onClick={()=>setTab('settings')}>{ICONS.settings(22)}<span>C√†i ƒë·∫∑t</span></button>
          <button className="tabbtn" aria-current={tab==='admin'} onClick={()=>setTab('admin')}>{ICONS.admin(22)}<span>Admin</span></button>
        </div>
      </nav>
    );

    /* ======================= ·ª®NG D·ª§NG ======================= */
    function App(){
      /* ===== Tabs, Theme, Links Menu ===== */
      const [tab,setTab]=useState('home');
      const [theme,setTheme]=useState(localStorage.getItem(THEME_KEY)||'lucbao');
      const [linksOpen,setLinksOpen]=useState(false);
      useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);localStorage.setItem(THEME_KEY,theme);},[theme]);
      useEffect(()=>{
        const onClick=(e)=>{ if(!document.getElementById('btn-links')?.contains(e.target)) setLinksOpen(false); };
        window.addEventListener('click',onClick); return()=>window.removeEventListener('click',onClick);
      },[]);

      /* ===== D·ªØ li·ªáu b√†i h√°t / ngu·ªìn ===== */
      const [songs,setSongs]=useState([]);
      const [playlist,setPlaylist]=useState([]);
      const [loading,setLoading]=useState(true);
      const [visible,setVisible]=useState(INITIAL_VISIBLE);
      const [sourcePref,setSourcePref]=useState(load(SRC_PREF_KEY,{archive:true,custom:false,customText:""}));
      useEffect(()=>save(SRC_PREF_KEY,sourcePref),[sourcePref]);

      /* ===== Tr·∫°ng th√°i ph√°t ===== */
      const [currentIndex,setCurrentIndex]=useState(0);
      const [playing,setPlaying]=useState(false);
      const [progress,setProgress]=useState({current:0,duration:0});
      const [shuffle,setShuffle]=useState(load(SHUFFLE_KEY,false));
      const [repeat,setRepeat]=useState(load(REPEAT_KEY,'all')); // off|one|all
      const [stopAtEnd,setStopAtEnd]=useState(load(STOP_END_KEY,false));
      useEffect(()=>save(SHUFFLE_KEY,shuffle),[shuffle]);
      useEffect(()=>save(REPEAT_KEY,repeat),[repeat]);
      useEffect(()=>save(STOP_END_KEY,stopAtEnd),[stopAtEnd]);

      /* ===== √Çm thanh ===== */
      const audioRef=useRef(null);
      const preloadRef=useRef(null);
      useEffect(()=>{ audioRef.current=document.getElementById('mstq-player'); preloadRef.current=document.getElementById('mstq-preload'); },[]);
      const interactedRef=useRef(false);
      useEffect(()=>{ const m=()=>{interactedRef.current=true;document.removeEventListener('click',m);document.removeEventListener('keydown',m)};document.addEventListener('click',m,{once:true});document.addEventListener('keydown',m,{once:true});},[]);

      const [volume,setVolume]=useState(load(RESUME_KEY,{volume:.9}).volume??.9);
      const [playbackRate,setPlaybackRate]=useState(parseFloat(localStorage.getItem(SPEED_KEY)||'1')||1);
      const [muted,setMuted]=useState(localStorage.getItem(MUTED_KEY)==='1');
      useEffect(()=>{const a=audioRef.current;if(a){a.volume=volume}},[volume]);
      useEffect(()=>{const a=audioRef.current;if(a){a.playbackRate=playbackRate}localStorage.setItem(SPEED_KEY,String(playbackRate))},[playbackRate]);
      useEffect(()=>{const a=audioRef.current;if(a){a.muted=muted}localStorage.setItem(MUTED_KEY,muted?'1':'0')},[muted]);

      /* ===== Ti·∫øt ki·ªám pin + H·∫πn gi·ªù ===== */
      const [powerSave,setPowerSave]=useState(load(POWER_KEY,false));
      useEffect(()=>save(POWER_KEY,powerSave),[powerSave]);

      const [timerLeft,setTimerLeft]=useState(load(TIMER_KEY,null)); // ms
      const timerRef=useRef(null);
      const startSleepTimer=(ms)=>{
        clearInterval(timerRef.current);
        const end=Date.now()+ms;
        setTimerLeft(ms); save(TIMER_KEY,ms);
        timerRef.current=setInterval(()=>{
          const left=end-Date.now();
          if(left<=0){ clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null); pauseAll(); }
          else setTimerLeft(left);
        },1000);
      };
      const cancelSleepTimer=()=>{clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null);};
      useEffect(()=>{ const v=load(TIMER_KEY,null); if(v&&v>0) startSleepTimer(v); return()=>clearInterval(timerRef.current); },[]);

      /* ===== T·∫£i danh s√°ch t·ª´ nhi·ªÅu ngu·ªìn ===== */
      const FALLBACK_SONGS=[{id:"testmp3testfile/mpthreetest.mp3",title:"B√†i h√°t m·∫´u (T·∫°m th·ªùi)",artist:"Public Domain",stream_url:"https://archive.org/download/testmp3testfile/mpthreetest.mp3",artwork:"/PlayMusic/images/icons/icon-192x192.png",duration:5,lyrics:"B√†i m·∫´u.",item_identifier:"testmp3testfile"}];

      const parseCustomM3UorText=(txt)=>{
        const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const out=[]; let lastTitle="";
        for(const ln of lines){
          if(ln.startsWith('#EXTINF:')){ const t=ln.split(',').slice(1).join(',').trim(); if(t) lastTitle=t; }
          else if(/^https?:\/\//i.test(ln)){
            out.push({id:ln,title:lastTitle||ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:'/PlayMusic/images/icons/icon-192x192.png',duration:0,lyrics:'',item_identifier:'custom'});
            lastTitle="";
          }
        }
        if(!out.length){
          for(const ln of lines){
            if(/^https?:\/\//i.test(ln)){
              out.push({id:ln,title:ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:'/PlayMusic/images/icons/icon-192x192.png',duration:0,lyrics:'',item_identifier:'custom'});
            }
          }
        }
        return out;
      };

      const refetch=useCallback(async()=>{
        setLoading(true);
        const cached=load(SONGS_CACHE_KEY,null);
        if(cached?.length){setSongs(cached);setPlaylist(cached);setLoading(false)}
        try{
          let all=[];
          if(sourcePref.archive!==false){
            const queries=[
              'uploader:(tinhquang) AND mediatype:(audio)',
              'uploader:(thiensutinhquang) AND mediatype:(audio)',
              'creator:("Minh Su Tinh Quang") AND mediatype:(audio)'
            ];
            let docs=[];let ok=false;
            for(const q of queries){
              const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=publicdate+desc&rows=200&page=1&output=json`;
              const r=await fetch(url,{cache:'no-store'}); if(!r.ok) continue;
              const j=await r.json(); const list=j?.response?.docs||[]; if(list.length){docs=list;ok=true;break;}
            }
            if(ok){
              for(const d of docs){
                try{
                  const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                  (meta.files||[]).forEach(f=>{
                    if(String(f.format||'').toUpperCase().includes('MP3')){
                      all.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'TinhQuang',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                    }
                  });
                }catch{}
              }
            }
          }
          if(sourcePref.custom && sourcePref.customText?.trim()){
            all=[...all, ...parseCustomM3UorText(sourcePref.customText)];
          }
          if(!all.length){ all=FALLBACK_SONGS; }
          save(SONGS_CACHE_KEY,all); setSongs(all); setPlaylist(all);
        }catch{
          if(!cached?.length){ setSongs(FALLBACK_SONGS); setPlaylist(FALLBACK_SONGS); }
        }
        setLoading(false);
      },[sourcePref]);
      useEffect(()=>{refetch()},[]);

      const current=playlist[currentIndex]||null;

      /* ===== Preload an to√†n (t·∫Øt khi n·ªÅn/powerSave) ===== */
      const queuePreload=useCallback((idx)=>{
        const n=(idx+1)%playlist.length;
        const next=playlist[n]; const pre=preloadRef.current;
        if(!next||!pre) return;
        if (powerSave || document.visibilityState!=='visible') { pre.removeAttribute('src'); pre.load(); return; }
        if (isiOS && document.visibilityState!=='visible') return;
        if(pre.src!==next.stream_url){ pre.src=next.stream_url; pre.load(); }
      },[playlist,powerSave]);
      useEffect(()=>{ if(playlist.length) queuePreload(currentIndex); },[playlist.length,currentIndex,queuePreload]);
      useEffect(()=>{ const h=()=>queuePreload(currentIndex); document.addEventListener('visibilitychange',h); return()=>document.removeEventListener('visibilitychange',h); },[queuePreload,currentIndex]);

      /* ===== Media Session ===== */
      useEffect(()=>{
        const a=audioRef.current; if(!a||!current||!('mediaSession' in navigator)) return;
        try{
          navigator.mediaSession.metadata=new MediaMetadata({
            title:current.title, artist:current.artist||'minhsutinhquang', album:'MSTQ Music',
            artwork:[{src:current.artwork||'/PlayMusic/images/icons/icon-192x192.png',sizes:'512x512',type:'image/png'}]
          });
          navigator.mediaSession.setActionHandler('play',()=>{ setPlaying(true); a.play().catch(()=>{}); });
          navigator.mediaSession.setActionHandler('pause',()=>{ setPlaying(false); a.pause(); });
          navigator.mediaSession.setActionHandler('previoustrack',()=>prevTrack());
          navigator.mediaSession.setActionHandler('nexttrack',()=>nextTrack());
          navigator.mediaSession.setActionHandler('seekbackward',d=>{ a.currentTime=Math.max(0,(a.currentTime||0)-(d.seekOffset||10)); });
          navigator.mediaSession.setActionHandler('seekforward',d=>{ a.currentTime=Math.min(a.duration||0,(a.currentTime||0)+(d.seekOffset||10)); });
          navigator.mediaSession.setActionHandler('seekto',d=>{ if(d.seekTime!=null) a.currentTime=d.seekTime; });
          navigator.mediaSession.playbackState=playing?'playing':'paused';
          navigator.mediaSession.setPositionState?.({duration:a.duration||0,position:a.currentTime||0,playbackRate:a.playbackRate||1});
        }catch{}
      },[current,playing]);

      /* ===== Watchdog ch·ªëng k·∫πt (kh√¥ng spam) ===== */
      const targetPlayingRef=useRef(false);
      const lastProgRef=useRef({t:0,pos:0});
      const stallScoreRef=useRef(0);
      const lastManualPauseRef=useRef(0);
      const lastRecoverRef=useRef(0);

      // Wake lock khi visible
      useEffect(()=>{
        let lock=null;
        const reqLock=async()=>{try{if('wakeLock'in navigator && document.visibilityState==='visible'){lock=await navigator.wakeLock.request('screen');}}catch{}};
        const vis=()=>{ if(document.visibilityState==='visible'){ reqLock(); if(targetPlayingRef.current){ audioRef.current?.play?.().catch(()=>{}); } } };
        reqLock(); document.addEventListener('visibilitychange',vis);
        return()=>{document.removeEventListener('visibilitychange',vis);try{lock?.release?.()}catch{}};
      },[]);

      // audio events
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const onTime=()=>{ if(!isFinite(a.duration)) return; setProgress({current:a.currentTime||0,duration:a.duration||0});
          const now=Date.now();
          if(Math.abs(a.currentTime-(lastProgRef.current.pos||0))>0.25){ lastProgRef.current={t:now,pos:a.currentTime}; stallScoreRef.current=0; }
        };
        const onEnded=()=>{ handleEnd(); };
        const onPause=()=>{ if(!targetPlayingRef.current){ lastManualPauseRef.current=Date.now(); } };
        a.addEventListener('timeupdate',onTime);
        a.addEventListener('ended',onEnded);
        ['stalled','suspend','waiting','error','abort'].forEach(e=>a.addEventListener(e,()=>{}));
        a.addEventListener('pause',onPause);
        return()=>{a.removeEventListener('timeupdate',onTime);a.removeEventListener('ended',onEnded);['stalled','suspend','waiting','error','abort'].forEach(e=>a.removeEventListener(e,()=>{}));a.removeEventListener('pause',onPause);};
      },[]);

      useEffect(()=>{
        const interval = powerSave ? 8000 : 5000;
        const tick=setInterval(async()=>{
          const a=audioRef.current; if(!a||!current) return;
          // l∆∞u resume
          save(RESUME_KEY,{index:currentIndex,id:current.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});
          if(!targetPlayingRef.current) return;
          if(Date.now()-lastManualPauseRef.current<1500) return;

          const stagnate = (Date.now()-(lastProgRef.current.t||0) > (document.visibilityState==='visible'?(powerSave?28000:20000):(powerSave?15000:12000)));
          const poorReady = a.readyState<2;

          const now=Date.now();
          const canRecover = now - (lastRecoverRef.current||0) > (powerSave?3500:2500);

          if(a.paused && canRecover){
            lastRecoverRef.current=now;
            try{ await a.play(); return; }catch{}
          }
          if((stagnate || poorReady) && canRecover){
            lastRecoverRef.current=now;
            stallScoreRef.current++;
            try{
              if(a.paused) await a.play();
              if(a.paused || poorReady){ a.load(); await a.play().catch(()=>{}); }
              const limit=(document.visibilityState==='visible'?(powerSave?4:3):(powerSave?3:2));
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(); }
            }catch{
              const limit=(document.visibilityState==='visible'?(powerSave?4:3):(powerSave?3:2));
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(); }
            }
          }
        },interval);
        return()=>clearInterval(tick);
      },[currentIndex,current,powerSave]);

      /* ===== ƒêi·ªÅu khi·ªÉn ===== */
      const computeNextIndex = useCallback((dir)=> {
        if(!playlist.length) return 0;
        if(shuffle){
          let r=Math.floor(Math.random()*playlist.length);
          if (r===currentIndex) r=(r+1)%playlist.length;
          return r;
        }
        if(dir>0) return (currentIndex+1)%playlist.length;
        if(dir<0) return (currentIndex-1+playlist.length)%playlist.length;
        return currentIndex;
      },[playlist.length,shuffle,currentIndex]);

      const nextTrack=useCallback(()=>{
        if(!playlist.length) return;
        const i=computeNextIndex(+1);
        setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i);
      },[playlist.length,computeNextIndex,queuePreload]);

      const prevTrack=useCallback(()=>{
        if(!playlist.length) return;
        const a=audioRef.current; if(a?.currentTime>3){ a.currentTime=0; return; }
        const i=computeNextIndex(-1);
        setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i);
      },[playlist.length,computeNextIndex,queuePreload]);

      const handleEnd=useCallback(()=>{
        if(repeat==='one'){ const a=audioRef.current; if(a){ a.currentTime=0; a.play().catch(()=>{});} return; }
        if(stopAtEnd && currentIndex===playlist.length-1){ setPlaying(false); targetPlayingRef.current=false; return; }
        if(repeat==='off' && currentIndex===playlist.length-1){ setPlaying(false); targetPlayingRef.current=false; return; }
        nextTrack();
      },[repeat,stopAtEnd,currentIndex,playlist.length,nextTrack]);

      const pickSong=(s)=>{
        const i=playlist.findIndex(x=>x.id===s.id);
        if(i>=0){ setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i); }
      };

      const playPause=()=>{
        const a=audioRef.current; if(!a) return;
        if(!current && playlist.length){ setCurrentIndex(0); setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); return; }
        if(playing){ setPlaying(false); targetPlayingRef.current=false; a.pause(); }
        else{ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
      };
      const pauseAll=()=>{const a=audioRef.current; if(a){ setPlaying(false); targetPlayingRef.current=false; a.pause(); }};

      // Load & apply khi current ƒë·ªïi
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        if(current){
          if(a.src!==current.stream_url){ a.src=current.stream_url; a.load(); }
          a.playbackRate=playbackRate; a.muted=muted; a.volume=volume;
          document.title=`${playing?'‚ñ∂':'‚è∏'} ${current.title} ‚Äì MSTQ`;
          if(playing && interactedRef.current){ a.play().catch(()=>{}); }
        }else{ document.title='MSTQ Music'; }
      },[currentIndex,playing,playbackRate,muted,volume,current]);

      // resume
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const r=load(RESUME_KEY,null);
        if(r&&playlist.length){
          const idx=Math.min(Math.max(0,r.index||0),playlist.length-1);
          setCurrentIndex(idx);
          setTimeout(()=>{ const s=playlist[idx]; if(!s) return;
            if(a.src!==s.stream_url){ a.src=s.stream_url; a.load(); }
            a.currentTime=Number(r.currentTime||0); a.volume=r.volume??volume; a.playbackRate=r.rate??playbackRate; a.muted=!!r.muted;
            if(r.playing){ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
          },0);
        }
      // eslint-disable-next-line react-hooks/exhaustive-deps
      },[playlist.length]);

      useEffect(()=>{
        const saver=()=>{const a=audioRef.current;if(!a) return;save(RESUME_KEY,{index:currentIndex,id:current?.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});};
        window.addEventListener('pagehide',saver); document.addEventListener('freeze',saver);
        return()=>{window.removeEventListener('pagehide',saver);document.removeEventListener('freeze',saver);};
      },[currentIndex,current]);

      /* ===== Favorites ===== */
      const [favs,setFavs]=useState(load(FAVORITES_KEY,[]));
      const isFav=(s)=>favs.some(x=>x.id===s.id);
      const toggleFav=(s)=>{
        setFavs((prev)=>{
          const ex=isFav(s);
          const out = ex ? prev.filter(x=>x.id!==s.id) : [{id:s.id,title:s.title,artist:s.artist,artwork:s.artwork},...prev].slice(0,200);
          save(FAVORITES_KEY,out); return out;
        });
      };

      /* ====== Giao di·ªán c√°c tab ====== */
      const HomeTab = () => (
        <div className="px-4 py-3">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-xl font-semibold">Danh s√°ch ph√°t</h2>
            <span className="chip">{songs.length} b√†i</span>
          </div>
          {loading?(
            <div className="animate-pulse space-y-3">{Array.from({length:6}).map((_,i)=>(<div key={i} className="h-14 rounded-xl bg-[var(--card)]/40"></div>))}</div>
          ):(
            <>
              <div className="space-y-2">
                {playlist.slice(0,visible).map((s)=>(
                  <div key={s.id} className={`flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)] ${current?.id===s.id?'ring-2 ring-[var(--ring)] bg-[var(--card)]/50':''}`}>
                    <img src={s.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-12 h-12 rounded-lg object-cover"/>
                    <button className="flex-grow text-left" onClick={()=>pickSong(s)}>
                      <div className="font-semibold truncate">{s.title||'Untitled'}</div>
                      <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                    </button>
                    <button className="btn" title="Y√™u th√≠ch" onClick={()=>toggleFav(s)}>{ICONS.heart(18)}</button>
                    <div className="text-xs text-[var(--muted)]">{formatTime(s.duration||0)}</div>
                  </div>
                ))}
              </div>
              {songs.length>visible && <button onClick={()=>setVisible(v=>Math.min(playlist.length,v+VISIBLE_STEP))} className="btn w-full mt-3">T·∫£i th√™m</button>}
            </>
          )}
        </div>
      );

      const SearchTab = () => {
        const [kw,setKw]=useState('');
        const [busy,setBusy]=useState(false);
        const doSearch=async()=>{
          setBusy(true);
          try{
            const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(kw+' AND mediatype:(audio)')}&fl[]=identifier,title,creator,description&sort[]=downloads+desc&rows=100&page=1&output=json`;
            const r=await fetch(url,{cache:'no-store'}); const j=await r.json();
            const docs=j?.response?.docs||[];
            const out=[];
            for(const d of docs){
              try{
                const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                (meta.files||[]).forEach(f=>{
                  if(String(f.format||'').toUpperCase().includes('MP3')){
                    out.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'Archive',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                  }
                });
              }catch{}
            }
            if(out.length){ setPlaylist(out); setVisible(INITIAL_VISIBLE); setTab('home'); }
          }catch{}
          setBusy(false);
        };
        return (
          <div className="px-4 py-3">
            <div className="flex gap-2">
              <input className="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-xl p-2" placeholder="T√¨m tr√™n Archive.org..." value={kw} onChange={e=>setKw(e.target.value)}/>
              <button className="btn btn-primary" onClick={doSearch} disabled={!kw||busy}>{busy?'ƒêang t√¨m‚Ä¶':'T√¨m'}</button>
            </div>
            <p className="text-xs text-[var(--muted)] mt-2">G·ª£i √Ω: ‚ÄúMinh Su Tinh Quang‚Äù, ‚ÄúPh√°p tho·∫°i‚Äù‚Ä¶</p>
          </div>
        );
      };

      const LibraryTab = () => (
        <div className="px-4 py-3">
          <div className="mb-2 flex items-center justify-between">
            <h2 className="text-lg font-semibold">Y√™u th√≠ch</h2>
            <span className="chip">{favs.length} b√†i</span>
          </div>
          {favs.length===0 ? <p className="text-[var(--muted)] text-sm">Ch∆∞a c√≥ b√†i n√†o trong ‚ÄúY√™u th√≠ch‚Äù.</p>:
            <div className="space-y-2">
              {favs.map(s=>(
                <div key={s.id} className="flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)]">
                  <img src={s.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-12 h-12 rounded-lg object-cover"/>
                  <button className="flex-grow text-left" onClick={()=>pickSong(s)}>
                    <div className="font-semibold truncate">{s.title}</div>
                    <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                  </button>
                  <button className="btn" onClick={()=>toggleFav(s)} title="B·ªè y√™u th√≠ch">‚àí</button>
                </div>
              ))}
            </div>
          }
        </div>
      );

      const SettingsTab = () => (
        <div className="px-4 py-3 space-y-6">
          <!-- Theme grid -->
          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-lg">Giao di·ªán</h3>
              <span className="chip">{theme}</span>
            </div>
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
              {[
                ['T·ªëi','dark'],['S√°ng','light'],['L·ª•c B·∫£o','lucbao'],['Tinh Quang','tinhquang'],['Sen V√†ng','senvang'],['B√¨nh Minh','binhminh'],
                ['H∆∞ Kh√¥ng','hukhong'],['Kim C∆∞∆°ng','kimcuong'],['H√†o Quang','haoguang'],['Thi√™n ·∫¢nh','thienanh'],['Sakura','sakura']
              ].map(([label,code])=>(
                <ThemeSwatch key={code} name={label} code={code} active={theme===code} onPick={setTheme}/>
              ))}
            </div>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Ch·∫ø ƒë·ªô ti·∫øt ki·ªám ƒëi·ªán</h3>
            <p className="text-sm text-[var(--muted)] mb-2">Gi·∫£m t·∫£i n·ªÅn & t·∫Øt preload khi n·ªÅn ƒë·ªÉ ti·∫øt ki·ªám pin.</p>
            <label className="flex items-center gap-2">
              <input type="checkbox" checked={!!powerSave} onChange={e=>setPowerSave(e.target.checked)}/> {ICONS.power(18)} B·∫≠t ti·∫øt ki·ªám pin
            </label>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-3">H·∫πn gi·ªù t·∫Øt nh·∫°c</h3>
            <div className="grid grid-cols-3 sm:grid-cols-6 gap-2">
              {[15,30,45,60,90,120].map(m=>(
                <button key={m} className="btn" onClick={()=>startSleepTimer(m*60*1000)}>{m} ph√∫t</button>
              ))}
            </div>
            <div className="flex items-center gap-3 mt-3">
              <span className="chip">{timerLeft?`C√≤n: ${formatTime(Math.ceil(timerLeft/1000))}`:'Kh√¥ng ƒë·∫∑t'}</span>
              {timerLeft && <button className="btn" onClick={cancelSleepTimer}>Hu·ª∑ h·∫πn gi·ªù</button>}
            </div>
            <label className="flex items-center gap-2 mt-3">
              <input type="checkbox" checked={!!stopAtEnd} onChange={e=>setStopAtEnd(e.target.checked)} /> D·ª´ng khi h·∫øt b√†i
            </label>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Ngu·ªìn d·ªØ li·ªáu</h3>
            <label className="flex items-center gap-2 mb-2">
              <input type="checkbox" checked={sourcePref.archive!==false} onChange={e=>setSourcePref(p=>({...p,archive:e.target.checked}))}/>
              <span>Archive.org</span>
            </label>
            <label className="flex items-center gap-2 mb-2">
              <input type="checkbox" checked={!!sourcePref.custom} onChange={e=>setSourcePref(p=>({...p,custom:e.target.checked}))}/>
              <span>Ngu·ªìn tu·ª≥ ch·ªânh (m·ªói d√≤ng 1 URL ho·∫∑c M3U)</span>
            </label>
            <textarea className="w-full bg-[var(--card)] border border-[var(--border)] rounded-xl p-2 min-h-[120px]" placeholder="https://.../song1.mp3&#10;https://.../song2.mp3&#10;#EXTINF:-1,T·ª±a ƒë·ªÅ&#10;https://.../song3.mp3" value={sourcePref.customText||''} onChange={e=>setSourcePref(p=>({...p,customText:e.target.value}))}></textarea>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">D·ªØ li·ªáu & ƒê·ªìng b·ªô</h3>
            <div className="flex flex-col gap-2">
              <button className="btn" onClick={()=>refetch()}>L√†m m·ªõi danh s√°ch nh·∫°c</button>
              <button className="btn" style="background:#2a1313;border-color:#6b1d1d;color:#fff" onClick={async()=>{
                // xo√° cache c·ªßa app + localStorage
                try{
                  if('caches' in window){
                    const keys=await caches.keys();
                    for(const k of keys){ await caches.delete(k); }
                  }
                }catch{}
                try{ localStorage.clear(); }catch{}
                location.reload();
              }}>X√≥a & L√†m m·ªõi t·∫•t c·∫£</button>
              <p className="text-xs text-[var(--muted)]">N·∫øu g·∫∑p l·ªói ho·∫∑c danh s√°ch kh√¥ng c·∫≠p nh·∫≠t, h√£y th·ª≠ c√°c tu·ª≥ ch·ªçn n√†y.</p>
            </div>
          </div>
        </div>
      );

      const AdminTab = () => (
        <div className="px-4 py-3 space-y-3">
          <h3 className="font-semibold text-lg">B·∫£ng ƒëi·ªÅu khi·ªÉn</h3>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div className="p-3 rounded-2xl border border-[var(--border)]">
              <div className="text-sm">B√†i hi·ªán t·∫°i: <span className="chip">{current?.title||'‚Äî'}</span></div>
              <div className="text-sm mt-1">V·ªã tr√≠: <span className="chip">{formatTime(progress.current)} / {formatTime(progress.duration)}</span></div>
              <div className="text-sm mt-1">Tr·∫°ng th√°i: <span className="chip">{playing?'playing':'paused'}</span></div>
              <div className="mt-2 flex gap-2">
                <button className="btn" onClick={()=>audioRef.current?.play?.()}>Force Play</button>
                <button className="btn" onClick={()=>audioRef.current?.load?.()}>Force Load</button>
              </div>
            </div>
            <div className="p-3 rounded-2xl border border-[var(--border)]">
              <div className="text-sm">Playlist: <span className="chip">{playlist.length}</span></div>
              <div className="text-sm mt-1">Shuffle: <span className="chip">{String(shuffle)}</span></div>
              <div className="text-sm mt-1">Repeat: <span className="chip">{repeat}</span></div>
            </div>
          </div>
        </div>
      );

      /* ====== M√†n h√¨nh ƒêang ph√°t ====== */
      const [showNowPlaying,setShowNowPlaying]=useState(false);
      const NowPlaying = () => {
        if(!current) return null;
        return (
          <div className="fixed inset-0 z-50 bg-[var(--bg)]/98 backdrop-blur-md">
            <div className="p-4 flex items-center justify-between border-b border-[var(--border)]">
              <button className="btn" onClick={()=>setShowNowPlaying(false)}>ƒê√≥ng</button>
              <div className="font-semibold">ƒêang ph√°t</div>
              <div className="w-14"></div>
            </div>
            <div className="px-6 py-6">
              <div className="mx-auto w-64 h-64 rounded-3xl shadow-xl overflow-hidden" style={{background:'var(--gradient)'}}>
                <img src={current.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-full h-full object-cover mix-blend-luminosity"/>
              </div>
              <div className="mt-5 text-center">
                <div className="text-xl font-bold truncate">{current.title}</div>
                <div className="text-sm text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</div>
              </div>

              <div className="mt-5 px-1">
                <div className="h-1.5 bg-[var(--muted)]/20 rounded">
                  <div className="h-1.5 bg-[var(--primary)] rounded" style={{width:`${progress.duration>0?(progress.current/progress.duration)*100:0}%`}}></div>
                </div>
                <div className="mt-1 text-[12px] text-[var(--muted)] flex justify-between">
                  <span>{formatTime(progress.current)}</span>
                  <span>{formatTime(progress.duration)}</span>
                </div>
              </div>

              <div className="mt-5 flex items-center justify-center gap-4">
                <button className="btn" onClick={()=>setShuffle(s=>!s)}>{shuffle?'Ng·∫´u nhi√™n ‚úì':'Ng·∫´u nhi√™n'}</button>
                <button className="btn" onClick={prevTrack}>{ICONS.back(24)}</button>
                <button className="btn btn-primary" onClick={playPause}>{playing?ICONS.pause(24):ICONS.play(24)}</button>
                <button className="btn" onClick={nextTrack}>{ICONS.next(24)}</button>
                <button className="btn" onClick={()=>{
                  setRepeat(r=>r==='off'?'all':r==='all'?'one':'off');
                }}>L·∫∑p: {repeat==='off'?'T·∫Øt':repeat==='all'?'DS':'1'}</button>
              </div>
            </div>
          </div>
        );
      };

      /* ====== Render ====== */
      const padTop=64; // topbar
      const padBottom = (current? 190:110); // mini + tabbar

      return (
        <div className="min-h-screen" style={{paddingTop:padTop, paddingBottom:padBottom}}>
          <TopBar title={tab==='home'?'Trang ch·ªß':tab==='search'?'T√¨m ki·∫øm':tab==='library'?'Th∆∞ vi·ªán':tab==='settings'?'C√†i ƒë·∫∑t':'Admin'} onTheme={()=>setTheme(t=>t==='lucbao'?'light':'lucbao')} linksOpen={linksOpen} setLinksOpen={setLinksOpen}/>

          {tab==='home' && <HomeTab/>}
          {tab==='search' && <SearchTab/>}
          {tab==='library' && <LibraryTab/>}
          {tab==='settings' && <SettingsTab/>}
          {tab==='admin' && <AdminTab/>}

          <TabBar tab={tab} setTab={setTab}/>

          {/* Mini Player */}
          {current && (
            <div className="fixed left-2 right-2 rounded-2xl bg-[var(--card)]/95 border border-[var(--border)] backdrop-blur-md p-2 z-50 shadow-[var(--shadow)]" style={{bottom:'64px'}}>
              <div className="flex items-center gap-3">
                <img src={current.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" width="44" height="44" className="rounded-lg object-cover"/>
                <button className="flex-grow min-w-0 text-left" onClick={()=>setShowNowPlaying(true)}>
                  <p className="truncate font-semibold">{current.title}</p>
                  <p className="text-xs text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</p>
                </button>
                <button className="w-10 h-10" onClick={prevTrack} aria-label="Previous">{ICONS.back(22)}</button>
                <button className="w-10 h-10" onClick={playPause} aria-label="Play/Pause">{playing?ICONS.pause(22):ICONS.play(22)}</button>
                <button className="w-10 h-10" onClick={nextTrack} aria-label="Next">{ICONS.next(22)}</button>
              </div>
              <div className="mt-2 h-1 bg-[var(--muted)]/20 rounded">
                <div className="h-1 bg-[var(--primary)] rounded" style={{width:`${progress.duration>0?(progress.current/progress.duration)*100:0}%`}}></div>
              </div>
            </div>
          )}

          {showNowPlaying && <NowPlaying/>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
