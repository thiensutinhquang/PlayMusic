<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Play Nhạc MSTQ - Bản Nâng Cấp Toàn Diện</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="https://thiensutinhquang.github.io/PlayMusic/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <link rel="apple-touch-icon" href="https://thiensutinhquang.github.io/PlayMusic/images/icons/icon-192x192.png">

    <!-- Optimization: Preconnect to critical domains -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://api.audius.co">
    <!-- Assuming common discovery hosts, add more if known -->
    <link rel="preconnect" href="https://discoveryprovider.audius.co"> 
    <link rel="preconnect" href="https://discoveryprovider2.audius.co">

    <!-- Libraries -->
    <!-- Optimization: Preload critical scripts -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://unpkg.com/@phosphor-icons/web" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2" as="script">
    <link rel="preload" href="https://fonts.gstatic.com/s/bevietnampro/v11/QdVN_sc_f5t3g4N_LqR_2_NPg_jC_gL_g_bC_gW_g.woff2" as="font" type="font/woff2" crossorigin>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    
    <!-- 
        GIẢI PHÁP 1: TÁCH CSS RA FILE RIÊNG (main.css)
        Trong dự án thực tế, bạn sẽ tạo một file main.css và đặt toàn bộ CSS dưới đây vào đó.
        Sau đó, bạn sẽ liên kết nó như sau: <link rel="stylesheet" href="main.css">
        Trong môi trường Canvas, chúng ta vẫn phải giữ nó trong thẻ <style>, nhưng đây là cách bạn tổ chức nó.
    -->
    <style>
        /* ==============================================
        HỆ THỐNG THIẾT KẾ & BIẾN TOÀN CỤC (CSS VARIABLES)
        ============================================== */
        :root {
            /* Màu chủ đạo */
            --primary-color: #f59e0b;       /* Cam hổ phách */
            --primary-hover: #d97706;       /* Cam đậm hơn */
            --secondary-color: #3b82f6;     /* Xanh dương trung tính */
            --danger-color: #ef4444;        /* Đỏ cảnh báo */

            /* Giao diện Sáng (Tone Trắng Kem + Cam Hổ Phách Ấm) */
            --bg-light: #fdfcfb;            /* Trắng kem dịu */
            --card-bg-light: #ffffff;       /* Nền thẻ trắng */
            --text-light: #1f2937;          /* Xám đậm dễ đọc */
            --text-muted-light: #64748b;    /* Xám mờ vừa đủ */
            --border-light: #dbeafe;        /* Xanh xám nhẹ */
            --logo-bg-light: #fef9ef;       /* Nền logo hơi vàng nhạt */

            /* Màu cho nút "Tải thêm nhạc" */
            --load-more-bg: #FFD700;        /* Vàng kim */
            --load-more-text: #8B4513;      /* Nâu đỏ */
            --load-more-hover-bg: #DAA520;  /* Vàng kim đậm hơn khi hover */


            /* Giá trị mặc định áp dụng */
            --bg-current: var(--bg-light);
            --card-bg-current: var(--card-bg-light);
            --text-current: var(--text-light);
            --text-muted-current: var(--text-muted-light);
            --border-current: var(--border-light);
            --logo-bg-current: var(--logo-bg-light);
            --font-sans: 'Be Vietnam Pro', sans-serif; /* Added back font variable */
        }

        /* Giao diện Tối (Tone Than Xám + Cam Vàng Nổi Bật) */
        body.dark-mode {
            --bg-current: #1a1c23;          /* Than đậm dịu mắt */
            --card-bg-current: #232732;     /* Xám xanh lạnh */
            --text-current: #f1f5f9;        /* Trắng hơi xám dễ nhìn */
            --text-muted-current: #cbd5e1;  /* Xám trắng rõ ràng hơn */
            --border-current: #3b4252;      /* Viền rõ trên nền tối */
            --logo-bg-current: #1f2530;     /* Logo nền than xanh */

            /* Màu cho nút "Tải thêm nhạc" trong Dark Mode */
            --load-more-bg: #FFD700;        /* Vàng kim */
            --load-more-text: #8B4513;      /* Nâu đỏ */
            --load-more-hover-bg: #DAA520;  /* Vàng kim đậm hơn khi hover */
        }
        
        /* ==============================================
        PHONG CÁCH CƠ BẢN & TOÀN CỤC
        ============================================== */
        html { scroll-behavior: smooth; }
        
        body {
            font-family: var(--font-sans); /* Changed to use font variable */
            background-color: var(--bg-current);
            color: var(--text-current);
            transition: background-color var(--transition-slow), color var(--transition-fast);
            line-height: 1.6;
            padding-bottom: 90px;
            overflow-x: hidden;
            touch-action: manipulation; /* Ngăn chặn các cử chỉ chạm mặc định của trình duyệt */
        }
        
        .container { max-width: 1280px; margin: 0 auto; padding: 1rem 1.5rem; }
        
        .card {
            background-color: var(--card-bg-current);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-current);
            transition: var(--transition-slow);
            padding: 1.25rem 1.5rem;
            will-change: transform, box-shadow; /* Optimize for hover effects - kept as per user's model */
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        /* ==============================================
        HEADER & ĐIỀU HƯỚNG
        ============================================== */
        .header {
            background-color: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid var(--border-current);
            position: sticky; top: 0; z-index: 1000;
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column; 
            align-items: center; padding: 1rem 0; height: auto;
        }
        body.dark-mode .header { background-color: rgba(15, 23, 42, 0.7); }

        .header-layout-wrapper {
            display: flex; align-items: stretch; justify-content: space-between;
            width: 100%; gap: 1.5rem; padding: 0 1.5rem;
        }

        .header-logo-container {
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            max-width: 200px; width: 20%; min-width: 100px; position: relative; 
            background-color: var(--logo-bg-current); 
            transition: background-color var(--transition-fast);
            padding: 10px; box-sizing: content-box; border-radius: 12px; 
            border: 1px solid var(--border-current); 
        }
        
        #header-logo-placeholder {
            width: 100%; height: 100%; display: flex; align-items: center;
            justify-content: center; position: relative; overflow: hidden; 
            border-radius: 8px;
        }
        #header-logo-placeholder svg {
            width: 100%; height: 100%; object-fit: cover;
            position: relative; z-index: 1; 
        }

        #header-logo-placeholder::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 400%; height: 400%; 
            border-radius: 50%; 
            background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.9) 20%, rgba(255, 255, 255, 0) 60%);
            z-index: 0;
            animation: radiant-glow 1.5s infinite alternate ease-in-out; 
        }

        @keyframes radiant-glow {
            0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0.9; filter: blur(5px); }
            100% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; filter: blur(15px); }
        }

        .header-main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; text-align: center; justify-content: center;
        }

        .main-title {
            font-size: 2.5rem; font-weight: 800;
            color: var(--primary-color); margin: 0.5rem 0; width: 100%;
        }
        
        /* Reverted to original @apply structure for nav items */
        .nav-item {
            display: inline-flex; align-items: center; gap: 0.5rem; 
            background-color: transparent; color: var(--text-muted-current); 
            padding: 0.6rem 1rem; border-radius: 8px; text-decoration: none; 
            font-weight: 500; font-size: 0.95rem; border: 2px solid transparent; 
            transition: var(--transition-fast); white-space: nowrap;
        }
        .nav-item:hover { color: var(--text-current); background-color: var(--bg-current); transform: translateY(-2px); }
        .nav-item:active { transform: scale(0.95); }
        .nav-item.active { color: var(--primary-color); font-weight: 700; background-color: var(--bg-current); border-color: var(--primary-color); }

        .dropdown-container { position: relative; }
        /* Reverted to original @apply structure for dropdown toggle */
        .dropdown-toggle {
            display: inline-flex; align-items: center; gap: 0.5rem; background-color: transparent;
            color: var(--text-muted-current); padding: 0.6rem 1rem; border-radius: 8px;
            text-decoration: none; font-weight: 500; font-size: 0.95rem; border: 2px solid transparent;
            transition: var(--transition-fast); white-space: nowrap; cursor: pointer; 
        }
        .dropdown-toggle:hover { color: var(--text-current); background-color: var(--bg-current); transform: translateY(-2px); }
        .dropdown-toggle.active { color: var(--primary-color); font-weight: 700; background-color: var(--bg-current); border-color: var(--primary-color); }
        .dropdown-toggle .ph-caret-down { transition: transform 0.2s ease-in-out; }
        .dropdown-toggle.open .ph-caret-down { transform: rotate(180deg); }

        .dropdown-menu {
            display: none; position: absolute; top: calc(100% + 10px); right: 0;
            background-color: var(--card-bg-current); border-radius: 8px; 
            box-shadow: var(--shadow-lg); border: 1px solid var(--border-current); 
            width: 220px; z-index: 1010; opacity: 0; transform: translateY(10px); 
            transition: opacity 0.3s ease, transform 0.3s ease; padding: 0.5rem; 
        }
        .dropdown-menu.show { display: block; opacity: 1; transform: translateY(0); } /* Added back .show rule */
        .dropdown-menu a { 
            display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; 
            color: var(--text-muted-current); text-decoration: none; 
            transition: var(--transition-fast); font-size: 0.95rem; border-radius: 6px; 
        }
        .dropdown-menu a:hover { background-color: var(--primary-color); color: #fff; }
        .dropdown-menu a i, .dropdown-menu a svg { font-size: 1.25rem; width: 20px; height: 20px; text-align: center; }

        .preset-theme-btn {
            width: 32px; height: 32px; border-radius: 8px; border: 2px solid var(--border-current);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: var(--shadow-sm);
        }
        .preset-theme-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-md); }
        .preset-theme-btn.active { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.4); }

        /* Reverted to original @apply structure for timer action buttons */
        .timer-action-btn {
            width: 100%; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 600; 
            transition: all 0.2s ease-in-out; cursor: pointer; text-align: center;
            display: block; color: white; margin-top: 0.5rem;
        }
        .timer-action-btn.bg-primary-color { background-color: var(--primary-color); }
        .timer-action-btn.bg-primary-color:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .timer-action-btn.bg-danger-color { background-color: var(--danger-color); }
        .timer-action-btn.bg-danger-color:hover { background-color: #dc2626; transform: translateY(-2px); box-shadow: var(--shadow-md); }

        body:not(.dark-mode) input[type="number"] { color: var(--text-light); background-color: #f8fafc; border-color: #cbd5e1; }
        #player-bar .player-buttons button.active-control,
        #player-bar .player-actions-right button.active-control { color: var(--primary-color); }
        #player-bar .player-actions-right button.liked { color: var(--danger-color); }

        /* ==============================================
        MÀN HÌNH CHÀO (SPLASH SCREEN)
        ============================================== */
        #splash-screen { 
            position: fixed; inset: 0; z-index: 9999; 
            opacity: 0; transition: opacity 1s ease-out, visibility 1s ease-out; 
            visibility: hidden; display: flex; justify-content: center; align-items: center; 
            background: #000; overflow: hidden;
        }
        #splash-screen.visible { opacity: 1; visibility: visible; }
        #splash-screen.hidden { opacity: 0; visibility: hidden; }
        #splash-logo-container { width: 250px; height: 250px; position: relative; z-index: 10; }
        #splash-logo-placeholder svg, #header-logo-placeholder svg { width: 100%; height: 100%; object-fit: contain; }
        
        /* ==============================================
        HIỆU ỨNG LOGO & VŨ TRỤ
        ============================================== */
        #header-logo-placeholder #human-body.breathing-effect { animation: breathe 2s infinite alternate ease-in-out; }
        #header-logo-placeholder #chakra-system.energy-flow-active { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: flow-animation 3s linear infinite; }
        #header-logo-placeholder #logo-text-trucchichantam.highlight-text { fill: gold; }

        .stars, .stars2, .stars3 {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; display: block; background: transparent;
        }
        .stars { animation: rotate-stars 150s linear infinite; }
        .stars2 { animation: rotate-stars 100s linear infinite; }
        .stars3 { animation: rotate-stars 50s linear infinite; }
        @keyframes rotate-stars { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes twinkle { 0% { transform: scale(0.5); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(0.5); opacity: 0.5; } }

        /* ==============================================
        NỘI DUNG CHÍNH
        ============================================== */
        .main-content { 
            position: relative; z-index: 1; display: grid; 
            grid-template-columns: 1fr; gap: 2rem; margin-top: 2rem; 
            max-width: none; width: 100%; padding-left: 1.5rem; padding-right: 1.5rem; 
        }
        
        /* ==============================================
        TRÌNH PHÁT NHẠC - THANH ĐIỀU KHIỂN DƯỚI
        ============================================== */
        #player-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 90px;
            background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); /* Reverted blur value */
            border-top: 1px solid var(--border-current); z-index: 1001;
            padding: 0 1.5rem; display: grid; 
            grid-template-columns: 3.5fr 2fr 1.2fr; align-items: center; gap: 1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Transition cho tất cả thuộc tính */
        }
        body.fullscreen-player-active #player-bar {
            transform: translateY(100%);
        }
        body.dark-mode #player-bar { background-color: rgba(15, 23, 42, 0.7); }

        #player-bar .now-playing-info {
            display: flex; align-items: center; gap: 0.75rem;
            min-width: 0; opacity: 1; transition: opacity 0.3s ease-out;
            cursor: pointer;
            will-change: opacity;
        }
        #player-bar .now-playing-info.fade-out { opacity: 0; }
        /* Reverted img tag and removed album-art-placeholder class */
        #player-bar .now-playing-info img {
            width: 56px; height: 56px; border-radius: 8px; object-fit: cover;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; flex-shrink: 0;
            will-change: transform, box-shadow;
        }
        #player-bar .now-playing-info img.animate-pulse { /* Kept pulse animation for image */
            animation: pulse-placeholder 1.5s infinite alternate;
        }
        @keyframes pulse-placeholder {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        #player-bar .now-playing-info .text-info { 
            min-width: 0; 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 56px; /* Đảm bảo chiều cao cho 2 dòng tiêu đề */
        }

        #player-bar .player-controls-main {
            display: flex; flex-direction: column; align-items: center;
            gap: 0.5rem; min-width: 0;
        }
        /* Reverted to original styles for player buttons */
        #player-bar .player-buttons { display: flex; align-items: center; gap: 1rem; }
        #player-bar .player-buttons button {
            background: none; border: none; color: var(--text-muted-current);
            font-size: 1.5rem; cursor: pointer; transition: var(--transition-fast);
            min-width: 48px; /* Đảm bảo kích thước chạm tối thiểu */
            min-height: 48px; /* Đảm bảo kích thước chạm tối thiểu */
            display: flex; /* Để căn giữa icon nếu cần */
            align-items: center;
            justify-content: center;
        }
        #player-bar .player-buttons button:hover { color: var(--text-current); }
        #player-bar .player-buttons button:active { transform: scale(0.9); }
        #player-bar .player-buttons #play-pause-btn {
            background-color: var(--primary-color); color: white;
            width: 44px; height: 44px; border-radius: 50%; font-size: 1.5rem;
            min-width: 44px; /* Giữ nguyên kích thước đặc biệt */
            min-height: 44px;
        }
        #player-bar .player-buttons #play-pause-btn:hover { background-color: var(--primary-hover); }

        .play-pause-loading .ph-play, .play-pause-loading .ph-pause { display: none; }
        .play-pause-loading::after {
            content: ''; display: block; width: 24px; height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top-color: white; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #player-bar .progress-section { display: flex; align-items: center; gap: 0.75rem; width: 100%; }
        
        .progress-container { 
            flex-grow: 1; height: 8px; background-color: var(--border-current);
            border-radius: 4px; overflow: hidden; cursor: pointer; position: relative;
            will-change: width; /* For progress bar updates */
        }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 4px; transition: width 0.1s linear; }
        #progress-tooltip {
            position: absolute; bottom: 100%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white; padding: 0.25rem 0.5rem;
            border-radius: 4px; font-size: 0.75rem; white-space: nowrap;
            pointer-events: none; opacity: 0; transition: opacity 0.2s ease; margin-bottom: 5px;
            will-change: opacity, transform;
        }
        .progress-container:hover #progress-tooltip { opacity: 1; }

        #player-bar .player-actions-right { display: flex; align-items: center; justify-content: flex-end; gap: 1rem; }
        /* Reverted to original styles for player action buttons */
        #player-bar .player-actions-right button {
            background: none; border: none; color: var(--text-muted-current); font-size: 1.25rem;
            cursor: pointer; transition: color var(--transition-fast);
            min-width: 48px; /* Đảm bảo kích thước chạm tối thiểu */
            min-height: 48px; /* Đảm bảo kích thước chạm tối thiểu */
            display: flex; /* Để căn giữa icon nếu cần */
            align-items: center;
            justify-content: center;
        }
        #player-bar .player-actions-right button:hover { color: var(--text-current); }
        .volume-container { display: flex; align-items: center; gap: 0.5rem; width: 120px; }
        .volume-container .volume-icon { cursor: pointer; transition: color var(--transition-fast); }
        .volume-container .volume-icon:hover { color: var(--text-current); }
        .volume-container input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; }
        .volume-container input[type="range"]::-webkit-slider-runnable-track { background: var(--border-current); border-radius: 4px; height: 6px; }
        .volume-container input[type="range"]::-moz-range-track { background: var(--border-current); border-radius: 4px; height: 6px; }
        .volume-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            background: var(--primary-color); border-radius: 50%; cursor: grab;
            margin-top: -5px; box-shadow: 0 0 0 2px var(--card-bg-current);
        }
        .volume-container input[type="range"]::-moz-range-thumb {
            width: 16px; height: 16px; background: var(--primary-color);
            border-radius: 50%; cursor: grab; box-shadow: 0 0 0 2px var(--card-bg-current);
        }
        .volume-percentage { font-size: 0.75rem; width: 25px; text-align: right; }

        .media-session-indicator { font-size: 1.25rem; color: var(--text-muted-current); transition: color 0.2s ease-in-out; }
        .media-session-indicator.active { color: var(--primary-color); }

        /* ==============================================
        DANH SÁCH CHỜ (POPUP PLAYLIST)
        ============================================== */
        #popup-playlist-container {
            position: fixed; bottom: 90px; left: 0; right: 0;
            background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px);
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            box-shadow: var(--shadow-lg); border: 1px solid var(--border-current);
            z-index: 1000; max-height: 300px; overflow-y: auto;
            transform: translateY(10px); opacity: 0; visibility: hidden;
            transition: all 0.3s ease-out; padding: 1rem;
            will-change: transform, opacity, visibility;
        }
        body.dark-mode #popup-playlist-container { background-color: rgba(15, 23, 42, 0.9); }
        #popup-playlist-container.show { transform: translateY(0); opacity: 1; visibility: visible; }
        #popup-playlist-container.hidden { display: none; }

        #popup-song-list li {
            padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer;
            transition: background-color var(--transition-fast), opacity 0.2s;
            display: flex; align-items: center; gap: 0.75rem;
            will-change: background-color, opacity;
        }
        #popup-song-list li:hover { background-color: var(--bg-current); }
        #popup-song-list li.active-song-in-list { background-color: var(--primary-color); color: white; font-weight: 600; }
        #popup-song-list li.active-song-in-list .artist-text { color: rgba(255,255,255,0.8); }
        #popup-song-list li .song-info-text { flex-grow: 1; min-width: 0; }
        #popup-song-list li.dragging { opacity: 0.5; background: var(--primary-hover); }
        #popup-song-list li.drag-over { border-top: 2px solid var(--primary-color); }

        /* ==============================================
        GIAO DIỆN DANH SÁCH NHẠC (LIST VIEW)
        ============================================== */
        #music-section { position: relative; }
        .song-list-container { display: flex; flex-direction: column; }
        .song-list-header {
            display: grid; grid-template-columns: 40px 1fr auto auto;
            gap: 1rem; padding: 0.5rem 1rem; border-bottom: 1px solid var(--border-current);
            color: var(--text-muted-current); font-size: 0.8rem; font-weight: 600; text-transform: uppercase;
        }
        /* Reverted to original styles for song list item */
        .song-list-item {
            display: grid; grid-template-columns: 40px 1fr auto auto;
            gap: 1rem; align-items: center; padding: 0.75rem 1rem;
            border-radius: 8px; cursor: pointer; transition: background-color var(--transition-fast);
            animation: slide-in-up 0.4s ease-out forwards;
            animation-delay: calc(var(--i, 0) * 30ms);
            opacity: 0;
        }
        @keyframes slide-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .song-list-item:hover { background-color: var(--bg-current); }
        .song-list-item .song-index-play { position: relative; display: flex; align-items: center; justify-content: center; }
        .song-list-item .index-number { transition: opacity var(--transition-fast); }
        .song-list-item .play-button {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            opacity: 0; transition: opacity var(--transition-fast); font-size: 1.5rem;
        }
        .song-list-item:hover .index-number, .song-list-item.active-song .index-number { opacity: 1; } /* Reverted to 1 to be visible on hover/active */
        .song-list-item.active-song .play-button { opacity: 1; }
        .song-list-item .song-info { display: flex; align-items: center; gap: 1rem; min-width: 0; }
        /* Reverted img tag and removed artwork-placeholder class */
        .song-list-item .artwork { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .song-list-item .title-artist { min-width: 0; }
        .song-list-item .title { font-weight: 600; }
        .song-list-item .artist { font-size: 0.875rem; color: var(--text-muted-current); }
        .song-list-item.active-song .title { color: var(--primary-color); }
        /* Reverted to original styles for lyrics button */
        .song-list-item .lyrics-button {
            background: none; border: none; color: var(--text-muted-current);
            font-size: 1.25rem; cursor: pointer; transition: color var(--transition-fast);
            padding: 0.5rem; border-radius: 6px;
            min-width: 48px; /* Đảm bảo kích thước chạm tối thiểu */
            min-height: 48px; /* Đảm bảo kích thước chạm tối thiểu */
            display: flex; /* Để căn giữa icon nếu cần */
            align-items: center;
            justify-content: center;
        }
        .song-list-item .lyrics-button:hover { color: var(--primary-color); background-color: var(--bg-current); }
        .song-list-item .duration { text-align: right; font-size: 0.875rem; color: var(--text-muted-current); }
        .pulsing-icon { animation: pulse-icon 1s infinite alternate; }
        @keyframes pulse-icon { from { transform: scale(1); opacity: 1; } to { transform: scale(1.2); opacity: 0.7; } }

        /* NÂNG CẤP: Skeleton & Empty States */
        /* Reverted to original skeleton styles */
        .skeleton { animation: skeleton-loading 1.5s linear infinite alternate; }
        @keyframes skeleton-loading { 0% { background-color: var(--border-current); } 100% { background-color: var(--bg-current); } }
        .skeleton-text { width: 75%; height: 1.25rem; margin-bottom: 0.5rem; border-radius: 4px; }
        .skeleton-text-sm { width: 50%; height: 1rem; border-radius: 4px; }
        .skeleton-img { width: 40px; height: 40px; border-radius: 4px; }
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 2rem; text-align: center; color: var(--text-muted-current);
        }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; color: var(--border-current); }

        .title-artist-wrapper { overflow: hidden; width: 100%; display: block; }
        
        /* NÂNG CẤP: Tự động xuống dòng cho tên bài hát */
        .marquee-text {
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Giới hạn 2 dòng */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal; /* Cho phép xuống dòng */
            word-break: break-word; /* Ngắt từ nếu cần */
            line-height: 1.3;
        }

        mark {
            background-color: var(--primary-color);
            color: white;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        /* Reverted to original scroll nav styles */
        #scroll-nav-container {
            position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
            z-index: 999; display: flex; flex-direction: column; gap: 0.75rem;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #scroll-nav-container.show { opacity: 1; visibility: visible; }
        #scroll-nav-container button {
            width: 48px; /* Tăng kích thước nút cuộn */
            height: 48px; /* Tăng kích thước nút cuộn */
            background-color: rgba(0, 0, 0, 0.3); color: white;
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.2s; backdrop-filter: blur(4px);
        }
        #scroll-nav-container button:hover { background-color: var(--primary-color); color: white; transform: scale(1.1); }
        #scroll-nav-container button i { font-size: 1.25rem; }

        /* ==============================================
        MODAL & POPUP
        ============================================== */
        /* Reverted to original modal styles */
        .custom-alert-modal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-alert-modal.show { opacity: 1; visibility: visible; }
        .custom-alert-content {
            background-color: var(--card-bg-current); color: var(--text-current);
            padding: 2rem; border-radius: 12px; box-shadow: var(--shadow-lg);
            max-width: 400px; width: 90%; text-align: center;
            transform: translateY(-20px); transition: transform 0.3s ease;
        }
        .custom-alert-modal.show .custom-alert-content { transform: translateY(0); }
        .custom-alert-content h3 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
        .custom-alert-content p { margin-bottom: 1.5rem; color: var(--text-muted-current); }
        .custom-alert-content button {
            background-color: var(--primary-color); color: white; padding: 0.75rem 1.5rem;
            border-radius: 8px; font-weight: 600; transition: background-color 0.2s ease;
            cursor: pointer; border: none;
        }
        .custom-alert-content button:hover { background-color: var(--primary-hover); }

        #lyrics-fullscreen-popup {
            position: fixed; inset: 0; background-color: var(--bg-current);
            z-index: 1500; display: flex; flex-direction: column;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #lyrics-fullscreen-popup.show { opacity: 1; visibility: visible; }
        .lyrics-popup-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-current);
            background-color: var(--card-bg-current); flex-shrink: 0;
        }
        .lyrics-popup-header h2 {
            font-size: 1.5rem; font-weight: bold; color: var(--text-current);
            flex-grow: 1; text-align: center; margin-left: 2rem;
        }
        .lyrics-popup-header .close-button {
            background: none; border: none; font-size: 2rem; color: var(--text-muted-current);
            cursor: pointer; transition: color 0.2s;
        }
        .lyrics-popup-header .close-button:hover { color: var(--text-current); }
        .lyrics-popup-content {
            flex-grow: 1; padding: 2rem; overflow-y: auto; text-align: center;
            line-height: 1.8; transition: background-color 0.3s, color 0.3s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overscroll-behavior: contain; /* Ngăn cuộn nền khi cuộn lời bài hát */
        }
        /* NÂNG CẤP: Hiệu ứng chuyển trang lời bài hát */
        .lyrics-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .lyrics-popup-content p { margin-bottom: 0.5rem; }
        /* Reverted to original pagination button styles */
        .lyrics-pagination {
            display: flex; justify-content: center; align-items: center; gap: 1rem;
            padding: 1rem; background-color: var(--card-bg-current);
            border-top: 1px solid var(--border-current); flex-shrink: 0;
        }
        .lyrics-pagination button {
            background: none; border: none; font-size: 1.5rem; color: var(--primary-color);
            cursor: pointer; transition: opacity 0.2s;
        }
        .lyrics-pagination button:hover:not(.disabled) { opacity: 0.7; }
        .lyrics-pagination button.disabled { opacity: 0.3; cursor: not-allowed; }
        .lyrics-pagination span { font-weight: 600; color: var(--text-current); }

        /* Reverted to original radial menu styles */
        #lyrics-radial-menu-container {
            position: fixed; bottom: 110px; right: 20px; z-index: 1600;
            width: 50px; height: 50px; display: flex; justify-content: center;
            align-items: center; transition: all 0.3s ease-out;
        }
        #lyrics-radial-menu-container.active { width: 250px; height: 250px; }
        #radial-menu-toggle-btn {
            width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary-color);
            color: white; font-size: 1.5rem; display: flex; justify-content: center;
            align-items: center; box-shadow: var(--shadow-md); cursor: pointer;
            transition: transform 0.3s ease, background-color 0.2s; position: relative; z-index: 1;
        }
        #radial-menu-toggle-btn:hover { background-color: var(--primary-hover); transform: scale(1.05); }
        #lyrics-radial-menu-container.active #radial-menu-toggle-btn { transform: rotate(135deg); }
        .radial-item {
            position: absolute; width: 60px; height: 60px; border-radius: 50%;
            background-color: var(--card-bg-current); color: var(--text-current);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: var(--shadow-sm); cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0; pointer-events: none; transform: translate(0, 0); padding: 4px;
        }
        .radial-item i { font-size: 1.75rem; margin-bottom: 2px; }
        .radial-label { font-size: 0.6rem; font-weight: 500; color: inherit; white-space: nowrap; }
        #lyrics-radial-menu-container.active .radial-item { opacity: 1; pointer-events: all; transform: translate(var(--x, 0), var(--y, 0)); }
        .radial-item:hover { background-color: var(--primary-color); color: white; transform: translate(var(--x, 0), var(--y, 0)) scale(1.1); }

        /* ==============================================
        RESPONSIVE & MOBILE
        ============================================== */
        .hamburger-menu { display: none; }
        .mobile-nav-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 1005;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mobile-nav-overlay.active { opacity: 1; visibility: visible; }
        .mobile-nav-content {
            position: absolute; top: 0; right: 0; bottom: 0; width: 300px; max-width: 80%;
            background-color: var(--card-bg-current); box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2);
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1.5rem; display: flex; flex-direction: column;
        }
        /* FIX: Corrected selector for mobile menu to slide in */
        .mobile-nav-overlay.active .mobile-nav-content { transform: translateX(0); }
        .mobile-nav-content .close-mobile-menu {
            background: none; border: none; font-size: 2rem; color: var(--text-muted-current);
            cursor: pointer; align-self: flex-end; margin-bottom: 1rem;
        }
        .mobile-nav-content .close-mobile-menu:hover { color: var(--text-current); }
        /* Reverted to original mobile nav item styles */
        .mobile-nav-content .nav-item { 
            width: 100%; justify-content: flex-start; margin-bottom: 0.75rem; font-size: 1.1rem; padding: 0.8rem 1.2rem; 
            min-height: 48px; /* Đảm bảo kích thước chạm tối thiểu */
        }
        .mobile-nav-content .dropdown-container { width: 100%; }
        .mobile-nav-content .dropdown-toggle { 
            width: 100%; justify-content: flex-start; font-size: 1.1rem; padding: 0.8rem 1.2rem; 
            min-height: 48px; /* Đảm bảo kích thước chạm tối thiểu */
        }
        .mobile-nav-content .dropdown-menu {
            position: static; width: 100%; box-shadow: none; border: none; padding: 0;
            margin-top: 0.5rem; background-color: transparent; opacity: 1; transform: translateY(0);
        }
        .mobile-nav-content .dropdown-menu a { padding-left: 3rem; font-size: 1rem; padding-top: 0.6rem; padding-bottom: 0.6rem; }
        
        /* Reverted to original minimized player bar styles */
        body.player-bar-minimized #player-bar {
            height: 60px; /* Chiều cao ngắn hơn */
            grid-template-columns: auto 1fr; /* Chỉ hiển thị thông tin và điều khiển */
            padding: 0 0.75rem;
        }

        body.player-bar-minimized #player-bar .now-playing-info .text-info {
            display: none; /* Ẩn thông tin văn bản */
        }

        body.player-bar-minimized #player-bar .now-playing-info img {
            width: 48px; /* Thu nhỏ ảnh bìa */
            height: 48px;
        }

        body.player-bar-minimized #player-bar .player-controls-main {
            flex-direction: row; /* Đặt các nút ngang hàng */
            justify-content: flex-end; /* Căn điều khiển sang phải trên di động */
        }

        body.player-bar-minimized #player-bar .player-buttons {
            gap: 0.5rem; /* Giảm khoảng cách */
        }

        body.player-bar-minimized #player-bar .player-buttons #play-pause-btn {
            width: 36px; /* Thu nhỏ nút play/pause */
            height: 36px;
            font-size: 1.2rem;
        }

        body.player-bar-minimized #player-bar .player-buttons button {
            font-size: 1.2rem; /* Thu nhỏ icon nút */
            min-width: 36px;
            min-height: 36px;
        }

        body.player-bar-minimized #player-bar .progress-section,
        body.player-bar-minimized #player-bar .player-actions-right {
            display: none; /* Ẩn thanh tiến trình và các hành động bên phải */
        }


        @media (max-width: 1024px) {
            .desktop-nav { display: none; }
            .header-layout-wrapper { flex-direction: row; justify-content: space-between; align-items: center; padding: 0 1rem; }
            .header-logo-container { width: 80px !important; max-width: 80px !important; min-width: 60px !important; } 
            .header-main-content {
                display: flex; flex-grow: 1; flex-direction: row;
                justify-content: center; align-items: center; text-align: center;
            }
            .header .main-title { display: block; font-size: 1.8rem; margin: 0; flex-grow: 1; } /* Reverted to display: block */
            .hamburger-menu-wrapper { display: block; flex-shrink: 0; margin-left: auto; }
            /* Reverted to original hamburger menu styles */
            .hamburger-menu {
                display: block; font-size: 2.5rem; padding: 0.5rem; border-radius: 8px;
                background-color: transparent; color: var(--text-current);
                transition: var(--transition-fast); cursor: pointer; border: 2px solid transparent;
                min-width: 48px; /* Đảm bảo kích thước chạm tối thiểu */
                min-height: 48px; /* Đảm bảo kích thước chạm tối thiểu */
            }
            .hamburger-menu:hover { background-color: var(--bg-current); border-color: var(--primary-color); }
            .header .desktop-nav { display: none; }
        }

        @media (max-width: 768px) {
            .header { height: auto; padding-top: 0.5rem; padding-bottom: 0.5rem; }
            .header-logo-container { width: 60px !important; max-width: 60px !important; } 
            .main-title { font-size: 1.5rem; }
            /* Reverted to original mobile player bar styles */
            #player-bar {
                grid-template-columns: 1fr; /* Chỉ 1 cột */
                grid-template-rows: auto auto auto; /* 3 hàng: info, controls, actions */
                height: auto; 
                gap: 0.5rem; 
                padding: 0.75rem 1rem;
            }
            #player-bar .now-playing-info { 
                grid-column: 1 / -1; 
                order: 1; 
                justify-content: space-between; /* Căn đều các phần tử */
                align-items: center;
            }
            #player-bar .player-controls-main { 
                grid-column: 1 / -1; 
                order: 2; 
                flex-direction: row; /* Nút điều khiển ngang hàng */
                justify-content: center;
                gap: 1rem; /* Khoảng cách giữa các nút */
            }
            #player-bar .player-actions-right { 
                display: flex; /* Hiển thị lại */
                justify-content: space-around; /* Phân phối đều các nút */
                align-items: center;
                grid-column: 1 / -1; /* Đặt nó ở hàng riêng */
                order: 3; /* Đặt sau các điều khiển chính */
                padding-top: 0.5rem; /* Khoảng cách với hàng trên */
                gap: 0.5rem; /* Khoảng cách giữa các nút */
                flex-wrap: wrap; /* Cho phép xuống dòng nếu không đủ chỗ */
            }
            #player-bar .progress-section { 
                order: -1; /* Vẫn ở trên cùng */
                grid-column: 1 / -1; /* Mở rộng toàn bộ chiều rộng */
            } 

            /* Đảm bảo tất cả các nút trong player-actions-right hiển thị và có kích thước chạm phù hợp */
            #player-bar .player-actions-right button,
            #player-bar .player-actions-right .volume-container {
                display: flex; /* Đảm bảo hiển thị */
                min-width: 48px; /* Kích thước chạm tối thiểu */
                min-height: 48px; /* Kích thước chạm tối thiểu */
                font-size: 1.5rem; /* Kích thước icon lớn hơn */
                align-items: center;
                justify-content: center;
            }
            #player-bar .player-actions-right .volume-container {
                width: 100%; /* Cho phép chiếm toàn bộ chiều rộng nếu cần */
                max-width: 250px; /* Giới hạn chiều rộng tối đa */
                margin: 0 auto; /* Căn giữa */
            }
            #player-bar .player-actions-right .volume-percentage {
                flex-shrink: 0; /* Phần trăm không co lại */
                min-width: 30px; /* Đảm bảo đủ chỗ cho chữ */
            }
            /* Reverted to original minimized player bar styles for mobile */
            body.player-bar-minimized #player-bar {
                height: 60px; /* Giữ chiều cao nhất quán */
                grid-template-columns: auto 1fr; /* Chỉ hiển thị thông tin và điều khiển */
                padding: 0 0.75rem;
            }
            body.player-bar-minimized #player-bar .now-playing-info {
                gap: 0.5rem;
            }
            body.player-bar-minimized #player-bar .now-playing-info img {
                width: 48px;
                height: 48px;
            }
            body.player-bar-minimized #player-bar .player-controls-main {
                flex-direction: row;
                justify-content: flex-end; /* Căn điều khiển sang phải trên di động */
            }
            body.player-bar-minimized #player-bar .player-buttons {
                gap: 0.5rem;
            }
            body.player-bar-minimized #player-bar .player-buttons #play-pause-btn {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
            body.player-bar-minimized #player-bar .player-buttons button {
                font-size: 1.2rem;
                min-width: 36px;
                min-height: 36px;
            }
            body.player-bar-minimized #player-bar .now-playing-info .text-info {
                display: none; /* Vẫn ẩn thông tin văn bản */
            }
            body.player-bar-minimized #player-bar .player-actions-right {
                display: none; /* Vẫn ẩn các hành động bên phải */
            }
        }
    </style>
</head>
<body>
    <!-- Màn hình chờ -->
    <div id="splash-screen">
        <div class="stars"></div> <div class="stars2"></div> <div class="stars3"></div>
        <div id="splash-logo-container"> <div id="splash-logo-placeholder"></div> </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container header-layout-wrapper">
            <div class="header-logo-container">
                <a href="#"> <div id="header-logo-placeholder"></div> </a>
            </div>
            <div class="header-main-content">
                <h1 class="main-title">PLAY NHẠC MSTQ</h1>
                <nav class="desktop-nav flex flex-col items-center w-full">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <a href="https://sites.google.com/view/thiensutinhquang" class="nav-item group active" target="_blank" aria-label="Trang chủ"><i class="ph-bold ph-house text-2xl"></i><span class="ml-2">Trang Chủ</span></a>
                        <a href="https://thiensutinhquang.github.io/Playlist-YouTube/" class="nav-item group" target="_blank" aria-label="Xem video"><i class="ph-bold ph-video text-2xl"></i><span class="ml-2">Xem video</span></a>
                        <a href="https://thiensutinhquang.github.io/playtholientuc/" class="nav-item group" target="_blank" aria-label="Kho thơ"><i class="ph-bold ph-book-open text-2xl"></i><span class="ml-2">Kho Thơ</span></a>
                    </div>
                    <div class="flex items-center justify-center gap-2">
                        <div class="dropdown-container" id="platforms-dropdown-desktop">
                            <button type="button" class="dropdown-toggle group" id="platforms-toggle-desktop" aria-label="Các nền tảng"><i class="ph-bold ph-globe text-2xl"></i><span class="ml-2">Các Nền tảng</span><i class="ph-bold ph-caret-down ml-2"></i></button>
                            <div class="dropdown-menu" id="platforms-menu-desktop"></div>
                        </div>
                        <div class="dropdown-container" id="theme-dropdown-desktop">
                            <button type="button" class="dropdown-toggle group" id="theme-toggle-desktop" aria-label="Giao diện"><i class="ph-bold ph-palette text-2xl"></i><span class="ml-2">Giao diện</span><i class="ph-bold ph-caret-down ml-2"></i></button>
                            <div class="dropdown-menu" id="theme-menu-desktop">
                                <div id="preset-themes-desktop" class="grid grid-cols-4 gap-2 mb-4"></div>
                                <div class="flex items-center gap-2 justify-center">
                                    <i class="ph-bold ph-sun text-yellow-500"></i>
                                    <label class="relative inline-flex items-center cursor-pointer" aria-label="Chế độ tối"><input type="checkbox" id="darkModeToggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-color"></div></label>
                                    <i class="ph-bold ph-moon text-slate-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-container" id="timer-dropdown-desktop">
                            <button type="button" class="dropdown-toggle group" id="timer-toggle-desktop" aria-label="Hẹn giờ tắt nhạc"><i class="ph-bold ph-hourglass text-2xl"></i><span class="ml-2">Hẹn giờ</span><i class="ph-bold ph-caret-down ml-2"></i></button>
                            <div class="dropdown-menu" id="timer-menu-desktop">
                                <div class="p-4">
                                    <label for="timer-minutes-desktop" class="block text-sm font-medium mb-2 text-current">Số phút:</label>
                                    <input type="number" id="timer-minutes-desktop" min="1" value="30" class="w-full p-2 rounded-md bg-bg-current border border-border-current mb-2 text-current" aria-label="Nhập số phút hẹn giờ">
                                    <button type="button" id="start-timer-btn-desktop" class="timer-action-btn bg-primary-color">Bắt đầu</button>
                                    <button type="button" id="cancel-timer-btn-desktop" class="timer-action-btn bg-danger-color hidden">Hủy hẹn giờ</button>
                                    <p id="timer-display-desktop" class="text-center text-lg font-bold mt-2 text-current" aria-live="polite">00:00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="hamburger-menu-wrapper">
                <button type="button" class="hamburger-menu" id="hamburger-menu" aria-label="Mở menu điều hướng"><i class="ph-bold ph-list"></i></button>
            </div>
        </div>
    </header>

    <!-- Mobile Navigation -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay">
        <div class="mobile-nav-content">
            <button type="button" class="close-mobile-menu" id="close-mobile-menu" aria-label="Đóng menu điều hướng"><i class="ph-bold ph-x"></i></button>
            <div class="flex flex-col gap-2 mt-8">
                <a href="https://sites.google.com/view/thiensutinhquang" class="nav-item group active" target="_blank" aria-label="Trang chủ"><i class="ph-bold ph-house text-2xl"></i><span class="ml-2">Trang Chủ</span></a>
                <a href="https://thiensutinhquang.github.io/Playlist-YouTube/" class="nav-item group" target="_blank" aria-label="Xem video"><i class="ph-bold ph-video text-2xl"></i><span class="ml-2">Xem video</span></a>
                <a href="https://thiensutinhquang.github.io/playtholientuc/" class="nav-item group" target="_blank" aria-label="Kho thơ"><i class="ph-bold ph-book-open text-2xl"></i><span class="ml-2">Kho Thơ</span></a>
                <div class="dropdown-container">
                    <button type="button" class="dropdown-toggle group" id="platforms-toggle-mobile" aria-label="Các nền tảng"><i class="ph-bold ph-globe text-2xl"></i><span class="ml-2">Các Nền tảng</span><i class="ph-bold ph-caret-down ml-auto"></i></button>
                    <div class="dropdown-menu" id="platforms-menu-mobile"></div>
                </div>
                <div class="dropdown-container" id="mobile-theme-dropdown-container">
                    <button type="button" class="dropdown-toggle group" id="theme-toggle-mobile" aria-label="Giao diện"><i class="ph-bold ph-palette text-2xl"></i><span class="ml-2">Giao diện</span><i class="ph-bold ph-caret-down ml-auto"></i></button>
                    <div class="dropdown-menu" id="mobile-theme-options">
                        <div id="preset-themes-mobile" class="grid grid-cols-4 gap-2 mb-4"></div>
                        <div class="flex items-center gap-2 justify-center">
                            <i class="ph-bold ph-sun text-yellow-500"></i>
                            <label class="relative inline-flex items-center cursor-pointer" aria-label="Chế độ tối"><input type="checkbox" id="darkModeToggleMobile" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-color"></div></label>
                            <i class="ph-bold ph-moon text-slate-400"></i>
                        </div>
                    </div>
                </div>
                <div class="dropdown-container">
                    <button type="button" class="dropdown-toggle group" id="timer-toggle-mobile" aria-label="Hẹn giờ tắt nhạc"><i class="ph-bold ph-hourglass text-2xl"></i><span class="ml-2">Hẹn giờ</span><i class="ph-bold ph-caret-down ml-auto"></i></button>
                    <div class="dropdown-menu" id="timer-menu-mobile">
                        <div class="p-4">
                            <label for="timer-minutes-mobile" class="block text-sm font-medium mb-2 text-current">Số phút:</label>
                            <input type="number" id="timer-minutes-mobile" min="1" value="30" class="w-full p-2 rounded-md bg-bg-current border border-border-current mb-2 text-current" aria-label="Nhập số phút hẹn giờ">
                            <button type="button" id="start-timer-btn-mobile" class="timer-action-btn bg-primary-color">Bắt đầu</button>
                            <button type="button" id="cancel-timer-btn-mobile" class="timer-action-btn bg-danger-color hidden">Hủy hẹn giờ</button>
                            <p id="timer-display-mobile" class="text-center text-lg font-bold mt-2 text-current" aria-live="polite">00:00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Nội dung chính -->
    <main class="container main-content">
        <div class="main-column space-y-6">
            <div class="card" id="music-section">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold">Thư viện nhạc</h2>
                    <div id="category-menu" class="flex flex-wrap justify-center gap-2"></div>
                </div>
                <div class="relative mb-4">
                    <input type="search" id="search-input" placeholder="Tìm kiếm bài hát, nghệ sĩ..." class="w-full p-3 pl-10 rounded-lg bg-bg-current border border-border-current focus:ring-2 focus:ring-primary-color focus:outline-none transition-shadow" aria-label="Tìm kiếm bài hát">
                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-muted-current"></i>
                    <button type="button" id="search-clear-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-current hover:text-current hidden cursor-pointer" aria-label="Xóa tìm kiếm"><i class="ph-bold ph-x"></i></button>
                </div>
                <div id="songs-container" class="song-list-container">
                    <div class="song-list-header">
                        <span>#</span> <span>Bài hát</span> <span>Lời bài hát</span> <span>Thời lượng</span>
                    </div>
                    <div id="song-list-body"></div>
                    <!-- Initial Loading Overlay -->
                    <div id="initial-loading-overlay" class="absolute inset-0 bg-bg-current flex items-center justify-center flex-col text-muted-current z-10 transition-opacity duration-500">
                        <i class="ph-bold ph-spinner-gap animate-spin text-4xl text-primary-color mb-4"></i>
                        <p>Đang tải thư viện nhạc...</p>
                    </div>
                </div>
                <audio id="audio-player" style="display: none;" crossOrigin="anonymous" preload="auto" playsinline webkit-playsinline></audio>
                <!-- Pagination / Load More -->
                <div id="pagination-controls" class="mt-6 text-center">
                    <button id="load-more-btn" class="px-8 py-4 rounded-lg font-semibold transition-colors duration-200 shadow-lg text-lg w-full max-w-xs hidden"
                        style="background-color: var(--load-more-bg); color: var(--load-more-text);">
                        Tải thêm nhạc
                    </button>
                    <p id="all-songs-loaded-msg" class="text-muted-current mt-2 hidden">Đã tải hết tất cả nhạc.</p>
                    <p id="loading-more-spinner" class="text-muted-current mt-2 hidden">
                        <i class="ph-bold ph-spinner-gap animate-spin mr-2"></i>Đang tải thêm...
                    </p>
                    <button id="reload-library-btn" class="mt-4 px-8 py-3 rounded-lg font-semibold transition-colors duration-200 shadow-lg text-lg w-full max-w-xs bg-blue-600 text-white hover:bg-blue-700 hidden">
                        Tải lại thư viện
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Nút cuộn cố định -->
    <div id="scroll-nav-container">
        <button type="button" id="scroll-to-top-btn" aria-label="Cuộn lên đầu"><i class="ph-bold ph-caret-up"></i></button>
        <button type="button" id="scroll-to-bottom-btn" aria-label="Cuộn xuống cuối"><i class="ph-bold ph-caret-down"></i></button>
    </div>
    
    <!-- Thanh điều khiển nhạc -->
    <div id="player-bar">
        <div id="popup-playlist-container" class="hidden"><ul id="popup-song-list"></ul></div>
        <div class="now-playing-info" id="popup-now-playing-info-wrapper">
            <span id="popup-track-number" class="text-lg font-bold text-red-700 flex items-center justify-content-center w-8 h-8 flex-shrink-0" aria-label="Số thứ tự bài hát"></span>
            <img id="popup-album-art" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art" class="animate-pulse">
            <div class="text-info">
                <div class="title-artist-wrapper"><h4 id="popup-song-title" class="font-bold marquee-text">Chọn một bài hát</h4></div>
                <div class="title-artist-wrapper"><p id="popup-song-artist" class="text-sm text-muted-current marquee-text">Để bắt đầu nghe nhạc</p></div>
            </div>
            <button type="button" id="toggle-playlist-btn" title="Danh sách phát" aria-label="Hiển thị hoặc ẩn danh sách phát" class="ml-4 text-xl text-muted-current hover:text-current"><i class="ph-bold ph-list-music"></i></button>
        </div>
        <div class="player-controls-main">
            <div class="player-buttons">
                <button type="button" id="popup-shuffle-btn" title="Trộn bài" aria-label="Trộn bài"><i class="ph-bold ph-shuffle"></i></button>
                <button type="button" id="popup-prev-btn" title="Bài trước" aria-label="Bài trước"><i class="ph-bold ph-skip-back"></i></button>
                <button type="button" id="popup-play-pause-btn" title="Phát/Dừng" aria-label="Phát hoặc dừng nhạc"><i class="ph-bold ph-play" id="play-icon"></i><i class="ph-bold ph-pause hidden" id="pause-icon"></i></button>
                <button type="button" id="popup-next-btn" title="Bài kế tiếp" aria-label="Bài kế tiếp"><i class="ph-bold ph-skip-forward"></i></button>
                <button type="button" id="popup-repeat-btn" title="Lặp lại" aria-label="Chế độ lặp lại"><i class="ph-bold ph-repeat"></i></button>
            </div>
            <div class="progress-section" id="popup-progress-section">
                <span id="popup-current-time" class="text-xs" aria-label="Thời gian hiện tại">0:00</span>
                <div class="progress-container" id="popup-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Thanh tiến trình bài hát">
                    <div class="progress-bar" id="popup-progress-bar" style="width: 0%"></div>
                    <div id="progress-tooltip" class="hidden">0:00</div>
                </div>
                <span id="popup-duration" class="text-xs" aria-label="Tổng thời lượng bài hát">0:00</span>
            </div>
        </div>
        <div class="player-actions-right">
             <button type="button" id="popup-share-btn" title="Chia sẻ" aria-label="Chia sẻ bài hát"><i class="ph-bold ph-share-network"></i></button>
             <button type="button" id="popup-favorite-btn" title="Yêu thích" aria-label="Thêm vào mục yêu thích"><i class="ph-bold ph-heart"></i></button>
             <button type="button" id="popup-open-lyrics-btn" title="Mở lời bài hát" aria-label="Mở lời bài hát toàn màn hình" class="text-muted-current hover:text-current"><i class="ph-bold ph-file-text text-xl"></i></button>
             <span id="media-session-indicator" class="media-session-indicator" title="Media Session Active" aria-label="Chỉ báo Media Session đang hoạt động"><i class="ph-bold ph-broadcast"></i></span>
             <div class="volume-container">
                 <i id="volume-icon" class="ph-bold ph-speaker-high volume-icon" aria-label="Biểu tượng âm lượng"></i>
                 <input type="range" id="popup-volume-slider" min="0" max="1" step="0.01" value="1" class="w-full h-1 bg-border-current rounded-lg appearance-none cursor-pointer" aria-label="Điều chỉnh âm lượng">
                 <span id="volume-percentage" class="text-xs text-muted-current w-6 text-right" aria-label="Phần trăm âm lượng">100</span>
             </div>
        </div>
    </div>

    <!-- Modal & Popups -->
    <div id="custom-alert-modal" class="custom-alert-modal" role="alertdialog" aria-modal="true" aria-labelledby="custom-alert-title" aria-describedby="custom-alert-message">
        <div class="custom-alert-content">
            <h3 id="custom-alert-title">Thông báo</h3><p id="custom-alert-message"></p><button type="button" id="custom-alert-ok-btn">OK</button>
        </div>
    </div>
    <div id="lyrics-fullscreen-popup" class="hidden" role="dialog" aria-modal="true" aria-labelledby="lyrics-popup-title">
        <div class="lyrics-popup-header">
            <button type="button" id="close-lyrics-fullscreen" class="close-button" aria-label="Đóng lời bài hát"><i class="ph-bold ph-x"></i></button>
            <h2 id="lyrics-popup-title"></h2><div class="w-8"></div>
        </div>
        <div class="lyrics-popup-content"><div id="full-lyrics-display"></div></div>
        <div class="lyrics-pagination">
            <button type="button" id="lyrics-left-arrow" aria-label="Trang trước"><i class="ph-bold ph-caret-left"></i></button>
            <span id="lyrics-page-indicator" aria-live="polite">Trang 1 / 1</span>
            <button type="button" id="lyrics-right-arrow" aria-label="Trang kế tiếp"><i class="ph-bold ph-caret-right"></i></button>
        </div>
        <div id="lyrics-radial-menu-container">
            <button type="button" id="radial-menu-toggle-btn" aria-label="Mở menu tùy chỉnh lời bài hát"><i class="ph-bold ph-plus"></i></button>
            <div class="radial-item" id="radial-font-size-increase" style="--x: 0px; --y: 0px;" aria-label="Tăng cỡ chữ"><i class="ph-fill ph-text-aa"></i><span class="radial-label">Cỡ chữ+</span></div>
            <div class="radial-item" id="radial-font-size-decrease" style="--x: 0px; --y: 0px;" aria-label="Giảm cỡ chữ"><i class="ph-fill ph-text-a"></i><span class="radial-label">Cỡ chữ-</span></div>
            <div class="radial-item" id="radial-lines-increase" style="--x: 0px; --y: 0px;" aria-label="Tăng số dòng"><i class="ph-fill ph-text-align-justify"></i><span class="radial-label">Dòng+</span></div>
            <div class="radial-item" id="radial-lines-decrease" style="--x: 0px; --y: 0px;" aria-label="Giảm số dòng"><i class="ph-fill ph-list-dashes"></i><span class="radial-label">Dòng-</span></div>
            <div class="radial-item" id="radial-font-btn" style="--x: 0px; --y: 0px;" aria-label="Đổi phông chữ"><i class="ph-fill ph-font"></i><span class="radial-label">Phông</span></div>
            <div class="radial-item" id="radial-theme-btn" style="--x: 0px; --y: 0px;" aria-label="Đổi màu nền"><i class="ph-fill ph-palette"></i><span class="radial-label">Màu</span></div>
            <div class="radial-item" id="radial-download-lyrics" style="--x: 0px; --y: 0px;" aria-label="Tải lời bài hát"><i class="ph-fill ph-download-simple"></i><span class="radial-label">Tải về</span></div>
        </div>
    </div>
    
    <script>
    // --- PWA Service Worker Logic ---
    const swCode = `
        const CACHE_NAME = 'mstq-music-cache-v9'; // Nâng cấp phiên bản cache
        const BASE_URL = 'https://thiensutinhquang.github.io/PlayMusic/';
        const urlsToCache = [
            BASE_URL, BASE_URL + 'index.html',
            'https://cdn.tailwindcss.com', 'https://unpkg.com/@phosphor-icons/web',
            'https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap',
            'https://cdn.jsdelivr.net/npm/fuse.js@6.6.2',
            'https://raw.githubusercontent.com/thiensutinhquang/PlayMusic/main/LOGOvectorFULL.svg',
            BASE_URL + 'images/icons/icon-192x192.png', BASE_URL + 'images/icons/icon-512x512.png',
            BASE_URL + 'images/icons/play.png', BASE_URL + 'images/icons/pause.png',
            BASE_URL + 'images/icons/next.png', BASE_URL + 'images/icons/prev.png'
        ];

        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(CACHE_NAME).then(cache => {
                    console.log('Cache đã được mở');
                    return cache.addAll(urlsToCache);
                }).catch(error => console.error('Lỗi cache tài nguyên khi cài đặt:', error))
            );
        });

        self.addEventListener('fetch', event => {
            const { request } = event;
            const url = new URL(request.url);

            // Luôn lấy từ mạng cho các API của Audius để có dữ liệu mới nhất
            if (url.hostname.includes('audius.co') || url.hostname.includes('staked.cloud')) {
                event.respondWith(
                    fetch(request).catch(err => {
                        console.error("Lỗi fetch API Audius:", err);
                    })
                );
                return;
            }

            // Chiến lược Cache First cho các tài sản tĩnh
            event.respondWith(
                caches.match(request).then(cachedResponse => {
                    if (cachedResponse) {
                        return cachedResponse;
                    }
                    return fetch(request).then(networkResponse => {
                        if (networkResponse && networkResponse.status === 200) {
                            const responseToCache = networkResponse.clone();
                            caches.open(CACHE_NAME).then(cache => {
                                cache.put(request, responseToCache);
                            });
                        }
                        return networkResponse;
                    }).catch(error => {
                        console.log('Fetch thất bại, không có trong cache:', error);
                    });
                })
            );
        });

        self.addEventListener('activate', event => {
          const cacheWhitelist = [CACHE_NAME];
          event.waitUntil(
            caches.keys().then(cacheNames => {
              return Promise.all(
                cacheNames.map(cacheName => {
                  if (cacheWhitelist.indexOf(cacheName) === -1) {
                    console.log('Xóa cache cũ:', cacheName);
                    return caches.delete(cacheName);
                  }
                })
              );
            })
          );
        });

        self.addEventListener('notificationclick', event => {
            event.notification.close();
            const action = event.action;
            event.waitUntil(
                clients.matchAll({ type: 'window', includeUncontrolled: true }).then(windowClients => {
                    let clientToFocus = windowClients.find(client => client.url.startsWith(BASE_URL) && 'focus' in client);
                    if (clientToFocus) {
                        clientToFocus.focus();
                        clientToFocus.postMessage({ action: action });
                    } else if (clients.openWindow) {
                        clients.openWindow(BASE_URL).then(newClient => newClient && newClient.postMessage({ action: action }));
                    }
                })
            );
        });
    `;

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('ServiceWorker đã đăng ký thành công:', reg.scope))
                .catch(err => console.log('ServiceWorker đăng ký thất bại:', err));
        });
    } else {
        console.warn("Service Workers không được hỗ trợ trong môi trường này. Các tính năng PWA có thể bị hạn chế.");
    }

    // --- Dynamic Styles ---
    const dynamicStyleSheet = document.createElement('style');
    document.head.appendChild(dynamicStyleSheet);
    const sheet = dynamicStyleSheet.sheet;
    sheet.insertRule(`@keyframes bounce-animation { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }`, sheet.cssRules.length);
    sheet.insertRule(`.bounce-animation { animation: bounce-animation 0.3s ease-in-out; }`, sheet.cssRules.length);
    sheet.insertRule(`@keyframes bounce-category-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }`, sheet.cssRules.length);
    sheet.insertRule(`.bounce-category-btn { animation: bounce-category-btn 0.3s ease-out; }`, sheet.cssRules.length);
    // New animation for attention cue
    sheet.insertRule(`@keyframes attention-bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }`, sheet.cssRules.length);
    sheet.insertRule(`.attention-bounce { animation: attention-bounce 0.8s ease-in-out 3; }`, sheet.cssRules.length);


    document.addEventListener('DOMContentLoaded', async () => {
        // ==============================================
        // CẤU HÌNH & BIẾN TOÀN CỤC
        // ==============================================
        const CONFIG = {
            API_KEY: "08c897eb7784e03007e0769d01f2ca1c6a2001b4",
            USER_HANDLE: "minhsutinhquang",
            MAX_AUDIO_RETRIES: 3,
            STORAGE_KEYS: {
                THEME: 'themeState',
                SHUFFLE: 'isShuffling',
                REPEAT: 'repeatMode',
                FAVORITES: 'favoriteSongIds',
                VOLUME: 'playerVolume',
                PLAYBACK_STATE: 'playbackState',
            },
            CATEGORIES: [
                { id: 'all', name: '🎧 Tất cả' }, { id: 'new', name: '🆕 Mới' },
                { id: 'hot', name: '🔥 Nổi bật' }, { id: 'dieu-thu', name: '🎤 Diệu Thu' },
                { id: 'others', name: '👤 Khác' }, { id: 'phap', name: '📿 Pháp' },
                { id: 'favorites', name: '❤️ Yêu thích' }
            ],
            GENRE_MAP: { 'new': "Pop", 'hot': "Country", 'dieu-thu': "Classical", 'others': "Reggae", 'phap': "Podcasts" },
            LYRICS: {
                FONTS: ['Be Vietnam Pro, sans-serif','Arial, sans-serif','Verdana, sans-serif','Tahoma, sans-serif',"'Times New Roman', serif"], /* Reverted font list */
                THEMES: [
                    { id: 'auto_day', name: "Sáng", bgColor: "#FFFFFF", textColor: "#1e293b" },
                    { id: 'auto_night', name: "Tối", bgColor: "#1e293b", textColor: "#e2e8f0" },
                    { id: 'sepia', name: "Vàng Cổ", bgColor: "#fbf3e5", textColor: "#5a4628" },
                ],
                DEFAULT_FONT_SIZE: 18,
                DEFAULT_LINES_PER_PAGE: 15,
                STORAGE_KEYS: {
                    FONT_SIZE: 'lyricsFontSize',
                    LINES_PER_PAGE: 'linesPerPage',
                    FONT_INDEX: 'lyricsFontIndex',
                    THEME_ID: 'lyricsThemeId'
                }
            },
            PLATFORM_LINKS: [
                { name: 'YouTube', url: 'https://www.youtube.com/@ThiensuTinhQuang', icon: 'ph-youtube-logo', color: '#FF0000' },
                { name: 'TikTok', url: 'https://www.tiktok.com/@thiensutinhquang', icon: 'ph-tiktok-logo', color: '#000000' },
                { name: 'Facebook', url: 'https://www.facebook.com/groups/minhsutinhquang', icon: 'ph-facebook-logo', color: '#1877F2' },
                { name: 'Telegram', url: 'https://t.me/thiensutinhquang', icon: 'ph-telegram-logo', color: '#24A1DE' },
                { name: 'Zalo', url: 'https://zalo.me/g/vjkhzt168', icon: 'zalo-svg', color: '#0068FF' }
            ],
            PAGE_SIZE: 20, // Số lượng bài hát tải mỗi lần phân trang
            INITIAL_LOAD_SIZE: 20, // Số lượng bài hát tải ban đầu
            APP_THEMES: [ // Defined app themes
                { id: 'light', name: 'Sáng', bgColor: '#fdfcfb', cardBgColor: '#ffffff', textColor: '#1f2937', textMutedColor: '#64748b', borderColor: '#dbeafe', logoBgColor: '#fef9ef' },
                { id: 'dark', name: 'Tối', bgColor: '#1a1c23', cardBgColor: '#232732', textColor: '#f1f5f9', textMutedColor: '#cbd5e1', borderColor: '#3b4252', logoBgColor: '#1f2530' },
                { id: 'modern', name: 'Hiện đại', bgColor: '#228B22', cardBgColor: '#339B33', textColor: '#FFD700', textMutedColor: '#FFDD77', borderColor: '#44AA44', logoBgColor: '#1A7A1A' }, // Kept from original
                { id: 'tinhquang', name: 'MSTQ độc quyền', bgColor: '#1a0b2a', cardBgColor: '#2a1b4a', textColor: '#FFD700', textMutedColor: '#e0e0e0', borderColor: '#4a2a6a', logoBgColor: '#100818' }, // Kept from original
                { id: 'zen', name: 'Zen', bgColor: '#e6f0ec', cardBgColor: '#ffffff', textColor: '#1f2937', textMutedColor: '#4b5563', borderColor: '#cbd5e1', logoBgColor: '#f5fdfb' },
                { id: 'midnight', name: 'Midnight', bgColor: '#1a1c23', cardBgColor: '#232732', textColor: '#f1f5f9', textMutedColor: '#cbd5e1', borderColor: '#3b4252', logoBgColor: '#1f2530' },
                { id: 'sunset', name: 'Sunset', bgColor: '#ffedd5', cardBgColor: '#fff7ed', textColor: '#1f2937', textMutedColor: '#4b5563', borderColor: '#fcd34d', logoBgColor: '#fef3c7' },
                { id: 'ocean', name: 'Ocean', bgColor: '#e0f2fe', cardBgColor: '#f0f9ff', textColor: '#0f172a', textMutedColor: '#334155', borderColor: '#bae6fd', logoBgColor: '#e0f7fa' },
                { id: 'classic', name: 'Classic', bgColor: '#fef9ef', cardBgColor: '#ffffff', textColor: '#1e293b', textMutedColor: '#475569', borderColor: '#e2e8f0', logoBgColor: '#f8fafc' },
            ],
        };

        // DOM Elements
        const dom = {
            body: document.body,
            html: document.documentElement,
            header: {
                logoPlaceholder: document.getElementById('header-logo-placeholder'),
                mainTitle: document.querySelector('.main-title'),
                hamburgerMenu: document.getElementById('hamburger-menu'),
                mobileNavOverlay: document.getElementById('mobile-nav-overlay'),
                closeMobileMenu: document.getElementById('close-mobile-menu'),
            },
            playerBar: {
                container: document.getElementById('player-bar'),
                nowPlayingWrapper: document.getElementById('popup-now-playing-info-wrapper'),
                songTitle: document.getElementById('popup-song-title'),
                songArtist: document.getElementById('popup-song-artist'),
                albumArt: document.getElementById('popup-album-art'),
                playPauseBtn: document.getElementById('popup-play-pause-btn'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                progressContainer: document.getElementById('popup-progress-container'),
                progressBar: document.getElementById('popup-progress-bar'),
                currentTime: document.getElementById('popup-current-time'),
                duration: document.getElementById('popup-duration'),
                nextBtn: document.getElementById('popup-next-btn'),
                prevBtn: document.getElementById('popup-prev-btn'),
                shuffleBtn: document.getElementById('popup-shuffle-btn'),
                repeatBtn: document.getElementById('popup-repeat-btn'),
                volumeSlider: document.getElementById('popup-volume-slider'),
                volumePercentage: document.getElementById('volume-percentage'),
                volumeIcon: document.getElementById('volume-icon'),
                favoriteBtn: document.getElementById('popup-favorite-btn'),
                shareBtn: document.getElementById('popup-share-btn'),
                trackNumber: document.getElementById('popup-track-number'),
                mediaSessionIndicator: document.getElementById('media-session-indicator'),
                progressTooltip: document.getElementById('progress-tooltip'),
            },
            playlist: {
                toggleBtn: document.getElementById('toggle-playlist-btn'),
                container: document.getElementById('popup-playlist-container'),
                list: document.getElementById('popup-song-list'),
            },
            lyrics: {
                openBtn: document.getElementById('popup-open-lyrics-btn'),
                popup: document.getElementById('lyrics-fullscreen-popup'),
                closeBtn: document.getElementById('close-lyrics-fullscreen'),
                title: document.getElementById('lyrics-popup-title'),
                content: document.getElementById('full-lyrics-display'),
                leftArrow: document.getElementById('lyrics-left-arrow'),
                rightArrow: document.getElementById('lyrics-right-arrow'),
                pageIndicator: document.getElementById('lyrics-page-indicator'),
                radialMenu: {
                    container: document.getElementById('lyrics-radial-menu-container'),
                    toggleBtn: document.getElementById('radial-menu-toggle-btn'),
                    items: document.querySelectorAll('#lyrics-radial-menu-container .radial-item'),
                    downloadBtn: document.getElementById('radial-download-lyrics'),
                }
            },
            mainContent: {
                songsContainer: document.getElementById('song-list-body'),
                categoryMenu: document.getElementById('category-menu'),
                searchInput: document.getElementById('search-input'),
                searchClearBtn: document.getElementById('search-clear-btn'),
                initialLoadingOverlay: document.getElementById('initial-loading-overlay'),
                loadMoreBtn: document.getElementById('load-more-btn'),
                allSongsLoadedMsg: document.getElementById('all-songs-loaded-msg'),
                loadingMoreSpinner: document.getElementById('loading-more-spinner'),
            },
            modals: {
                alert: document.getElementById('custom-alert-modal'),
                alertTitle: document.getElementById('custom-alert-title'),
                alertMessage: document.getElementById('custom-alert-message'),
                alertOkBtn: document.getElementById('custom-alert-ok-btn'),
            },
            splashScreen: document.getElementById('splash-screen'),
            scrollNav: {
                container: document.getElementById('scroll-nav-container'),
                toTopBtn: document.getElementById('scroll-to-top-btn'),
                toBottomBtn: document.getElementById('scroll-to-bottom-btn'),
            },
            audioPlayer: document.getElementById('audio-player')
        };
        
        // Global State
        let state = {
            originalSongData: [], // To store all songs for search
            currentFilteredSongs: [], // All songs filtered by category/search, potentially shuffled
            currentDisplayData: [], // The actual subset of songs currently rendered in the UI
            currentDisplayStartIndex: 0, // The index in currentFilteredSongs where currentDisplayData starts
            audiusHosts: [],
            currentAudiusHost: null,
            currentSongIndex: -1, // Index of the currently playing song within currentFilteredSongs
            isPlaying: false,
            isShuffling: false,
            repeatMode: 'all',
            favoriteSongIds: [],
            wakeLock: null,
            lastVolume: 1,
            lyrics: {
                pages: [],
                currentPage: 0,
                fontSize: CONFIG.LYRICS.DEFAULT_FONT_SIZE,
                linesPerPage: CONFIG.LYRICS.DEFAULT_LINES_PER_PAGE,
                fontIndex: 0,
                themeId: 'auto_day'
            },
            sleepTimer: {
                endTime: null,
                interval: null
            },
            logoElements: {},
            lastScrollY: 0, // Track scroll position for player bar minimization
            songsLoadedCount: 0, // This will now represent the end index of currentDisplayData within currentFilteredSongs
            isFetchingAllData: false, // Flag to prevent multiple full data fetches
            isSearching: false, // Flag to indicate if search is active
            draggedItem: null, // Declare draggedItem here once
        };

        // ==============================================
        // UTILITY & HELPER FUNCTIONS
        // ==============================================
        let messageTimer = null;

        function showMessage(message, title = "Thông báo", autoDismiss = false, duration = 4000) {
            if (messageTimer) {
                clearTimeout(messageTimer);
            }
            dom.modals.alertTitle.textContent = title;
            dom.modals.alertMessage.textContent = message;
            dom.modals.alertOkBtn.style.display = autoDismiss ? 'none' : 'inline-block';
            dom.modals.alert.classList.add('show');
            if (autoDismiss) {
                messageTimer = setTimeout(hideMessage, duration);
            }
        }

        function hideMessage() {
            dom.modals.alert.classList.remove('show');
            if (messageTimer) {
                clearTimeout(messageTimer);
                messageTimer = null;
            }
        }
        
        function createStars(count, container) {
            if (!container) return;
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'absolute bg-white rounded-full';
                const size = Math.random() * 2 + 1;
                star.style.cssText = `width:${size}px; height:${size}px; top:${Math.random()*100}%; left:${Math.random()*100}%; animation:twinkle ${Math.random()*5+3}s linear infinite; animation-delay:${Math.random()*3}s;`;
                container.appendChild(star);
            }
        }

        async function loadAndInjectSVG() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/thiensutinhquang/PlayMusic/main/LOGOvectorFULL.svg');
                if (!response.ok) throw new Error('Không tải được SVG');
                const svgText = await response.text();
                document.getElementById('splash-logo-placeholder').innerHTML = svgText;
                dom.header.logoPlaceholder.innerHTML = svgText;
            } catch (error) {
                console.error("Lỗi tải SVG:", error);
                dom.header.logoPlaceholder.innerHTML = `<div class="w-16 h-16 bg-primary-color rounded-full flex items-center justify-center text-white font-bold text-2xl">M</div>`;
            }
        }

        function cacheLogoElements() {
            state.logoElements = {
                chakraSystem: dom.header.logoPlaceholder.querySelector('#chakra-system'),
                humanBody: dom.header.logoPlaceholder.querySelector('#human-body'),
                trucChiChanTamText: dom.header.logoPlaceholder.querySelector('#logo-text-trucchichantam'),
            };
        }

        function toggleLogoAnimations(isActive) {
            Object.values(state.logoElements).forEach(el => {
                if(el) {
                    el.classList.toggle('breathing-effect', isActive && el.id.includes('human'));
                    el.classList.toggle('energy-flow-active', isActive && el.id.includes('chakra'));
                    el.classList.toggle('highlight-text', isActive && el.id.includes('text'));
                }
            });
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator && !state.wakeLock) {
                try { state.wakeLock = await navigator.wakeLock.request('screen'); } 
                catch (err) { console.log('Không thể khóa màn hình:', err.message); }
            }
        }

        function releaseWakeLock() {
            if (state.wakeLock) {
                state.wakeLock.release().then(() => { state.wakeLock = null; });
            }
        }
        
        function triggerHapticFeedback(duration = 50) {
            if (navigator.vibrate) navigator.vibrate(duration);
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                if (!inThrottle) {
                    func.apply(this, arguments);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                await Notification.requestPermission();
            }
        }

        // ==============================================
        // STATE & LOCAL STORAGE MANAGEMENT
        // ==============================================
        function saveStateToLocalStorage(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function loadStateFromLocalStorage(key, defaultValue) {
            const storedValue = localStorage.getItem(key);
            return storedValue ? JSON.parse(storedValue) : defaultValue;
        }
        
        function saveCurrentPlaybackState() {
            if (state.currentSongIndex === -1) return;
            const song = state.currentFilteredSongs[state.currentSongIndex]; // Use currentFilteredSongs for persistence
            if (!song) return;

            const playbackState = {
                songId: song.id,
                currentTime: dom.audioPlayer.currentTime,
                currentCategory: document.querySelector('#category-menu .nav-item.active')?.dataset.category || 'all',
                currentSearchQuery: dom.mainContent.searchInput.value
            };
            saveStateToLocalStorage(CONFIG.STORAGE_KEYS.PLAYBACK_STATE, playbackState);
        }
        
        // ==============================================
        // THEME MANAGEMENT
        // ==============================================
        function applyTheme() {
            const theme = loadStateFromLocalStorage(CONFIG.STORAGE_KEYS.THEME, { mode: 'light' });
            dom.body.classList.remove('dark-mode');
            dom.html.removeAttribute('data-theme'); // Remove data-theme to ensure dynamic CSS variables take precedence
            document.querySelectorAll('.preset-theme-btn').forEach(b => b.classList.remove('active'));
            
            const darkModeToggle = document.getElementById('darkModeToggle');
            const darkModeToggleMobile = document.getElementById('darkModeToggleMobile');

            let currentThemeObj;
            if (theme.mode === 'dark') {
                dom.body.classList.add('dark-mode');
                currentThemeObj = CONFIG.APP_THEMES.find(t => t.id === 'dark');
                if(darkModeToggle) darkModeToggle.checked = true;
                if(darkModeToggleMobile) darkModeToggleMobile.checked = true;
            } else if (theme.mode === 'preset' && theme.id) {
                // No need to set data-theme attribute if using dynamic CSS variables
                currentThemeObj = CONFIG.APP_THEMES.find(t => t.id === theme.id);
                document.querySelectorAll(`.preset-theme-btn[data-theme="${theme.id}"]`).forEach(btn => btn.classList.add('active'));
                if(darkModeToggle) darkModeToggle.checked = false;
                if(darkModeToggleMobile) darkModeToggleMobile.checked = false;
            } else { // Default to light mode
                currentThemeObj = CONFIG.APP_THEMES.find(t => t.id === 'light');
                if(darkModeToggle) darkModeToggle.checked = false;
                if(darkModeToggleMobile) darkModeToggleMobile.checked = false;
            }

            // Apply dynamic CSS variables from the selected theme object
            if (currentThemeObj) {
                document.documentElement.style.setProperty('--bg-current', currentThemeObj.bgColor);
                document.documentElement.style.setProperty('--card-bg-current', currentThemeObj.cardBgColor);
                document.documentElement.style.setProperty('--text-current', currentThemeObj.textColor);
                document.documentElement.style.setProperty('--text-muted-current', currentThemeObj.textMutedColor);
                document.documentElement.style.setProperty('--border-current', currentThemeObj.borderColor);
                document.documentElement.style.setProperty('--logo-bg-current', currentThemeObj.logoBgColor);
            }
        }

        function changeTheme(themeId) {
            if (themeId === 'light' || themeId === 'dark') {
                saveStateToLocalStorage(CONFIG.STORAGE_KEYS.THEME, { mode: themeId });
            } else {
                saveStateToLocalStorage(CONFIG.STORAGE_KEYS.THEME, { mode: 'preset', id: themeId });
            }
            applyTheme();
            triggerHapticFeedback(20);
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => menu.classList.remove('show'));
            document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => toggle.classList.remove('open'));
        }

        function renderPresetThemes(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = ''; // Clear existing buttons
            CONFIG.APP_THEMES.filter(theme => theme.id !== 'light' && theme.id !== 'dark').forEach(theme => { // Exclude light/dark as they have separate toggles
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'preset-theme-btn';
                btn.dataset.theme = theme.id;
                btn.style.backgroundColor = theme.bgColor;
                btn.style.borderColor = theme.borderColor;
                btn.title = theme.name;
                btn.addEventListener('click', () => changeTheme(theme.id));
                container.appendChild(btn);
            });
        }

        // ==============================================
        // API & DATA FETCHING
        // ==============================================
        async function fetchAudiusData() {
            // Add a timeout for the fetch request
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 seconds timeout

            try {
                let hosts;
                try {
                    const response = await fetch('https://api.audius.co', { signal: controller.signal });
                    if (!response.ok) {
                        console.warn('Không thể lấy danh sách host từ Audius API, sử dụng danh sách dự phòng.');
                        hosts = ['https://discoveryprovider.audius.co', 'https://discoveryprovider2.audius.co', 'https://discoveryprovider3.audius.co', 'https://dn-dn.audius.co', 'https://discoveryprovider.audius.prod-us-2.staked.cloud'];
                    } else {
                        const hostsData = await response.json();
                        if (hostsData && Array.isArray(hostsData.data)) {
                            hosts = hostsData.data;
                        } else {
                            console.warn('Cấu trúc dữ liệu host từ Audius API không hợp lệ, sử dụng danh sách dự phòng.');
                            hosts = ['https://discoveryprovider.audius.co', 'https://discoveryprovider2.audius.co', 'https://discoveryprovider3.audius.co', 'https://dn-dn.audius.co', 'https://discoveryprovider.audius.prod-us-2.staked.cloud'];
                        }
                    }
                } catch (e) {
                    if (e.name === 'AbortError') {
                        console.error("Yêu cầu lấy host từ Audius bị hủy do timeout:", e.message);
                        throw new Error("Tải dữ liệu Audius quá lâu, vui lòng kiểm tra kết nối mạng.");
                    }
                    console.warn("Lỗi khi lấy danh sách host từ Audius, sử dụng danh sách dự phòng.", e.message);
                    hosts = ['https://discoveryprovider.audius.co', 'https://discoveryprovider2.audius.co', 'https://discoveryprovider3.audius.co', 'https://dn-dn.audius.co', 'https://discoveryprovider.audius.prod-us-2.staked.cloud'];
                }
                
                if (!hosts || hosts.length === 0) {
                    throw new Error('Không có host Audius nào khả dụng.');
                }
                state.audiusHosts = hosts;
                state.currentAudiusHost = state.audiusHosts[Math.floor(Math.random() * state.audiusHosts.length)];

                // Show initial loading overlay
                dom.mainContent.initialLoadingOverlay.classList.remove('hidden');
                dom.mainContent.initialLoadingOverlay.classList.add('opacity-100');

                // Fetch user ID
                const userResponse = await fetch(`${state.currentAudiusHost}/v1/users/search?query=${CONFIG.USER_HANDLE}&app_name=MSTQPlayer`, { signal: controller.signal });
                if (!userResponse.ok) {
                    throw new Error(`Không thể tìm thấy người dùng "${CONFIG.USER_HANDLE}" trên Audius. Mã lỗi: ${userResponse.status}`);
                }
                const userData = await userResponse.json();
                if (!userData || !Array.isArray(userData.data) || userData.data.length === 0) {
                    throw new Error("Dữ liệu người dùng từ Audius không hợp lệ hoặc không tìm thấy.");
                }
                const userId = userData.data[0].id;
                
                // Fetch all tracks for search functionality
                state.isFetchingAllData = true;
                const allTracksResponse = await fetch(`${state.currentAudiusHost}/v1/users/${userId}/tracks?limit=10000&app_name=MSTQPlayer`, { signal: controller.signal }); // Increased limit for full fetch
                if (!allTracksResponse.ok) {
                    throw new Error(`Không thể tải danh sách bài hát từ Audius. Mã lỗi: ${allTracksResponse.status}`);
                }
                const allTracksData = await allTracksResponse.json();
                
                if (allTracksData && Array.isArray(allTracksData.data)) {
                    state.originalSongData = allTracksData.data.map(track => ({
                        id: track.id,
                        title: track.title,
                        artist: track.user ? track.user.name : 'Nghệ sĩ không xác định',
                        artwork: track.artwork ? (track.artwork['480x480'] || track.artwork.url) : `data:image/svg+xml;base64,` + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150"><rect width="150" height="150" fill="#1e293b"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="60" fill="#f1f5f9">${track.title.charAt(0) || '?'}</text></svg>`), /* Reverted to original image source, but provided SVG fallback */
                        duration: track.duration,
                        description: track.description || 'Không có lời bài hát cho bài này.',
                        isFavorite: state.favoriteSongIds.includes(track.id),
                        genre: track.genre || 'Không xác định',
                        permalink: track.permalink
                    }));
                } else {
                    console.warn("Audius API did not return expected data structure for tracks. Setting originalSongData to empty array.");
                    state.originalSongData = [];
                }

                state.isFetchingAllData = false;
                dom.mainContent.initialLoadingOverlay.classList.remove('opacity-100');
                dom.mainContent.initialLoadingOverlay.classList.add('opacity-0');
                setTimeout(() => dom.mainContent.initialLoadingOverlay.classList.add('hidden'), 500);

                window.fuse = new Fuse(state.originalSongData, { keys: ['title', 'artist', 'genre'], includeScore: true, threshold: 0.4 }); // Initialize Fuse.js here
                
            } catch (error) {
                console.error("Lỗi khi lấy dữ liệu từ Audius:", error);
                dom.mainContent.songsContainer.innerHTML = '<p class="text-center text-red-500 col-span-full">Lỗi khi tải danh sách nhạc. Vui lòng thử lại sau.</p>';
                showMessage(`Không thể tải danh sách nhạc từ Audius: ${error.message}. Vui lòng kiểm tra kết nối internet hoặc thử lại sau.`, "Lỗi tải dữ liệu");
                
                // Ensure loading overlay is hidden even on error
                dom.mainContent.initialLoadingOverlay.classList.remove('opacity-100');
                dom.mainContent.initialLoadingOverlay.classList.add('opacity-0');
                setTimeout(() => dom.mainContent.initialLoadingOverlay.classList.add('hidden'), 500);
            } finally {
                clearTimeout(timeoutId); // Clear the timeout regardless of success or failure
            }
        }

        // ==============================================
        // MUSIC PLAYER CORE
        // ==============================================
        async function playSongWithRetries(song, retryCount = 0, lastFailedHost = null) {
            if (!song) return;

            let host = state.currentAudiusHost;
            if (lastFailedHost && state.audiusHosts.length > 1) {
                const availableHosts = state.audiusHosts.filter(h => h !== lastFailedHost);
                if (availableHosts.length > 0) {
                    host = availableHosts[Math.floor(Math.random() * availableHosts.length)];
                    state.currentAudiusHost = host;
                } else {
                    console.error("Không còn host nào để thử.");
                    showMessage("Không thể phát bài hát này. Vui lòng thử bài khác.", "Lỗi phát nhạc");
                    state.isPlaying = false; updateUI();
                    if (state.repeatMode === 'all' || state.isShuffling) playNext();
                    return;
                }
            }
            
            console.log(`Đang thử phát ${song.title} từ ${host} (Lần thử ${retryCount + 1})`);
            dom.playerBar.playPauseBtn.classList.add('play-pause-loading');
            dom.playerBar.albumArt.classList.add('animate-pulse'); // Show pulse on album art during loading
            updateUI();
            
            dom.audioPlayer.src = `${host}/v1/tracks/${song.id}/stream?app_name=MSTQPlayer`;
            dom.audioPlayer.load();

            try {
                // Khôi phục vị trí phát nếu có
                const savedState = loadStateFromLocalStorage(CONFIG.STORAGE_KEYS.PLAYBACK_STATE, {});
                if (savedState.songId === song.id && savedState.currentTime) {
                    dom.audioPlayer.currentTime = savedState.currentTime;
                    saveStateToLocalStorage(CONFIG.STORAGE_KEYS.PLAYBACK_STATE, {});
                }
                await dom.audioPlayer.play();
            } catch (error) {
                console.error(`Lỗi phát nhạc từ ${host}:`, error);
                if (retryCount < CONFIG.MAX_AUDIO_RETRIES - 1) {
                    showMessage(`Lỗi phát nhạc. Đang thử kết nối khác...`, "Lỗi kết nối");
                    await playSongWithRetries(song, retryCount + 1, host);
                } else {
                    showMessage("Không thể phát bài hát này. Vui lòng kiểm tra kết nối Internet hoặc thử lại sau.", "Lỗi phát nhạc");
                    if (state.repeatMode === 'all' || state.isShuffling) playNext();
                    else { state.isPlaying = false; updateUI(); }
                }
            }
        }

        function playSong(filteredIndex) {
            if (filteredIndex < 0 || filteredIndex >= state.currentFilteredSongs.length) return;
            
            state.currentSongIndex = filteredIndex; // This is the index in the full filtered list
            const song = state.currentFilteredSongs[filteredIndex];

            // Determine if the song is outside the current displayed window
            const currentDisplayEndIndex = state.currentDisplayStartIndex + state.currentDisplayData.length;
            let needsRerender = false;

            if (filteredIndex < state.currentDisplayStartIndex || filteredIndex >= currentDisplayEndIndex) {
                // Calculate new window start index, trying to center the playing song
                let newDisplayStartIndex = Math.max(0, filteredIndex - Math.floor(CONFIG.PAGE_SIZE / 2));
                // Ensure the window doesn't go beyond the end of currentFilteredSongs
                newDisplayStartIndex = Math.min(newDisplayStartIndex, state.currentFilteredSongs.length - CONFIG.PAGE_SIZE);
                if (newDisplayStartIndex < 0) newDisplayStartIndex = 0; // Handle cases where total songs < PAGE_SIZE

                state.currentDisplayData = state.currentFilteredSongs.slice(newDisplayStartIndex, newDisplayStartIndex + CONFIG.PAGE_SIZE);
                state.currentDisplayStartIndex = newDisplayStartIndex;
                needsRerender = true;
            }

            if (needsRerender) {
                renderSongs(state.currentDisplayData); // Re-render the new window of songs
            }

            dom.playerBar.songTitle.textContent = song.title;
            dom.playerBar.songArtist.textContent = song.artist;
            dom.playerBar.albumArt.src = song.artwork; /* Reverted to .src for img tag */
            dom.playerBar.albumArt.classList.remove('animate-pulse');
            
            playSongWithRetries(song);

            // Scroll the active song into view within the *currently rendered* list
            const displayIndexInCurrentData = state.currentDisplayData.findIndex(s => s.id === song.id);
            const activeSongElement = document.querySelector(`.song-list-item[data-display-index="${displayIndexInCurrentData}"]`);
            if (activeSongElement) {
                activeSongElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function playNext() {
            if (state.currentFilteredSongs.length === 0) return;

            let newIndex = (state.currentSongIndex + 1) % state.currentFilteredSongs.length;
            playSong(newIndex); // Call playSong with the index in the full filtered list
            triggerHapticFeedback(50);
        }

        function playPrev() {
            if (state.currentFilteredSongs.length === 0) return;

            let newIndex = (state.currentSongIndex - 1 + state.currentFilteredSongs.length) % state.currentFilteredSongs.length;
            playSong(newIndex); // Call playSong with the index in the full filtered list
            triggerHapticFeedback(50);
        }
        
        function toggleFavorite(songId) {
            const songIndexInFavorites = state.favoriteSongIds.indexOf(songId);
            if (songIndexInFavorites > -1) {
                state.favoriteSongIds.splice(songIndexInFavorites, 1);
                showMessage("Đã xóa khỏi danh sách yêu thích.", "Thông báo", true, 2500); // Changed duration to 2.5 seconds
            } else {
                state.favoriteSongIds.push(songId);
                showMessage("Đã thêm vào danh sách yêu thích!", "Thông báo", true, 2500); // Changed duration to 2.5 seconds
            }
            saveStateToLocalStorage(CONFIG.STORAGE_KEYS.FAVORITES, state.favoriteSongIds);
            
            const song = state.originalSongData.find(s => s.id === songId); // Use originalSongData
            if(song) song.isFavorite = state.favoriteSongIds.includes(songId);

            const currentCategory = document.querySelector('#category-menu .nav-item.active')?.dataset.category;
            if (currentCategory === 'favorites') loadCustomCategory('favorites');
            
            updateUI();
            dom.playerBar.favoriteBtn.classList.add('bounce-animation');
            setTimeout(() => dom.playerBar.favoriteBtn.classList.remove('bounce-animation'), 300);
        }
        
        // ==============================================
        // UI RENDERING & UPDATES
        // ==============================================
        function renderSkeletonLoader(count = 10) {
            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                skeletonHTML += `
                    <div class="song-list-item">
                        <div class="song-index-play"><span class="index-number">${i + 1}</span></div>
                        <div class="song-info">
                            <div class="skeleton skeleton-img"></div>
                            <div class="title-artist w-full">
                                <div class="skeleton skeleton-text"></div>
                                <div class="skeleton skeleton-text-sm"></div>
                            </div>
                        </div>
                        <div class="lyrics-button"><div class="skeleton w-6 h-6 rounded-md"></div></div> 
                        <div class="duration"><div class="skeleton w-10 h-5 rounded-md"></div></div>
                    </div>
                `;
            }
            dom.mainContent.songsContainer.innerHTML = skeletonHTML;
        }

        // Function to add event listeners to song items
        function addSongEventListeners() {
            document.querySelectorAll('.song-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.lyrics-button')) return; /* Prevent song play if lyrics button is clicked */
                    // Get the song from the full filtered list based on its ID
                    const songId = state.currentDisplayData[parseInt(item.dataset.displayIndex)].id;
                    const filteredIndex = state.currentFilteredSongs.findIndex(s => s.id === songId);
                    if (filteredIndex !== -1) {
                        if (filteredIndex === state.currentSongIndex) {
                            if (dom.audioPlayer.paused) dom.audioPlayer.play(); else dom.audioPlayer.pause();
                        } else {
                            playSong(filteredIndex);
                        }
                    }
                });
                item.querySelector('.lyrics-button')?.addEventListener('click', (e) => {
                    e.stopPropagation(); /* Prevent song play when lyrics button is clicked */
                    const songId = state.currentDisplayData[parseInt(item.dataset.displayIndex)].id; /* Get ID from displayed song */
                    const song = state.originalSongData.find(s => s.id === songId); /* Use originalSongData for lyrics lookup */
                    if (song) showLyricsFullscreenPopup(song);
                });
            });
        }

        function renderSongs(tracksToRender) { // No longer needs 'append'
            const container = dom.mainContent.songsContainer;
            const searchQuery = dom.mainContent.searchInput.value.trim();
            
            container.innerHTML = ''; // Always clear and re-render the current window of songs

            if (!tracksToRender || tracksToRender.length === 0) {
                const currentCategory = document.querySelector('#category-menu .nav-item.active')?.dataset.category;
                if (currentCategory === 'favorites') {
                    container.innerHTML = `<div class="empty-state col-span-full"><i class="ph-bold ph-heart-break"></i><p>Bạn chưa có bài hát yêu thích nào.</p><p class="text-sm">Nhấn vào hình trái tim ❤️ ở một bài hát để thêm vào đây.</p></div>`;
                } else if (state.isSearching && searchQuery.length > 0) {
                    container.innerHTML = `<div class="empty-state col-span-full"><i class="ph-bold ph-magnifying-glass-slash"></i><p>Không tìm thấy kết quả cho "${searchQuery}".</p></div>`;
                } else {
                    container.innerHTML = '<p class="text-center text-muted-current col-span-full p-4">Không tìm thấy bài hát nào.</p>';
                }
                dom.mainContent.loadMoreBtn.classList.add('hidden');
                dom.mainContent.allSongsLoadedMsg.classList.add('hidden');
            } else {
                tracksToRender.forEach((song, indexInDisplayedList) => { // indexInDisplayedList is the index within currentDisplayData
                    const songItem = document.createElement('div');
                    songItem.className = 'song-list-item';
                    songItem.dataset.displayIndex = indexInDisplayedList; // This is now index within the *displayed* list
                    songItem.style.setProperty('--i', indexInDisplayedList); // For animation delay

                    let titleHTML = song.title;
                    let artistHTML = song.artist;

                    if (searchQuery) {
                        const regex = new RegExp(searchQuery.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'ig');
                        titleHTML = song.title.replace(regex, `<mark>$&</mark>`);
                        artistHTML = song.artist.replace(regex, `<mark>$&</mark>`);
                    }

                    songItem.innerHTML = `
                        <div class="song-index-play"><span class="index-number">${state.currentFilteredSongs.indexOf(song) + 1}</span><div class="play-button"><i class="ph-bold ph-play"></i></div></div>
                        <div class="song-info">
                            <img src="${song.artwork}" alt="${song.title}" class="artwork"> 
                            <div class="title-artist"><p class="title marquee-text">${titleHTML}</p><p class="artist marquee-text">${artistHTML}</p></div>
                        </div>
                        <button type="button" class="lyrics-button" data-song-id="${song.id}" aria-label="Xem lời bài hát"><i class="ph-bold ph-book-open"></i></button>
                        <div class="duration">${new Date(song.duration * 1000).toISOString().substr(14, 5)}</div>
                    `;
                    container.appendChild(songItem);
                });
                updatePaginationControls();
            }
            addSongEventListeners(); // Re-add listeners to new elements
            renderPopupSongList(state.currentDisplayData); // Popup list always reflects currentDisplayData
            updateUI(); // Update player bar and active song state
        }
        
        function renderPopupSongList(songs) {
            dom.playlist.list.innerHTML = '';
            if (!songs || songs.length === 0) {
                dom.playlist.list.innerHTML = '<li class="p-4 text-center text-muted-current">Danh sách phát trống.</li>'; /* Reverted padding */
                return;
            }
            songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'p-2 rounded-md cursor-pointer hover:bg-bg-current text-sm';
                li.draggable = true;
                li.dataset.displayIndex = index;
                li.innerHTML = `<div class="song-info-text"><p class="font-semibold marquee-text">${song.title}</p><p class="artist-text marquee-text">${song.artist}</p></div>`;
                li.addEventListener('click', () => playSong(state.currentFilteredSongs.indexOf(song))); // Play song from its index in the full filtered list
                dom.playlist.list.appendChild(li);
            });
            addDragAndDropListeners();
        }
        
        function updateUI() {
            state.isPlaying = !dom.audioPlayer.paused;
            const song = state.currentFilteredSongs[state.currentSongIndex]; // Always reference from currentFilteredSongs
            
            // Player bar
            if (song) {
                dom.playerBar.songTitle.textContent = song.title;
                dom.playerBar.songArtist.textContent = song.artist;
                dom.playerBar.albumArt.src = song.artwork; /* Reverted to .src for img tag */
                dom.playerBar.albumArt.classList.remove('animate-pulse');
                dom.playerBar.favoriteBtn.classList.toggle('liked', state.favoriteSongIds.includes(song.id));
                dom.playerBar.favoriteBtn.innerHTML = state.favoriteSongIds.includes(song.id) ? '<i class="ph-fill ph-heart"></i>' : '<i class="ph-bold ph-heart"></i>';
                dom.playerBar.trackNumber.textContent = state.currentSongIndex + 1; // Display actual track number
            } else {
                dom.playerBar.songTitle.textContent = "Chọn một bài hát";
                dom.playerBar.songArtist.textContent = "Để bắt đầu nghe nhạc";
                dom.playerBar.albumArt.src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="; /* Reverted to transparent GIF */
                dom.playerBar.albumArt.classList.add('animate-pulse');
                dom.playerBar.trackNumber.textContent = '';
            }

            // Play/Pause button
            const isLoading = state.isPlaying && (dom.audioPlayer.readyState < 3 || dom.audioPlayer.seeking); // Also consider seeking as loading
            dom.playerBar.playPauseBtn.classList.toggle('play-pause-loading', isLoading);
            dom.playerBar.playIcon.classList.toggle('hidden', state.isPlaying || isLoading);
            dom.playerBar.pauseIcon.classList.toggle('hidden', !state.isPlaying || isLoading);

            // Song list items
            document.querySelectorAll('.song-list-item').forEach(item => {
                const songInDisplayedList = state.currentDisplayData[parseInt(item.dataset.displayIndex)];
                const isActive = songInDisplayedList && songInDisplayedList.id === song?.id;
                item.classList.toggle('active-song', isActive);
                const indicatorIcon = item.querySelector('.play-button i');
                if (isActive && isLoading) {
                    if(indicatorIcon) indicatorIcon.className = 'ph-bold ph-spinner-gap animate-spin text-primary-color';
                } else {
                    if(indicatorIcon) indicatorIcon.className = (isActive && state.isPlaying) ? 'ph-bold ph-speaker-high pulsing-icon text-primary-color' : 'ph-bold ph-play';
                }
            });

            // Popup playlist items
            document.querySelectorAll('#popup-song-list li').forEach(item => {
                const songInPopupList = state.currentDisplayData[parseInt(item.dataset.displayIndex)];
                const isActive = songInPopupList && songInPopupList.id === song?.id;
                item.classList.toggle('active-song-in-list', isActive);
                if (isActive && dom.playlist.container.classList.contains('show')) {
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });

            // Repeat button
            dom.playerBar.repeatBtn.classList.toggle('active-control', state.repeatMode !== 'none');
            if (state.repeatMode === 'one') dom.playerBar.repeatBtn.innerHTML = '<i class="ph-bold ph-repeat-once"></i>';
            else dom.playerBar.repeatBtn.innerHTML = '<i class="ph-bold ph-repeat"></i>';

            // Shuffle button
            dom.playerBar.shuffleBtn.classList.toggle('active-control', state.isShuffling);
            
            // Logo animation
            toggleLogoAnimations(state.isPlaying);
            
            // Media Session
            updateMediaSession();
        }

        function updateMediaSession() {
            if ('mediaSession' in navigator) {
                try {
                    const song = state.currentFilteredSongs[state.currentSongIndex]; // Always reference from currentFilteredSongs
                    if (!song) {
                        navigator.mediaSession.metadata = null;
                        navigator.mediaSession.playbackState = "none";
                        dom.playerBar.mediaSessionIndicator.classList.remove('active');
                        return;
                    }
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song.title, artist: song.artist, album: 'Âm nhạc TSTQ',
                        artwork: [{ src: song.artwork, sizes: '512x512', type: 'image/jpeg' }] /* Reverted to original artwork source */
                    });
                    navigator.mediaSession.playbackState = state.isPlaying ? "playing" : "paused";
                    dom.playerBar.mediaSessionIndicator.classList.add('active');

                    // Set Media Session action handlers
                    navigator.mediaSession.setActionHandler('play', () => {
                        dom.audioPlayer.play();
                        dom.playerBar.playPauseBtn.classList.remove('attention-bounce'); // Remove animation on manual play
                    });
                    navigator.mediaSession.setActionHandler('pause', () => dom.audioPlayer.pause());
                    navigator.mediaSession.setActionHandler('stop', () => dom.audioPlayer.pause());
                    navigator.mediaSession.setActionHandler('nexttrack', playNext);
                    navigator.mediaSession.setActionHandler('previoustrack', playPrev);

                } catch (error) {
                    console.error("Lỗi khi cập nhật Media Session:", error);
                    dom.playerBar.mediaSessionIndicator.classList.remove('active');
                }
            }
        }

        // ==============================================
        // LYRICS MANAGEMENT
        // ==============================================
        function showLyricsFullscreenPopup(song) {
            if (!song) { showMessage("Vui lòng chọn một bài hát để xem lời."); return; }
            dom.lyrics.title.textContent = song.title;
            paginateLyrics(song.description);
            applyLyricsThemeAndFontStyles();
            dom.lyrics.popup.classList.add('show');
        }

        function paginateLyrics(text) {
            const lines = text ? text.split('\n').filter(line => line.trim() !== '') : ['Không có lời bài hát.'];
            state.lyrics.pages = [];
            if (lines.length === 0) state.lyrics.pages.push(['Không có lời bài hát.']);
            else {
                for (let i = 0; i < lines.length; i += state.lyrics.linesPerPage) {
                    state.lyrics.pages.push(lines.slice(i, i + state.lyrics.linesPerPage));
                }
            }
            state.lyrics.currentPage = 0;
            displayCurrentLyricsPage();
        }

        function displayCurrentLyricsPage() {
            const { pages, currentPage } = state.lyrics;
            const contentEl = dom.lyrics.content;
            if (!pages || pages.length === 0 || !pages[currentPage]) {
                contentEl.innerHTML = '<p class="text-muted-current">Không có lời bài hát.</p>';
                dom.lyrics.pageIndicator.textContent = 'Trang 0 / 0';
                dom.lyrics.leftArrow.classList.add('disabled');
                dom.lyrics.rightArrow.classList.add('disabled');
                return;
            }
            contentEl.innerHTML = pages[currentPage].map(line => `<p>${line}</p>`).join('');
            contentEl.classList.remove('lyrics-fade-in');
            void contentEl.offsetWidth; // Trigger reflow
            contentEl.classList.add('lyrics-fade-in');

            dom.lyrics.pageIndicator.textContent = `Trang ${currentPage + 1} / ${pages.length}`;
            dom.lyrics.leftArrow.classList.toggle('disabled', currentPage === 0);
            dom.lyrics.rightArrow.classList.toggle('disabled', currentPage === pages.length - 1);
        }

        function applyLyricsThemeAndFontStyles() {
            const theme = CONFIG.LYRICS.THEMES.find(t => t.id === state.lyrics.themeId) || CONFIG.LYRICS.THEMES[0];
            const popupContent = dom.lyrics.popup.querySelector('.lyrics-popup-content');
            popupContent.style.backgroundColor = theme.bgColor;
            popupContent.style.color = theme.textColor;
            dom.lyrics.content.style.fontSize = `${state.lyrics.fontSize}px`;
            dom.lyrics.content.style.fontFamily = CONFIG.LYRICS.FONTS[state.lyrics.fontIndex];
        }
        
        function positionRadialItems() {
            const items = dom.lyrics.radialMenu.items;
            const totalAngle = 360; 
            const radius = 95;
            if (items.length <= 1) return;
            const angleStep = totalAngle / items.length;

            items.forEach((item, index) => {
                const angle = -90 + (index * angleStep);
                const radians = angle * (Math.PI / 180);
                item.style.setProperty('--x', `${radius * Math.cos(radians)}px`);
                item.style.setProperty('--y', `${radius * Math.sin(radians)}px`);
            });
        }

        // ==============================================
        // NEW FEATURES: SHARE & DOWNLOAD
        // ==============================================
        async function shareSong() {
            const song = state.currentFilteredSongs[state.currentSongIndex]; // Use currentFilteredSongs
            if (!song || !song.permalink) {
                showMessage("Không thể chia sẻ bài hát này.");
                return;
            }

            let shareUrl = song.permalink;
            // Decode URI component to handle special characters like Vietnamese accents
            shareUrl = decodeURIComponent(shareUrl);
            // Ensure it starts with https://audius.co/
            if (!shareUrl.startsWith('http://') && !shareUrl.startsWith('https://')) {
                shareUrl = `https://audius.co${shareUrl}`; 
            }
            
            const shareData = {
                title: `Nghe "${song.title}" - ${song.artist}`,
                text: `Nghe bài hát "${song.title}" của ${song.artist} trên Play Nhạc MSTQ.`,
                url: shareUrl
            };

            const copyToClipboard = () => {
                const textArea = document.createElement("textarea");
                textArea.value = shareUrl;
                textArea.style.position = "fixed";
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage("Đã sao chép liên kết vào bộ nhớ tạm!", "Thông báo", true, 2500); // Changed duration to 2.5 seconds
                } catch (err) {
                    showMessage("Không thể sao chép liên kết.", "Lỗi");
                }
                document.body.removeChild(textArea);
            };

            if (navigator.share && window.top === window.self) { // Kiểm tra navigator.share và nếu không phải trong iframe
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    console.error('Lỗi khi chia sẻ:', err);
                    // Nếu lỗi không phải do người dùng hủy bỏ, thì fallback sang copy
                    if (err.name !== 'AbortError') {
                            copyToClipboard();
                    } else {
                        showMessage("Đã hủy chia sẻ.", "Thông báo", true, 2500); // Changed duration to 2.5 seconds
                    }
                }
            } else {
                copyToClipboard();
            }
        }

        function downloadLyrics() {
            const song = state.currentFilteredSongs[state.currentSongIndex]; // Use currentFilteredSongs
            if (!song || !song.description || song.description.trim() === 'Không có lời bài hát cho bài này.') {
                showMessage("Không có lời bài hát để tải về.", "Thông báo");
                return;
            }
            const filename = `${song.title} - ${song.artist}.txt`;
            const text = song.description.replace(/\n/g, '\r\n');
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // ==============================================
        // SLEEP TIMER
        // ==============================================
        function startSleepTimer(minutes) {
            if (minutes <= 0 || isNaN(minutes)) {
                showMessage("Vui lòng nhập số phút hợp lệ.", "Lỗi hẹn giờ");
                return;
            }
            cancelSleepTimer();
            state.sleepTimer.endTime = Date.now() + minutes * 60 * 1000;
            document.getElementById('start-timer-btn-desktop').classList.add('hidden');
            document.getElementById('cancel-timer-btn-desktop').classList.remove('hidden');
            document.getElementById('start-timer-btn-mobile').classList.add('hidden');
            document.getElementById('cancel-timer-btn-mobile').classList.remove('hidden');
            updateSleepTimerDisplay();
            state.sleepTimer.interval = setInterval(() => {
                if (Date.now() >= state.sleepTimer.endTime) {
                    dom.audioPlayer.pause();
                    cancelSleepTimer();
                    showMessage("Hẹn giờ tắt nhạc đã kết thúc.", "Hẹn giờ", true, 2500); // Changed duration to 2.5 seconds
                } else {
                    updateSleepTimerDisplay();
                }
            }, 1000);
        }

        function updateSleepTimerDisplay() {
            const displayDesktop = document.getElementById('timer-display-desktop');
            const displayMobile = document.getElementById('timer-display-mobile');
            if (!state.sleepTimer.endTime) {
                    if(displayDesktop) displayDesktop.textContent = '00:00';
                    if(displayMobile) displayMobile.textContent = '00:00';
                return;
            }
            const remainingTimeMs = state.sleepTimer.endTime - Date.now();
            if (remainingTimeMs <= 0) {
                if(displayDesktop) displayDesktop.textContent = '00:00';
                if(displayMobile) displayMobile.textContent = '00:00';
                return;
            }
            const totalSeconds = Math.floor(remainingTimeMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if(displayDesktop) displayDesktop.textContent = formattedTime;
            if(displayMobile) dom.playerBar.songArtist.classList.add('hidden'); // Hide on mobile when timer is active
            if(displayMobile) mobileDisplay.textContent = formattedTime; // Corrected ID
        }

        function cancelSleepTimer() {
            if (state.sleepTimer.interval) {
                clearInterval(state.sleepTimer.interval);
                state.sleepTimer.interval = null;
            }
            state.sleepTimer.endTime = null;
            document.getElementById('start-timer-btn-desktop').classList.remove('hidden');
            document.getElementById('cancel-timer-btn-desktop').classList.add('hidden');
            document.getElementById('start-timer-btn-mobile').classList.remove('hidden');
            document.getElementById('cancel-timer-btn-mobile').classList.add('hidden');
            updateSleepTimerDisplay();
        }

        // ==============================================
        // NAVIGATION & UI
        // ==============================================
        function setupNavEvents() {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
            const closeMobileMenu = document.getElementById('close-mobile-menu'); 
            
            hamburgerMenu?.addEventListener('click', () => mobileNavOverlay.classList.add('active'));
            closeMobileMenu?.addEventListener('click', () => mobileNavOverlay.classList.remove('active'));
            mobileNavOverlay?.addEventListener('click', (e) => {
                if (e.target === mobileNavOverlay) mobileNavOverlay.classList.remove('active');
            });

            const setupDropdown = (toggleId, menuId) => {
                const toggle = document.getElementById(toggleId);
                const menu = document.getElementById(menuId);
                toggle?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isShown = menu.classList.toggle('show');
                    toggle.classList.toggle('open', isShown);
                    document.querySelectorAll('.dropdown-menu.show').forEach(openMenu => {
                        if (openMenu !== menu) openMenu.classList.remove('show');
                    });
                    document.querySelectorAll('.dropdown-toggle.open').forEach(openToggle => {
                        if (openToggle !== toggle) openToggle.classList.remove('open');
                    });
                });
            };
            
            setupDropdown('platforms-toggle-desktop', 'platforms-menu-desktop');
            setupDropdown('theme-toggle-desktop', 'theme-menu-desktop');
            setupDropdown('timer-toggle-desktop', 'timer-menu-desktop');
            setupDropdown('platforms-toggle-mobile', 'platforms-menu-mobile');
            setupDropdown('theme-toggle-mobile', 'mobile-theme-options'); /* Corrected ID for mobile theme dropdown */
            setupDropdown('timer-toggle-mobile', 'timer-menu-mobile');

            document.addEventListener('click', (e) => {
                // Close all dropdowns if click is outside
                if (!e.target.closest('.dropdown-container')) {
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => menu.classList.remove('show'));
                    document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => toggle.classList.remove('open'));
                }
            });

            // Dark Mode toggles
            document.getElementById('darkModeToggle')?.addEventListener('change', (e) => {
                changeTheme(e.target.checked ? 'dark' : 'light');
            });
            document.getElementById('darkModeToggleMobile')?.addEventListener('change', (e) => {
                changeTheme(e.target.checked ? 'dark' : 'light');
            });
        }
        
        function renderPlatformLinks() {
            const containers = [document.getElementById('platforms-menu-desktop'), document.getElementById('platforms-menu-mobile')];
            const zaloSvg = `<svg viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 456c-114.9 0-208-93.1-208-208S141.1 48 256 48s208 93.1 208 208-93.1 208-208 208zm-22.6-261.2c-1.5-1.5-3.5-2.2-5.7-2.2H168.4c-4.4 0-8 3.6-8 8v123.6c0 4.4 3.6 8 8 8h59.3c4.4 0 8-3.6 8-8v-60.6l28.7 28.7c1.5 1.5 3.5 2.2 5.7 2.2h15.2c4.4 0 8-3.6 8-8V194.8c0-4.4-3.6-8-8-8h-15.2c-2.2 0-4.2-.7-5.7-2.2L233.4 162.6zM343.6 288.4c-1.5-1.5-3.5-2.2-5.7-2.2h-59.3c-4.4 0-8 3.6-8 8v60.6l-28.7-28.7c-1.5-1.5-3.5-2.2-5.7-2.2h-15.2c-4.4 0-8 3.6-8 8v59.3c0 4.4 3.6 8 8 8h59.3c4.4 0 8-3.6 8-8v-60.6l28.7 28.7c1.5 1.5 3.5 2.2 5.7 2.2h15.2c4.4 0 8-3.6 8-8v-59.3c0-4.4-3.6-8-8-8z"/></svg>`;

            containers.forEach(container => {
                if (!container) return;
                container.innerHTML = '';
                CONFIG.PLATFORM_LINKS.forEach(link => {
                    const iconHtml = link.icon === 'zalo-svg' ? zaloSvg : `<i class="ph-bold ${link.icon}"></i>`;
                    const linkElement = document.createElement('a');
                    linkElement.href = link.url;
                    linkElement.target = "_blank";
                    linkElement.rel = "noopener noreferrer";
                    linkElement.innerHTML = `${iconHtml} ${link.name}`;
                    const iconEl = linkElement.querySelector('svg, i');
                    if (iconEl) iconEl.style.color = link.color;
                    container.appendChild(linkElement);
                });
            });
        }

        // ==============================================
        // DRAG & DROP LOGIC
        // ==============================================
        let draggedItem = null; /* Reverted to let declaration */

        function addDragAndDropListeners() {
            dom.playlist.list.querySelectorAll('li[draggable="true"]').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = e.currentTarget; /* Reverted to direct assignment */
                    setTimeout(() => e.currentTarget.classList.add('dragging'), 0);
                });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.currentTarget.classList.add('drag-over');
                });
                item.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over'));
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.currentTarget.classList.remove('drag-over');
                    if (draggedItem !== e.currentTarget) { /* Reverted to direct comparison */
                        const fromIndex = parseInt(draggedItem.dataset.displayIndex); /* Reverted to direct access */
                        const toIndex = parseInt(e.currentTarget.dataset.displayIndex);
                        
                        const [reorderedItem] = state.currentDisplayData.splice(fromIndex, 1);
                        state.currentDisplayData.splice(toIndex, 0, reorderedItem);
                        
                        // After reordering currentDisplayData, find the new index of the currently playing song in the full filtered list
                        const currentlyPlayingSongId = state.currentFilteredSongs[state.currentSongIndex]?.id;
                        if(currentlyPlayingSongId) {
                            // Update currentFilteredSongs to reflect the reorder
                            const reorderedSongInFiltered = state.currentFilteredSongs.find(s => s.id === reorderedItem.id);
                            const originalIndexInFiltered = state.currentFilteredSongs.indexOf(reorderedSongInFiltered);
                            state.currentFilteredSongs.splice(originalIndexInFiltered, 1);
                            state.currentFilteredSongs.splice(toIndex + state.currentDisplayStartIndex, 0, reorderedSongInFiltered); // Insert at the correct position in the full list

                            state.currentSongIndex = state.currentFilteredSongs.findIndex(s => s.id === currentlyPlayingSongId);
                        }
                        
                        renderPopupSongList(state.currentDisplayData); // Re-render popup list
                        renderSongs(state.currentDisplayData); // Re-render main list
                        updateUI();
                        triggerHapticFeedback(70);
                    }
                });
                item.addEventListener('dragend', (e) => e.currentTarget.classList.remove('dragging')); /* Reverted to direct access */
            });
        }

        // ==============================================
        // PAGINATION & CATEGORY LOGIC
        // ==============================================
        function loadCustomCategory(category) {
            document.querySelectorAll('#category-menu .nav-item').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`#category-menu .nav-item[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bounce-category-btn');
                setTimeout(() => activeBtn.classList.remove('bounce-category-btn'), 300);
            }
            
            dom.mainContent.searchInput.value = '';
            state.isSearching = false; // Reset search state when changing category
            dom.mainContent.searchClearBtn.classList.add('hidden');

            let filteredSongs;
            if (category === 'favorites') {
                filteredSongs = state.originalSongData.filter(s => state.favoriteSongIds.includes(s.id));
            } else if (CONFIG.GENRE_MAP[category]) {
                filteredSongs = state.originalSongData.filter(s => s.genre && s.genre.toLowerCase() === CONFIG.GENRE_MAP[category].toLowerCase());
            } else { // 'all' or other categories
                filteredSongs = [...state.originalSongData];
            }

            // Apply shuffle if active for the current category (excluding favorites)
            if (state.isShuffling && category !== 'favorites') {
                // Simple shuffle logic
                for (let i = filteredSongs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [filteredSongs[i], filteredSongs[j]] = [filteredSongs[j], filteredSongs[i]]; // Corrected swap
                }
            }

            state.currentFilteredSongs = filteredSongs; 
            state.currentDisplayStartIndex = 0; // Always start from the beginning for a new category
            state.currentDisplayData = state.currentFilteredSongs.slice(0, CONFIG.INITIAL_LOAD_SIZE);
            
            renderSongs(state.currentDisplayData); // Render initial songs
            updatePaginationControls(); // Update pagination controls based on the full filtered list
        }

        function loadMoreSongs() {
            dom.mainContent.loadMoreBtn.classList.add('hidden');
            dom.mainContent.loadingMoreSpinner.classList.remove('hidden');
            
            setTimeout(() => { // Simulate loading delay
                // Calculate the next chunk to load from currentFilteredSongs
                const startIndex = state.currentDisplayStartIndex + state.currentDisplayData.length;
                const endIndex = Math.min(startIndex + CONFIG.PAGE_SIZE, state.currentFilteredSongs.length);
                const newSongs = state.currentFilteredSongs.slice(startIndex, endIndex);

                state.currentDisplayData = [...state.currentDisplayData, ...newSongs]; // Append to current displayed songs
                
                renderSongs(state.currentDisplayData); // Re-render the expanded list
                updateUI(); // Update player bar and active song state

                dom.mainContent.loadingMoreSpinner.classList.add('hidden');
                updatePaginationControls();
            }, 500);
        }

        function updatePaginationControls() {
            // Hide all by default
            dom.mainContent.loadMoreBtn.classList.add('hidden');
            dom.mainContent.allSongsLoadedMsg.classList.add('hidden');
            dom.mainContent.loadingMoreSpinner.classList.add('hidden');

            if (state.isSearching) {
                // No load more button during search, as search operates on all data
                return;
            }

            // Show load more if there are more songs in currentFilteredSongs than currently displayed
            if (state.currentDisplayData.length < state.currentFilteredSongs.length) {
                dom.mainContent.loadMoreBtn.classList.remove('hidden');
            } else {
                if (state.currentFilteredSongs.length > 0) { // Only show "all loaded" if there are songs
                    dom.mainContent.allSongsLoadedMsg.classList.add('hidden'); // Ensure hidden if all loaded
                }
            }
        }
        
        // ==============================================
        // NÂNG CẤP: ĐỒNG BỘ TAB & ÂM LƯỢNG
        // ==============================================
        const broadcastChannel = new BroadcastChannel('mstq_music_player');

        function setupBroadcastChannel() {
            broadcastChannel.onmessage = (event) => {
                const { type, payload } = event.data;
                if (type === 'PLAY_ACTION' && payload.isPlaying) {
                    dom.audioPlayer.pause();
                }
            };
        }
        
        // ==============================================
        // INITIALIZATION
        // ==============================================
        function toggleScrollNavVisibility() {
            // Check if content height is greater than viewport height
            const isScrollable = document.documentElement.scrollHeight > window.innerHeight;
            // Check if scroll position is not at the very top or bottom
            const isNotAtExtremes = window.scrollY > 0 && (window.scrollY + window.innerHeight) < document.documentElement.scrollHeight;

            // Only show if scrollable AND not at the very top/bottom
            dom.scrollNav.container.classList.toggle('show', isScrollable && isNotAtExtremes);
        }

        function updateVolumeUI() {
            const volume = dom.audioPlayer.volume;
            const isMuted = dom.audioPlayer.muted;
            dom.playerBar.volumePercentage.textContent = isMuted ? 0 : Math.round(volume * 100);

            if (isMuted || volume === 0) {
                dom.playerBar.volumeIcon.className = 'ph-bold ph-speaker-slash volume-icon';
            } else if (volume < 0.5) {
                dom.playerBar.volumeIcon.className = 'ph-bold ph-speaker-low volume-icon';
            } else {
                dom.playerBar.volumeIcon.className = 'ph-bold ph-speaker-high volume-icon';
            }
        }

        function toggleMute() {
            dom.audioPlayer.muted = !dom.audioPlayer.muted;
            if (!dom.audioPlayer.muted && dom.audioPlayer.volume === 0) {
                dom.audioPlayer.volume = state.lastVolume > 0 ? state.lastVolume : 0.5;
                dom.playerBar.volumeSlider.value = dom.audioPlayer.volume;
            }
            updateVolumeUI();
            showMessage(dom.audioPlayer.muted ? "Đã tắt tiếng" : "Đã bật tiếng", "Âm thanh", true, 2500); // Changed duration to 2.5 seconds
        }
        
        function setupEventListeners() {
            // Player controls
            dom.playerBar.playPauseBtn?.addEventListener('click', () => { // Added null check
                triggerHapticFeedback(50);
                dom.playerBar.playPauseBtn.classList.remove('attention-bounce'); // Remove animation on click
                if (state.currentSongIndex === -1 && state.currentFilteredSongs.length > 0) playSong(0); // Play first song from filtered list
                else if (dom.audioPlayer.paused) dom.audioPlayer.play();
                else dom.audioPlayer.pause();
            });
            dom.playerBar.nextBtn?.addEventListener('click', () => { playNext(); triggerHapticFeedback(50); }); // Added null check
            dom.playerBar.prevBtn?.addEventListener('click', () => { playPrev(); triggerHapticFeedback(50); }); // Added null check
            dom.playerBar.shuffleBtn?.addEventListener('click', () => { // Added null check
                state.isShuffling = !state.isShuffling;
                saveStateToLocalStorage(CONFIG.STORAGE_KEYS.SHUFFLE, state.isShuffling);
                // When shuffling, re-render the current category's songs (which will apply pagination)
                const currentCategory = document.querySelector('#category-menu .nav-item.active')?.dataset.category || 'all';
                loadCustomCategory(currentCategory); // This will re-filter and re-shuffle if needed
                updateUI(); triggerHapticFeedback(30);
            });
            dom.playerBar.repeatBtn?.addEventListener('click', () => { // Added null check
                const modes = ['none', 'all', 'one'];
                state.repeatMode = modes[(modes.indexOf(state.repeatMode) + 1) % modes.length];
                saveStateToLocalStorage(CONFIG.STORAGE_KEYS.REPEAT, state.repeatMode);
                updateUI(); triggerHapticFeedback(30);
            });
            dom.playerBar.favoriteBtn?.addEventListener('click', () => { // Added null check
                if (state.currentSongIndex !== -1) toggleFavorite(state.currentFilteredSongs[state.currentSongIndex].id); // Use currentFilteredSongs
                else showMessage("Vui lòng chọn một bài hát để yêu thích.");
                triggerHapticFeedback(70);
            });
            dom.playerBar.shareBtn?.addEventListener('click', shareSong); // Added null check
            
            // Audio events
            dom.audioPlayer.addEventListener('play', () => { 
                state.isPlaying = true; 
                updateUI(); 
                requestWakeLock(); 
                broadcastChannel.postMessage({ type: 'PLAY_ACTION', payload: { isPlaying: true } });
            });
            dom.audioPlayer.addEventListener('pause', () => { 
                state.isPlaying = false; 
                updateUI(); 
                dom.playerBar.albumArt.classList.remove('animate-pulse'); // Ensure pulse is removed on pause
                releaseWakeLock(); 
                broadcastChannel.postMessage({ type: 'PLAY_ACTION', payload: { isPlaying: false } });
            });
            dom.audioPlayer.addEventListener('ended', () => { if (state.repeatMode !== 'none') playNext(); else { state.isPlaying = false; updateUI(); } });
            dom.audioPlayer.addEventListener('timeupdate', throttle(() => {
                const { currentTime, duration } = dom.audioPlayer;
                if(duration && isFinite(duration)) {
                    dom.playerBar.progressBar.style.width = `${(currentTime / duration) * 100}%`;
                    dom.playerBar.currentTime.textContent = new Date(currentTime * 1000).toISOString().substr(14, 5);
                    dom.playerBar.duration.textContent = new Date(duration * 1000).toISOString().substr(14, 5);
                }
            }, 500));
            dom.audioPlayer.addEventListener('waiting', () => {
                console.log('Audio is waiting for more data...');
                if (state.isPlaying) { // Only show loading if it was supposed to be playing
                    dom.playerBar.playPauseBtn.classList.add('play-pause-loading');
                    dom.playerBar.albumArt.classList.add('animate-pulse'); // Show pulse on album art during buffering
                    updateUI(); // Update UI to show spinner on active song too
                }
            });
            dom.audioPlayer.addEventListener('playing', () => {
                console.log('Audio is playing again.');
                dom.playerBar.playPauseBtn.classList.remove('play-pause-loading');
                dom.playerBar.albumArt.classList.remove('animate-pulse'); // Remove pulse when playing resumes
                updateUI(); // Ensure spinner is removed
            });
            dom.audioPlayer.addEventListener('stalled', () => {
                console.warn('Audio playback stalled. Network or buffering issue.');
                // For now, let the browser try to recover.
                // If persistent, user might need to check network or we might need more aggressive host switching.
                showMessage("Kết nối mạng không ổn định, đang tải lại...", "Lỗi mạng", true, 2500); // Changed duration to 2.5 seconds
            });
            dom.audioPlayer.addEventListener('error', (e) => {
                console.error('Audio error:', e);
                let errorMessage = "Đã xảy ra lỗi khi phát bài hát.";
                switch (e.target.error.code) {
                    case e.target.error.MEDIA_ERR_ABORTED:
                        errorMessage = "Quá trình tải bài hát đã bị hủy bỏ.";
                        break;
                    case e.target.error.MEDIA_ERR_NETWORK:
                        errorMessage = "Lỗi mạng: Không thể tải bài hát.";
                        break;
                    case e.target.error.MEDIA_ERR_DECODE:
                        errorMessage = "Lỗi giải mã: Bài hát không thể phát.";
                        break;
                    case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMessage = "Định dạng bài hát không được hỗ trợ.";
                        break;
                    default:
                        errorMessage = "Lỗi không xác định khi phát bài hát.";
                        break;
                }
                showMessage(errorMessage + " Tự động chuyển bài tiếp theo.", "Lỗi Phát Nhạc");
                playNext(); // Automatically try next song on error
            });
            
            // Progress bar
            dom.playerBar.progressContainer?.addEventListener('click', (e) => { // Added null check
                if(dom.audioPlayer.duration) dom.audioPlayer.currentTime = (e.offsetX / dom.playerBar.progressContainer.clientWidth) * dom.audioPlayer.duration; // Corrected ID
            });
            dom.playerBar.progressContainer?.addEventListener('mousemove', throttle((e) => { // Added null check
                if (dom.audioPlayer.duration) {
                    const hoverTime = (e.offsetX / dom.playerBar.progressContainer.clientWidth) * dom.audioPlayer.duration;
                    dom.playerBar.progressTooltip.textContent = new Date(hoverTime * 1000).toISOString().substr(14, 5);
                    dom.playerBar.progressTooltip.style.left = `${e.offsetX}px`;
                    dom.playerBar.progressTooltip.classList.remove('hidden');
                }
            }, 50));
            dom.playerBar.progressContainer?.addEventListener('mouseleave', () => dom.playerBar.progressTooltip.classList.add('hidden')); // Added null check

            // Volume
            dom.playerBar.volumeSlider?.addEventListener('input', (e) => { // Added null check
                dom.audioPlayer.muted = false; // Unmute when user adjusts volume
                dom.audioPlayer.volume = e.target.value;
                updateVolumeUI();
            });
             dom.playerBar.volumeSlider?.addEventListener('change', (e) => { // Added null check
                saveStateToLocalStorage(CONFIG.STORAGE_KEYS.VOLUME, e.target.value);
            });
            dom.playerBar.volumeIcon?.addEventListener('click', toggleMute); // Added null check
            
            // Search
            dom.mainContent.searchInput?.addEventListener('input', debounce(() => { // Added null check
                const query = dom.mainContent.searchInput.value.trim();
                state.isSearching = query.length > 0; // Update search flag
                dom.mainContent.searchClearBtn.classList.toggle('hidden', !state.isSearching);
                
                if (state.isSearching) {
                    dom.mainContent.loadingMoreSpinner.classList.remove('hidden'); // Show searching spinner
                    dom.mainContent.loadMoreBtn.classList.add('hidden'); // Hide load more button
                    dom.mainContent.allSongsLoadedMsg.classList.add('hidden'); // Hide all loaded message

                    // Initialize Fuse.js only when search is first used
                    if (!window.fuse) {
                        window.fuse = new Fuse(state.originalSongData, { keys: ['title', 'artist', 'genre'], includeScore: true, threshold: 0.4 });
                    }
                    const result = window.fuse.search(query);
                    state.currentFilteredSongs = result.map(item => item.item); // Update filtered songs with search results
                    state.currentDisplayStartIndex = 0; // Reset display start for search results
                    state.currentDisplayData = state.currentFilteredSongs; // Display all search results
                    renderSongs(state.currentDisplayData); // Render search results
                    dom.mainContent.loadingMoreSpinner.classList.add('hidden'); // Hide searching spinner
                } else {
                    // If search is cleared, reload the current category with pagination
                    loadCustomCategory(document.querySelector('#category-menu .nav-item.active')?.dataset.category || 'all');
                }
            }, 300));
            dom.mainContent.searchClearBtn?.addEventListener('click', () => { // Added null check
                dom.mainContent.searchInput.value = '';
                state.isSearching = false;
                dom.mainContent.searchClearBtn.classList.add('hidden');
                loadCustomCategory(document.querySelector('#category-menu .nav-item.active')?.dataset.category || 'all');
            });

            // Modals and Popups
            dom.modals.alertOkBtn?.addEventListener('click', hideMessage); // Added null check
            dom.playlist.toggleBtn?.addEventListener('click', () => { // Added null check
                const isHidden = dom.playlist.container.classList.toggle('hidden');
                dom.playlist.container.classList.toggle('show', !isHidden);
                if (!isHidden) updateUI();
            });
            dom.lyrics.openBtn?.addEventListener('click', () => showLyricsFullscreenPopup(state.currentFilteredSongs[state.currentSongIndex])); // Added null check // Use currentFilteredSongs
            dom.lyrics.closeBtn?.addEventListener('click', () => dom.lyrics.popup.classList.remove('show')); // Added null check
            
            // Timer
            document.getElementById('start-timer-btn-desktop')?.addEventListener('click', () => startSleepTimer(parseInt(document.getElementById('timer-minutes-desktop').value)));
            document.getElementById('cancel-timer-btn-desktop')?.addEventListener('click', cancelSleepTimer);
            document.getElementById('start-timer-btn-mobile')?.addEventListener('click', () => startSleepTimer(parseInt(document.getElementById('timer-minutes-mobile').value)));
            document.getElementById('cancel-timer-btn-mobile')?.addEventListener('click', cancelSleepTimer);

            // Lyrics Radial Menu
            dom.lyrics.radialMenu.toggleBtn?.addEventListener('click', () => dom.lyrics.radialMenu.container.classList.toggle('active')); // Added null check
            document.getElementById('radial-font-size-increase')?.addEventListener('click', () => { // Added null check
                state.lyrics.fontSize++;
                applyLyricsThemeAndFontStyles();
                saveStateToLocalStorage(CONFIG.LYRICS.STORAGE_KEYS.FONT_SIZE, state.lyrics.fontSize);
            });
            document.getElementById('radial-font-size-decrease')?.addEventListener('click', () => { // Added null check
                state.lyrics.fontSize = Math.max(12, state.lyrics.fontSize - 1);
                applyLyricsThemeAndFontStyles();
                saveStateToLocalStorage(CONFIG.LYRICS.STORAGE_KEYS.FONT_SIZE, state.lyrics.fontSize);
            });
            document.getElementById('radial-lines-increase')?.addEventListener('click', () => { // Added null check
                state.lyrics.linesPerPage++;
                paginateLyrics(state.currentFilteredSongs[state.currentSongIndex]?.description || ''); // Use currentFilteredSongs
                saveStateToLocalStorage(CONFIG.LYRICS.STORAGE_KEYS.LINES_PER_PAGE, state.lyrics.linesPerPage);
            });
             document.getElementById('radial-lines-decrease')?.addEventListener('click', () => { // Added null check
                state.lyrics.linesPerPage = Math.max(1, state.lyrics.linesPerPage - 1);
                paginateLyrics(state.currentFilteredSongs[state.currentSongIndex]?.description || ''); // Use currentFilteredSongs
                saveStateToLocalStorage(CONFIG.LYRICS.STORAGE_KEYS.LINES_PER_PAGE, state.lyrics.linesPerPage);
            });
            document.getElementById('radial-font-btn')?.addEventListener('click', () => { // Added null check
                state.lyrics.fontIndex = (state.lyrics.fontIndex + 1) % CONFIG.LYRICS.FONTS.length;
                applyLyricsThemeAndFontStyles();
                saveStateToLocalStorage(CONFIG.LYRICS.STORAGE_KEYS.FONT_INDEX, state.lyrics.fontIndex);
            });
            document.getElementById('radial-theme-btn')?.addEventListener('click', () => { // Added null check
                let currentThemeObjIndex = CONFIG.LYRICS.THEMES.findIndex(t => t.id === state.lyrics.themeId);
                state.lyrics.themeId = CONFIG.LYRICS.THEMES[(currentThemeObjIndex + 1) % CONFIG.LYRICS.THEMES.length].id;
                applyLyricsThemeAndFontStyles();
                saveStateToLocalStorage(CONFIG.LYRICS.STORAGE_KEYS.THEME_ID, state.lyrics.themeId);
            });
            dom.lyrics.radialMenu.downloadBtn?.addEventListener('click', downloadLyrics); // Added null check

            // Window events
            window.addEventListener('beforeunload', saveCurrentPlaybackState);

            // Nâng cấp: Cuộn ẩn/hiện thanh player
            window.addEventListener('scroll', throttle(() => {
                const currentScrollY = window.scrollY;
                if (window.innerWidth > 768) { // Only apply minimization on larger screens
                    if (currentScrollY > state.lastScrollY && currentScrollY > 100) { // Scrolling down
                        dom.body.classList.add('player-bar-minimized');
                    } else if (currentScrollY < state.lastScrollY || currentScrollY <= 100) { // Scrolling up or at the top
                        dom.body.classList.remove('player-bar-minimized');
                    }
                } else {
                    // Ensure it's never minimized on mobile
                    dom.body.classList.remove('player-bar-minimized');
                }
                state.lastScrollY = currentScrollY;
                toggleScrollNavVisibility(); // Update scroll nav visibility on scroll
            }, 200)); // Throttle scroll event

            // Nâng cấp: Swipe gestures on album art
            let touchStartX = 0;
            let touchStartY = 0;
            const albumArtElement = dom.playerBar.nowPlayingWrapper;

            albumArtElement?.addEventListener('touchstart', (e) => { // Added null check
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });

            albumArtElement?.addEventListener('touchmove', (e) => { // Added null check
                // Only prevent vertical scrolling if horizontal swipe is significant
                const touchMoveX = e.touches[0].clientX;
                const touchMoveY = e.touches[0].clientY;
                const diffX = touchMoveX - touchStartX;
                const diffY = touchMoveY - touchStartY;

                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) { // If horizontal movement is more significant than vertical
                    e.preventDefault(); // Prevent page scrolling
                }
            }, { passive: false }); // `passive: false` to allow `preventDefault`

            albumArtElement?.addEventListener('touchend', (e) => { // Added null check
                const touchEndX = e.changedTouches[0].clientX;
                const diffX = touchEndX - touchStartX;

                if (Math.abs(diffX) > 50) { // Swipe threshold
                    if (diffX > 0) { // Swiped right
                        playPrev();
                    } else { // Swiped left
                        playNext();
                    }
                    triggerHapticFeedback(50);
                }
            });

            // Scroll navigation buttons
            dom.scrollNav.toTopBtn?.addEventListener('click', () => { // Added null check
                window.scrollTo({ top: 0, behavior: 'smooth' });
                triggerHapticFeedback(30);
            });
            dom.scrollNav.toBottomBtn?.addEventListener('click', () => { // Added null check
                window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
                triggerHapticFeedback(30);
            });

            // Load more button event listener
            dom.mainContent.loadMoreBtn?.addEventListener('click', loadMoreSongs); // Added null check

            // Reload Library button listener
            dom.mainContent.reloadLibraryBtn?.addEventListener('click', async () => { // Added null check
                dom.mainContent.reloadLibraryBtn.classList.add('hidden'); // Hide button while reloading
                dom.mainContent.initialLoadingOverlay.classList.remove('hidden');
                dom.mainContent.initialLoadingOverlay.classList.add('opacity-100');
                await fetchAudiusData(); // Re-fetch all data
                loadCustomCategory(document.querySelector('#category-menu .nav-item.active')?.dataset.category || 'all'); // Re-render current category
            });


            // NÂNG CẤP: Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                // Bỏ qua nếu đang gõ trong ô input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                switch (e.code) {
                    case 'Space':
                        e.preventDefault(); // Ngăn cuộn trang
                        dom.playerBar.playPauseBtn?.click(); // Added null check
                        break;
                    case 'ArrowRight':
                        dom.playerBar.nextBtn?.click(); // Added null check
                        break;
                    case 'ArrowLeft':
                        dom.playerBar.prevBtn?.click(); // Added null check
                        break;
                }
            });
        }

        async function initializeApp() {
            // 1. Setup initial UI
            createStars(100, dom.splashScreen.querySelector('.stars'));
            createStars(50, dom.splashScreen.querySelector('.stars2'));
            createStars(20, dom.splashScreen.querySelector('.stars3'));
            await loadAndInjectSVG();
            cacheLogoElements();
            
            // 2. Load settings from Local Storage
            state.isShuffling = loadStateFromLocalStorage(CONFIG.STORAGE_KEYS.SHUFFLE, false);
            state.repeatMode = loadStateFromLocalStorage(CONFIG.STORAGE_KEYS.REPEAT, 'all');
            state.favoriteSongIds = loadStateFromLocalStorage(CONFIG.STORAGE_KEYS.FAVORITES, []);
            const savedVolume = loadStateFromLocalStorage(CONFIG.STORAGE_KEYS.VOLUME, '1');
            dom.audioPlayer.volume = savedVolume;
            state.lastVolume = savedVolume;
            dom.playerBar.volumeSlider.value = savedVolume;
            updateVolumeUI();
            applyTheme();

            // Render preset theme buttons
            renderPresetThemes('preset-themes-desktop');
            renderPresetThemes('preset-themes-mobile');

            // 3. Render static components (already done above for categories)
            CONFIG.CATEGORIES.forEach(cat => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'nav-item text-xs';
                btn.innerHTML = cat.name;
                btn.dataset.category = cat.id;
                btn.onclick = () => loadCustomCategory(cat.id);
                dom.mainContent.categoryMenu.appendChild(btn);
            });
            setupNavEvents();
            renderPlatformLinks();
            positionRadialItems();
            
            // 4. Setup all event listeners
            setupEventListeners();
            setupBroadcastChannel();
            
            // 5. Fetch data and render song list
            renderSkeletonLoader(CONFIG.INITIAL_LOAD_SIZE); // Show skeleton for initial load size
            dom.mainContent.initialLoadingOverlay.classList.remove('hidden'); // Show initial loading overlay
            dom.mainContent.initialLoadingOverlay.classList.add('opacity-100');

            await fetchAudiusData(); // This now fetches all data into originalSongData

            // If fetchAudiusData failed, show the reload button
            if (state.originalSongData.length === 0) {
                dom.mainContent.reloadLibraryBtn.classList.remove('hidden');
            }

            // 6. Restore previous playback state or handle shared link
            const urlParams = new URLSearchParams(window.location.search);
            const songToPlayId = urlParams.get('play');

            if (songToPlayId) {
                // Nếu có ID bài hát trong URL, ưu tiên phát bài hát đó
                const songIndex = state.originalSongData.findIndex(s => s.id === songToPlayId);
                if (songIndex !== -1) {
                    // Load the category of the shared song, then play it
                    const sharedSongCategory = state.originalSongData[songIndex].genre ? 
                                                Object.keys(CONFIG.GENRE_MAP).find(key => CONFIG.GENRE_MAP[key].toLowerCase() === state.originalSongData[songIndex].genre.toLowerCase()) || 'all'
                                                : 'all';
                    loadCustomCategory(sharedSongCategory);
                    // Ensure the song is in currentDisplayData before playing
                    const displayIndex = state.currentFilteredSongs.findIndex(s => s.id === songToPlayId);
                    if (displayIndex !== -1) {
                             // Ensure the song is within the initially loaded set or load it
                            if (displayIndex >= state.currentDisplayStartIndex + state.currentDisplayData.length || displayIndex < state.currentDisplayStartIndex) {
                                // If the song is not in the current window, adjust the window
                                let newDisplayStartIndex = Math.max(0, displayIndex - Math.floor(CONFIG.PAGE_SIZE / 2));
                                newDisplayStartIndex = Math.min(newDisplayStartIndex, state.currentFilteredSongs.length - CONFIG.PAGE_SIZE);
                                if (newDisplayStartIndex < 0) newDisplayStartIndex = 0;

                                state.currentDisplayData = state.currentFilteredSongs.slice(newDisplayStartIndex, newDisplayStartIndex + CONFIG.PAGE_SIZE);
                                state.currentDisplayStartIndex = newDisplayStartIndex;
                                renderSongs(state.currentDisplayData);
                            }
                        playSong(displayIndex); // Play the song using its index in the filtered list
                        // Inform the user that they might need to click play due to browser policies
                        showMessage(`Đã tải bài hát "${state.currentFilteredSongs[displayIndex].title}". Vui lòng nhấn nút Play để bắt đầu nghe.`, "Sẵn sàng phát nhạc", true, 5000);
                        // Add visual cue to play button
                        dom.playerBar.playPauseBtn.classList.add('attention-bounce');
                        setTimeout(() => {
                            dom.playerBar.playPauseBtn.classList.remove('attention-bounce');
                        }, 2400); // Remove after 3 bounces (0.8s * 3)
                    } else {
                        // Fallback if song is not found in filtered list
                        loadCustomCategory('all');
                        showMessage("Không tìm thấy bài hát được chia sẻ. Vui lòng chọn bài khác.", "Lỗi");
                    }
                } else {
                    // Nếu không tìm thấy bài hát, tải danh mục mặc định
                    loadCustomCategory('all');
                    showMessage("Không tìm thấy bài hát được chia sẻ. Vui lòng chọn bài khác.", "Lỗi");
                }
            } else {
                // Nếu không có ID bài hát trong URL, khôi phục trạng thái phát lại trước đó
                const savedPlaybackState = loadStateFromLocalStorage(CONFIG.STORAGE_KEYS.PLAYBACK_STATE, null);
                if (savedPlaybackState) {
                    dom.mainContent.searchInput.value = savedPlaybackState.currentSearchQuery || '';
                    loadCustomCategory(savedPlaybackState.currentCategory || 'all');
                    const songIndex = state.currentFilteredSongs.findIndex(s => s.id === savedPlaybackState.songId); // Check in filtered songs
                    if (songIndex !== -1) {
                        state.currentSongIndex = songIndex;
                        updateUI(); 
                        dom.audioPlayer.currentTime = savedPlaybackState.currentTime || 0;
                        showMessage("Đã khôi phục phiên nghe nhạc trước đó. Nhấn nút Play để tiếp tục.", "Chào mừng trở lại!", true, 2500); // 2.5 seconds duration
                    } else {
                        loadCustomCategory('all'); // Fallback nếu bài hát đã lưu không còn tồn tại
                    }
                } else {
                    loadCustomCategory('all'); // Tải danh mục tất cả nếu không có trạng thái lưu
                }
            }

            // 7. Final UI updates and splash screen
            updateUI();
            dom.splashScreen.classList.add('visible');
            setTimeout(() => dom.splashScreen.classList.remove('visible'), 2000);
            
            requestNotificationPermission();

            // Cập nhật hiển thị nút cuộn sau khi tải trang và khi thay đổi kích thước cửa sổ
            toggleScrollNavVisibility();
            window.addEventListener('resize', throttle(toggleScrollNavVisibility, 200));
        };

        initializeApp();
    });
    </script>
</body>
</html>
