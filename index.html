<!DOCTYPE html>
<html lang="vi" data-theme="lucbao">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1b2d" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="MSTQ Music" />
  <title>MSTQ Music ‚Äì Nghe nh·∫°c li√™n t·ª•c</title>

  <!-- PWA Link -->
  <link id="manifest-link" rel="manifest" href="/PlayMusic/manifest.webmanifest">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <style>
    :root,[data-theme]{transition:color .25s ease,background-color .25s ease}
    :root{
      --bg:#0b132b;--card:#0f1b2d;--text:#eaf2ff;--muted:#93a3b8;
      --primary:#f59e0b;--primary-fg:#0b132b;--ring:#f59e0b66;
      --border:#203047;--nav-bg:rgba(16,24,40,.88);--shadow:0 12px 36px rgba(0,0,0,.28);
      --gradient:linear-gradient(135deg,#60a5fa 0%,#f59e0b 100%);
      --active-bg: rgba(245, 158, 11, 0.12);
    }
    [data-theme=light]{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#0ea5e9;--primary-fg:#ffffff;--ring:#0ea5e955;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.92);--active-bg: rgba(14, 165, 233, 0.08);}
    [data-theme=lucbao]{--bg:#081414;--card:#102424;--text:#e0f2f1;--muted:#80cbc4;--primary:#f4ff81;--primary-fg:#0c1113;--ring:#f4ff8166;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(16,36,36,.86);--active-bg: rgba(244, 255, 129, 0.1);}
    
    .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--card);color:var(--text);padding:.6rem .9rem;border-radius:14px;transition:background-color .15s,transform .1s}
    .btn:active{transform:scale(0.98);opacity:.8} 
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-primary{background:var(--primary);color:var(--primary-fg);border-color:transparent}
    .chip{font-size:.72rem;border:1px solid var(--border);padding:.15rem .45rem;border-radius:999px;color:var(--muted)}
    
    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:40;backdrop-filter:blur(8px);background:var(--nav-bg);border-top:1px solid var(--border)}
    .tabbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:.55rem 0;font-size:.74rem;color:var(--muted);transition:color .2s}
    .tabbtn[aria-current=true]{color:var(--text)}
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 10px)}
    
    /* Range Slider */
    input[type="range"]{-webkit-appearance:none;appearance:none;height:6px;width:100%;background:var(--muted);border-radius:999px}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;border-radius:50%;background:var(--primary);cursor:pointer}
    input[type="range"]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--primary);cursor:pointer}
    
    /* Dropdown */
    .dropdown{position:relative; display: inline-block;}
    .dropdown-menu{
        position:absolute; right:0; top:100%; margin-top:.5rem; 
        background:var(--card); border:1px solid var(--border); 
        border-radius:14px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); 
        min-width:220px; z-index:100; padding:.5rem; 
        animation:fadeIn .15s ease-out; transform-origin: top right;
    }
    .dropdown-item{display:flex;align-items:center;gap:.6rem;padding:.75rem .8rem;border-radius:10px;transition:background-color .1s; font-weight: 500; font-size: 0.95rem; color: var(--text); text-decoration: none;}
    .dropdown-item:active{background-color:var(--primary); color: var(--primary-fg);}
    
    /* Animation */
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    @keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* === COMPACT SONG ROW STYLES (NEW) === */
    .song-row {
        display: flex; align-items: center;
        padding: 0 12px;
        height: 58px; /* Fixed compact height */
        border-bottom: 1px solid var(--border);
        transition: background-color 0.2s;
        cursor: pointer;
    }
    .song-row:active { background-color: var(--border); }
    .song-row.active { background-color: var(--active-bg); }
    .song-row.active .song-idx { color: var(--primary); font-weight: bold; animation: pulse 2s infinite; }
    
    .icon-btn-mini {
        width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
        color: var(--muted);
    }
    .icon-btn-mini:active { background-color: var(--border); transform: scale(0.9); }

    /* === TET TOAST STYLE === */
    .toast-container {
        position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
        z-index: 2000; pointer-events: none;
        width: 90%; max-width: 380px;
        text-align: center;
    }
    .toast-tet {
        background: linear-gradient(135deg, #d32f2f, #b71c1c); /* ƒê·ªè T·∫øt */
        color: #ffff00; /* Ch·ªØ V√†ng */
        border: 2px solid #ffeb3b;
        padding: 14px 20px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(211, 47, 47, 0.6);
        font-weight: 600;
        font-size: 0.95rem;
        animation: toastSlide 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: inline-block;
        pointer-events: auto;
    }
    @keyframes toastSlide { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)] font-sans">
  <div id="root"></div>

  <audio id="mstq-player" preload="metadata" playsinline webkit-playsinline crossOrigin="anonymous"></audio>
  <audio id="mstq-preload" preload="auto" playsinline webkit-playsinline muted crossOrigin="anonymous"></audio>

  <script>
    (function(){
      const show=(m)=>{
        const str = String(m||'');
        if(str.includes('AbortError') || str.includes('NotAllowedError') || str.includes('Interrupted')) return;
        console.error('[GLOBAL ERROR]',m);
      };
      window.addEventListener('error',e=>show(e.error||e.message||e));
      window.addEventListener('unhandledrejection',e=>show(e.reason||e));
    })();
  </script>

  <script type="text/javascript">
    const { useState, useEffect, useRef, useCallback, createElement: e } = React;

    /* ===== Keys & utils ===== */
    const SONGS_CACHE_KEY='mstq_songs_v13';
    const RESUME_KEY='mstq_resume_v18'; 
    const THEME_KEY='music-theme', SPEED_KEY='mstq_speed', MUTED_KEY='mstq_muted';
    const SHUFFLE_KEY='mstq_shuffle', REPEAT_KEY='mstq_repeat';
    const POWER_KEY='mstq_power_save', TIMER_KEY='mstq_sleep_timer', STOP_END_KEY='mstq_stop_at_end';
    const SRC_PREF_KEY='mstq_sources_pref'; 
    const COMPRESSOR_KEY='mstq_compressor_on';
    const INITIAL_VISIBLE=120, VISIBLE_STEP=160;

    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
    const clamp=(x,min,max)=>Math.min(Math.max(x,min),max);
    const formatTime=s=>{if(!isFinite(s)||s<0)return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${String(sec).padStart(2,'0')}`};
    const sanitizeRepeat=(r)=> (r==='off'||r==='all'||r==='one')?r:'all';
    const haptic=(ms=14)=>{ try{ navigator.vibrate?.(ms); }catch{} };
    
    const Icon = ({d=22,p="M5 12h14"}) => e('svg', {width:d, height:d, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"1.7"},
      e('path', {d:p, strokeLinecap:"round", strokeLinejoin:"round"})
    );

    const ICON_URL = 'https://raw.githubusercontent.com/thiensutinhquang/PlayMusic/main/images/icons/icon-192x192.png';
    const LOGO_FALLBACK_URL = ICON_URL;
    const LOGO_PLACEHOLDER = 'https://placehold.co/24x24/102424/e0f2f1?text=MSTQ';

    const Icons={
      home:(d)=>e(Icon, {d:d, p:"M3 10.5 12 3l9 7.5v8.5a1.5 1.5 0 0 1-1.5 1.5H4.5A1.5 1.5 0 0 1 3 19V10.5Z"}),
      search:(d)=>e(Icon, {d:d, p:"M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"}),
      lib:(d)=>e(Icon, {d:d, p:"M4 19h16M6 17V5a2 2 0 0 1 2-2h0M12 17V3h0M18 17V7a2 2 0 0 0-2-2h0"}),
      queue:(d)=>e(Icon, {d:d, p:"M4 6h16M4 12h10M4 18h7"}),
      settings:(d)=>e(Icon, {d:d, p:"M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7Z M19.4 15l1.1 1.9-1.7 3-2.2-.4-.9 1.9h-3.4l-.9-1.9-2.2.4-1.7-3 1.1-1.9Z"}),
      play:(d)=>e(Icon, {d:d, p:"M8 5v14l11-7z"}), pause:(d)=>e(Icon, {d:d, p:"M6 5h4v14H6zM14 5h4v14h-4z"}),
      next:(d)=>e(Icon, {d:d, p:"M13 5 20 12l-7 7V5z M4 5h2v14H4z"}),
      back:(d)=>e(Icon, {d:d, p:"M11 19 4 12l7-7v14z M18 5h2v14h-2z"}),
      more:(d)=>e(Icon, {d:d, p:"M6 12h.01M12 12h.01M18 12h.01"}),
      repeat:(d)=>e(Icon, {d:d, p:"M17 1v4H7a5 5 0 0 0 0 10h1M7 23v-4h10a5 5 0 0 0 0-10h-1"}),
      shuffle:(d)=>e(Icon, {d:d, p:"M4 4l7 7-7 7M15 4h5M20 4l-6 6M15 20h5M20 20l-6-6"}),
      download:(d)=>e(Icon, {d:d, p:"M12 3v12m0 0l4-4m-4 4-4-4M5 21h14"}),
      share:(d)=>e('svg', {width:d, height:d, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round"},
        e('circle', {cx:"18", cy:"5", r:"3"}),
        e('circle', {cx:"6", cy:"12", r:"3"}),
        e('circle', {cx:"18", cy:"19", r:"3"}),
        e('line', {x1:"8.59", y1:"13.51", x2:"15.42", y2:"17.49"}),
        e('line', {x1:"15.41", y1:"6.51", x2:"8.59", y2:"10.49"})
      ),
      heart:(d, fill)=>e('svg', {width:d, height:d, viewBox:"0 0 0 24 24", fill:fill?'currentColor':'none', stroke:"currentColor", strokeWidth:"1.7"},
        e('path', {d:"M20.8 5.2a5.5 5.5 0 0 0-7.8 0L12 6.2l-.9-1a5.5 5.5 0 0 0-7.8 0 5.5 5.5 0 0 0 0 7.8L12 21l8.7-8a5.5 5.5 0 0 0 0-7.8Z", strokeLinecap:"round", strokeLinejoin:"round", fill:fill?'var(--primary)': 'none'})
      )
    };

    const TopBar = ({ title, askInstall, linksOpen, setLinksOpen, setTheme }) => {
        const SimpleLinkDropdown = e('div', {className: "dropdown", onClick: (e) => e.stopPropagation()}, 
            e('button', {className: "btn", onClick: ()=>{haptic();setLinksOpen(o=>!o)}}, "Li√™n k·∫øt ‚ñæ"),
            linksOpen && e('div', {className: "dropdown-menu"}, 
                e('a', {className: "dropdown-item", href: "https://thiensutinhquang.github.io/home/", target: "_blank", rel: "noopener"}, "üè† Trang ch·ªß"),
                e('a', {className: "dropdown-item", href: "https://thiensutinhquang.github.io/PlayMusic/", target: "_blank", rel: "noopener"}, "üéµ Play Nh·∫°c"),
                e('hr', {className: "my-1 border-[var(--border)]"}),
                e('div', {className: "px-2 py-1 text-[var(--muted)] text-xs font-semibold"}, "N·ªÅn t·∫£ng"),
                e('a', {className: "dropdown-item", href: "https://www.youtube.com/@ThiensuTinhQuang", target: "_blank", rel: "noopener"}, "‚ñ∂Ô∏è YouTube"),
                e('a', {className: "dropdown-item", href: "https://www.tiktok.com/@minhsutinhquang", target: "_blank", rel: "noopener"}, "üé∂ TikTok"),
                e('a', {className: "dropdown-item", href: "https://www.facebook.com/groups/minhsutinhquang", target: "_blank", rel: "noopener"}, "üë• Facebook Group"),
                e('a', {className: "dropdown-item", href: "https://t.me/Giaoly_phap_don_ngo", target: "_blank", rel: "noopener"}, "üí¨ Telegram"),
                e('a', {className: "dropdown-item", href: "https://zalo.me/g/dukrae245", target: "_blank", rel: "noopener"}, "üì± Zalo")
            )
        );
        
        const LogoElement = e('img', {
            src: LOGO_FALLBACK_URL, 
            width: "24", height: "24", 
            className: "rounded-md", 
            alt: "MSTQ logo",
            onError: (e) => { e.target.src = LOGO_PLACEHOLDER; e.target.onError = null; }
        });

        return e('header', {className: "fixed top-0 inset-x-0 z-30 px-4 py-3 flex items-center justify-between bg-[var(--nav-bg)] backdrop-blur-lg border-b border-[var(--border)]"},
          e('div', {className: "flex items-center gap-2"},
            LogoElement, 
            e('h1', {className: "font-semibold"}, title)
          ),
          e('div', {className: "flex items-center gap-2"},
            e('button', {className: "btn", onClick: askInstall}, "C√†i ƒë·∫∑t ·ª©ng d·ª•ng"),
            SimpleLinkDropdown, 
            e('button', {className: "btn", onClick: ()=>{haptic();setTheme(t=>t==='lucbao'?'light':'lucbao')}}, "Ch·ªß ƒë·ªÅ")
          )
        );
    };

    function App(){
      const [tab,setTab]=useState('home');
      const [theme,setTheme]=useState(localStorage.getItem(THEME_KEY)||'lucbao');
      useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);localStorage.setItem(THEME_KEY,theme);},[theme]);

      const [needsStart,setNeedsStart]=useState(true);
      const autoStartRef=useRef(null);
      const startTimerRef=useRef(null);

      const installEvtRef=useRef(null);
      const [linksOpen,setLinksOpen]=useState(false);
      const linkRef = useRef(null);
      const [toast, setToast] = useState(null); // Tr·∫°ng th√°i th√¥ng b√°o

      // X√≥a th√¥ng b√°o sau 3 gi√¢y
      useEffect(() => {
          if (toast) {
              const timer = setTimeout(() => setToast(null), 3500);
              return () => clearTimeout(timer);
          }
      }, [toast]);
      
      const askInstall = async () => { 
        haptic(); 
        try { await audioCtxRef.current?.resume?.(); } catch {} 
        
        // PWA V29
        if (window.pwaEngine) {
            window.pwaEngine.handleInstallClick();
        } else {
            alert("Vui l√≤ng m·ªü menu tr√¨nh duy·ªát ch·ªçn 'Th√™m v√†o m√†n h√¨nh ch√≠nh' (Add to Home Screen).");
        }
      };

      const [playlist,setPlaylist]=useState([]);
      const [loading,setLoading]=useState(true);
      const [visible,setVisible]=useState(INITIAL_VISIBLE);
      const [filter,setFilter]=useState('');
      const [sourcePref,setSourcePref]=useState(load(SRC_PREF_KEY,{archive:true,custom:false,customText:""}));
      useEffect(()=>save(SRC_PREF_KEY,sourcePref),[sourcePref]);

      const [currentIndex,setCurrentIndex]=useState(0);
      const [playing,setPlaying]=useState(false);
      const [progress,setProgress]=useState({current:0,duration:0});
      const [shuffle,setShuffle]=useState(load(SHUFFLE_KEY,false));
      const [repeat,setRepeat]=useState(sanitizeRepeat(load(REPEAT_KEY,'all')));
      const [stopAtEnd,setStopAtEnd]=useState(load(STOP_END_KEY,false));
      useEffect(()=>save(SHUFFLE_KEY,shuffle),[shuffle]);
      useEffect(()=>save(REPEAT_KEY,repeat),[repeat]);
      useEffect(()=>save(STOP_END_KEY,stopAtEnd),[stopAtEnd]);

      const [upNext,setUpNext]=useState([]);
      const enqueueNext=(s)=>{ haptic(); setUpNext(q=> q.includes(s.id)? q : [...q,s.id]); };
      const moveUp=(id)=>{ haptic(); setUpNext(q=>{ const i=q.indexOf(id); if(i<=0) return q; const a=q.slice(); [a[i-1],a[i]]=[a[i],a[i-1]]; return a; }); };
      const moveDown=(id)=>{ haptic(); setUpNext(q=>{ const i=q.indexOf(id); if(i<0||i===q.length-1) return q; const a=q.slice(); [a[i+1],a[i]]=[a[i],a[i+1]]; return a; }); };
      const removeFromQueue=(id)=>{ haptic(); setUpNext(q=>q.filter(x=>x!==id)); };
      const clearQueue=()=>{ haptic(); setUpNext([]); };

      const audioRef=useRef(null), preloadRef=useRef(null);
      useEffect(()=>{ audioRef.current=document.getElementById('mstq-player'); preloadRef.current=document.getElementById('mstq-preload'); },[]);
      const [volume,setVolume]=useState(load(RESUME_KEY,{volume:.9}).volume??.9);
      const [playbackRate,setPlaybackRate]=useState(parseFloat(localStorage.getItem(SPEED_KEY)||'1')||1);
      const [muted,setMuted]=useState(localStorage.getItem(MUTED_KEY)==='1');
      const [compressorOn,setCompressorOn]=useState(load(COMPRESSOR_KEY,true));

      const audioCtxRef=useRef(null), gainRef=useRef(null), compNodeRef=useRef(null), srcNodeRef=useRef(null);
      const ensureAudioContext=async()=>{
        try{
          if(!audioCtxRef.current){
            const ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'playback'});
            const a=audioRef.current;
            const src=ctx.createMediaElementSource(a);
            const gain=ctx.createGain(); gain.gain.value=1;
            const comp=ctx.createDynamicsCompressor();
            comp.threshold.value=-18; comp.knee.value=24; comp.ratio.value=6; comp.attack.value=0.008; comp.release.value=0.25;
            src.connect(gain);
            // OPTIMIZATION: Only connect compressor if needed to save CPU
            if(compressorOn){ gain.connect(comp).connect(ctx.destination); } else { gain.connect(ctx.destination); }
            audioCtxRef.current=ctx; gainRef.current=gain; compNodeRef.current=comp; srcNodeRef.current=src;

            // SMART RECOVERY: Auto resume if OS suspends context
            ctx.onstatechange = () => {
                 if (ctx.state === 'suspended' && playing) {
                     ctx.resume();
                 }
            };
          }
          if (audioCtxRef.current.state === 'suspended') {
             await audioCtxRef.current.resume();
          }
        }catch{}
      };
      
      // Toggle Compressor Graph
      useEffect(()=>{ try{
        if(audioCtxRef.current && gainRef.current){
          gainRef.current.disconnect();
          const dst=audioCtxRef.current.destination;
          if(compressorOn){ gainRef.current.connect(compNodeRef.current).connect(dst); }
          else { gainRef.current.connect(dst); }
        }}catch{} },[compressorOn]);

      const fadeTo=async(target=1,ms=800)=>{
        try{
          if(!audioCtxRef.current || !gainRef.current) return;
          const g=gainRef.current;
          const now=audioCtxRef.current.currentTime;
          g.gain.cancelScheduledValues(now);
          g.gain.setValueAtTime(g.gain.value, now);
          g.gain.linearRampToValueAtTime(target, now + ms/1000);
        }catch{}
      };

      useEffect(()=>{const a=audioRef.current;if(a){a.volume=volume}},[volume]);
      useEffect(()=>{const a=audioRef.current;if(a){a.playbackRate=playbackRate}localStorage.setItem(SPEED_KEY,String(playbackRate))},[playbackRate]);
      useEffect(()=>{const a=audioRef.current;if(a){a.muted=muted}localStorage.setItem(MUTED_KEY,muted?'1':'0')},[muted]);

      const [powerSave,setPowerSave]=useState(load(POWER_KEY,false));
      useEffect(()=>save(POWER_KEY,powerSave),[powerSave]);
      const [timerLeft,setTimerLeft]=useState(load(TIMER_KEY,null));
      const timerRef=useRef(null);
      const startSleepTimer=(ms)=>{
        haptic();
        clearInterval(timerRef.current);
        const end=Date.now()+ms; setTimerLeft(ms); save(TIMER_KEY,ms);
        timerRef.current=setInterval(()=>{ const left=end-Date.now(); if(left<=0){ clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null); pauseAll(); } else setTimerLeft(left); },1000);
      };
      const cancelSleepTimer=()=>{ haptic(); clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null);};
      useEffect(()=>{ const v=load(TIMER_KEY,null); if(v&&v>0) startSleepTimer(v); return()=>clearInterval(timerRef.current); },[]);

      const FALLBACK_SONGS=[{id:"testmp3testfile/mpthreetest.mp3",title:"B√†i h√°t m·∫´u (T·∫°m th·ªùi)",artist:"Public Domain",stream_url:"https://archive.org/download/testmp3testfile/mpthreetest.mp3",artwork:ICON_URL,duration:5,lyrics:"B√†i m·∫´u.",item_identifier:"testmp3testfile"}];

      const parseCustom=(txt)=>{
        const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const out=[]; let last="";
        for(const ln of lines){
          if(ln.startsWith('#EXTINF:')){ last=ln.split(',').slice(1).join(',').trim(); }
          else if(/^https?:\/\//i.test(ln)){
            out.push({id:ln,title:last||ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:ICON_URL,duration:0,lyrics:'',item_identifier:'custom'}); last="";
          }
        }
        if(!out.length){
          for(const ln of lines) if(/^https?:\/\//i.test(ln))
            out.push({id:ln,title:ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:ICON_URL,duration:0,lyrics:'',item_identifier:'custom'});
        }
        return out;
      };

      /* === RESTORED REFETCH LOGIC === */
      const refetch=useCallback(async()=>{
        setLoading(true);
        try{
          let all=[];
          if(sourcePref.archive!==false){
            const queries=[
              'uploader:(tinhquang) AND mediatype:(audio)',
              'uploader:(thiensutinhquang) AND mediatype:(audio)',
              'creator:("Minh Su Tinh Quang") AND mediatype:(audio)'
            ];
            let docs=[];let ok=false;
            for(const q of queries){
              const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=publicdate+desc&rows=200&page=1&output=json`;
              const r=await fetch(url,{cache:'no-store'}); if(!r.ok) continue;
              const j=await r.json(); const list=j?.response?.docs||[]; if(list.length){docs=list;ok=true;break;}
            }
            if(ok){
              for(const d of docs){
                try{
                  const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                  (meta.files||[]).forEach(f=>{
                    if(String(f.format||'').toUpperCase().includes('MP3')){
                      all.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'TinhQuang',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                    }
                  });
                }catch{}
              }
            }
          }
          if(sourcePref.custom && sourcePref.customText?.trim()){
            all=[...all, ...parseCustom(sourcePref.customText)];
          }
          if(!all.length){ all=FALLBACK_SONGS; }
          setPlaylist(all);
          save(SONGS_CACHE_KEY,all);
        }catch{
          const cached=load(SONGS_CACHE_KEY,null);
          setPlaylist(cached?.length?cached:FALLBACK_SONGS);
        }
        setLoading(false);
      },[sourcePref]);
      useEffect(()=>{refetch()},[]);

      const current=playlist[currentIndex]||null;

      const queuePreload=useCallback((idx)=>{
        const n=(idx+1)%playlist.length;
        const next=playlist[n]; const pre=preloadRef.current;
        if(!next||!pre) return;
        if (powerSave || document.visibilityState!=='visible') { pre.removeAttribute('src'); pre.load(); return; }
        if(pre.src!==next.stream_url){ pre.src=next.stream_url; pre.load(); }
      },[playlist,powerSave]);
      useEffect(()=>{ if(playlist.length) queuePreload(currentIndex); },[playlist.length,currentIndex,queuePreload]);
      useEffect(()=>{ const h=()=>queuePreload(currentIndex); document.addEventListener('visibilitychange',h); return()=>document.removeEventListener('visibilitychange',h); },[queuePreload,currentIndex]);

      // *** MEDIA SESSION API - REPLACEMENT FOR WAKELOCK ***
      useEffect(()=>{
        const a=audioRef.current; if(!a||!current||!('mediaSession' in navigator)) return;
        try{
          navigator.mediaSession.metadata=new MediaMetadata({
            title:current.title, artist:current.artist||'minhsutinhquang', album:'MSTQ Music',
            artwork:[{src:current.artwork||ICON_URL,sizes:'512x512',type:'image/png'}]
          });
          
          // Basic controls
          navigator.mediaSession.setActionHandler('play',()=>playPause());
          navigator.mediaSession.setActionHandler('pause',()=>playPause());
          navigator.mediaSession.setActionHandler('previoustrack',()=>prevTrack());
          navigator.mediaSession.setActionHandler('nexttrack',()=>nextTrack());
          
          // Advanced controls for full player emulation
          navigator.mediaSession.setActionHandler('seekto',d=>{ 
             const a=audioRef.current; 
             if(a && d.seekTime!=null && isFinite(d.seekTime)) {
                 a.currentTime=d.seekTime; 
                 updatePositionState(); // Immediately update lock screen
             }
          });
          navigator.mediaSession.setActionHandler('seekbackward', (details) => {
              const skipTime = details.seekOffset || 10;
              const a = audioRef.current;
              if(a) { a.currentTime = Math.max(a.currentTime - skipTime, 0); updatePositionState(); }
          });
          navigator.mediaSession.setActionHandler('seekforward', (details) => {
              const skipTime = details.seekOffset || 10;
              const a = audioRef.current;
              if(a) { a.currentTime = Math.min(a.currentTime + skipTime, a.duration); updatePositionState(); }
          });

          // Sync Playback State
          navigator.mediaSession.playbackState=playing?'playing':'paused';
        }catch(e){ console.warn("MediaSession update failed", e); }
      },[current,playing]);

      // Helper to keep Lock Screen progress bar smooth
      const updatePositionState = () => {
          if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession) {
              const a = audioRef.current;
              if (a && !isNaN(a.duration) && !isNaN(a.currentTime)) {
                  navigator.mediaSession.setPositionState({
                      duration: a.duration,
                      playbackRate: a.playbackRate,
                      position: a.currentTime
                  });
              }
          }
      };

      const computeNextIndex = useCallback((dir)=> {
        if(!playlist.length) return 0;
        if(shuffle){ let r=Math.floor(Math.random()*playlist.length); if (r===currentIndex && playlist.length>1) r=(r+1)%playlist.length; return r; }
        if(dir>0) return (currentIndex+1)%playlist.length;
        if(dir<0) return (currentIndex-1+playlist.length)%playlist.length;
        return currentIndex;
      },[playlist.length,shuffle,currentIndex]);

      const playIndex=useCallback(async(i,{fadeIn=true}={})=>{
        const a=audioRef.current; if(!a) return;
        await ensureAudioContext();
        a.loop=false; a.muted=false; if(a.volume<0.6) a.volume=0.85;
        setCurrentIndex(i); setPlaying(true); 
        const s=playlist[i]; if(!s) return;
        
        if(a.src===s.stream_url && a.currentTime>0){
          a.play().catch(e => console.warn("Resume failed", e));
        }else{
          if(gainRef.current) {
             try {
               gainRef.current.gain.cancelScheduledValues(audioCtxRef.current.currentTime);
               gainRef.current.gain.value = 0; 
             } catch(e) {}
          }
          a.src=s.stream_url; 
          a.load(); 
          try {
             await a.play();
             if(gainRef.current) {
               const now = audioCtxRef.current.currentTime;
               gainRef.current.gain.setValueAtTime(0, now);
               gainRef.current.gain.linearRampToValueAtTime(1, now + 0.5); 
             }
          } catch(e) {
             console.warn("Autoplay blocked/interrupted (Harmless in BG):", e);
          }
        }
        queuePreload(i);
      },[playlist,queuePreload]);

      const handleEnd=useCallback(()=>{
        const a=audioRef.current; if(a) a.loop=false;
        if(repeat==='one'){ const a=audioRef.current; if(a){ a.currentTime=0; a.loop=false; a.play().catch(()=>{});} return; }
        const nextIdx = computeNextIndex(+1);
        if((stopAtEnd || repeat==='off') && !upNext.length && nextIdx === 0 && currentIndex === playlist.length-1){ 
          setPlaying(false); 
          return; 
        }
        nextTrack();
      },[repeat,stopAtEnd,currentIndex,playlist.length,upNext.length]); 

      const nextTrack=useCallback(()=>{
        haptic();
        if(!playlist.length) return;
        if(upNext.length){
          const nextId=upNext[0]; setUpNext(q=>q.slice(1));
          const i=playlist.findIndex(x=>x.id===nextId);
          if(i>=0){ playIndex(i).catch(()=>{}); return; }
        }
        let i=computeNextIndex(+1);
        if(playlist.length>1 && i===currentIndex && !shuffle){ i=(i+1)%playlist.length; }
        playIndex(i).catch(()=>{}); 
      },[playlist.length,computeNextIndex,upNext,currentIndex,shuffle,playIndex]);

      const prevTrack=useCallback(()=>{
        haptic();
        if(!playlist.length) return;
        const a=audioRef.current; if(a?.currentTime>3){ a.currentTime=0; return; }
        const i=computeNextIndex(-1);
        playIndex(i).catch(()=>{}); 
      },[playlist.length,computeNextIndex,playIndex]);
      
      const pickSong=async(s)=>{ haptic(); const i=playlist.findIndex(x=>x.id===s.id); if(i>=0) playIndex(i).catch(()=>{}); };

      const playPause=async()=>{
        haptic();
        const a=audioRef.current; if(!a) return;
        await ensureAudioContext();
        a.loop=false; a.muted=false; if(a.volume<0.6) a.volume=0.85;
        if(!current && playlist.length){ playIndex(0,{fadeIn:false}).catch(()=>{}); setNeedsStart(false); return; }
        if(playing){ 
          setPlaying(false); 
          try{await fadeTo(0.01,150)}catch{} a.pause(); 
        }
        else{ 
          setPlaying(true); setNeedsStart(false); 
          try{ await fadeTo(1,200); }catch{} a.play().catch(()=>{}); 
        }
      };
      
      const targetPlayingRef=useRef(false);
      const lastProgRef=useRef({t:0,pos:0});
      const stallScoreRef=useRef(0);
      const lastManualPauseRef=useRef(0);
      const lastRecoverRef=useRef(0);

      // --- DELETED WAKELOCK ---
      // We no longer request wake lock. OS handles audio backgrounding via 'audio' tag + MediaSession.

      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const onTime=()=>{ 
          if(!isFinite(a.duration)) return;
          setProgress({current:a.currentTime||0,duration:a.duration||0});
          const now=Date.now();
          if(Math.abs(a.currentTime-(lastProgRef.current.pos||0))>0.25){ lastProgRef.current={t:now,pos:a.currentTime}; stallScoreRef.current=0; }
          if(a.duration>1 && !a.paused && !a.loop && (a.currentTime>=a.duration-0.8)){ handleEnd(); }
          
          // Throttled position update for lock screen (saving CPU)
          if (now % 20 === 0) updatePositionState(); 
        };
        const onEnded=()=>{ handleEnd(); };
        const onPause=()=>{ 
             if(!targetPlayingRef.current){ lastManualPauseRef.current=Date.now(); }
             // IO OPTIMIZATION: Save state on pause (better than interval)
             if(current) save(RESUME_KEY,{index:currentIndex,id:current.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:false});
        };
        a.addEventListener('timeupdate',onTime);
        a.addEventListener('ended',onEnded);
        a.addEventListener('pause',onPause);
        ['stalled','suspend','waiting','error','abort'].forEach(e=>a.addEventListener(e,()=>{}));
        return()=>{a.removeEventListener('timeupdate',onTime);a.removeEventListener('ended',onEnded);a.removeEventListener('pause',onPause);['stalled','suspend','waiting','error','abort'].forEach(e=>a.removeEventListener(e,()=>{}));};
      },[handleEnd]); 

      // --- IO & WATCHDOG OPTIMIZATION ---
      useEffect(()=>{
        // Increased interval: 6s -> 15s to reduce wakeups
        const interval = powerSave ? 20000 : 15000;
        const tick=setInterval(async()=>{
          const a=audioRef.current; if(!a||!current) return;
          
          // Only save to disk if playing to minimize IO
          if (targetPlayingRef.current) {
              save(RESUME_KEY,{index:currentIndex,id:current.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});
          }

          if(!targetPlayingRef.current) return;
          if(Date.now()-lastManualPauseRef.current<2000) return; 

          const visibilityCheckTime = document.visibilityState==='visible'?20000:30000; // Allow longer gaps in background
          const stagnate = (Date.now()-(lastProgRef.current.t||0) > visibilityCheckTime);
          const poorReady = a.readyState<2;
          const now=Date.now();
          const canRecover = now - (lastRecoverRef.current||0) > (powerSave?4000:3000);

          if(a.paused && canRecover){
            try{ await ensureAudioContext(); a.play().catch(()=>{}); return; }catch{}
          }
          if((stagnate || poorReady) && canRecover){
            stallScoreRef.current++;
            try{
              await ensureAudioContext();
              if(a.paused) await a.play().catch(()=>{});
              if(poorReady){ a.load(); await a.play().catch(()=>{}); }
            }catch{ /* ignored */ }

            const limit=(document.visibilityState==='visible'?(powerSave?5:3):(powerSave?4:3));
            if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(); }
          }
        },interval);
        return()=>clearInterval(tick);
      },[currentIndex,current,powerSave,nextTrack]);

      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const r=load(RESUME_KEY,null);
        if(r&&playlist.length){
          const idx=Math.min(Math.max(0,r.index||0),playlist.length-1);
          setCurrentIndex(idx);
          setTimeout(()=>{ const s=playlist[idx]; if(!s) return;
            if(a.src!==s.stream_url){ a.src=s.stream_url; a.load(); }
            a.currentTime=Number(r.currentTime||0); a.volume=r.volume??volume; a.playbackRate=r.rate??playbackRate; a.muted=false; a.loop=false;
            if(r.playing){ setPlaying(true); targetPlayingRef.current=true; }
          },0);
        }
      },[playlist.length]);

      const [sheetFor,setSheetFor]=useState(null);
      const closeSheet=()=>setSheetFor(null);

      async function shareTrack(s){
        haptic();
        try{
          if(navigator.share){
            await navigator.share({title:s.title, text:`Nghe: ${s.title} ‚Äì ${s.artist||''}`, url:s.stream_url});
          }else{
            await navigator.clipboard.writeText(s.stream_url);
            // Just toast
            const tempMsg = document.createElement('div');
            tempMsg.className = 'fixed bottom-[110px] left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-[1000] opacity-0 transition-opacity duration-300';
            tempMsg.textContent = 'ƒê√£ sao ch√©p link ph√°t v√†o b·ªô nh·ªõ t·∫°m.';
            document.body.appendChild(tempMsg);
            setTimeout(() => { tempMsg.style.opacity = 1; }, 10);
            setTimeout(() => { tempMsg.style.opacity = 0; tempMsg.addEventListener('transitionend', () => tempMsg.remove()); }, 2000);
          }
        }catch{}
      }

      /* === UPDATED DOWNLOAD TRACK FUNCTION === */
      async function downloadTrack(s) {
        haptic();
        
        // 1. Th√¥ng b√°o ngay l·∫≠p t·ª©c
        setToast(`üßß ƒêang chu·∫©n b·ªã t·∫£i: "${s.title}"...`);

        try {
            if(!s.stream_url) throw new Error("No URL");

            const response = await fetch(s.stream_url);
            if (!response.ok) throw new Error('Network error');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            // X·ª≠ l√Ω t√™n file: Gi·ªØ nguy√™n Ti·∫øng Vi·ªát, ch·ªâ b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát c·ªßa h·ªá th·ªëng file
            a.download = `${s.title.replace(/[\/\\:*?"<>|]/g, '')}.mp3`;
            document.body.appendChild(a);
            a.click();

            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            setToast('‚úÖ ƒê√£ t·∫£i xong! Ch√∫c b·∫°n nghe nh·∫°c vui v·∫ª.');
        } catch (e) {
            console.error(e);
            // Fallback: M·ªü link tr·ª±c ti·∫øp
            setToast('‚ö†Ô∏è ƒêang chuy·ªÉn h∆∞·ªõng ƒë·ªÉ t·∫£i...');
            setTimeout(() => {
                const a = document.createElement('a');
                a.href = s.stream_url;
                a.download = '';
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }, 800);
        }
      }

      const HomeTab=()=>{
        const list = filter.trim()
          ? playlist.filter(s => (s.title||'').toLowerCase().includes(filter.toLowerCase()) || (s.artist||'').toLowerCase().includes(filter.toLowerCase()))
          : playlist;

        /* --- FIXED AUTO SCROLL (SMART FOCUS) --- */
        const lastAutoScrollId = useRef(null);
        
        useEffect(() => {
            if(current?.id && (lastAutoScrollId.current !== current.id || tab === 'home')) {
                const el = document.getElementById(`song-${current.id}`);
                if(el) {
                   setTimeout(() => {
                       el.scrollIntoView({behavior: 'smooth', block: 'center'});
                       lastAutoScrollId.current = current.id;
                   }, 300);
                }
            }
        }, [current?.id, tab]);

        const SongItem = (s, index) => {
            const isCurrent = current?.id === s.id;
            return e('div', {
                key: s.id, 
                id: `song-${s.id}`,
                className: `song-row ${isCurrent ? 'active' : ''}`,
                onClick: () => pickSong(s) 
            },
              /* 1. STT (Play Icon if active) */
              e('div', {className: `w-8 text-center flex-shrink-0 text-xs font-mono mr-2 ${isCurrent ? 'song-idx' : 'text-[var(--muted)]'}`},
                  isCurrent ? "‚ñ∂" : (index + 1)
              ),
              
              /* 2. Title & Artist (Flex 1 - Grows) */
              e('div', {className: "flex-1 min-w-0 flex flex-col justify-center pr-2"}, 
                e('div', {className: `truncate text-[0.92rem] ${isCurrent ? 'text-[var(--primary)] font-semibold' : 'text-[var(--text)]'}`}, s.title||'Untitled'),
                e('div', {className: "truncate text-xs text-[var(--muted)] opacity-80 mt-0.5"}, s.artist||'minhsutinhquang')
              ),
              
              /* 3. Right Action Group */
              e('div', {className: "flex items-center gap-1 flex-shrink-0"},
                  /* Share Button (Blue) */
                  e('button', {
                    className: "icon-btn-mini", style: { color: isCurrent ? 'var(--primary)' : '#818cf8' },
                    onClick: (e)=>{ e.stopPropagation(); shareTrack(s); }
                  }, e(Icons.share, {d:17})),
                  
                  /* Time Divider */
                  e('div', {className: "flex flex-col items-center justify-center px-2 mx-1 border-l border-r border-[var(--border)] h-8"},
                    e('span', {className: "text-[10px] font-mono text-[var(--muted)]"}, formatTime(s.duration||0))
                  ),
                  
                  /* Download Button (Red) */
                  e('button', {
                    className: "icon-btn-mini", style: { color: '#ef4444' },
                    onClick: (e)=>{ e.stopPropagation(); downloadTrack(s); }
                  }, e(Icons.download, {d:17}))
              )
            );
        };

        return e('div', {className: "px-0 pb-24 pt-14"},
          e('div', {className: "px-3 py-2 flex items-center gap-2 sticky top-14 z-20 bg-[var(--bg)]/95 backdrop-blur-md border-b border-[var(--border)]"},
            e('input', {className: "flex-1 bg-[var(--card)] text-sm border border-[var(--border)] rounded-full py-2 px-4 focus:ring-1 focus:ring-[var(--primary)] focus:outline-none", placeholder: "T√¨m nhanh...", value: filter, onChange: e=>setFilter(e.target.value)}),
            filter && e('button', {className: "text-xs px-3 py-1.5 bg-[var(--card)] border border-[var(--border)] rounded-full", onClick: ()=>{haptic();setFilter('');setVisible(INITIAL_VISIBLE)}}, "Xo√°")
          ),
          loading?(
            e('div', {className: "animate-pulse space-y-3 p-4"}, Array.from({length:6}).map((_,i)=>e('div', {key:i, className: "h-12 rounded bg-[var(--card)]/40"})))
          ):(
            e(React.Fragment, null,
              e('div', {className: "space-y-0"}, list.slice(0,visible).map((s, index) => SongItem(s, index))), 
              list.length>visible && e('button', {onClick: ()=>{haptic();setVisible(v=>Math.min(list.length,v+VISIBLE_STEP))}, className: "btn w-full mt-3"}, "T·∫£i th√™m")
            )
          ),
          sheetFor && e('div', {className: "sheet safe-bottom"}, /* ... */ )
        );
      };

      const SearchTab=()=>{
        const [kw,setKw]=useState(''); const [busy,setBusy]=useState(false);
        const runQuery=async(q,sort='downloads+desc')=>{
          haptic();
          setBusy(true);
          try{
            const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=${encodeURIComponent(sort)}&rows=120&page=1&output=json`;
            const r=await fetch(url,{cache:'no-store'}); const j=await r.json();
            const docs=j?.response?.docs||[]; const out=[];
            for(const d of docs){
              try{
                const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                (meta.files||[]).forEach(f=>{
                  if(String(f.format||'').toUpperCase().includes('MP3')){
                    out.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'Archive',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                  }
                });
              }catch{}
            }
            if(out.length){ setPlaylist(out); setVisible(INITIAL_VISIBLE); setTab('home'); setFilter(''); }
          }catch{} setBusy(false);
        };
        const quick=[{label:'M·ªõi nh·∫•t',q:'mediatype:(audio)',sort:'publicdate+desc'},{label:'Ph·ªï bi·∫øn',q:'mediatype:(audio)',sort:'downloads+desc'},{label:'Ph√°p tho·∫°i',q:'"Minh Su Tinh Quang" mediatype:(audio)',sort:'downloads+desc'}];
        return e('div', {className: "px-4 py-3 pt-16"},
          e('div', {className: "flex gap-2"},
            e('input', {className: "flex-1 bg-[var(--card)] border border-[var(--border)] rounded-xl p-2 focus:ring-2 focus:ring-[var(--primary)] focus:outline-none", placeholder: "T√¨m tr√™n Archive.org...", value: kw, onChange: e=>setKw(e.target.value)}),
            e('button', {className: "btn btn-primary", onClick: ()=>runQuery(`${kw} AND mediatype:(audio)`), disabled:!kw||busy}, busy?'ƒêang t√¨m‚Ä¶':'T√¨m')
          ),
          e('div', {className: "flex gap-2 mt-3 flex-wrap"},
            quick.map(x=>e('button', {key:x.label, className: "btn", onClick: ()=>runQuery(x.q,x.sort)}, x.label))
          )
        );
      };

      const LibraryTab=()=>{
        const [custom,setCustom]=useState(sourcePref.customText||'');
        return e('div', {className: "px-4 py-3 space-y-6 pt-16"},
          e('div', null,
            e('h2', {className: "text-lg font-semibold mb-2"}, "Th∆∞ vi·ªán (Ngu·ªìn nh·∫°c)"),
            e('p', {className: "text-[var(--muted)] text-sm"}, "M·ª•c n√†y ch·ª©a c√°c c√†i ƒë·∫∑t n√¢ng cao v·ªÅ ngu·ªìn nh·∫°c."),
            ),
          e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
            e('h3', {className: "font-semibold mb-2"}, "Ngu·ªìn tu·ª≥ ch·ªânh (M3U/URL)"),
            e('label', {className: "flex items-center gap-2 mb-2"}, e('input', {type:"checkbox", checked:!!sourcePref.custom, onChange:e=>{haptic();setSourcePref(p=>({...p,custom:e.target.checked}))}}), " B·∫≠t"),
            e('textarea', {className: "w-full bg-[var(--card)] border border-[var(--border)] rounded-xl p-2 min-h-[120px] focus:ring-2 focus:ring-[var(--primary)] focus:outline-none", placeholder: "https://.../song1.mp3\nhttps://.../song2.mp3", value:custom, onChange:e=>setCustom(e.target.value)}),
            e('div', {className: "mt-2 flex gap-2"},
              e('button', {className: "btn btn-primary", onClick:()=>{haptic();setSourcePref(p=>({...p,customText:custom,custom:true})); refetch();}}, "T·∫£i v√†o danh s√°ch"),
              e('button', {className: "btn", onClick:()=>{haptic();setCustom(''); setSourcePref(p=>({...p,customText:''}));}}, "Xo√° n·ªôi dung")
            )
          )
        );
      };

      const QueueTab=()=>{ const items=upNext.map(id=>playlist.find(s=>s.id===id)).filter(Boolean);
        return e('div', {className: "px-4 py-3 pt-16"},
          e('div', {className: "flex items-center justify-between mb-2"},
            e('h2', {className: "text-lg font-semibold"}, "H√†ng ƒë·ª£i ‚ÄúPh√°t ti·∫øp theo‚Äù"),
            e('div', {className: "flex gap-2"}, e('span', {className: "chip"}, `${items.length} m·ª•c`), items.length>0 && e('button', {className: "btn", onClick:()=>{haptic();clearQueue()}}, "Xo√° h·∫øt"))
          ),
          items.length===0 ? e('p', {className: "text-[var(--muted)] text-sm"}, "Ch∆∞a c√≥ m·ª•c n√†o. B·∫•m ‚ãØ tr√™n b√†i h√°t ƒë·ªÉ th√™m."):
            e('div', {className: "space-y-2"}, items.map(s=>
              e('div', {key:s.id, className: "flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)]"},
                e('img', {src:s.artwork||ICON_URL, alt:"", className: "w-10 h-10 rounded-lg object-cover"}),
                e('div', {className: "flex-grow min-w-0"},
                  e('div', {className: "font-semibold truncate"}, s.title),
                  e('div', {className: "text-xs text-[var(--muted)] truncate"}, s.artist||'minhsutinhquang')
                ),
                e('div', {className: "flex gap-2"},
                  e('button', {className: "btn", onClick:()=>moveUp(s.id)}, "‚Üë"),
                  e('button', {className: "btn", onClick:()=>moveDown(s.id)}, "‚Üì"),
                  e('button', {className: "btn", onClick:()=>removeFromQueue(s.id)}, "‚úï")
                )
              )
            ))
        );
      };

      const SettingsTab=()=>e('div', {className: "px-4 py-3 space-y-6 pt-16"},
        e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
          e('div', {className: "flex items-center justify-between mb-3"},
            e('h3', {className: "font-semibold text-lg"}, "Giao di·ªán"),
            e('span', {className: "chip"}, theme)
          ),
          e('div', {className: "grid grid-cols-3 gap-3"},
            [['T·ªëi','dark'],['S√°ng','light'],['L·ª•c B·∫£o','lucbao']].map(([label,code])=>
              e('button', {key:code, onClick:()=>{haptic();setTheme(code)}, className: `w-full text-left p-4 rounded-2xl border border-[var(--border)] ${theme===code?'ring-2 ring-[var(--ring)]':''}`},
                e('div', {className: "font-semibold"}, label),
                e('div', {className: "text-xs text-[var(--muted)]"}, code)
              )
            )
          )
        ),
        e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
          e('h3', {className: "font-semibold mb-2"}, "√Çm l∆∞·ª£ng & t·ªëc ƒë·ªô"),
          e('div', {className: "space-y-2"},
            e('label', {className: "text-sm"}, `√Çm l∆∞·ª£ng: ${(volume*100)|0}%`),
            e('input', {type:"range", min:"0", max:"1", step:"0.01", value:volume, onChange:e=>{haptic(8);setVolume(parseFloat(e.target.value))}}),
            e('div', {className: "flex gap-2 flex-wrap"},
              [0.75,1,1.25,1.5].map(v=>
                e('button', {key:v, className: `btn ${playbackRate===v?'btn-primary':''}`, onClick:()=>{haptic();setPlaybackRate(v)}}, `${v}x`)
              ),
              e('label', {className: "flex items-center gap-2 ml-1"},
                e('input', {type:"checkbox", checked:muted, onChange:e=>{haptic();setMuted(e.target.checked)}}), " T·∫Øt ti·∫øng"
              )
            )
          )
        ),
        e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
          e('h3', {className: "font-semibold mb-2"}, "·ªîn ƒë·ªãnh √¢m l∆∞·ª£ng (WebAudio)"),
          e('label', {className: "flex items-center gap-2"},
            e('input', {type:"checkbox", checked:!!compressorOn, onChange:e=>{haptic();setCompressorOn(e.target.checked)}}), " B·∫≠t Dynamics Compressor"
          ),
           e('p', {className: "text-xs text-[var(--muted)] mt-1"}, "T·∫Øt s·∫Ω gi√∫p ti·∫øt ki·ªám pin h∆°n 1 ch√∫t.")
        ),
        e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
          e('h3', {className: "font-semibold mb-2"}, "Ti·∫øt ki·ªám pin & Ch·∫°y n·ªÅn"),
          e('label', {className: "flex items-center gap-2"},
            e('input', {type:"checkbox", checked:!!powerSave, onChange:e=>{haptic();setPowerSave(e.target.checked)}}), " B·∫≠t ti·∫øt ki·ªám pin (t·∫Øt preload v√† gi·∫£m t·∫ßn su·∫•t ki·ªÉm tra khi n·ªÅn)"
          )
        ),
        e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
          e('h3', {className: "font-semibold mb-3"}, "H·∫πn gi·ªù t·∫Øt nh·∫°c"),
          e('div', {className: "grid grid-cols-3 gap-2"},
            [15,30,45,60,90,120].map(m=>e('button', {key:m, className: "btn", onClick:()=>startSleepTimer(m*60*1000)}, `${m} ph√∫t`))
          ),
          e('div', {className: "flex items-center gap-3 mt-3"},
            e('span', {className: "chip"}, timerLeft?`C√≤n: ${formatTime(Math.ceil(timerLeft/1000))}`:'Kh√¥ng ƒë·∫∑t'),
            timerLeft && e('button', {className: "btn", onClick:cancelSleepTimer}, "Hu·ª∑ h·∫πn gi·ªù"),
            e('label', {className: "flex items-center gap-2 ml-auto"},
              e('input', {type:"checkbox", checked:!!stopAtEnd, onChange:e=>{haptic();setStopAtEnd(e.target.checked)}}), " D·ª´ng khi h·∫øt b√†i"
            )
          )
        ),
        e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
          e('h3', {className: "font-semibold mb-2"}, "D·ªØ li·ªáu & ƒê·ªìng b·ªô"),
          e('div', {className: "flex flex-col gap-2"},
            e('button', {className: "btn", onClick:()=>{haptic();refetch()}}, "L√†m m·ªõi danh s√°ch nh·∫°c"),
            e('button', {className: "btn", onClick:async()=>{
              haptic();
              try{ if('caches' in window){ const keys=await caches.keys(); for(const k of keys){ await caches.delete(k); } } }catch{}
              try{ localStorage.clear(); }catch{}
              location.reload();
            }, style:{background:'#2a1313',borderColor:'#6b1d1d',color:'#fff'}}, "X√≥a Cache & L√†m m·ªõi t·∫•t c·∫£")
          )
        )
      );

      /* === RESTORED NOW PLAYING (FULL SCREEN) === */
      const [showNowPlaying,setShowNowPlaying]=useState(false);
      const NowPlaying=()=>{
        if(!current) return null;
        const a=audioRef.current;
        const onSeek=(e)=>{ 
          if(!a||!isFinite(a.duration)) return; 
          const newVal = parseFloat(e.target.value);
          a.currentTime=clamp(newVal,0,a.duration); 
          updatePositionState(); // Sync lockscreen immediately
        };
        const dblLeft=()=>{ haptic(5); if(a) a.currentTime=Math.max(0,(a.currentTime||0)-10); updatePositionState();};
        const dblRight=()=>{ haptic(5); if(a) a.currentTime=Math.min(a.duration||0,(a.currentTime||0)+10); updatePositionState();};
        
        const RepeatButton = () => {
          let label = 'L·∫∑p: T·∫Øt';
          let className = 'btn';
          if (repeat === 'all') { label = 'L·∫∑p: DS'; className += ' btn-primary'; } 
          else if (repeat === 'one') { label = 'L·∫∑p: 1'; className += ' btn-primary'; }
          return e('button', {className: className, onClick: ()=>{haptic();setRepeat(r=> sanitizeRepeat(r==='off'?'all':r==='all'?'one':'off'))}}, 
            Icons.repeat(18), ` ${label}`); 
        };

        return e('div', {className: "fixed inset-0 z-50 bg-[var(--bg)]/98 backdrop-blur-md overflow-y-auto"},
          e('div', {className: "p-4 flex items-center justify-between border-b border-[var(--border)] sticky top-0 bg-[var(--nav-bg)] z-10"},
            e('button', {className: "btn", onClick: ()=>{haptic();setShowNowPlaying(false)}}, "ƒê√≥ng"),
            e('div', {className: "font-semibold"}, "ƒêang ph√°t"),
            e('div', {className: "w-10"}) // Spacer
          ),
          e('div', {className: "px-6 py-6 pb-20 max-w-xl mx-auto"},
            e('div', {className: "mx-auto w-full max-w-[300px] aspect-square rounded-3xl shadow-xl overflow-hidden relative select-none", style:{background:'var(--gradient)'}},
              e('div', {className: "absolute inset-0 z-10", onDoubleClick: dblLeft}),
              e('div', {className: "absolute inset-0 left-1/2 z-10", onDoubleClick: dblRight}),
              e('img', {src: current.artwork||ICON_URL, alt: "", className: "w-full h-full object-cover mix-blend-luminosity pointer-events-none"})
            ),
            e('div', {className: "mt-5 text-center"},
              e('div', {className: "text-2xl font-bold truncate"}, current.title),
              e('div', {className: "text-sm text-[var(--muted)] truncate"}, current.artist||'minhsutinhquang')
            ),
            e('div', {className: "mt-8 px-1"},
              e('input', {type:"range", min:"0", max:progress.duration||0, step:"0.1", value:progress.current||0, onChange:onSeek, style:{width:'100%', accentColor:'var(--primary)'}}),
              e('div', {className: "mt-1 text-[12px] text-[var(--muted)] flex justify-between"},
                e('span', null, formatTime(progress.current)), e('span', null, formatTime(progress.duration))
              )
            ),
            
            // Player Controls (Original Layout)
            e('div', {className: "mt-6 flex items-center justify-center gap-6"},
              e('button', {className: `btn text-xl p-3 ${shuffle?'btn-primary':''}`, onClick:()=>{haptic();setShuffle(s=>!s)}}, Icons.shuffle(24)), 
              e('button', {className: "btn text-3xl p-3", onClick:prevTrack}, Icons.back(32)), 
              e('button', {className: "btn btn-primary text-4xl p-5 rounded-full", onClick:playPause}, playing?Icons.pause(36):Icons.play(36)), 
              e('button', {className: "btn text-3xl p-3", onClick:nextTrack}, Icons.next(32)), 
              e(RepeatButton, null)
            ),

            e('div', {className: "mt-8 space-y-4"},
              e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
                e('div', {className: "flex items-center justify-between mb-2"},
                    e('div', {className: "font-semibold"}, "√Çm l∆∞·ª£ng"),
                    e('span', {className: "chip"}, `${(volume*100|0)}%`)
                ),
                e('input', {type:"range", min:"0", max:"1", step:"0.01", value:volume, onChange:e=>{haptic(8);setVolume(parseFloat(e.target.value))}, style:{accentColor:'var(--primary)'}})
              ),
              e('div', {className: "p-3 rounded-2xl border border-[var(--border)]"},
                e('div', {className: "flex items-center justify-between mb-2"},
                    e('div', {className: "font-semibold"}, "T·ªëc ƒë·ªô ph√°t"),
                    e('span', {className: "chip"}, `${playbackRate}x`)
                ),
                e('div', {className: "flex gap-2 justify-start"},
                  [0.75,1,1.25,1.5,2.0].map(v=>
                    e('button', {key:v, className: `btn text-sm ${playbackRate===v?'btn-primary':''}`, onClick:()=>{haptic();setPlaybackRate(v)}}, `${v}x`)
                  )
                )
              )
            )
          )
        );
      };

      /* ---- Render & auto start ---- */
      useEffect(()=>{ 
        const a=audioRef.current; if(!a) return;
        if(current){
          if(a.src!==current.stream_url){ a.src=current.stream_url; a.load(); }
          a.loop=false; a.playbackRate=playbackRate; a.muted=false; 
          document.title=`${playing?'‚ñ∂':'‚è∏'} ${current.title} ‚Äì MSTQ`;
          if(playing && !needsStart){ a.play().catch(()=>{}); }
        }else{
          document.title='MSTQ Music';
        }
      },[currentIndex,playing,playbackRate,current,needsStart]);

      const START_TIMEOUT_MS = 4000; 
      
      useEffect(()=>{
        clearTimeout(startTimerRef.current);
        if(!loading && needsStart){
          startTimerRef.current=setTimeout(async()=>{
            try{
              await ensureAudioContext();
              if(!playlist.length){ 
                setNeedsStart(false); 
                return; 
              }
              setNeedsStart(false); 
              playIndex(0,{fadeIn:false}); 
            }catch{
                 setNeedsStart(false);
            }
          }, START_TIMEOUT_MS);
        }
        return()=>clearTimeout(startTimerRef.current);
      },[loading, needsStart, playlist.length, playIndex]);


      const TabBar=()=>e('nav', {className: "tabbar safe-bottom"},
        e('div', {className: "flex"},
          e('button', {className: "tabbtn", 'aria-current':tab==='home', onClick:()=>{haptic();setTab('home')}}, Icons.home(20), e('span', null, "Trang ch·ªß")), 
          e('button', {className: "tabbtn", 'aria-current':tab==='search', onClick:()=>{haptic();setTab('search')}}, Icons.search(20), e('span', null, "T√¨m ki·∫øm")), 
          e('button', {className: "tabbtn", 'aria-current':tab==='settings', onClick:()=>{haptic();setTab('settings')}}, Icons.settings(20), e('span', null, "C√†i ƒë·∫∑t")), 
          e('button', {className: "tabbtn", 'aria-current':tab==='queue', onClick:()=>{haptic();setTab('queue')}}, Icons.queue(20), e('span', null, "H√†ng ƒë·ª£i"))
        )
      );

      const MiniPlayer = () => current && !needsStart && e('div', {
        className: "fixed left-2 right-2 rounded-2xl bg-[var(--card)]/95 border border-[var(--border)] backdrop-blur-md p-2 pt-3 z-50 shadow-[var(--shadow)]",
        style:{bottom:'64px'}
      },
        e('div', {className: "flex items-center justify-between gap-3"},
          e('button', {className: "flex-grow min-w-0 text-left pr-2", onClick: ()=>{haptic();setShowNowPlaying(true)}},
            e('p', {className: "truncate font-semibold"}, current.title),
            e('p', {className: "text-xs text-[var(--muted)] truncate"}, current.artist||'minhsutinhquang'),
          ),
          
          e('div', {className: "absolute inset-x-0 bottom-1/2 translate-y-1/2 flex justify-center pointer-events-none"},
            e('div', {className: "flex items-center justify-center rounded-full bg-[var(--primary)] text-[var(--primary-fg)] overflow-hidden shadow-lg pointer-events-auto w-3/4 max-w-[200px]"},
              e('button', {className: "w-1/3 h-10 flex items-center justify-center p-2", onClick: ()=>{haptic();prevTrack()}, 'aria-label': "Previous"}, Icons.back(20)), 
              e('button', {className: "w-1/3 h-10 flex items-center justify-center p-2 border-x border-[var(--primary-fg)]/20", onClick: ()=>{haptic();playPause()}, 'aria-label': "Play/Pause"}, playing?Icons.pause(22):Icons.play(22)), 
              e('button', {className: "w-1/3 h-10 flex items-center justify-center p-2", onClick: ()=>{haptic();nextTrack()}, 'aria-label': "Next"}, Icons.next(20)) 
            )
          )
        ),
        e('div', {className: "mt-3 h-1 bg-[var(--muted)]/20 rounded-full"},
          e('div', {className: "h-1 bg-[var(--primary)] rounded-full transition-all duration-500", style:{width:`${progress.duration>0?(progress.current/progress.duration)*100:0}%`}})
        )
      );

      const StartGate = () => needsStart && e('div', {className: "fixed inset-0 z-50 flex items-center justify-center bg-[var(--bg)]/95 backdrop-blur"},
        e('div', {className: "p-5 rounded-2xl border border-[var(--border)] bg-[var(--card)] shadow-xl text-center max-w-sm"},
          e('img', {src: LOGO_FALLBACK_URL, onError: (e) => { e.target.src = LOGO_PLACEHOLDER; e.target.onError = null; }, width: "64", height: "64", className: "mx-auto mb-3 rounded-xl", alt: "MSTQ logo"}),
          e('h2', {className: "font-bold text-lg mb-2"}, "MSTQ Music"),
          e('p', {className: "text-sm text-[var(--muted)] mb-3"}, `Ch·∫°m ‚ÄúB·∫Øt ƒë·∫ßu nghe‚Äù ƒë·ªÉ m·ªü quy·ªÅn √¢m thanh. H·ªôp tho·∫°i s·∫Ω t·ª± ƒë√≥ng sau ${START_TIMEOUT_MS/1000} gi√¢y v√† th·ª≠ ph√°t t·ª± ƒë·ªông.`),
          e('div', {className: "flex gap-2 justify-center"},
            e('button', {className: "btn", onClick: askInstall}, "C√†i ƒë·∫∑t ·ª©ng d·ª•ng"),
            e('button', {className: "btn btn-primary", onClick: async()=>{haptic(); await ensureAudioContext(); setNeedsStart(false); if(playlist.length){ playIndex(0,{fadeIn:false}); }}}, "B·∫Øt ƒë·∫ßu nghe")
          ),
          e('div', {className: "text-[12px] text-[var(--muted)] mt-2"}, loading?'ƒêang t·∫£i danh s√°ch nh·∫°c...':`S·∫Ω t·ª± ƒë·ªông b·∫Øt ƒë·∫ßu sau ${START_TIMEOUT_MS/1000} gi√¢y‚Ä¶`)
        )
      );

      const title = tab==='home'?'Trang ch·ªß':tab==='search'?'T√¨m ki·∫øm':tab==='settings'?'C√†i ƒë·∫∑t':tab==='queue'?'H√†ng ƒë·ª£i':'';

      return e('div', {className: "min-h-screen", onClick: ()=>setLinksOpen(false), style:{paddingTop:64, paddingBottom:(current?188:104)}},
        // FIX FLICKER: G·ªçi TopBar nh∆∞ Component chu·∫©n (e(TopBar))
        e(TopBar, {title, askInstall, linksOpen, setLinksOpen, setTheme}),
        e(StartGate, null),
        
        /* Toast Notification */
        toast && e('div', {className: "toast-container"},
            e('div', {className: "toast-tet"}, toast)
        ),

        tab==='home' && e(HomeTab, null),
        tab==='search' && e(SearchTab, null),
        tab==='settings' && e(SettingsTab, null),
        tab==='queue' && e(QueueTab, null),
        e('nav', {className: "tabbar safe-bottom"},
          e('div', {className: "flex"},
            e('button', {className: "tabbtn", 'aria-current':tab==='home', onClick:()=>{haptic();setTab('home')}}, Icons.home(20), e('span', null, "Trang ch·ªß")), 
            e('button', {className: "tabbtn", 'aria-current':tab==='search', onClick:()=>{haptic();setTab('search')}}, Icons.search(20), e('span', null, "T√¨m ki·∫øm")), 
            e('button', {className: "tabbtn", 'aria-current':tab==='settings', onClick:()=>{haptic();setTab('settings')}}, Icons.settings(20), e('span', null, "C√†i ƒë·∫∑t")), 
            e('button', {className: "tabbtn", 'aria-current':tab==='queue', onClick:()=>{haptic();setTab('queue')}}, Icons.queue(20), e('span', null, "H√†ng ƒë·ª£i"))
          )
        ),
        e(MiniPlayer, null),
        showNowPlaying && !needsStart && e(NowPlaying, null)
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(e(App, null));
  </script>

  <!-- ================================================================= -->
  <!-- B·∫ÆT ƒê·∫¶U PWA ENGINE V29 - SMART INTELLIGENT INSTALL -->
  <!-- ================================================================= -->

  <style>
      /* PWA UI STYLES */
      .install-fab {
          transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          box-shadow: 0 4px 15px rgba(238, 77, 45, 0.4);
          display: none; 
          z-index: 9999;
      }
      .install-fab:active { transform: scale(0.95); }
      .install-fab:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(238, 77, 45, 0.5); }
      
      .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; position: relative; }
      .status-dot::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; opacity: 0.7; }
      @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
      
      /* New Animations V22 */
      @keyframes attention-pulse { 
          0% {transform: scale(1);} 
          50% {transform: scale(1.05); box-shadow: 0 0 15px rgba(238,77,45,0.7);} 
          100% {transform: scale(1);} 
      }
      .animate-pulse-slow { animation: attention-pulse 1.5s infinite; }

      .dot-red { background-color: #ef4444; } .dot-red::after { background-color: #ef4444; }
      .dot-green { background-color: #22c55e; } .dot-green::after { background-color: #22c55e; }
      .dot-yellow { background-color: #eab308; } .dot-yellow::after { background-color: #eab308; }

      /* Guide UI Steps */
      .guide-step { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; font-size: 15px; line-height: 1.5; text-align: left; }
      .step-num { background: #ee4d2d; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 14px; }
      
      /* Animations */
      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
      .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes pop-in { 0% { transform: scale(0) translateY(20px); opacity: 0; } 80% { transform: scale(1.1) translateY(0); opacity: 1; } 100% { transform: scale(1); } }
      .animate-pop-in { animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
  </style>

  <!-- N√öT C√ÄI ƒê·∫∂T TH√îNG MINH (Auto Android/PC) -->
  <button id="btnInstall" class="install-fab fixed bottom-20 right-4 bg-[#ee4d2d] text-white py-3 px-6 rounded-full font-bold border-4 border-white items-center gap-3 cursor-pointer animate-pop-in text-lg">
      <span class="text-3xl">üì≤</span>
      <span class="font-bold uppercase tracking-wide">T·∫¢I APP</span>
  </button>

  <!-- MODAL H∆Ø·ªöNG D·∫™N TH√îNG MINH -->
  <div id="pwaHealthModal" class="hidden fixed inset-0 z-[100000] bg-black/80 text-gray-800 flex flex-col justify-center items-center p-4 backdrop-blur-sm transition-opacity">
      <div class="w-full max-w-sm bg-white rounded-2xl p-0 shadow-2xl overflow-hidden animate-slide-up border-2 border-[#ee4d2d]">
          <div class="bg-[#ee4d2d] p-5 text-white text-center">
              <div class="font-bold text-xl mb-1 uppercase">C√†i ƒë·∫∑t ·ª®ng d·ª•ng</div>
              <div class="text-xs opacity-90">Truy c·∫≠p nhanh h∆°n - M∆∞·ª£t m√† h∆°n</div>
          </div>
          
          <div id="smartGuideContent" class="p-6">
              <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c thay ƒë·ªïi th√¥ng minh b·ªüi JS -->
          </div>
          
          <div class="p-4 bg-gray-50 text-center border-t">
              <button onclick="document.getElementById('pwaHealthModal').classList.add('hidden')" class="text-gray-500 font-bold text-sm hover:text-gray-800">ƒê√≥ng l·∫°i</button>
          </div>
      </div>
      <!-- M≈©i t√™n ch·ªâ d·∫´n cho iOS -->
      <div id="iosArrow" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 animate-bounce text-6xl text-white drop-shadow-lg z-[100001]" style="text-shadow: 0 2px 5px rgba(0,0,0,0.5);">‚¨áÔ∏è</div>
  </div>

  <script>
      /* =========================================================
         üß† LOGIC CORE V29.0 (INTELLIGENT INSTALL ACTION)
         ========================================================= */
      const logicCore = {
          deferredPrompt: null,
          repoPath: '/PlayMusic', 

          state: {
              isIOS: /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase()),
              isAndroid: /android/.test(navigator.userAgent.toLowerCase()),
              isPC: !/iphone|ipad|ipod|android/i.test(navigator.userAgent), // Ph√°t hi·ªán PC
              isInApp: /FBAN|FBAV|Instagram|Zalo/i.test(navigator.userAgent),
              isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone,
          },
          
          init: function() {
              if ('serviceWorker' in navigator) {
                  navigator.serviceWorker.register(`${this.repoPath}/sw.js?v=${Date.now()}`)
                      .then(() => console.log("‚úÖ PWA Engine: SW Registered"))
                      .catch(err => console.warn("‚ùå PWA Engine: SW Fail", err));
              }

              this.updateUI('init');
              
              // Check installed status
              if (this.state.isStandalone) {
                  this.updateUI('installed');
              } else {
                  // Capture event for Android/PC Chrome
                  window.addEventListener('beforeinstallprompt', (e) => {
                      e.preventDefault();
                      this.deferredPrompt = e;
                      this.showSmartFAB();
                      this.updateUI('ready');
                  });
              }

              // Expose for React
              window.pwaEngine = this;
          },

          updateUI: function(status) {
              const dot = document.getElementById('pwaStatusDot');
              if (dot) {
                  dot.className = "status-dot"; 
                  if (status === 'init') dot.classList.add('dot-yellow');
                  else if (status === 'ready') dot.classList.add('dot-red');
                  else if (status === 'installed') dot.classList.add('dot-green');
              }
          },

          showSmartFAB: function() {
              if (this.state.isStandalone) return;
              const fab = document.getElementById('btnInstall');
              if(fab) {
                  fab.style.display = 'flex';
                  fab.onclick = () => this.handleInstallClick();
              }
          },

          // --- TRUNG T√ÇM X·ª¨ L√ù CLICK TH√îNG MINH ---
          handleInstallClick: async function() {
              const modal = document.getElementById('pwaHealthModal');
              const content = document.getElementById('smartGuideContent');
              const arrow = document.getElementById('iosArrow');
              if(!modal || !content) return;

              modal.classList.remove('hidden');
              if(arrow) arrow.classList.add('hidden'); // Reset

              // === CASE 1: ƒê√É C√ÄI ƒê·∫∂T (STANDALONE) ===
              if (this.state.isStandalone) {
                  content.innerHTML = `
                      <div class="text-center">
                          <div class="text-green-500 text-5xl mb-3">üéâ</div>
                          <h3 class="text-xl font-bold text-gray-800 mb-2">ƒê√£ c√†i ƒë·∫∑t th√†nh c√¥ng!</h3>
                          <p class="text-gray-600">B√°c ƒëang s·ª≠ d·ª•ng phi√™n b·∫£n ·ª®ng d·ª•ng.<br>Ch√∫c b√°c nghe nh·∫°c vui v·∫ª ·∫°.</p>
                      </div>
                  `;
                  return;
              }

              // === CASE 2: C√ì TH·ªÇ C√ÄI T·ª∞ ƒê·ªòNG (ANDROID/PC CHROME) ===
              if (this.deferredPrompt) {
                  // G·ªçi prompt ngay l·∫≠p t·ª©c
                  modal.classList.add('hidden'); // ·∫®n modal h∆∞·ªõng d·∫´n ƒëi
                  this.deferredPrompt.prompt();
                  const { outcome } = await this.deferredPrompt.userChoice;
                  if (outcome === 'accepted') {
                      this.deferredPrompt = null;
                      // Sau khi c√†i xong th√¨ ·∫©n n√∫t FAB lu√¥n
                      const fab = document.getElementById('btnInstall');
                      if(fab) fab.style.display = 'none';
                  }
                  return;
              }

              // === CASE 3: IN-APP BROWSER (ZALO/FB) ===
              if (this.state.isInApp) {
                  content.innerHTML = `
                      <div class="text-center text-red-600 font-bold mb-3">‚ö†Ô∏è C·∫£nh B√°o Tr√¨nh Duy·ªát</div>
                      <p class="mb-3 text-sm">B√°c ƒëang m·ªü b·∫±ng Zalo/Facebook n√™n kh√¥ng c√†i ƒë∆∞·ª£c ·∫°.</p>
                      <div class="guide-step bg-yellow-50 p-2 rounded border border-yellow-200 text-left">
                          <div class="step-num">1</div>
                          <div>B·∫•m d·∫•u <b>3 ch·∫•m</b> <span class="text-xl">‚ãØ</span> ·ªü g√≥c tr√™n ph·∫£i.</div>
                      </div>
                      <div class="guide-step bg-yellow-50 p-2 rounded border border-yellow-200 text-left">
                          <div class="step-num">2</div>
                          <div>Ch·ªçn <b>M·ªü b·∫±ng tr√¨nh duy·ªát</b> (Chrome/Safari).</div>
                      </div>
                  `;
                  return;
              }

              // === CASE 4: iOS (IPHONE/IPAD) ===
              if (this.state.isIOS) {
                  content.innerHTML = `
                      <div class="text-center font-bold mb-2 text-blue-600">D√†nh cho iPhone/iPad</div>
                      <div class="guide-step"><div class="step-num">1</div><div>B·∫•m n√∫t <b>Chia s·∫ª</b> <i class="text-blue-500 text-xl">‚éã</i> ·ªü d∆∞·ªõi c√πng.</div></div>
                      <div class="guide-step"><div class="step-num">2</div><div>K√©o l√™n ch·ªçn <b>Th√™m v√†o MH ch√≠nh</b>.</div></div>
                      <div class="guide-step"><div class="step-num">3</div><div>B·∫•m n√∫t <b>Th√™m</b> ·ªü g√≥c tr√™n c√πng.</div></div>
                  `;
                  if(arrow) arrow.classList.remove('hidden');
                  return;
              }

              // === CASE 5: ANDROID (TH·ª¶ C√îNG) ===
              if (this.state.isAndroid) {
                  content.innerHTML = `
                      <div class="text-center font-bold mb-2 text-green-600">D√†nh cho Android</div>
                      <div class="guide-step"><div class="step-num">1</div><div>B·∫•m d·∫•u <b>3 ch·∫•m</b> <span class="text-xl">‚ãÆ</span> ·ªü g√≥c tr√™n b√™n ph·∫£i.</div></div>
                      <div class="guide-step"><div class="step-num">2</div><div>Ch·ªçn <b>C√†i ƒë·∫∑t ·ª©ng d·ª•ng</b> ho·∫∑c <b>Th√™m v√†o m√†n h√¨nh ch√≠nh</b>.</div></div>
                  `;
                  return;
              }

              // === CASE 6: PC/LAPTOP (TH·ª¶ C√îNG) ===
              if (this.state.isPC) {
                    content.innerHTML = `
                      <div class="text-center">
                          <p class="mb-3 font-bold text-lg">C√†i ƒë·∫∑t tr√™n M√°y t√≠nh</p>
                          <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 inline-block mb-3 text-left">
                              <div class="flex items-center gap-3 mb-2">
                                  <span class="text-2xl">‚äï</span> 
                                  <span>B·∫•m bi·ªÉu t∆∞·ª£ng <b>C√†i ƒë·∫∑t</b> ·ªü cu·ªëi thanh ƒë·ªãa ch·ªâ (tr√™n c√πng b√™n ph·∫£i).</span>
                              </div>
                              <div class="text-sm text-gray-500 italic ml-8">Ho·∫∑c b·∫•m menu 3 ch·∫•m > "C√†i ƒë·∫∑t MSTQ Music..."</div>
                          </div>
                      </div>
                  `;
                  return;
              }
          }
      };

      // K√≠ch ho·∫°t Engine
      document.addEventListener('DOMContentLoaded', () => logicCore.init());
  </script>
  <!-- ================================================================= -->
  <!-- K·∫æT TH√öC PWA ENGINE V29 -->
  <!-- ================================================================= -->

</body>
</html>
