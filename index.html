<!DOCTYPE html>
<html lang="vi" data-theme="lucbao">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSTQ Music + Admin (Firebase API_BASE, One-File)</title>

  <!-- CSP th√¢n thi·ªán GitHub Pages + Babel -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: blob: 'unsafe-inline' 'unsafe-eval';
                 script-src  'self' https: 'unsafe-inline' 'unsafe-eval';
                 img-src     'self' https: data: blob:;
                 media-src   'self' https: data: blob:;
                 connect-src 'self' https://archive.org https://*.archive.org https://firestore.googleapis.com https://*.googleapis.com https://*.gstatic.com https: ;
                 worker-src  'self' blob: data:;
                 style-src   'self' https: 'unsafe-inline';
                 frame-ancestors 'self';">

  <link rel="dns-prefetch" href="https://archive.org">
  <link rel="preconnect" href="https://archive.org" crossorigin>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat (ƒë∆°n gi·∫£n d√πng trong HTML thu·∫ßn) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <style>
    :root,[data-theme]{transition:color .2s, background-color .2s}
    :root{
      --bg:#111827;--card:#1f2937;--text:#f9fafb;--muted:#9ca3af;--primary:#f59e0b;--primary-fg:#111827;
      --ring:#f59e0b66;--shadow:0 10px 30px rgba(0,0,0,.35);--border:#374151;--nav-bg:rgba(31,41,55,.8);
      --gradient:linear-gradient(135deg,#f59e0b 0%,#fbbf24 100%);
    }
    [data-theme="light"]{
      --bg:#f3f4f6;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#d97706;--primary-fg:#fff;
      --ring:#d9770666;--shadow:0 10px 25px rgba(0,0,0,.1);--border:#e5e7eb;--nav-bg:rgba(255,255,255,.8);
      --gradient:linear-gradient(135deg,#fbbf24 0%,#f97316 100%);
    }
    [data-theme="lucbao"]{
      --bg:#081414;--card:#102424;--text:#e0f2f1;--muted:#80cbc4;--primary:#f4ff81;--primary-fg:#1a2327;
      --ring:#f4ff8166;--shadow:0 18px 40px rgba(168,255,120,.2);--border:rgba(255,255,255,.08);
      --nav-bg:rgba(16,36,36,.8);--gradient:linear-gradient(135deg,#a8ff78 0%,#f4ff81 100%);
    }
    .theme-swatch{display:flex;flex-direction:column;align-items:center;gap:.5rem;padding:.75rem;border-radius:14px;background:var(--card);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer;transition:all .2s}
    .theme-swatch .dot{width:40px;height:40px;border-radius:9999px;background:linear-gradient(135deg,var(--c1),var(--c2))}
    .theme-swatch[aria-current="true"]{outline:3px solid var(--ring);outline-offset:2px;transform:scale(1.05)}
    @keyframes slide-up{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .animate-slide-up{animation:slide-up .3s ease-out}
    :root[data-powersave]{--shadow:none}
    :root[data-powersave] *{transition:none!important;animation:none!important}
    .kbd{display:inline-block;border:1px solid var(--border);border-bottom-width:2px;border-radius:.5rem;padding:.2rem .45rem;background:var(--card);font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.8rem}
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)] font-sans">
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
/* =========================================================
   MSTQ PLAYER + ADMIN (Firebase ‚Üí Firestore ƒë·ªÉ l·∫•y/ghi API_BASE)
   - ErrorBoundary ch·ªëng ‚Äúm√†n h√¨nh ƒëen‚Äù
   - Admin g·ªçn: ch·ªçn b√†i b·∫±ng select r·ªìi m·ªü form s·ª≠a
   - Firestore doc: puppeteer-control/admin-config
       { apiBase: "https://your-backend", bearerToken: "..." }
   - N√∫t ‚ÄúL∆∞u C·ª•c b·ªô‚Äù (LocalStorage) + ‚ÄúL∆∞u l√™n Firestore‚Äù
   - Kh√¥ng nh√∫ng IA secret v√†o client; d√πng backend API_BASE
   ========================================================= */

const {useState,useEffect,useMemo,useRef,useCallback} = React;
const SKEY={
  songs:"mstq_songs_v1", fav:"mstq_favorites_v1",
  theme:"music-theme", overrides:"mstq_admin_overrides_v1",
  custom:"mstq_admin_custom_songs_v1", apiBase:"mstq_api_base_v1",
  apiToken:"mstq_api_token_v1"
};
const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
const load=(k,def)=>{try{const x=JSON.parse(localStorage.getItem(k)||"");return x??def}catch{return def}};
const haptic=()=>navigator?.vibrate?.(8);
const ft = s => (!Number.isFinite(s)||s<0)?"0:00":`${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;

/* ---------- Firebase Init ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyD1VGc1stVvkpFqTMaSh2X7KqzBiH1-dDY",
  authDomain: "ai-companel.firebaseapp.com",
  projectId: "ai-companel",
  storageBucket: "ai-companel.firebasestorage.app",
  messagingSenderId: "869875628579",
  appId: "1:869875628579:web:9c5fcf2c4372748c17cf96",
  measurementId: "G-YY7E4DLFHL"
};
let firestore = null;
try{
  const app = firebase.initializeApp(firebaseConfig);
  firestore = firebase.firestore();
}catch(e){
  console.warn("Firebase init fail (ti·∫øp t·ª•c ch·∫°y offline admin):", e);
}

/* ---------- ErrorBoundary ---------- */
class ErrorBoundary extends React.Component{
  constructor(p){super(p);this.state={err:null}}
  static getDerivedStateFromError(error){return {err:error}}
  componentDidCatch(e,info){console.error("[UI ERROR]",e,info)}
  render(){
    if(this.state.err){
      return (
        <div className="min-h-screen p-6">
          <div className="max-w-2xl mx-auto bg-[var(--card)] border border-[var(--border)] rounded-2xl p-6 shadow-[var(--shadow)]">
            <h2 className="text-2xl font-bold mb-2">C√≥ l·ªói UI üò•</h2>
            <p className="text-[var(--muted)] mb-4">B·∫°n v·∫´n c√≥ th·ªÉ <button onClick={()=>location.reload()} className="underline">t·∫£i l·∫°i trang</button>.</p>
            <pre className="text-xs whitespace-pre-wrap bg-black/20 p-3 rounded-lg overflow-auto max-h-64">{String(this.state.err)}</pre>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

/* ---------- Icons / Bars ---------- */
const Play=({s=24})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
const Pause=({s=24})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>;
const Back=({s=24})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" y1="19" x2="5" y2="5"/></svg>;
const Next=({s=24})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/></svg>;

const Tabs=({active,setActive})=>{
  const items=[['home','Trang ch·ªß'],['search','T√¨m ki·∫øm'],['library','Th∆∞ vi·ªán'],['settings','C√†i ƒë·∫∑t']];
  return (
    <nav className="fixed bottom-0 inset-x-0 h-16 bg-[var(--nav-bg)] backdrop-blur-lg border-t border-[var(--border)] z-40">
      <div className="grid grid-cols-4 h-full">
        {items.map(([id,label])=>(
          <button key={id} onClick={()=>setActive(id)}
            className={`flex flex-col items-center justify-center gap-1 text-xs ${active===id?'text-[var(--primary)]':'text-[var(--muted)] hover:text-[var(--text)]'}`}>
            <span className="text-lg">{id==='home'?'üè†':id==='search'?'üîé':id==='library'?'üìö':'‚öôÔ∏è'}</span>
            <span className="font-medium">{label}</span>
          </button>
        ))}
      </div>
    </nav>
  );
};

/* ---------- Mini Player ---------- */
const Mini=({song,playing,onPlay,onNext,onPrev,progress,seek,isFav,toggleFav})=>{
  if(!song) return null;
  const pct = progress.duration>0 ? (progress.current/progress.duration)*100 : 0;
  return (
    <div className="fixed bottom-[68px] left-2 right-2 rounded-2xl shadow-[var(--shadow)] bg-[var(--card)]/95 backdrop-blur-md border border-[var(--border)] p-2 z-40 overflow-hidden">
      <div className="flex items-center gap-3">
        <img src={song.artwork||'https://placehold.co/64x64/1f2937/9ca3af?text=üéµ'} className="w-12 h-12 rounded-lg object-cover" alt=""/>
        <div className="flex-grow min-w-0">
          <p className="font-semibold text-[15px] truncate">{song.title}</p>
          <p className="text-sm text-[var(--muted)] truncate">{song.artist||'minhsutinhquang'}</p>
        </div>
        <button onClick={()=>toggleFav(song.id)} className={`w-10 h-10 grid place-items-center rounded-full ${isFav?'text-red-500':'text-[var(--muted)] hover:text-[var(--text)]'}`}>‚ù§Ô∏è</button>
        <button onClick={onPrev} className="w-10 h-10 grid place-items-center rounded-full hover:bg-[var(--border)]"><Back s={20}/></button>
        <button onClick={onPlay} className="w-11 h-11 grid place-items-center rounded-full hover:bg-[var(--border)]">{playing?<Pause s={20}/>:<Play s={20}/>}</button>
        <button onClick={onNext} className="w-11 h-11 grid place-items-center rounded-full hover:bg-[var(--border)]"><Next s={20}/></button>
      </div>
      <div onPointerDown={seek} className="mt-2 h-1 bg-[var(--muted)]/20 cursor-pointer">
        <div className="h-full bg-[var(--primary)]" style={{width:`${pct}%`}}></div>
      </div>
    </div>
  );
};

/* ---------- Rows & Views ---------- */
const Row=({song,active,onClick})=>(
  <div onClick={onClick}
       className={`flex items-center gap-3 p-3 rounded-2xl cursor-pointer ${active?'bg-[var(--primary)]/20':'hover:bg-[var(--card)]/50'}`}>
    <img loading="lazy" src={song.artwork||'https://placehold.co/64x64/1f2937/9ca3af?text=üéµ'} className="w-14 h-14 rounded-lg object-cover" alt=""/>
    <div className="flex-grow min-w-0">
      <p className={`font-semibold truncate text-[15px] ${active?'text-[var(--primary)]':'text-[var(--text)]'}`}>{song.title}</p>
      <p className="text-sm text-[var(--muted)] truncate">{song.artist||'minhsutinhquang'}</p>
    </div>
    <div className="text-sm text-[var(--muted)]">{ft(song.duration||0)}</div>
  </div>
);
const HomeView=({songs,onPick,activeId,isLoading})=>{
  if(isLoading) return <p className="px-4 py-20 text-center text-[var(--muted)]">ƒêang t·∫£i danh s√°ch...</p>;
  return (
    <div className="px-4">
      <h2 className="text-2xl font-bold mb-4">Danh s√°ch ph√°t</h2>
      <div className="space-y-2">
        {songs.length? songs.map(s=><Row key={s.id} song={s} active={s.id===activeId} onClick={()=>onPick(s)}/>)
                    : <p className="text-[var(--muted)] text-center py-10">Kh√¥ng c√≥ b√†i h√°t n√†o.</p>}
      </div>
    </div>
  );
};
const SearchView=({songs,onPick,activeId})=>{
  const [q,setQ]=useState("");
  const list = useMemo(()=> !q?[]:songs.filter(s=>(s.title||"").toLowerCase().includes(q.toLowerCase())||(s.artist||"").toLowerCase().includes(q.toLowerCase())),[q,songs]);
  return (
    <div className="px-4">
      <div className="relative mb-6">
        <input className="w-full bg-[var(--card)] border border-[var(--border)] rounded-full py-3 px-4 pl-12 text-lg"
               placeholder="Nh·∫≠p t√™n b√†i h√°t, ngh·ªá sƒ©..." value={q} onChange={e=>setQ(e.target.value)}/>
        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--muted)]">üîé</div>
      </div>
      {q && <div className="space-y-2">{list.map(s=><Row key={s.id} song={s} active={s.id===activeId} onClick={()=>onPick(s)}/>)}</div>}
    </div>
  );
};
const LibraryView=({songs,onPick,activeId,favs})=>{
  const favList = useMemo(()=>songs.filter(s=>favs.includes(s.id)),[songs,favs]);
  return (
    <div className="px-4">
      <h2 className="text-2xl font-bold mb-4">B√†i h√°t y√™u th√≠ch</h2>
      <div className="space-y-2">
        {favList.length? favList.map(s=><Row key={s.id} song={s} active={s.id===activeId} onClick={()=>onPick(s)}/>)
                      : <p className="text-[var(--muted)] text-center py-10">Ch∆∞a c√≥ b√†i y√™u th√≠ch.</p>}
      </div>
    </div>
  );
};

/* ---------- Admin helpers ---------- */
const themes={light:{name:'S√°ng',c1:'#ffffff',c2:'#f6f7fb'}, lucbao:{name:'L·ª•c B·∫£o',c1:'#a8ff78',c2:'#f4ff81'}};
const AdminBanner=({apiBase})=>{
  return apiBase
    ? <div className="p-3 rounded-lg bg-emerald-500/15 text-emerald-300 border border-emerald-500/30">üîí Admin ƒë√£ k·∫øt n·ªëi backend: <code>{apiBase}</code></div>
    : <div className="p-3 rounded-lg bg-yellow-500/15 text-yellow-300 border border-yellow-500/30">‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh backend. Thao t√°c admin ch·ªâ l∆∞u c·ª•c b·ªô.</div>;
};

/* ---------- Settings (Admin compact + Firestore) ---------- */
const SettingsView=({
  theme,setTheme,onClearCache,overrides,setOverrides,custom,setCustom,
  songs,onPick,exportData,importData,
  doDeleteIA,doUploadIA,doUpdateMetaIA,
  apiBase,setApiBase,apiToken,setApiToken,
  refreshApiFromFirestore, saveApiToFirestore
})=>{
  // ch·ªçn 1 b√†i ƒë·ªÉ s·ª≠a
  const [filter,setFilter]=useState("");
  const filteredOptions = useMemo(()=>songs
    .filter(s=>!overrides[s.id]?.hidden)
    .filter(s=>!filter || (s.title||"").toLowerCase().includes(filter.toLowerCase()) || (s.artist||"").toLowerCase().includes(filter.toLowerCase()))
    .map(s=>({id:s.id,label:`${s.title} ‚Äî ${(s.artist||'')}`})),[songs,overrides,filter]);
  const [selectedId,setSelectedId]=useState(filteredOptions[0]?.id||"");
  useEffect(()=>{ if(!selectedId && filteredOptions.length) setSelectedId(filteredOptions[0].id); },[filteredOptions.length]);
  const selectedSong = useMemo(()=>songs.find(s=>s.id===selectedId)||null,[songs,selectedId]);

  // th√™m b√†i m·ªõi c·ª•c b·ªô / upload IA
  const [adding,setAdding]=useState({title:"",artist:"",stream_url:"",artwork:"",duration:"",lyrics:""});
  const [fileUp,setFileUp]=useState(null);
  const [target,setTarget]=useState({identifier:"",filename:""});
  const onAddLocal=()=>{
    if(!adding.title.trim()||!adding.stream_url.trim()){alert("C·∫ßn Ti√™u ƒë·ªÅ + URL ph√°t");return;}
    const song={
      id:"custom-"+Date.now(), title:adding.title.trim(), artist:adding.artist.trim()||"TinhQuang",
      stream_url:adding.stream_url.trim(), artwork:adding.artwork.trim()||"", duration:parseFloat(adding.duration)||0,
      lyrics:adding.lyrics||"", item_identifier:"custom"
    };
    const next=[song,...custom]; setCustom(next); save(SKEY.custom,next);
    setAdding({title:"",artist:"",stream_url:"",artwork:"",duration:"",lyrics:""}); alert("ƒê√£ th√™m (c·ª•c b·ªô).");
  };
  const doUpload=async()=>{
    if(!fileUp){alert("Ch·ªçn t·ªáp tr∆∞·ªõc");return;}
    if(!apiBase){alert("Ch∆∞a c√≥ API_BASE");return;}
    const form=new FormData(); form.append("file",fileUp); form.append("identifier",target.identifier||""); form.append("filename",target.filename||fileUp.name);
    try{ await doUploadIA(form); alert("ƒê√£ upload l√™n IA"); }catch(e){ alert("L·ªói upload: "+e.message); }
  };

  // override helpers
  const onSaveOverride=(id,patch)=>{ const next={...overrides,[id]:{...(overrides[id]||{}),...patch}}; if(Object.keys(next[id]).length===0) delete next[id]; setOverrides(next); save(SKEY.overrides,next); };
  const onResetOverride=id=>{ const next={...overrides}; delete next[id]; setOverrides(next); save(SKEY.overrides,next); };
  const onToggleHide=id=> onSaveOverride(id,{hidden:!(overrides[id]?.hidden)});

  // editor card
  const Editor=({s})=>{
    const ov=overrides[s.id]||{};
    const [local,setLocal]=useState({title:ov.title??s.title,artist:ov.artist??s.artist,artwork:ov.artwork??s.artwork,lyrics:ov.lyrics??s.lyrics});
    useEffect(()=>{ setLocal({title:ov.title??s.title,artist:ov.artist??s.artist,artwork:ov.artwork??s.artwork,lyrics:ov.lyrics??s.lyrics}); },[s.id]);
    const remoteUpdate=async()=>{ if(!apiBase){alert("Ch∆∞a c√≥ API_BASE");return;} try{ await doUpdateMetaIA(s,local); alert("ƒê√£ ƒë·∫©y metadata l√™n IA"); }catch(e){ alert("L·ªói c·∫≠p nh·∫≠t: "+e.message); } };
    const remoteDelete=async()=>{ if(!confirm("Xo√° file tr√™n Internet Archive?")) return; if(!apiBase){ alert("Ch∆∞a c√≥ API_BASE"); return; } try{ await doDeleteIA(s); alert("ƒê√£ xo√° tr√™n IA"); }catch(e){ alert("L·ªói xo√°: "+e.message); } };
    const isCustom=s.item_identifier==="custom";
    return (
      <div className="p-4 rounded-xl border border-[var(--border)] bg-[var(--card)]/60">
        <div className="flex items-start gap-3">
          <img src={local.artwork||'https://placehold.co/64x64/1f2937/9ca3af?text=üéµ'} className="w-16 h-16 rounded-lg object-cover" alt=""/>
          <div className="flex-grow grid grid-cols-1 md:grid-cols-3 gap-2">
            <label className="text-sm">Ti√™u ƒë·ªÅ<input className="mt-1 px-3 py-2 rounded-lg w-full bg-[var(--bg)]/40 border border-[var(--border)]" value={local.title} onChange={e=>setLocal(v=>({...v,title:e.target.value}))}/></label>
            <label className="text-sm">Ngh·ªá sƒ©<input className="mt-1 px-3 py-2 rounded-lg w-full bg-[var(--bg)]/40 border border-[var(--border)]" value={local.artist||""} onChange={e=>setLocal(v=>({...v,artist:e.target.value}))}/></label>
            <label className="text-sm">·∫¢nh b√¨a URL<input className="mt-1 px-3 py-2 rounded-lg w-full bg-[var(--bg)]/40 border border-[var(--border)]" placeholder="https://" value={local.artwork||""} onChange={e=>setLocal(v=>({...v,artwork:e.target.value}))}/></label>
          </div>
        </div>
        <details className="mt-2">
          <summary className="cursor-pointer text-[var(--muted)]">L·ªùi b√†i h√°t</summary>
          <textarea rows="4" className="w-full mt-2 px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" value={local.lyrics||""} onChange={e=>setLocal(v=>({...v,lyrics:e.target.value}))}></textarea>
        </details>
        <div className="flex flex-wrap items-center gap-2 mt-3">
          <button onClick={()=>{onSaveOverride(s.id,local);alert("ƒê√£ l∆∞u c·ª•c b·ªô");}} className="px-3 py-2 rounded-lg bg-[var(--primary)] text-[var(--primary-fg)]">L∆∞u c·ª•c b·ªô</button>
          <button onClick={()=>onResetOverride(s.id)} className="px-3 py-2 rounded-lg bg-[var(--border)]">Xo√° ch·ªânh s·ª≠a</button>
          <button onClick={()=>onToggleHide(s.id)} className={`px-3 py-2 rounded-lg ${overrides[s.id]?.hidden?'bg-red-500/20 text-red-300':'bg-[var(--border)]'}`}>{overrides[s.id]?.hidden?'ƒêang ·∫®N (b·∫•m ƒë·ªÉ hi·ªán)':'·∫®n kh·ªèi danh s√°ch'}</button>
          {!isCustom && (<>
            <button onClick={remoteUpdate} className="px-3 py-2 rounded-lg bg-blue-500/20 border border-blue-400/30 text-blue-200">ƒê·∫©y metadata l√™n IA</button>
            <button onClick={remoteDelete} className="px-3 py-2 rounded-lg text-red-400 hover:bg-red-500/10">Xo√° file tr√™n IA</button>
          </>)}
          <span className="ml-auto text-xs text-[var(--muted)]">ID: {s.id}</span>
        </div>
      </div>
    );
  };

  // quick list (thu g·ªçn)
  const [quick,setQuick]=useState("");
  const quickList = useMemo(()=>songs.filter(s=>!overrides[s.id]?.hidden).filter(s=>!quick || (s.title||"").toLowerCase().includes(quick.toLowerCase()) || (s.artist||"").toLowerCase().includes(quick.toLowerCase())),[songs,overrides,quick]);

  return (
    <div className="px-4 space-y-8">
      <h2 className="text-2xl font-bold">C√†i ƒë·∫∑t</h2>
      <AdminBanner apiBase={apiBase}/>

      {/* K·∫øt n·ªëi API_BASE */}
      <section className="space-y-3">
        <h3 className="text-lg font-semibold">K·∫øt n·ªëi API</h3>
        <div className="bg-[var(--card)] rounded-2xl p-4 space-y-3">
          <div className="grid md:grid-cols-2 gap-2">
            <input className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" placeholder="API_BASE (https://...)" value={apiBase||""} onChange={e=>setApiBase(e.target.value)}/>
            <input className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" placeholder="Bearer token (tu·ª≥ ch·ªçn)" value={apiToken||""} onChange={e=>setApiToken(e.target.value)}/>
          </div>
          <div className="flex flex-wrap gap-2">
            {/* ƒê·ªïi t√™n n√∫t theo y√™u c·∫ßu */}
            <button onClick={()=>{save(SKEY.apiBase,apiBase||""); save(SKEY.apiToken,apiToken||""); alert("ƒê√£ l∆∞u v√†o b·ªô nh·ªõ c·ª•c b·ªô.");}} className="px-4 py-2 rounded-lg bg-[var(--border)]">L∆∞u C·ª•c b·ªô</button>
            <button onClick={saveApiToFirestore} className="px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-emerald-200">L∆∞u l√™n Firestore</button>
            <button onClick={refreshApiFromFirestore} className="px-4 py-2 rounded-lg bg-blue-500/20 border border-blue-400/30 text-blue-200">T·∫£i l·∫°i t·ª´ Firestore</button>
          </div>
          <p className="text-xs text-[var(--muted)]">Firestore doc: <span className="kbd">puppeteer-control/admin-config</span> ch·ª©a <span className="kbd">apiBase</span> v√† (tu·ª≥ ch·ªçn) <span className="kbd">bearerToken</span>.</p>
        </div>
      </section>

      {/* giao di·ªán */}
      <section className="space-y-3">
        <h3 className="text-lg font-semibold">Giao di·ªán</h3>
        <div className="bg-[var(--card)] rounded-2xl p-4 grid grid-cols-2 gap-3">
          {Object.entries(themes).map(([k,v])=>(
            <button key={k} onClick={()=>{setTheme(k);localStorage.setItem(SKEY.theme,k)}}
                    aria-current={(localStorage.getItem(SKEY.theme)||'lucbao')===k}
                    className="theme-swatch"><span className="dot" style={{'--c1':v.c1,'--c2':v.c2}}></span><span>{v.name}</span></button>
          ))}
        </div>
      </section>

      {/* h·ªá th·ªëng */}
      <section className="space-y-3">
        <h3 className="text-lg font-semibold">H·ªá th·ªëng</h3>
        <div className="flex flex-wrap gap-2">
          <button onClick={onClearCache} className="px-4 py-2 rounded-lg text-red-400 hover:bg-red-500/10">Xo√° to√†n b·ªô cache & reload</button>
          <button onClick={exportData} className="px-4 py-2 rounded-lg bg-[var(--border)]">Xu·∫•t c·∫•u h√¨nh (JSON)</button>
          <label className="px-4 py-2 rounded-lg bg-[var(--border)] cursor-pointer">Nh·∫≠p JSON<input type="file" accept="application/json" hidden onChange={importData}/></label>
        </div>
      </section>

      {/* th√™m b√†i */}
      <section className="space-y-3">
        <h3 className="text-lg font-semibold">Th√™m b√†i m·ªõi</h3>
        <div className="bg-[var(--card)] rounded-2xl p-4 space-y-3">
          <div className="grid md:grid-cols-2 gap-2">
            <input className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" placeholder="Ti√™u ƒë·ªÅ *" value={adding.title} onChange={e=>setAdding(v=>({...v,title:e.target.value}))}/>
            <input className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" placeholder="Ngh·ªá sƒ©" value={adding.artist} onChange={e=>setAdding(v=>({...v,artist:e.target.value}))}/>
            <input className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)] md:col-span-2" placeholder="URL ph√°t (mp3/ogg) *" value={adding.stream_url} onChange={e=>setAdding(v=>({...v,stream_url:e.target.value}))}/>
            <input className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" placeholder="·∫¢nh b√¨a URL" value={adding.artwork} onChange={e=>setAdding(v=>({...v,artwork:e.target.value}))}/>
            <input className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" placeholder="Th·ªùi l∆∞·ª£ng (gi√¢y)" value={adding.duration} onChange={e=>setAdding(v=>({...v,duration:e.target.value}))}/>
          </div>
          <textarea className="w-full px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" rows="3" placeholder="L·ªùi b√†i h√°t (text/LRC)" value={adding.lyrics} onChange={e=>setAdding(v=>({...v,lyrics:e.target.value}))}></textarea>
          <div className="flex flex-wrap items-center gap-2">
            <button onClick={onAddLocal} className="px-4 py-2 rounded-lg bg-[var(--primary)] text-[var(--primary-fg)]">Th√™m (c·ª•c b·ªô)</button>
            <span className="text-[var(--muted)]">‚Äî ho·∫∑c Upload l√™n IA (qua backend) ‚Äî</span>
            <input type="file" accept="audio/*" onChange={e=>setFileUp(e.target.files?.[0]||null)} className="px-2 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]"/>
            <input placeholder="Identifier IA (t√πy ch·ªçn)" className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" value={target.identifier} onChange={e=>setTarget(v=>({...v,identifier:e.target.value}))}/>
            <input placeholder="T√™n file (t√πy ch·ªçn)" className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)]" value={target.filename} onChange={e=>setTarget(v=>({...v,filename:e.target.value}))}/>
            <button onClick={doUpload} className="px-4 py-2 rounded-lg bg-blue-500/20 border border-blue-400/30 text-blue-200">Upload IA</button>
          </div>
          {!apiBase && <p className="text-xs text-yellow-300">ƒê·ªÉ upload th·∫≠t l√™n Internet Archive, c·∫ßn thi·∫øt l·∫≠p <span className="kbd">API_BASE</span> (qua Firestore ho·∫∑c nh·∫≠p tay).</p>}
        </div>
      </section>

      {/* s·ª≠a danh s√°ch hi·ªán c√≥ (compact) */}
      <section className="space-y-3">
        <h3 className="text-lg font-semibold">S·ª≠a danh s√°ch hi·ªán c√≥</h3>
        <div className="bg-[var(--card)] rounded-2xl p-4 space-y-2">
          <div className="flex flex-col md:flex-row gap-2">
            <input placeholder="L·ªçc nhanh theo t√™n/ngh·ªá sƒ©..." className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)] md:w-1/2" value={filter} onChange={e=>setFilter(e.target.value)}/>
            <select className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)] flex-1" value={selectedId} onChange={e=>setSelectedId(e.target.value)}>
              {filteredOptions.map(o=><option key={o.id} value={o.id}>{o.label}</option>)}
            </select>
            <button onClick={()=>{const s=songs.find(x=>x.id===selectedId); if(s) onPick(s);}} className="px-3 py-2 rounded-lg bg-[var(--border)]">Nghe b√†i n√†y</button>
          </div>
          <p className="text-xs text-[var(--muted)]">Ch·ªçn 1 b√†i trong danh s√°ch x·ªï xu·ªëng ƒë·ªÉ m·ªü form ch·ªânh s·ª≠a chi ti·∫øt b√™n d∆∞·ªõi.</p>
        </div>
        {selectedSong ? <Editor s={selectedSong}/> : <p className="text-[var(--muted)]">Ch∆∞a c√≥ b√†i ƒë·ªÉ s·ª≠a.</p>}
      </section>

      {/* xem nhanh danh s√°ch (thu g·ªçn) */}
      <section>
        <details className="rounded-2xl border border-[var(--border)]">
          <summary className="cursor-pointer px-4 py-3 font-semibold">Xem nhanh danh s√°ch</summary>
          <div className="p-4 space-y-3">
            <div className="flex items-center gap-2">
              <input placeholder="T√¨m nhanh..." className="px-3 py-2 rounded-lg bg-[var(--bg)]/40 border border-[var(--border)] flex-1" value={quick} onChange={e=>setQuick(e.target.value)}/>
              <span className="text-xs text-[var(--muted)]">B·∫•m ‚ÄúS·ª≠a‚Äù ƒë·ªÉ ch·ªçn b√†i ·ªü khu v·ª±c tr√™n.</span>
            </div>
            <div className="space-y-2 max-h-[50vh] overflow-y-auto pr-1">
              {quickList.map(s=>(
                <div key={s.id} className="flex items-center gap-3 p-2 rounded-xl hover:bg-[var(--card)]/50">
                  <img src={s.artwork||'https://placehold.co/40x40/1f2937/9ca3af?text=üéµ'} className="w-10 h-10 rounded-lg object-cover" alt=""/>
                  <div className="flex-grow min-w-0">
                    <p className="font-medium truncate">{s.title}</p>
                    <p className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</p>
                  </div>
                  <button onClick={()=>setSelectedId(s.id)} className="px-3 py-1.5 rounded-lg bg-[var(--border)]">S·ª≠a</button>
                </div>
              ))}
              {!quickList.length && <p className="text-[var(--muted)] text-center">Kh√¥ng c√≥ b√†i ph√π h·ª£p.</p>}
            </div>
          </div>
        </details>
      </section>
    </div>
  );
};

/* ---------- App ---------- */
function App(){
  // states
  const [theme,setTheme]=useState(localStorage.getItem(SKEY.theme)||'lucbao');
  const [songs,setSongs]=useState(load(SKEY.songs,{t:0,d:[]}).d||[]);
  const [overrides,setOverrides]=useState(load(SKEY.overrides,{}));
  const [custom,setCustom]=useState(load(SKEY.custom,[]));
  const [isLoading,setIsLoading]=useState(true);
  const [current,setCurrent]=useState(null);
  const [playing,setPlaying]=useState(false);
  const [index,setIndex]=useState(0);
  const [loop,setLoop]=useState(false);
  const [volume,setVolume]=useState(0.9);
  const [progress,setProgress]=useState({current:0,duration:0});
  const [tab,setTab]=useState('home');
  const [favs,setFavs]=useState(load(SKEY.fav,[]));

  // API from Firestore / local
  const [apiBase,setApiBaseState]=useState(load(SKEY.apiBase,""));
  const [apiToken,setApiTokenState]=useState(load(SKEY.apiToken,""));
  const setApiBase=(v)=>{setApiBaseState(v);};
  const setApiToken=(v)=>{setApiTokenState(v);};

  // audio
  const audioRef=useRef(null);
  if(!audioRef.current){const a=new Audio();a.preload='metadata';a.playsInline=true;a.crossOrigin='anonymous';audioRef.current=a;}

  // theme
  useEffect(()=>{document.documentElement.setAttribute('data-theme',theme)},[theme]);

  // Handlers
  const pickSong=s=>{ const list=mergedListRef.current; const i=list.findIndex(x=>x.id===s.id); if(i>-1){setIndex(i); setPlaying(true); haptic();} };
  const playPause=()=>{ if(!current && mergedListRef.current.length){ setIndex(0); } if(playing){audioRef.current.pause(); setPlaying(false);} else {audioRef.current.play().catch(()=>{}); setPlaying(true);} };
  const next=useCallback(()=>{ const list=mergedListRef.current; if(!list.length) return; if(loop){audioRef.current.currentTime=0; audioRef.current.play().catch(()=>{}); return;} setIndex(i=>(i+1)%list.length); },[loop]);
  const prev=useCallback(()=>{ const list=mergedListRef.current; if(!list.length) return; if(audioRef.current.currentTime>3){audioRef.current.currentTime=0; return;} setIndex(i=>(i-1+list.length)%list.length); },[]);
  const seek=e=>{const a=audioRef.current; if(!a.duration) return; const r=e.currentTarget.getBoundingClientRect(); const x=(e.clientX??e.touches?.[0]?.clientX)-r.left; const t=(x/r.width)*a.duration; if(Number.isFinite(t)) a.currentTime=t;};
  const toggleFav=id=>setFavs(f=>{const n=f.includes(id)?f.filter(x=>x!==id):[...f,id]; save(SKEY.fav,n); return n;});

  // merged list (custom + IA, √°p overrides)
  const mergedList=useMemo(()=>{
    const base=songs.map(s=>overrides[s.id]?.hidden?null:{...s,...(overrides[s.id]||{})}).filter(Boolean);
    return [...custom, ...base];
  },[songs,overrides,custom]);
  const mergedListRef=useRef(mergedList);
  useEffect(()=>{mergedListRef.current=mergedList;},[mergedList]);

  // ch·ªçn b√†i theo index
  useEffect(()=>{ if(mergedList.length){ setCurrent(mergedList[index%mergedList.length]); } else { setCurrent(null); setPlaying(false);} },[index,mergedList]);

  // audio life-cycle
  useEffect(()=>{
    const a=audioRef.current;
    const onErr=()=>{console.warn("audio error",current?.title); next();};
    a.addEventListener('error',onErr);
    let raf=0,last=0; const TICK=250;
    const loopTick=(ts)=>{const tick=document.hidden?1000:TICK; if(!a.paused&&a.duration){if(ts-last>=tick){last=ts; setProgress({current:a.currentTime,duration:a.duration});}} raf=requestAnimationFrame(loopTick);};
    const start=()=>{cancelAnimationFrame(raf); raf=requestAnimationFrame(loopTick);};
    const stop=()=>cancelAnimationFrame(raf);
    const ended=()=>next();
    const canplay=()=>setProgress(p=>({...p,duration:a.duration}));
    a.addEventListener('play',start); a.addEventListener('pause',stop); a.addEventListener('ended',ended); a.addEventListener('canplay',canplay);
    start();
    return ()=>{stop(); a.removeEventListener('error',onErr); a.removeEventListener('play',start); a.removeEventListener('pause',stop); a.removeEventListener('ended',ended); a.removeEventListener('canplay',canplay);};
  },[next,current?.title]);

  useEffect(()=>{audioRef.current.volume=volume;},[volume]);
  useEffect(()=>{const a=audioRef.current; if(current){ if(a.src!==current.stream_url) a.src=current.stream_url; if(playing) a.play().catch(()=>{}); else a.pause(); document.title=`${playing?'‚ñ∂':'‚è∏'} ${current.title} - MSTQ`; } else { document.title='MSTQ Music'; }},[current,playing]);

  // Fetch IA list
  useEffect(()=>{
    const parseDur=t=>{
      if(typeof t==='number') return t;
      const s=String(t||""); if(/^\d+:\d{2}$/.test(s)){const[m,ss]=s.split(':').map(Number);return m*60+ss;}
      const n=parseFloat(s); return Number.isFinite(n)?n:0;
    };
    const build=async(docs)=>{
      const out=[];
      for(const it of docs){
        try{
          const meta=await fetch(`https://archive.org/metadata/${it.identifier}`,{cache:'no-store'}).then(r=>r.json());
          const files=(meta.files||[]).filter(f=>/(MP3|MPEG|OGG)/i.test(f.format||""));
          for(const f of files){
            out.push({
              id:`${it.identifier}/${f.name}`,
              title:(f.title||it.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim()||'Untitled',
              artist:it.creator||'TinhQuang',
              stream_url:`https://archive.org/download/${it.identifier}/${encodeURIComponent(f.name)}`,
              artwork:`https://archive.org/download/${it.identifier}/__ia_thumb.jpg`,
              duration:parseDur(f.length), lyrics:it.description||null, item_identifier:it.identifier
            });
          }
        }catch(e){console.warn("skip",it?.identifier,e)}
      }
      return out;
    };
    const run=async()=>{
      setIsLoading(true);
      const cached=load(SKEY.songs,{t:0,d:[]}).d||[];
      if(cached.length){setSongs(cached);setIsLoading(false);}
      try{
        const q=encodeURIComponent('(uploader:(tinhquang) OR uploader:(thiensutinhquang)) AND mediatype:(audio)');
        const url=`https://archive.org/advancedsearch.php?q=${q}&fl[]=identifier&fl[]=title&fl[]=creator&fl[]=description&sort[]=publicdate+desc&rows=200&page=1&output=json`;
        const res=await fetch(url,{cache:'no-store'}).then(r=>r.json());
        const docs=res?.response?.docs||[];
        const list=await build(docs);
        save(SKEY.songs,{t:Date.now(),d:list}); setSongs(list);
      }catch(e){console.error("IA fetch fail",e)}
      finally{setIsLoading(false)}
    };
    run();
  },[]);

  // Firestore: load API_BASE + token khi v√†o Settings l·∫ßn ƒë·∫ßu
  const fetchedFromFsRef=useRef(false);
  const refreshApiFromFirestore=async()=>{
    if(!firestore){alert("Firestore ch∆∞a s·∫µn s√†ng (v·∫´n d√πng c·∫•u h√¨nh c·ª•c b·ªô).");return;}
    try{
      const docRef=firestore.collection("puppeteer-control").doc("admin-config");
      const snap=await docRef.get();
      if(snap.exists){
        const data=snap.data()||{};
        if(data.apiBase){ setApiBaseState(data.apiBase); save(SKEY.apiBase,data.apiBase); }
        if(data.bearerToken){ setApiTokenState(data.bearerToken); save(SKEY.apiToken,data.bearerToken); }
        alert("ƒê√£ n·∫°p API_BASE t·ª´ Firestore.");
      }else{
        alert("Kh√¥ng t√¨m th·∫•y puppeteer-control/admin-config.");
      }
    }catch(e){
      console.error("Firestore load error:",e);
      alert("L·ªói t·∫£i t·ª´ Firestore (xem console).");
    }
  };
  // NEW: L∆∞u l√™n Firestore (theo y√™u c·∫ßu)
  const saveApiToFirestore=async()=>{
    if(!firestore){alert("Firestore ch∆∞a s·∫µn s√†ng.");return;}
    try{
      const docRef=firestore.collection("puppeteer-control").doc("admin-config");
      await docRef.set({ apiBase: apiBase||"", bearerToken: apiToken||"" }, { merge:true });
      alert("ƒê√£ l∆∞u API_BASE/token l√™n Firestore.");
    }catch(e){
      console.error("Firestore save error:",e);
      alert("L·ªói l∆∞u l√™n Firestore (xem console).");
    }
  };

  useEffect(()=>{
    if(tab==='settings' && !fetchedFromFsRef.current){
      fetchedFromFsRef.current=true;
      refreshApiFromFirestore();
    }
  },[tab]);

  // API helpers theo apiBase hi·ªán t·∫°i
  const api = async(path,opts={})=>{
    if(!apiBase) throw new Error("No API_BASE configured");
    const headers={'Authorization': apiToken?`Bearer ${apiToken}`:undefined, ...(opts.headers||{})};
    const res=await fetch(`${apiBase}${path}`,{...opts,headers});
    if(!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
    const ct=res.headers.get("content-type")||"";
    return ct.includes("application/json")?res.json():res.text();
  };
  const iaDelete=async(song)=>{ const [identifier,filename]=[song.item_identifier,decodeURIComponent(song.id.split('/').slice(1).join('/'))]; return api('/ia/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({identifier,filename})}); };
  const iaUpload=async(formData)=>{ const headers={'Authorization': apiToken?`Bearer ${apiToken}`:undefined}; const res=await fetch(`${apiBase}/ia/upload`,{method:'POST',body:formData,headers}); if(!res.ok) throw new Error(await res.text()); return res.json(); };
  const iaUpdate=async(song,patch)=>{ const [identifier,filename]=[song.item_identifier,decodeURIComponent(song.id.split('/').slice(1).join('/'))]; return api('/ia/update-metadata',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({identifier,filename,patch})}); };

  // system utils
  const clearAll=async()=>{try{if('caches' in window){const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k)));} localStorage.clear();}finally{location.reload();}};
  const exportData=()=>{const blob=new Blob([JSON.stringify({overrides,custom},null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='mstq-admin-data.json';a.click();URL.revokeObjectURL(url);};
  const importData=e=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const j=JSON.parse(r.result); if(j.overrides){setOverrides(j.overrides); save(SKEY.overrides,j.overrides);} if(j.custom){setCustom(j.custom); save(SKEY.custom,j.custom);} alert('ƒê√£ nh·∫≠p d·ªØ li·ªáu.'); }catch{ alert('File kh√¥ng h·ª£p l·ªá'); }}; r.readAsText(f); };

  // UI paddings
  const pad = current ? "160px" : "80px";

  return (
    <div className="min-h-screen">
      <header className="fixed top-0 inset-x-0 z-30 p-4 flex items-center justify-between bg-[var(--bg)]/80 backdrop-blur-lg border-b border-[var(--border)]">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 rounded-lg bg-[var(--gradient)] grid place-items-center">üéµ</div>
          <h1 className="text-lg font-bold">MSTQ Music</h1>
        </div>
        <div className="text-xs text-[var(--muted)]">{apiBase ? "Backend ‚úì" : "Local only"}</div>
      </header>

      <main className="pt-20" style={{paddingBottom:pad}}>
        {tab==='home'    && <HomeView   songs={mergedList} onPick={pickSong} activeId={current?.id} isLoading={isLoading}/>}
        {tab==='search'  && <SearchView songs={mergedList} onPick={pickSong} activeId={current?.id}/>}
        {tab==='library' && <LibraryView songs={mergedList} onPick={pickSong} activeId={current?.id} favs={favs}/>}
        {tab==='settings'&& <SettingsView
          theme={theme} setTheme={setTheme}
          onClearCache={clearAll}
          overrides={overrides} setOverrides={setOverrides}
          custom={custom} setCustom={setCustom}
          songs={mergedList} onPick={pickSong}
          exportData={exportData} importData={importData}
          doDeleteIA={iaDelete} doUploadIA={iaUpload} doUpdateMetaIA={iaUpdate}
          apiBase={apiBase} setApiBase={setApiBase}
          apiToken={apiToken} setApiToken={setApiToken}
          refreshApiFromFirestore={refreshApiFromFirestore}
          saveApiToFirestore={saveApiToFirestore}
        />}
      </main>

      <Mini song={current} playing={playing} onPlay={playPause} onNext={next} onPrev={prev}
            progress={progress} seek={seek} isFav={favs.includes(current?.id)} toggleFav={toggleFav}/>
      <Tabs active={tab} setActive={setTab}/>
    </div>
  );
}

/* ---------- Render with ErrorBoundary ---------- */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ErrorBoundary><App/></ErrorBoundary>);
  </script>
</body>
</html>

