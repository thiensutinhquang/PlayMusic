<!DOCTYPE html>
<html lang="vi" data-theme="lucbao">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f59e0b" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>MSTQ Music – Nghe nhạc liên tục</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" sizes="192x192" href="/PlayMusic/images/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/PlayMusic/images/icons/icon-512x512.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel (JSX inline) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root,[data-theme]{transition:color .2s ease,background-color .2s ease}
    :root{
      --bg:#0b132b;--card:#0f1b2d;--text:#eaf2ff;--muted:#93a3b8;
      --primary:#f59e0b;--primary-fg:#0b132b;
      --ring:#f59e0b66;--border:#203047;--nav-bg:rgba(16,24,40,.88);
      --shadow:0 12px 36px rgba(0,0,0,.28);--gradient:linear-gradient(135deg,#60a5fa 0%,#f59e0b 100%)
    }
    [data-theme=light]{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#0ea5e9;--primary-fg:#ffffff;--ring:#0ea5e955;--border:#e5e7eb;--nav-bg:rgba(255,255,255,.92);--gradient:linear-gradient(135deg,#93c5fd 0%,#67e8f9 100%)}
    [data-theme=lucbao]{--bg:#081414;--card:#102424;--text:#e0f2f1;--muted:#80cbc4;--primary:#f4ff81;--primary-fg:#0c1113;--ring:#f4ff8166;--border:color-mix(in srgb,var(--text) 10%, transparent);--nav-bg:rgba(16,36,36,.86);--gradient:linear-gradient(135deg,#a8ff78 0%,#f4ff81 100%)}
    [data-theme=dark]{--bg:#0d0f14;--card:#131720;--text:#e5e7eb;--muted:#a3a9b6;--primary:#f59e0b;--primary-fg:#0b132b;--ring:#f59e0b66;--border:#232836;--nav-bg:rgba(19,23,32,.9)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:var(--card);color:var(--text);padding:.7rem .95rem;border-radius:14px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--primary);color:var(--primary-fg);border-color:transparent}
    .chip{font-size:.7rem;border:1px solid var(--border);padding:.15rem .45rem;border-radius:999px;color:var(--muted)}
    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:40;backdrop-filter:blur(8px);background:var(--nav-bg);border-top:1px solid var(--border)}
    .tabbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:.6rem 0;font-size:.78rem;color:var(--muted)}
    .tabbtn[aria-current=true]{color:var(--text)}
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 12px)}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow);z-index:60;padding:10px}
    .err{position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;text-align:left}
    .err-card{background:#111827;border:1px solid #374151;border-radius:14px;max-width:900px;width:100%;padding:18px}
    input[type="range"]{accent-color:#f59e0b}
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--text)]">
  <div id="root"></div>

  <!-- 2 audio: main + preload (muted) -->
  <audio id="mstq-player" preload="metadata" playsinline webkit-playsinline crossOrigin="anonymous"></audio>
  <audio id="mstq-preload" preload="auto" playsinline webkit-playsinline muted crossOrigin="anonymous"></audio>

  <!-- Error overlay -->
  <div id="err" class="err">
    <div class="err-card">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">Đã bắt lỗi runtime</h3>
        <button onclick="document.getElementById('err').style.display='none'" class="btn">Đóng</button>
      </div>
      <pre id="errlog" class="mt-3 whitespace-pre-wrap text-sm"></pre>
    </div>
  </div>

  <script>
    (function(){
      const show=(m)=>{const el=document.getElementById('err');const log=document.getElementById('errlog');if(log)log.textContent=String(m||'Unknown');if(el)el.style.display='flex';console.error('[GLOBAL ERROR]',m)};
      window.addEventListener('error',e=>show(e.error||e.message||e));
      window.addEventListener('unhandledrejection',e=>show(e.reason||e));
    })();
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
    }
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useRef,useMemo,useCallback} = React;

    /* ===== Keys & utils ===== */
    const SONGS_CACHE_KEY='mstq_songs_v6';
    const RESUME_KEY='mstq_resume_v9';
    const THEME_KEY='music-theme', SPEED_KEY='mstq_speed', MUTED_KEY='mstq_muted';
    const SHUFFLE_KEY='mstq_shuffle', REPEAT_KEY='mstq_repeat';
    const POWER_KEY='mstq_power_save', TIMER_KEY='mstq_sleep_timer', STOP_END_KEY='mstq_stop_at_end';
    const SRC_PREF_KEY='mstq_sources_pref', FAVORITES_KEY='mstq_favorites_v1';
    const COMPRESSOR_KEY='mstq_compressor_on';
    const INITIAL_VISIBLE=110, VISIBLE_STEP=150;

    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
    const clamp=(x,min,max)=>Math.min(Math.max(x,min),max);
    const formatTime=s=>{if(!isFinite(s)||s<0)return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${String(sec).padStart(2,'0')}`};

    const LINKS={home:'/',youtube:'https://youtube.com/',tiktok:'https://www.tiktok.com/',facebook:'https://www.facebook.com/groups/',telegram:'https://t.me/',zalo:'https://zalo.me/'};

    const I = (d=22,p="M5 12h14") => <svg width={d} height={d} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.7"><path d={p} strokeLinecap="round" strokeLinejoin="round"/></svg>;
    const ICONS={
      home:(d)=>I(d,"M3 10.5 12 3l9 7.5v8.5a1.5 1.5 0 0 1-1.5 1.5H4.5A1.5 1.5 0 0 1 3 19V10.5Z"),
      search:(d)=>I(d,"M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"),
      lib:(d)=>I(d,"M4 19h16M6 17V5a2 2 0 0 1 2-2h0M12 17V3h0M18 17V7a2 2 0 0 0-2-2h0"),
      settings:(d)=>I(d,"M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7Z M19.4 15l1.1 1.9-1.7 3-2.2-.4-.9 1.9h-3.4l-.9-1.9-2.2.4-1.7-3 1.1-1.9-1.1-1.9 1.7-3 2.2.4.9-1.9h3.4l.9 1.9 2.2-.4 1.7 3-1.1 1.9Z"),
      admin:(d)=>I(d,"M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm0 2c-4 0-7 2-7 4v3h14v-3c0-2-3-4-7-4Z"),
      play:(d)=>I(d,"M8 5v14l11-7z"), pause:(d)=>I(d,"M6 5h4v14H6zM14 5h4v14h-4z"),
      next:(d)=>I(d,"m13 5 9 7-9 7V5zM2 19V5h2v14H2z"), back:(d)=>I(d,"M11 19 2 12l9-7v14zm1-7 9 7V5l-9 7z"),
      more:(d)=>I(d,"M6 12h.01M12 12h.01M18 12h.01"), share:(d)=>I(d,"M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M16 6l-4-4-4 4M12 2v12")
    };

    /* =============== APP =============== */
    function App(){
      /* Tabs & theme */
      const [tab,setTab]=useState('home');
      const [theme,setTheme]=useState(localStorage.getItem(THEME_KEY)||'lucbao');
      const [linksOpen,setLinksOpen]=useState(false);
      useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);localStorage.setItem(THEME_KEY,theme);},[theme]);
      useEffect(()=>{
        const onClick=(e)=>{ if(!document.getElementById('btn-links')?.contains(e.target)) setLinksOpen(false); };
        window.addEventListener('click',onClick); return()=>window.removeEventListener('click',onClick);
      },[]);

      /* PWA install */
      const installEvtRef=useRef(null);
      const [canInstall,setCanInstall]=useState(false);
      useEffect(()=>{
        const onPrompt=(e)=>{ e.preventDefault(); installEvtRef.current=e; setCanInstall(true); };
        window.addEventListener('beforeinstallprompt',onPrompt);
        window.addEventListener('appinstalled',()=>setCanInstall(false));
        return()=>window.removeEventListener('beforeinstallprompt',onPrompt);
      },[]);
      const askInstall=async()=>{ try{ await installEvtRef.current?.prompt(); }catch{} };

      /* Data & playback */
      const [songs,setSongs]=useState([]);
      const [playlist,setPlaylist]=useState([]);
      const [loading,setLoading]=useState(true);
      const [visible,setVisible]=useState(INITIAL_VISIBLE);
      const [filter,setFilter]=useState('');
      const [sourcePref,setSourcePref]=useState(load(SRC_PREF_KEY,{archive:true,custom:false,customText:""}));
      useEffect(()=>save(SRC_PREF_KEY,sourcePref),[sourcePref]);

      const [currentIndex,setCurrentIndex]=useState(0);
      const [playing,setPlaying]=useState(false);
      const [progress,setProgress]=useState({current:0,duration:0});
      const [shuffle,setShuffle]=useState(load(SHUFFLE_KEY,false));
      const [repeat,setRepeat]=useState(load(REPEAT_KEY,'all')); // off|one|all
      const [stopAtEnd,setStopAtEnd]=useState(load(STOP_END_KEY,false));
      useEffect(()=>save(SHUFFLE_KEY,shuffle),[shuffle]);
      useEffect(()=>save(REPEAT_KEY,repeat),[repeat]);
      useEffect(()=>save(STOP_END_KEY,stopAtEnd),[stopAtEnd]);

      /* Up Next queue */
      const [upNext,setUpNext]=useState([]); // array of track ids
      const enqueueNext=(s)=>{ setUpNext(q=> q.includes(s.id)? q : [...q,s.id]); };
      const dequeueNext=()=>{ let out=null; setUpNext(q=>{ if(!q.length) return q; out=q[0]; return q.slice(1); }); return out; };

      /* Audio refs & WebAudio compressor */
      const audioRef=useRef(null);
      const preloadRef=useRef(null);
      useEffect(()=>{ audioRef.current=document.getElementById('mstq-player'); preloadRef.current=document.getElementById('mstq-preload'); },[]);
      const interactedRef=useRef(false);
      useEffect(()=>{ const m=()=>{interactedRef.current=true;document.removeEventListener('click',m);document.removeEventListener('keydown',m)};document.addEventListener('click',m,{once:true});document.addEventListener('keydown',m,{once:true});},[]);

      const [volume,setVolume]=useState(load(RESUME_KEY,{volume:.95}).volume??.95);
      const [playbackRate,setPlaybackRate]=useState(parseFloat(localStorage.getItem(SPEED_KEY)||'1')||1);
      const [muted,setMuted]=useState(localStorage.getItem(MUTED_KEY)==='1');
      const [compressorOn,setCompressorOn]=useState(load(COMPRESSOR_KEY,true));

      const audioCtxRef=useRef(null);
      const compNodeRef=useRef(null);
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        if(!audioCtxRef.current){
          try{
            const ctx=new (window.AudioContext||window.webkitAudioContext)();
            const src=ctx.createMediaElementSource(a);
            const comp=ctx.createDynamicsCompressor();
            comp.threshold.setValueAtTime(-18, ctx.currentTime);
            comp.knee.setValueAtTime(24, ctx.currentTime);
            comp.ratio.setValueAtTime(6, ctx.currentTime);
            comp.attack.setValueAtTime(0.008, ctx.currentTime);
            comp.release.setValueAtTime(0.25, ctx.currentTime);
            src.connect(comp).connect(ctx.destination);
            audioCtxRef.current=ctx; compNodeRef.current=comp;
          }catch{}
        }
      },[]);
      useEffect(()=>{ save(COMPRESSOR_KEY,compressorOn); if(compNodeRef.current){ compNodeRef.current.disconnect(); if(compressorOn){ const ctx=audioCtxRef.current; const a=audioRef.current; try{ const src=ctx.createMediaElementSource(a); src.connect(compNodeRef.current).connect(ctx.destination); }catch{} } } },[compressorOn]);

      useEffect(()=>{const a=audioRef.current;if(a){a.volume=volume}},[volume]);
      useEffect(()=>{const a=audioRef.current;if(a){a.playbackRate=playbackRate}localStorage.setItem(SPEED_KEY,String(playbackRate))},[playbackRate]);
      useEffect(()=>{const a=audioRef.current;if(a){a.muted=muted}localStorage.setItem(MUTED_KEY,muted?'1':'0')},[muted]);

      /* Power save & sleep timer */
      const [powerSave,setPowerSave]=useState(load(POWER_KEY,false));
      useEffect(()=>save(POWER_KEY,powerSave),[powerSave]);

      const [timerLeft,setTimerLeft]=useState(load(TIMER_KEY,null));
      const timerRef=useRef(null);
      const startSleepTimer=(ms)=>{
        clearInterval(timerRef.current);
        const end=Date.now()+ms;
        setTimerLeft(ms); save(TIMER_KEY,ms);
        timerRef.current=setInterval(()=>{
          const left=end-Date.now();
          if(left<=0){ clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null); pauseAll(); }
          else setTimerLeft(left);
        },1000);
      };
      const cancelSleepTimer=()=>{clearInterval(timerRef.current); setTimerLeft(null); save(TIMER_KEY,null);};
      useEffect(()=>{ const v=load(TIMER_KEY,null); if(v&&v>0) startSleepTimer(v); return()=>clearInterval(timerRef.current); },[]);

      /* Sources */
      const FALLBACK_SONGS=[{id:"testmp3testfile/mpthreetest.mp3",title:"Bài hát mẫu (Tạm thời)",artist:"Public Domain",stream_url:"https://archive.org/download/testmp3testfile/mpthreetest.mp3",artwork:"/PlayMusic/images/icons/icon-192x192.png",duration:5,lyrics:"Bài mẫu.",item_identifier:"testmp3testfile"}];

      const parseCustomM3UorText=(txt)=>{
        const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const out=[]; let lastTitle="";
        for(const ln of lines){
          if(ln.startsWith('#EXTINF:')){ const t=ln.split(',').slice(1).join(',').trim(); if(t) lastTitle=t; }
          else if(/^https?:\/\//i.test(ln)){
            out.push({id:ln,title:lastTitle||ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:'/PlayMusic/images/icons/icon-192x192.png',duration:0,lyrics:'',item_identifier:'custom'});
            lastTitle="";
          }
        }
        if(!out.length){
          for(const ln of lines){
            if(/^https?:\/\//i.test(ln)){
              out.push({id:ln,title:ln.split('/').pop(),artist:'Custom',stream_url:ln,artwork:'/PlayMusic/images/icons/icon-192x192.png',duration:0,lyrics:'',item_identifier:'custom'});
            }
          }
        }
        return out;
      };

      const refetch=useCallback(async()=>{
        setLoading(true);
        const cached=load(SONGS_CACHE_KEY,null);
        if(cached?.length){setSongs(cached);setPlaylist(cached);setLoading(false)}
        try{
          let all=[];
          if(sourcePref.archive!==false){
            const queries=[
              'uploader:(tinhquang) AND mediatype:(audio)',
              'uploader:(thiensutinhquang) AND mediatype:(audio)',
              'creator:("Minh Su Tinh Quang") AND mediatype:(audio)'
            ];
            let docs=[];let ok=false;
            for(const q of queries){
              const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&fl[]=identifier,title,creator,description&sort[]=publicdate+desc&rows=200&page=1&output=json`;
              const r=await fetch(url,{cache:'no-store'}); if(!r.ok) continue;
              const j=await r.json(); const list=j?.response?.docs||[]; if(list.length){docs=list;ok=true;break;}
            }
            if(ok){
              for(const d of docs){
                try{
                  const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                  (meta.files||[]).forEach(f=>{
                    if(String(f.format||'').toUpperCase().includes('MP3')){
                      all.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'TinhQuang',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                    }
                  });
                }catch{}
              }
            }
          }
          if(sourcePref.custom && sourcePref.customText?.trim()){
            all=[...all, ...parseCustomM3UorText(sourcePref.customText)];
          }
          if(!all.length){ all=FALLBACK_SONGS; }
          save(SONGS_CACHE_KEY,all); setSongs(all); setPlaylist(all);
        }catch{
          if(!cached?.length){ setSongs(FALLBACK_SONGS); setPlaylist(FALLBACK_SONGS); }
        }
        setLoading(false);
      },[sourcePref]);
      useEffect(()=>{refetch()},[]);

      const current=playlist[currentIndex]||null;

      /* Preload an toàn */
      const queuePreload=useCallback((idx)=>{
        const n=(idx+1)%playlist.length;
        const next=playlist[n]; const pre=preloadRef.current;
        if(!next||!pre) return;
        if (powerSave || document.visibilityState!=='visible') { pre.removeAttribute('src'); pre.load(); return; }
        if (isiOS && document.visibilityState!=='visible') return;
        if(pre.src!==next.stream_url){ pre.src=next.stream_url; pre.load(); }
      },[playlist,powerSave]);
      useEffect(()=>{ if(playlist.length) queuePreload(currentIndex); },[playlist.length,currentIndex,queuePreload]);
      useEffect(()=>{ const h=()=>queuePreload(currentIndex); document.addEventListener('visibilitychange',h); return()=>document.removeEventListener('visibilitychange',h); },[queuePreload,currentIndex]);

      /* Media Session */
      useEffect(()=>{
        const a=audioRef.current; if(!a||!current||!('mediaSession' in navigator)) return;
        try{
          navigator.mediaSession.metadata=new MediaMetadata({
            title:current.title, artist:current.artist||'minhsutinhquang', album:'MSTQ Music',
            artwork:[{src:current.artwork||'/PlayMusic/images/icons/icon-192x192.png',sizes:'512x512',type:'image/png'}]
          });
          navigator.mediaSession.setActionHandler('play',()=>{ setPlaying(true); a.play().catch(()=>{}); });
          navigator.mediaSession.setActionHandler('pause',()=>{ setPlaying(false); a.pause(); });
          navigator.mediaSession.setActionHandler('previoustrack',()=>prevTrack());
          navigator.mediaSession.setActionHandler('nexttrack',()=>nextTrack());
          navigator.mediaSession.setActionHandler('seekto',d=>{ if(d.seekTime!=null) a.currentTime=d.seekTime; });
          navigator.mediaSession.playbackState=playing?'playing':'paused';
        }catch{}
      },[current,playing]);

      /* Watchdog */
      const targetPlayingRef=useRef(false);
      const lastProgRef=useRef({t:0,pos:0});
      const stallScoreRef=useRef(0);
      const lastManualPauseRef=useRef(0);
      const lastRecoverRef=useRef(0);

      useEffect(()=>{
        let lock=null;
        const reqLock=async()=>{try{if('wakeLock'in navigator && document.visibilityState==='visible'){lock=await navigator.wakeLock.request('screen');}}catch{}};
        const vis=()=>{ if(document.visibilityState==='visible'){ reqLock(); if(targetPlayingRef.current){ audioRef.current?.play?.().catch(()=>{}); } } };
        reqLock(); document.addEventListener('visibilitychange',vis);
        return()=>{document.removeEventListener('visibilitychange',vis);try{lock?.release?.()}catch{}};
      },[]);

      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const onTime=()=>{ if(!isFinite(a.duration)) return; setProgress({current:a.currentTime||0,duration:a.duration||0});
          const now=Date.now();
          if(Math.abs(a.currentTime-(lastProgRef.current.pos||0))>0.25){ lastProgRef.current={t:now,pos:a.currentTime}; stallScoreRef.current=0; }
        };
        const onEnded=()=>{ handleEnd(); };
        const onPause=()=>{ if(!targetPlayingRef.current){ lastManualPauseRef.current=Date.now(); } };
        a.addEventListener('timeupdate',onTime);
        a.addEventListener('ended',onEnded);
        ['stalled','suspend','waiting','error','abort'].forEach(e=>a.addEventListener(e,()=>{}));
        a.addEventListener('pause',onPause);
        return()=>{a.removeEventListener('timeupdate',onTime);a.removeEventListener('ended',onEnded);['stalled','suspend','waiting','error','abort'].forEach(e=>a.removeEventListener(e,()=>{}));a.removeEventListener('pause',onPause);};
      },[]);

      useEffect(()=>{
        const interval = powerSave ? 8000 : 5000;
        const tick=setInterval(async()=>{
          const a=audioRef.current; if(!a||!current) return;
          save(RESUME_KEY,{index:currentIndex,id:current.id,currentTime:a.currentTime||0,volume:a.volume,rate:a.playbackRate,muted:a.muted,playing:targetPlayingRef.current});
          if(!targetPlayingRef.current) return;
          if(Date.now()-lastManualPauseRef.current<1500) return;

          const stagnate = (Date.now()-(lastProgRef.current.t||0) > (document.visibilityState==='visible'?(powerSave?28000:20000):(powerSave?15000:12000)));
          const poorReady = a.readyState<2;
          const now=Date.now();
          const canRecover = now - (lastRecoverRef.current||0) > (powerSave?3500:2500);

          if(a.paused && canRecover){
            lastRecoverRef.current=now;
            try{ await a.play(); return; }catch{}
          }
          if((stagnate || poorReady) && canRecover){
            lastRecoverRef.current=now;
            stallScoreRef.current++;
            try{
              if(a.paused) await a.play();
              if(a.paused || poorReady){ a.load(); await a.play().catch(()=>{}); }
              const limit=(document.visibilityState==='visible'?(powerSave?4:3):(powerSave?3:2));
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(); }
            }catch{
              const limit=(document.visibilityState==='visible'?(powerSave?4:3):(powerSave?3:2));
              if(stallScoreRef.current>=limit){ stallScoreRef.current=0; nextTrack(); }
            }
          }
        },interval);
        return()=>clearInterval(tick);
      },[currentIndex,current,powerSave]);

      /* Controls & queue */
      const computeNextIndex = useCallback((dir)=> {
        if(!playlist.length) return 0;
        if(shuffle){
          let r=Math.floor(Math.random()*playlist.length);
          if (r===currentIndex) r=(r+1)%playlist.length;
          return r;
        }
        if(dir>0) return (currentIndex+1)%playlist.length;
        if(dir<0) return (currentIndex-1+playlist.length)%playlist.length;
        return currentIndex;
      },[playlist.length,shuffle,currentIndex]);

      const nextTrack=useCallback(()=>{
        if(!playlist.length) return;
        // ưu tiên Up Next
        let nextId=null;
        if(upNext.length){ nextId=upNext[0]; setUpNext(q=>q.slice(1)); }
        if(nextId){
          const i=playlist.findIndex(x=>x.id===nextId);
          if(i>=0){ setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i); return; }
        }
        const i=computeNextIndex(+1);
        setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i);
      },[playlist.length,computeNextIndex,queuePreload,upNext]);

      const prevTrack=useCallback(()=>{
        if(!playlist.length) return;
        const a=audioRef.current; if(a?.currentTime>3){ a.currentTime=0; return; }
        const i=computeNextIndex(-1);
        setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i);
      },[playlist.length,computeNextIndex,queuePreload]);

      const handleEnd=useCallback(()=>{
        if(repeat==='one'){ const a=audioRef.current; if(a){ a.currentTime=0; a.play().catch(()=>{});} return; }
        if((stopAtEnd || repeat==='off') && currentIndex===playlist.length-1 && !upNext.length){ setPlaying(false); targetPlayingRef.current=false; return; }
        nextTrack();
      },[repeat,stopAtEnd,currentIndex,playlist.length,nextTrack,upNext.length]);

      const pickSong=(s)=>{
        const i=playlist.findIndex(x=>x.id===s.id);
        if(i>=0){ setCurrentIndex(i); setPlaying(true); targetPlayingRef.current=true; queuePreload(i); }
      };

      const playPause=()=>{
        const a=audioRef.current; if(!a) return;
        if(!current && playlist.length){ setCurrentIndex(0); setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); return; }
        if(playing){ setPlaying(false); targetPlayingRef.current=false; a.pause(); }
        else{ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
      };
      const pauseAll=()=>{const a=audioRef.current; if(a){ setPlaying(false); targetPlayingRef.current=false; a.pause(); }};

      /* Resume on load */
      useEffect(()=>{
        const a=audioRef.current; if(!a) return;
        const r=load(RESUME_KEY,null);
        if(r&&playlist.length){
          const idx=Math.min(Math.max(0,r.index||0),playlist.length-1);
          setCurrentIndex(idx);
          setTimeout(()=>{ const s=playlist[idx]; if(!s) return;
            if(a.src!==s.stream_url){ a.src=s.stream_url; a.load(); }
            a.currentTime=Number(r.currentTime||0); a.volume=r.volume??volume; a.playbackRate=r.rate??playbackRate; a.muted=!!r.muted;
            if(r.playing){ setPlaying(true); targetPlayingRef.current=true; a.play().catch(()=>{}); }
          },0);
        }
      // eslint-disable-next-line react-hooks/exhaustive-deps
      },[playlist.length]);

      /* Favorites */
      const [favs,setFavs]=useState(load(FAVORITES_KEY,[]));
      const isFav=(s)=>favs.some(x=>x.id===s.id);
      const toggleFav=(s)=>{
        setFavs((prev)=>{
          const ex=isFav(s);
          const out = ex ? prev.filter(x=>x.id!==s.id) : [{id:s.id,title:s.title,artist:s.artist,artwork:s.artwork},...prev].slice(0,200);
          save(FAVORITES_KEY,out); return out;
        });
      };

      /* ===== UI ===== */
      const TopBar=({title})=>(
        <header className="fixed top-0 inset-x-0 z-30 px-4 py-3 flex items-center justify-between bg-[var(--nav-bg)] backdrop-blur-lg border-b border-[var(--border)]">
          <div className="flex items-center gap-2">
            <img src="/PlayMusic/images/icons/icon-192x192.png" width="28" height="28" className="rounded-lg" alt="MSTQ"/>
            <h1 className="font-bold">{title}</h1>
          </div>
          <div className="flex items-center gap-2">
            {canInstall && <button className="btn" onClick={askInstall}>Cài đặt ứng dụng</button>}
            <div className="relative">
              <button id="btn-links" className="btn" onClick={()=>setLinksOpen(v=>!v)}>Liên kết ▾</button>
              {linksOpen && (
                <div className="absolute right-0 mt-2 w-56 rounded-2xl border border-[var(--border)] bg-[var(--card)] shadow-xl p-1 z-50">
                  <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5" onClick={()=>window.open(LINKS.home,'_blank')}>🏠 Trang chủ</button>
                  <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5" onClick={()=>window.open(LINKS.youtube,'_blank')}>🔗 YOUTUBE</button>
                  <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5" onClick={()=>window.open(LINKS.tiktok,'_blank')}>🔗 TIKTOK</button>
                  <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5" onClick={()=>window.open(LINKS.facebook,'_blank')}>🔗 FACEBOOK Group</button>
                  <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5" onClick={()=>window.open(LINKS.telegram,'_blank')}>🔗 TELEGRAM</button>
                  <button className="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5" onClick={()=>window.open(LINKS.zalo,'_blank')}>🔗 ZALO</button>
                </div>
              )}
            </div>
            <button className="btn" onClick={()=>setTheme(t=>t==='lucbao'?'light':'lucbao')}>Chủ đề</button>
          </div>
        </header>
      );

      const TabBar=()=>(
        <nav className="tabbar safe-bottom">
          <div className="flex">
            <button className="tabbtn" aria-current={tab==='home'} onClick={()=>setTab('home')}>{ICONS.home(22)}<span>Trang chủ</span></button>
            <button className="tabbtn" aria-current={tab==='search'} onClick={()=>setTab('search')}>{ICONS.search(22)}<span>Tìm kiếm</span></button>
            <button className="tabbtn" aria-current={tab==='library'} onClick={()=>setTab('library')}>{ICONS.lib(22)}<span>Thư viện</span></button>
            <button className="tabbtn" aria-current={tab==='settings'} onClick={()=>setTab('settings')}>{ICONS.settings(22)}<span>Cài đặt</span></button>
            <button className="tabbtn" aria-current={tab==='admin'} onClick={()=>setTab('admin')}>{ICONS.admin(22)}<span>Admin</span></button>
          </div>
        </nav>
      );

      const [sheetFor,setSheetFor]=useState(null); // track object to show sheet
      const closeSheet=()=>setSheetFor(null);

      const HomeTab = () => {
        const filtered = filter.trim()
          ? playlist.filter(s => (s.title||'').toLowerCase().includes(filter.toLowerCase()) || (s.artist||'').toLowerCase().includes(filter.toLowerCase()))
          : playlist;
        return (
          <div className="px-4 py-3">
            <div className="flex items-center justify-between mb-2">
              <h2 className="text-xl font-semibold">Danh sách phát</h2>
              <span className="chip">{filtered.length} bài</span>
            </div>
            <div className="mb-3 flex gap-2">
              <input className="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-xl p-2" placeholder="Lọc nhanh theo tiêu đề / nghệ sĩ" value={filter} onChange={e=>setFilter(e.target.value)}/>
              <button className="btn" onClick={()=>{setFilter('');setVisible(INITIAL_VISIBLE)}}>Xoá</button>
            </div>
            {loading?(
              <div className="animate-pulse space-y-3">{Array.from({length:6}).map((_,i)=>(<div key={i} className="h-14 rounded-xl bg-[var(--card)]/40"></div>))}</div>
            ):(
              <>
                <div className="space-y-2">
                  {filtered.slice(0,visible).map((s)=>(
                    <div key={s.id} className={`flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)] ${current?.id===s.id?'ring-2 ring-[var(--ring)] bg-[var(--card)]/50':''}`}>
                      <img src={s.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-12 h-12 rounded-lg object-cover"/>
                      <button className="flex-grow text-left" onClick={()=>pickSong(s)}>
                        <div className="font-semibold truncate">{s.title||'Untitled'}</div>
                        <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                      </button>
                      <button className="btn" title="Tuỳ chọn" onClick={()=>setSheetFor(s)}>{ICONS.more(18)}</button>
                      <div className="text-xs text-[var(--muted)]">{formatTime(s.duration||0)}</div>
                    </div>
                  ))}
                </div>
                {filtered.length>visible && <button onClick={()=>setVisible(v=>Math.min(filtered.length,v+VISIBLE_STEP))} className="btn w-full mt-3">Tải thêm</button>}
              </>
            )}

            {sheetFor && (
              <div className="sheet">
                <div className="flex items-center justify-between px-2">
                  <div className="font-semibold truncate mr-2">{sheetFor.title}</div>
                  <button className="btn" onClick={closeSheet}>Đóng</button>
                </div>
                <div className="mt-2 grid grid-cols-2 gap-2 px-2 pb-2">
                  <button className="btn btn-primary" onClick={()=>{enqueueNext(sheetFor); closeSheet();}}>Phát tiếp theo</button>
                  <button className="btn" onClick={()=>{toggleFav(sheetFor); closeSheet();}}>{isFav(sheetFor)?'Bỏ yêu thích':'Yêu thích'}</button>
                  <button className="btn" onClick={()=>{pickSong(sheetFor); closeSheet();}}>Phát ngay</button>
                  <button className="btn" onClick={()=>{navigator.share?.({title:sheetFor.title,text:'Nghe cùng MSTQ Music',url:sheetFor.stream_url}).catch(()=>{}); closeSheet();}}>{ICONS.share(18)} Chia sẻ</button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const SearchTab = () => {
        const [kw,setKw]=useState('');
        const [busy,setBusy]=useState(false);
        const doSearch=async()=>{
          setBusy(true);
          try{
            const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(kw+' AND mediatype:(audio)')}&fl[]=identifier,title,creator,description&sort[]=downloads+desc&rows=100&page=1&output=json`;
            const r=await fetch(url,{cache:'no-store'}); const j=await r.json();
            const docs=j?.response?.docs||[];
            const out=[];
            for(const d of docs){
              try{
                const meta=await fetch(`https://archive.org/metadata/${d.identifier}`,{cache:'no-store'}).then(r=>r.json());
                (meta.files||[]).forEach(f=>{
                  if(String(f.format||'').toUpperCase().includes('MP3')){
                    out.push({id:`${d.identifier}/${f.name}`,title:(f.title||d.title||f.name||'').replace(/\.mp3$/i,'').replace(/_/g,' ').trim(),artist:d.creator||'Archive',stream_url:`https://archive.org/download/${d.identifier}/${encodeURIComponent(f.name)}`,artwork:`https://archive.org/download/${d.identifier}/__ia_thumb.jpg`,duration:parseFloat(f.length||0)||0,lyrics:d.description||'',item_identifier:d.identifier});
                  }
                });
              }catch{}
            }
            if(out.length){ setPlaylist(out); setVisible(INITIAL_VISIBLE); setTab('home'); setFilter(''); }
          }catch{}
          setBusy(false);
        };
        return (
          <div className="px-4 py-3">
            <div className="flex gap-2">
              <input className="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-xl p-2" placeholder="Tìm trên Archive.org..." value={kw} onChange={e=>setKw(e.target.value)}/>
              <button className="btn btn-primary" onClick={doSearch} disabled={!kw||busy}>{busy?'Đang tìm…':'Tìm'}</button>
            </div>
            <p className="text-xs text-[var(--muted)] mt-2">Gợi ý: “Minh Su Tinh Quang”, “Pháp thoại”…</p>
          </div>
        );
      };

      const LibraryTab = () => (
        <div className="px-4 py-3">
          <div className="mb-2 flex items-center justify-between">
            <h2 className="text-lg font-semibold">Yêu thích</h2>
            <span className="chip">{favs.length} bài</span>
          </div>
          {favs.length===0 ? <p className="text-[var(--muted)] text-sm">Chưa có bài nào trong “Yêu thích”.</p>:
            <div className="space-y-2">
              {favs.map(s=>(
                <div key={s.id} className="flex items-center gap-3 p-3 rounded-2xl border border-[var(--border)]">
                  <img src={s.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-12 h-12 rounded-lg object-cover"/>
                  <button className="flex-grow text-left" onClick={()=>pickSong(s)}>
                    <div className="font-semibold truncate">{s.title}</div>
                    <div className="text-xs text-[var(--muted)] truncate">{s.artist||'minhsutinhquang'}</div>
                  </button>
                  <button className="btn" onClick={()=>toggleFav(s)} title="Bỏ yêu thích">−</button>
                  <button className="btn" onClick={()=>enqueueNext(s)} title="Phát tiếp theo">⋯</button>
                </div>
              ))}
            </div>
          }
        </div>
      );

      const SettingsTab = () => (
        <div className="px-4 py-3 space-y-6">
          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-lg">Giao diện</h3>
              <span className="chip">{theme}</span>
            </div>
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
              {[
                ['Tối','dark'],['Sáng','light'],['Lục Bảo','lucbao'],['Dark+','dark']
              ].map(([label,code])=>(
                <button key={code} onClick={()=>setTheme(code)} className={`w-full text-left p-4 rounded-2xl border border-[var(--border)] ${theme===code?'ring-2 ring-[var(--ring)]':''}`}>
                  <div className="font-semibold">{label}</div>
                  <div className="text-xs text-[var(--muted)]">{code}</div>
                </button>
              ))}
            </div>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Âm lượng & tốc độ</h3>
            <div className="space-y-2">
              <label className="text-sm">Âm lượng: {(volume*100)|0}%</label>
              <input type="range" min="0" max="1" step="0.01" value={volume} onChange={e=>setVolume(parseFloat(e.target.value))}/>
              <div className="flex gap-2 flex-wrap">
                {[0.75,1,1.25,1.5].map(v=>(
                  <button key={v} className={`btn ${playbackRate===v?'btn-primary':''}`} onClick={()=>setPlaybackRate(v)}>{v}x</button>
                ))}
                <label className="flex items-center gap-2 ml-2">
                  <input type="checkbox" checked={muted} onChange={e=>setMuted(e.target.checked)}/> Tắt tiếng
                </label>
              </div>
            </div>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Ổn định âm lượng</h3>
            <label className="flex items-center gap-2">
              <input type="checkbox" checked={!!compressorOn} onChange={e=>setCompressorOn(e.target.checked)}/> Bật Dynamics Compressor (khuyên dùng)
            </label>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Tiết kiệm điện</h3>
            <p className="text-sm text-[var(--muted)] mb-2">Tắt preload khi nền, nới chu kỳ watchdog.</p>
            <label className="flex items-center gap-2">
              <input type="checkbox" checked={!!powerSave} onChange={e=>setPowerSave(e.target.checked)}/> Bật tiết kiệm pin
            </label>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-3">Hẹn giờ tắt nhạc</h3>
            <div className="grid grid-cols-3 sm:grid-cols-6 gap-2">
              {[15,30,45,60,90,120].map(m=>(
                <button key={m} className="btn" onClick={()=>startSleepTimer(m*60*1000)}>{m} phút</button>
              ))}
            </div>
            <div className="flex items-center gap-3 mt-3">
              <span className="chip">{timerLeft?`Còn: ${formatTime(Math.ceil(timerLeft/1000))}`:'Không đặt'}</span>
              {timerLeft && <button className="btn" onClick={cancelSleepTimer}>Huỷ hẹn giờ</button>}
            </div>
            <label className="flex items-center gap-2 mt-3">
              <input type="checkbox" checked={!!stopAtEnd} onChange={e=>setStopAtEnd(e.target.checked)} /> Dừng khi hết bài
            </label>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Nguồn dữ liệu</h3>
            <label className="flex items-center gap-2 mb-2">
              <input type="checkbox" checked={sourcePref.archive!==false} onChange={e=>setSourcePref(p=>({...p,archive:e.target.checked}))}/>
              <span>Archive.org</span>
            </label>
            <label className="flex items-center gap-2 mb-2">
              <input type="checkbox" checked={!!sourcePref.custom} onChange={e=>setSourcePref(p=>({...p,custom:e.target.checked}))}/>
              <span>Nguồn tuỳ chỉnh (mỗi dòng 1 URL hoặc M3U)</span>
            </label>
            <textarea className="w-full bg-[var(--card)] border border-[var(--border)] rounded-xl p-2 min-h-[120px]" placeholder="https://.../song1.mp3&#10;https://.../song2.mp3&#10;#EXTINF:-1,Tựa đề&#10;https://.../song3.mp3" value={sourcePref.customText||''} onChange={e=>setSourcePref(p=>({...p,customText:e.target.value}))}></textarea>
          </div>

          <div className="p-3 rounded-2xl border border-[var(--border)]">
            <h3 className="font-semibold mb-2">Dữ liệu & Đồng bộ</h3>
            <div className="flex flex-col gap-2">
              <button className="btn" onClick={()=>refetch()}>Làm mới danh sách nhạc</button>
              <button className="btn" style={{background:'#2a1313',borderColor:'#6b1d1d',color:'#fff'}} onClick={async()=>{
                try{ if('caches' in window){ const keys=await caches.keys(); for(const k of keys){ await caches.delete(k); } } }catch{}
                try{ localStorage.clear(); }catch{}
                location.reload();
              }}>Xóa & Làm mới tất cả</button>
              <p className="text-xs text-[var(--muted)]">Nếu gặp lỗi hoặc danh sách không cập nhật, hãy thử các tuỳ chọn này.</p>
            </div>
          </div>
        </div>
      );

      const AdminTab = () => (
        <div className="px-4 py-3 space-y-3">
          <h3 className="font-semibold text-lg">Bảng điều khiển</h3>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div className="p-3 rounded-2xl border border-[var(--border)]">
              <div className="text-sm">Bài hiện tại: <span className="chip">{current?.title||'—'}</span></div>
              <div className="text-sm mt-1">Vị trí: <span className="chip">{formatTime(progress.current)} / {formatTime(progress.duration)}</span></div>
              <div className="text-sm mt-1">Trạng thái: <span className="chip">{playing?'playing':'paused'}</span></div>
              <div className="mt-2 flex gap-2">
                <button className="btn" onClick={()=>audioRef.current?.play?.()}>Force Play</button>
                <button className="btn" onClick={()=>audioRef.current?.load?.()}>Force Load</button>
              </div>
            </div>
            <div className="p-3 rounded-2xl border border-[var(--border)]">
              <div className="text-sm">Playlist: <span className="chip">{playlist.length}</span></div>
              <div className="text-sm mt-1">Up Next: <span className="chip">{upNext.length}</span></div>
              <div className="text-sm mt-1">Shuffle: <span className="chip">{String(shuffle)}</span></div>
              <div className="text-sm mt-1">Repeat: <span className="chip">{repeat}</span></div>
            </div>
          </div>
        </div>
      );

      /* Now Playing với double-tap seek */
      const [showNowPlaying,setShowNowPlaying]=useState(false);
      const NowPlaying = () => {
        if(!current) return null;
        const a=audioRef.current;
        const onSeek=(e)=>{ if(!a||!isFinite(a.duration)) return; const v=parseFloat(e.target.value); a.currentTime=clamp(v,0,a.duration); };
        const dblLeft=()=>{ if(a) a.currentTime=Math.max(0,(a.currentTime||0)-10); };
        const dblRight=()=>{ if(a) a.currentTime=Math.min(a.duration||0,(a.currentTime||0)+10); };
        return (
          <div className="fixed inset-0 z-50 bg-[var(--bg)]/98 backdrop-blur-md">
            <div className="p-4 flex items-center justify-between border-b border-[var(--border)]">
              <button className="btn" onClick={()=>setShowNowPlaying(false)}>Đóng</button>
              <div className="font-semibold">Đang phát</div>
              <div className="w-14"></div>
            </div>

            <div className="px-6 py-6">
              <div className="mx-auto w-64 h-64 rounded-3xl shadow-xl overflow-hidden relative select-none" style={{background:'var(--gradient)'}}>
                <div className="absolute inset-0" onDoubleClick={dblLeft}></div>
                <div className="absolute inset-0 left-1/2" onDoubleClick={dblRight}></div>
                <img src={current.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" className="w-full h-full object-cover mix-blend-luminosity pointer-events-none"/>
              </div>
              <div className="mt-5 text-center">
                <div className="text-xl font-bold truncate">{current.title}</div>
                <div className="text-sm text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</div>
              </div>

              <div className="mt-5 px-1">
                <input type="range" min="0" max={progress.duration||0} step="0.1" value={progress.current||0} onChange={onSeek} style={{width:'100%'}}/>
                <div className="mt-1 text-[12px] text-[var(--muted)] flex justify-between">
                  <span>{formatTime(progress.current)}</span>
                  <span>{formatTime(progress.duration)}</span>
                </div>
              </div>

              <div className="mt-4 grid grid-cols-3 gap-3 items-center">
                <div className="text-center">
                  <div className="text-xs text-[var(--muted)] mb-1">Âm lượng {(volume*100|0)}%</div>
                  <input type="range" min="0" max="1" step="0.01" value={volume} onChange={e=>setVolume(parseFloat(e.target.value))}/>
                </div>
                <div className="flex items-center justify-center gap-3">
                  <button className="btn" onClick={prevTrack}>{ICONS.back(24)}</button>
                  <button className="btn btn-primary" onClick={playPause}>{playing?ICONS.pause(24):ICONS.play(24)}</button>
                  <button className="btn" onClick={nextTrack}>{ICONS.next(24)}</button>
                </div>
                <div className="text-center">
                  <div className="text-xs text-[var(--muted)] mb-1">Tốc độ {playbackRate}x</div>
                  <div className="flex gap-1 justify-center">
                    {[0.75,1,1.25,1.5].map(v=>(
                      <button key={v} className={`btn ${playbackRate===v?'btn-primary':''}`} onClick={()=>setPlaybackRate(v)}>{v}x</button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="mt-4 flex flex-wrap gap-2 justify-center">
                <span className="chip">Up Next: {upNext.length}</span>
                <button className="btn" onClick={()=>setMuted(m=>!m)}>{muted?'Bật tiếng':'Tắt tiếng'}</button>
                <button className="btn" onClick={()=>{
                  setRepeat(r=>r==='off'?'all':r==='all'?'one':'off');
                }}>Lặp: {repeat==='off'?'Tắt':repeat==='all'?'DS':'1'}</button>
                <button className="btn" onClick={()=>navigator.share?.({title:current.title,text:'Nghe cùng MSTQ Music',url:current.stream_url}).catch(()=>{})}>{ICONS.share(18)} Chia sẻ</button>
                {[15,30,45].map(m=>(<button key={m} className="btn" onClick={()=>startSleepTimer(m*60*1000)}>Hẹn {m}’</button>))}
              </div>
            </div>
          </div>
        );
      };

      /* Render */
      const padTop=64, padBottom=(current? 190:110);
      useEffect(()=>{ const a=audioRef.current; if(!a) return; if(current){ if(a.src!==current.stream_url){ a.src=current.stream_url; a.load(); } a.playbackRate=playbackRate; a.muted=muted; a.volume=volume; document.title=`${playing?'▶':'⏸'} ${current.title} – MSTQ`; if(playing && interactedRef.current){ a.play().catch(()=>{}); } } else { document.title='MSTQ Music'; } },[currentIndex,playing,playbackRate,muted,volume,current]);

      const TabTitle = tab==='home'?'Trang chủ':tab==='search'?'Tìm kiếm':tab==='library'?'Thư viện':tab==='settings'?'Cài đặt':'Admin';

      return (
        <div className="min-h-screen" style={{paddingTop:padTop, paddingBottom:padBottom}}>
          <TopBar title={TabTitle}/>
          {tab==='home' && <HomeTab/>}
          {tab==='search' && <SearchTab/>}
          {tab==='library' && <LibraryTab/>}
          {tab==='settings' && <SettingsTab/>}
          {tab==='admin' && <AdminTab/>}
          <TabBar/>

          {/* Mini Player */}
          {current && (
            <div className="fixed left-2 right-2 rounded-2xl bg-[var(--card)]/95 border border-[var(--border)] backdrop-blur-md p-2 z-50 shadow-[var(--shadow)]" style={{bottom:'64px'}}>
              <div className="flex items-center gap-3">
                <img src={current.artwork||'/PlayMusic/images/icons/icon-192x192.png'} alt="" width="44" height="44" className="rounded-lg object-cover"/>
                <button className="flex-grow min-w-0 text-left" onClick={()=>setShowNowPlaying(true)}>
                  <p className="truncate font-semibold">{current.title}</p>
                  <p className="text-xs text-[var(--muted)] truncate">{current.artist||'minhsutinhquang'}</p>
                </button>
                <button className="w-10 h-10" onClick={prevTrack} aria-label="Previous">{ICONS.back(22)}</button>
                <button className="w-10 h-10" onClick={playPause} aria-label="Play/Pause">{playing?ICONS.pause(22):ICONS.play(22)}</button>
                <button className="w-10 h-10" onClick={nextTrack} aria-label="Next">{ICONS.next(22)}</button>
              </div>
              <div className="mt-2 h-1 bg-[var(--muted)]/20 rounded">
                <div className="h-1 bg-[var(--primary)] rounded" style={{width:`${progress.duration>0?(progress.current/progress.duration)*100:0}%`}}></div>
              </div>
            </div>
          )}
          {showNowPlaying && <NowPlaying/>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
